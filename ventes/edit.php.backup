<?php
// ventes/edit.php
require_once __DIR__ . '/../security.php';
require_once __DIR__ . '/../lib/stock.php';

exigerConnexion();
exigerPermission('VENTES_CREER');

global $pdo;

$TAUX_TVA = 0.1925; // Ajuste si besoin

$id     = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$isEdit = $id > 0;

// Clients
$stmt = $pdo->query("SELECT id, nom FROM clients ORDER BY nom");
$clients = $stmt->fetchAll();

// Canaux de vente
$stmt = $pdo->query("SELECT id, code, libelle FROM canaux_vente ORDER BY code");
$canaux = $stmt->fetchAll();

// Produits
$stmt = $pdo->query("
    SELECT id, code_produit, designation, prix_vente
    FROM produits
    WHERE actif = 1
    ORDER BY code_produit
");
$produits = $stmt->fetchAll();
$produitsById = [];
foreach ($produits as $p) {
    $produitsById[(int)$p['id']] = $p;
}

// Valeurs par dÃ©faut
$data = [
    'date_vente'        => date('Y-m-d'),
    'client_id'         => '',
    'canal_vente_id'    => '',
    'statut'            => 'EN_ATTENTE_LIVRAISON',
    'commentaires'      => '',
];

$lignes = []; // lignes de vente

if ($isEdit) {
    // Charger la vente
    $stmt = $pdo->prepare("SELECT * FROM ventes WHERE id = :id");
    $stmt->execute(['id' => $id]);
    $vente = $stmt->fetch();

    if (!$vente) {
        $_SESSION['flash_error'] = "Vente introuvable.";
        header('Location: ' . url_for('ventes/list.php'));
        exit;
    }

    $data = [
        'date_vente'      => $vente['date_vente'],
        'client_id'       => $vente['client_id'],
        'canal_vente_id'  => $vente['canal_vente_id'],
        'statut'          => $vente['statut'],
        'commentaires'    => $vente['commentaires'] ?? '',
    ];

    // Charger les lignes
    $stmt = $pdo->prepare("
        SELECT vl.*, p.code_produit, p.designation
        FROM ventes_lignes vl
        JOIN produits p ON p.id = vl.produit_id
        WHERE vl.vente_id = :id
        ORDER BY vl.id
    ");
    $stmt->execute(['id' => $id]);
    $lignes = $stmt->fetchAll();
} else {
    // Par dÃ©faut, on prÃ©pare 3 lignes vides pour initialiser le formulaire
    $lignes = [
        ['produit_id' => '', 'quantite' => '', 'prix_unitaire' => '', 'remise' => ''],
        ['produit_id' => '', 'quantite' => '', 'prix_unitaire' => '', 'remise' => ''],
        ['produit_id' => '', 'quantite' => '', 'prix_unitaire' => '', 'remise' => ''],
    ];
}

$errors = [];

// Traitement POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        verifierCsrf($_POST['csrf_token'] ?? '');

        $data['date_vente']     = trim($_POST['date_vente'] ?? '');
        $data['client_id']      = (int)($_POST['client_id'] ?? 0);
        $data['canal_vente_id'] = (int)($_POST['canal_vente_id'] ?? 0);
        $data['statut']         = $_POST['statut'] ?? 'EN_ATTENTE_LIVRAISON';
        $data['commentaires']   = trim($_POST['commentaires'] ?? '');

        $produitIds = $_POST['produit_id'] ?? [];
        $qtes       = $_POST['quantite'] ?? [];
        $prixUnit   = $_POST['prix_unitaire'] ?? [];
        $remises    = $_POST['remise'] ?? [];

        // Reconstruction des lignes
        $lignes = [];
        $totalHT = 0.0;

        foreach ($produitIds as $idx => $prodIdRaw) {
            $prodId = (int)$prodIdRaw;
            $q      = (float)str_replace(',', '.', $qtes[$idx] ?? '0');
            $pu     = (float)str_replace(',', '.', $prixUnit[$idx] ?? '0');
            $rem    = (float)str_replace(',', '.', $remises[$idx] ?? '0');

            if ($prodId <= 0 || $q <= 0 || $pu <= 0) {
                continue; // on ignore les lignes incomplÃ¨tes
            }

            $montantBrut = $pu * $q;
            $montantLigneHT = max(0, $montantBrut - $rem);

            $lignes[] = [
                'produit_id'    => $prodId,
                'quantite'      => $q,
                'prix_unitaire' => $pu,
                'remise'        => $rem,
                'montant_ligne_ht' => $montantLigneHT,
            ];

            $totalHT += $montantLigneHT;
        }

        // Validations
        if ($data['date_vente'] === '') {
            $errors[] = "La date de vente est obligatoire.";
        }
        if ($data['client_id'] <= 0) {
            $errors[] = "Le client est obligatoire.";
        }
        if ($data['canal_vente_id'] <= 0) {
            $errors[] = "Le canal de vente est obligatoire.";
        }
        if (!in_array($data['statut'], ['EN_ATTENTE_LIVRAISON','PARTIELLEMENT_LIVREE','LIVREE','ANNULEE'], true)) {
            $errors[] = "Statut de vente invalide.";
        }
        if (empty($lignes)) {
            $errors[] = "La vente doit contenir au moins une ligne produit valide.";
        }

        $totalTTC = $totalHT * (1 + $TAUX_TVA);

        if (empty($errors)) {
            try {
                $pdo->beginTransaction();
                $utilisateur = utilisateurConnecte();
                $utilisateurId = $utilisateur['id'] ?? null;

                if ($isEdit) {
                    // UPDATE vente
                    $stmt = $pdo->prepare("
                        UPDATE ventes
                        SET date_vente = :date_vente,
                            client_id = :client_id,
                            canal_vente_id = :canal_vente_id,
                            statut = :statut,
                            montant_total_ht = :mtht,
                            montant_total_ttc = :mttc,
                            commentaires = :commentaires
                        WHERE id = :id
                    ");
                    $stmt->execute([
                        'date_vente'     => $data['date_vente'],
                        'client_id'      => $data['client_id'],
                        'canal_vente_id' => $data['canal_vente_id'],
                        'statut'         => $data['statut'],
                        'mtht'           => $totalHT,
                        'mttc'           => $totalTTC,
                        'commentaires'   => $data['commentaires'] !== '' ? $data['commentaires'] : null,
                        'id'             => $id,
                    ]);

                    // Effacer les lignes existantes
                    $stmt = $pdo->prepare("DELETE FROM ventes_lignes WHERE vente_id = :id");
                    $stmt->execute(['id' => $id]);

                    // RÃ©insÃ©rer les lignes
                    $stmtL = $pdo->prepare("
                        INSERT INTO ventes_lignes
                        (vente_id, produit_id, quantite, prix_unitaire, remise, montant_ligne_ht)
                        VALUES
                        (:vente_id, :produit_id, :quantite, :prix_unitaire, :remise, :montant_ligne_ht)
                    ");
                    foreach ($lignes as $lg) {
                        $stmtL->execute([
                            'vente_id'        => $id,
                            'produit_id'      => $lg['produit_id'],
                            'quantite'        => $lg['quantite'],
                            'prix_unitaire'   => $lg['prix_unitaire'],
                            'remise'          => $lg['remise'],
                            'montant_ligne_ht'=> $lg['montant_ligne_ht'],
                        ]);
                    }

                    // ðŸ”— Synchronisation stock (sorties liÃ©es Ã  cette vente)
                    stock_synchroniser_vente($pdo, $id);

                    $_SESSION['flash_success'] = "Vente mise Ã  jour avec succÃ¨s.";

                } else {
                    // GÃ©nÃ©ration numÃ©ro de vente
                    $numero = 'V-' . date('Ymd-His');

                    // INSERT vente
                    $stmt = $pdo->prepare("
                        INSERT INTO ventes
                        (numero, date_vente, client_id, canal_vente_id, devis_id,
                         statut, montant_total_ht, montant_total_ttc, utilisateur_id, commentaires)
                        VALUES
                        (:numero, :date_vente, :client_id, :canal_vente_id, :devis_id,
                         :statut, :mtht, :mttc, :utilisateur_id, :commentaires)
                    ");
                    $stmt->execute([
                        'numero'         => $numero,
                        'date_vente'     => $data['date_vente'],
                        'client_id'      => $data['client_id'],
                        'canal_vente_id' => $data['canal_vente_id'],
                        'devis_id'       => null, // vente directe sans devis
                        'statut'         => $data['statut'],
                        'mtht'           => $totalHT,
                        'mttc'           => $totalTTC,
                        'utilisateur_id' => $utilisateurId,
                        'commentaires'   => $data['commentaires'] !== '' ? $data['commentaires'] : null,
                    ]);

                    $venteId = (int)$pdo->lastInsertId();

                    // INSERT lignes
                    $stmtL = $pdo->prepare("
                        INSERT INTO ventes_lignes
                        (vente_id, produit_id, quantite, prix_unitaire, remise, montant_ligne_ht)
                        VALUES
                        (:vente_id, :produit_id, :quantite, :prix_unitaire, :remise, :montant_ligne_ht)
                    ");
                    foreach ($lignes as $lg) {
                        $stmtL->execute([
                            'vente_id'        => $venteId,
                            'produit_id'      => $lg['produit_id'],
                            'quantite'        => $lg['quantite'],
                            'prix_unitaire'   => $lg['prix_unitaire'],
                            'remise'          => $lg['remise'],
                            'montant_ligne_ht'=> $lg['montant_ligne_ht'],
                        ]);
                    }

                    // ðŸ”— Synchronisation stock (sorties liÃ©es Ã  cette vente)
                    stock_synchroniser_vente($pdo, $venteId);

                    $_SESSION['flash_success'] = "Vente crÃ©Ã©e avec succÃ¨s.";
                }

                $pdo->commit();
                header('Location: ' . url_for('ventes/list.php'));
                exit;
            } catch (Throwable $e) {
                if ($pdo->inTransaction()) $pdo->rollBack();
                $errors[] = "Erreur lors de l'enregistrement de la vente : " . $e->getMessage();
            }
        }
}

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $isEdit ? 'Modifier une vente' : 'Nouvelle vente directe' ?>
        </h1>
        <a href="<?= url_for('ventes/list.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
        </a>
    </div>

    <?php if (!empty($errors)): ?>
        <div class="alert alert-danger py-2">
            <ul class="mb-0">
                <?php foreach ($errors as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <div class="card mb-3">
        <div class="card-body">
            <form method="post">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small">Date de vente</label>
                        <input type="date" name="date_vente" class="form-control"
                               value="<?= htmlspecialchars($data['date_vente']) ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">Client</label>
                        <select name="client_id" class="form-select" required>
                            <option value="">-- SÃ©lectionner --</option>
                            <?php foreach ($clients as $c): ?>
                                <option value="<?= (int)$c['id'] ?>"
                                    <?= (int)$data['client_id'] === (int)$c['id'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($c['nom']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Canal de vente</label>
                        <select name="canal_vente_id" class="form-select" required>
                            <option value="">-- SÃ©lectionner --</option>
                            <?php foreach ($canaux as $cv): ?>
                                <option value="<?= (int)$cv['id'] ?>"
                                    <?= (int)$data['canal_vente_id'] === (int)$cv['id'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($cv['code']) ?> â€“ <?= htmlspecialchars($cv['libelle']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Statut</label>
                        <select name="statut" class="form-select" required>
                            <?php foreach (['EN_ATTENTE_LIVRAISON','PARTIELLEMENT_LIVREE','LIVREE','ANNULEE'] as $s): ?>
                                <option value="<?= $s ?>" <?= $data['statut'] === $s ? 'selected' : '' ?>>
                                    <?= $s ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="form-label small">Commentaires (facultatif)</label>
                        <textarea name="commentaires" class="form-control" rows="2"
                                  placeholder="Infos complÃ©mentaires sur la vente, conditions spÃ©cifiques..."><?= htmlspecialchars($data['commentaires']) ?></textarea>
                    </div>
                </div>

                <hr class="my-4">

                <h5 class="h6 mb-3">Lignes de vente</h5>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th style="width:40%">Produit</th>
                            <th style="width:10%">QtÃ©</th>
                            <th style="width:20%">Prix unitaire</th>
                            <th style="width:15%">Remise (ligne)</th>
                            <th style="width:15%">Montant HT (indicatif)</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php
                        // On affiche au moins 3 lignes, ou les lignes existantes + 1
                        $nbLignesAffichees = max(count($lignes), 3);
                        for ($i = 0; $i < $nbLignesAffichees; $i++):
                            $lg = $lignes[$i] ?? [
                                'produit_id' => '',
                                'quantite'   => '',
                                'prix_unitaire' => '',
                                'remise'     => '',
                                'montant_ligne_ht' => '',
                            ];
                            $prodId = (int)($lg['produit_id'] ?? 0);
                            $montantIndicatif = $lg['montant_ligne_ht'] ?? '';
                        ?>
                            <tr>
                                <td>
                                    <select name="produit_id[]" class="form-select">
                                        <option value="">-- SÃ©lectionner --</option>
                                        <?php foreach ($produits as $p): ?>
                                            <option value="<?= (int)$p['id'] ?>"
                                                <?= $prodId === (int)$p['id'] ? 'selected' : '' ?>>
                                                <?= htmlspecialchars($p['code_produit']) ?> â€“ <?= htmlspecialchars($p['designation']) ?>
                                                (<?= number_format((float)$p['prix_vente'], 0, ',', ' ') ?> FCFA)
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </td>
                                <td>
                                    <input type="number" step="0.01" name="quantite[]" class="form-control"
                                           value="<?= htmlspecialchars((string)$lg['quantite']) ?>">
                                </td>
                                <td>
                                    <input type="number" step="0.01" name="prix_unitaire[]" class="form-control"
                                           value="<?= htmlspecialchars((string)$lg['prix_unitaire']) ?>">
                                </td>
                                <td>
                                    <input type="number" step="0.01" name="remise[]" class="form-control"
                                           value="<?= htmlspecialchars((string)$lg['remise']) ?>">
                                </td>
                                <td>
                                    <?php if ($montantIndicatif !== ''): ?>
                                        <?= number_format((float)$montantIndicatif, 0, ',', ' ') ?> FCFA
                                    <?php else: ?>
                                        <span class="text-muted small">CalculÃ© Ã  lâ€™enregistrement</span>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endfor; ?>
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i>
                        <?= $isEdit ? 'Mettre Ã  jour la vente' : 'Enregistrer la vente' ?>
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>
