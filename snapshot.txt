===== ARBORESCENCE DU PROJET (depuis C:\xampp\htdocs\kms_app) =====
achats
achats\edit.php
achats\list.php
ajax
ajax\clients_search.php
api
api\clients_recherche.php
api\produits_recherche.php
assets
assets\css
assets\css\custom.css
assets\img
assets\img\logo kms.jpg
assets\img\logo-kms.png
assets\img\produits
assets\img\produits\MEU-CH-001.png
assets\img\produits\PAN-FOR-001.jpeg
assets\img\produits\PAN-FOR-001.jpg
assets\img\produits\PAN-FOR-001.png
assets\img\produits\PAN-MDF.jpg
audit_stock.php
caisse
caisse\journal.php
caisse\ventes_encaissements.php
check_migration.php
clients
clients\edit.php
clients\list.php
create_admin_password.php
db
db\1.sql
db\2.sql
db\3.sql
db\4.sql
db\5- satisfaction
db\db.php
db\kms_gestion (1).sql
db\schema.sql
debug_image.php
devis
devis\convertir_en_vente.php
devis\edit.php
devis\list.php
formation
formation\formations_edit.php
formation\formations_list.php
formation\inscriptions.php
formation\prospects_list.php
historique.txt
hotel
hotel\chambres_edit.php
hotel\chambres_list.php
hotel\reservation_edit.php
hotel\reservations.php
hotel\upsell_list.php
hotel\visiteurs_list.php
index.php
kms_gestion (1).sql
lib
lib\caisse.php
lib\stock.php
litiges
litiges\edit.php
litiges\list.php
livraisons
livraisons\list.php
livraisons\marquer_signe.php
login.php
logout.php
migrate_stock.php
Organisation du service Marketing.pdf
partials
partials\footer.php
partials\header.php
partials\sidebar.php
produits
produits\edit.php
produits\list.php
promotions
promotions\edit.php
promotions\list.php
recalc_all_stock.php
reporting
reporting\index.php
ruptures
ruptures\list.php
satisfaction
satisfaction\list.php
security.php
showroom
showroom\visiteurs_list.php
snapshot.txt
stock
stock\etat.php
stock\mouvements.php
terrain
terrain\prospections_list.php
terrain\rendezvous_list.php
test_export_csv.php
tests
tests\check_movements_for_product.php
tests\check_product_by_code.php
tests\compare_stock_product.php
tests\count_movements_for_vente.php
tests\find_vente_with_lines.php
tests\generer_bl_simulate.php
tests\http_tests_run.ps1
tests\stock_test.php
tests\stock_test_achat.php
tests\stock_test_ajustement.php
tests\stock_test_vente.php
utilisateurs
utilisateurs\edit.php
utilisateurs\list.php
ventes
ventes\detail.php
ventes\edit.php
ventes\edit.php.backup
ventes\generer_bl.php
ventes\list.php

===== CONTENU DES FICHIERS DE CODE =====

===== FICHIER : audit_stock.php =====

<?php
// audit_stock.php - Diagnostic complet du stock

require_once __DIR__ . '/db/db.php';

echo "<h2>ðŸ” AUDIT COMPLET DU STOCK</h2>";
echo "<hr>";

// ============================================
// 1. Comparer les deux tables de mouvements
// ============================================
echo "<h3>1ï¸âƒ£ Ã‰tat des deux tables de mouvements</h3>";
// helper: existe-t-on une table ?
function tableExists(PDO $pdo, string $name): bool {
    // Utiliser information_schema.tables pour Ã©viter les limitations
    // de certaines versions/driver PDO avec "SHOW TABLES LIKE ?".
    $sql = "SELECT COUNT(*) AS cnt FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = :t";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([':t' => $name]);
    $row = $stmt->fetch(PDO::FETCH_ASSOC);
    return isset($row['cnt']) && (int)$row['cnt'] > 0;
}

$hasMouvementsStock = tableExists($pdo, 'mouvements_stock');
$hasStocksMouvements = tableExists($pdo, 'stocks_mouvements');

$cnt1 = $hasMouvementsStock ? (int)$pdo->query("SELECT COUNT(*) as cnt FROM mouvements_stock")->fetch()['cnt'] : 0;
$cnt2 = $hasStocksMouvements ? (int)$pdo->query("SELECT COUNT(*) as cnt FROM stocks_mouvements")->fetch()['cnt'] : 0;

echo "<p>mouvements_stock : <strong>" . ($hasMouvementsStock ? "$cnt1 lignes" : "introuvable") . "</strong></p>";
echo "<p>stocks_mouvements : <strong>" . ($hasStocksMouvements ? "$cnt2 lignes" : "introuvable") . "</strong></p>";

// chercher un backup Ã©ventuel
$backupTable = null;
$stmt = $pdo->query("SHOW TABLES LIKE 'mouvements_stock_backup_%'");
$b = $stmt->fetchAll(PDO::FETCH_COLUMN);
if (!empty($b)) {
    // choisir le plus rÃ©cent (nom contient la date)
    rsort($b);
    $backupTable = $b[0];
    echo "<p>Backup trouvÃ© : <strong>" . htmlspecialchars($backupTable) . "</strong></p>";
}

// ============================================
// 2. Pour chaque produit, comparer le stock
// ============================================
echo "<h3>2ï¸âƒ£ CohÃ©rence stock par produit</h3>";

$stmt = $pdo->query("SELECT id, code_produit, stock_actuel FROM produits ORDER BY id");
$produits = $stmt->fetchAll();

echo "<table border='1' cellpadding='5'>";
echo "<tr><th>ID</th><th>Code</th><th>stock_actuel (BD)</th><th>ThÃ©orique stocks_mouvements</th><th>ThÃ©orique mouvements_stock</th><th>Statut</th></tr>";

foreach ($produits as $p) {
    $id = $p['id'];
    $code = $p['code_produit'];
    $stock_bd = $p['stock_actuel'];
    
    // Calcul stock thÃ©orique depuis stocks_mouvements
    $stmt = $pdo->prepare("
        SELECT
            COALESCE(
                SUM(
                    CASE
                        WHEN type_mouvement = 'ENTREE' THEN quantite
                        WHEN type_mouvement = 'SORTIE' THEN -quantite
                        WHEN type_mouvement = 'AJUSTEMENT' THEN quantite
                        ELSE 0
                    END
                ),
                0
            ) AS qte
        FROM stocks_mouvements
        WHERE produit_id = :pid
    ");
    $stmt->execute([':pid' => $id]);
    $stock_theo1 = $stmt->fetch()['qte'];
    
    // Calcul stock thÃ©orique depuis mouvements_stock
    $stock_theo2 = 'N/A';
    if ($hasMouvementsStock) {
        $stmt = $pdo->prepare("
            SELECT
                COALESCE(
                    SUM(
                        CASE
                            WHEN type_mouvement = 'ENTREE' THEN quantite
                            WHEN type_mouvement = 'SORTIE' THEN -quantite
                            WHEN type_mouvement = 'CORRECTION' THEN quantite
                            ELSE 0
                        END
                    ),
                    0
                ) AS qte
            FROM mouvements_stock
            WHERE produit_id = :pid
        ");
        $stmt->execute([':pid' => $id]);
        $stock_theo2 = $stmt->fetch()['qte'];
    } elseif (!empty($backupTable)) {
        // essayer depuis la table backup
        $sql = "SELECT COALESCE(SUM(CASE WHEN type_mouvement='ENTREE' THEN quantite WHEN type_mouvement='SORTIE' THEN -quantite WHEN type_mouvement='CORRECTION' THEN quantite ELSE 0 END),0) AS qte FROM `" . str_replace('`','', $backupTable) . "` WHERE produit_id = :pid";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([':pid' => $id]);
        $stock_theo2 = $stmt->fetch()['qte'];
    }
    
    // VÃ©rifier la cohÃ©rence
    $ok = ($stock_bd == $stock_theo1);
    $status = $ok ? 'âœ“ OK' : 'âœ— INCOHÃ‰RENT';
    
    echo "<tr>";
    echo "<td>$id</td>";
    echo "<td>$code</td>";
    echo "<td><strong>$stock_bd</strong></td>";
    echo "<td>$stock_theo1</td>";
    echo "<td>$stock_theo2</td>";
    echo "<td><strong style='color: " . ($ok ? 'green' : 'red') . "'>$status</strong></td>";
    echo "</tr>";
}

echo "</table>";

// ============================================
// 3. DÃ©tail des mouvements par produit
// ============================================
echo "<h3>3ï¸âƒ£ DÃ©tail des mouvements (stocks_mouvements)</h3>";

$stmt = $pdo->query("
    SELECT 
        p.id, p.code_produit, p.stock_actuel,
        sm.type_mouvement, sm.quantite, sm.source_type, sm.commentaire
    FROM produits p
    LEFT JOIN stocks_mouvements sm ON p.id = sm.produit_id
    ORDER BY p.id, sm.date_mouvement DESC
");
$rows = $stmt->fetchAll();

foreach ($rows as $row) {
    if ($row['type_mouvement'] === null) {
        echo "<p><strong>Produit {$row['code_produit']} (ID={$row['id']})</strong> : <em>Aucun mouvement</em></p>";
    } else {
        echo "<p><strong>Produit {$row['code_produit']}</strong> - {$row['type_mouvement']} {$row['quantite']} ({$row['source_type']}) : {$row['commentaire']}</p>";
    }
}

// ============================================
// 4. DÃ©tail des mouvements mouvements_stock
// ============================================
echo "<h3>4ï¸âƒ£ DÃ©tail des mouvements (mouvements_stock)</h3>";

if ($hasMouvementsStock) {
    $stmt = $pdo->query("
        SELECT 
            p.id, p.code_produit,
            ms.type_mouvement, ms.quantite, ms.source_module, ms.commentaire
        FROM produits p
        LEFT JOIN mouvements_stock ms ON p.id = ms.produit_id
        ORDER BY p.id, ms.date_mouvement DESC
    ");
    $rows = $stmt->fetchAll();

    foreach ($rows as $row) {
        if ($row['type_mouvement'] === null) {
            echo "<p><strong>Produit {$row['code_produit']} (ID={$row['id']})</strong> : <em>Aucun mouvement</em></p>";
        } else {
            echo "<p><strong>Produit {$row['code_produit']}</strong> - {$row['type_mouvement']} {$row['quantite']} ({$row['source_module']}) : {$row['commentaire']}</p>";
        }
    }

} elseif (!empty($backupTable)) {
    echo "<p>La table <strong>mouvements_stock</strong> est absente â€” affichage depuis backup <strong>" . htmlspecialchars($backupTable) . "</strong> :</p>";
    $sql = "
        SELECT 
            p.id, p.code_produit,
            ms.type_mouvement, ms.quantite, ms.source_module, ms.commentaire
        FROM produits p
        LEFT JOIN `" . str_replace('`','', $backupTable) . "` ms ON p.id = ms.produit_id
        ORDER BY p.id, ms.date_mouvement DESC
    ";
    $stmt = $pdo->query($sql);
    $rows = $stmt->fetchAll();
    foreach ($rows as $row) {
        if ($row['type_mouvement'] === null) {
            echo "<p><strong>Produit {$row['code_produit']} (ID={$row['id']})</strong> : <em>Aucun mouvement</em></p>";
        } else {
            echo "<p><strong>Produit {$row['code_produit']}</strong> - {$row['type_mouvement']} {$row['quantite']} ({$row['source_module']}) : {$row['commentaire']}</p>";
        }
    }
} else {
    echo "<p>Table <strong>mouvements_stock</strong> introuvable et aucun backup dÃ©tectÃ©.</p>";
}

echo "<hr>";
echo "<p><strong>âœ… Audit terminÃ©. Utilise les informations ci-dessus pour la migration.</strong></p>";
?>



===== FICHIER : check_migration.php =====

<?php
// check_migration.php - vÃ©rifie existence de tables mouvements_stock / backups
require_once __DIR__ . '/db/db.php';

echo "<h2>VÃ©rification migration</h2>";

// Liste des tables
$tables = [];
$stmt = $pdo->query("SHOW TABLES");
while ($row = $stmt->fetch(PDO::FETCH_NUM)) {
    $tables[] = $row[0];
}

echo "<p>Tables prÃ©sentes (filtrÃ©es pour 'mouv' et 'stocks') :</p>";
echo "<ul>";
foreach ($tables as $t) {
    if (stripos($t, 'mouv') !== false || stripos($t, 'stock') !== false) {
        echo "<li>" . htmlspecialchars($t) . "</li>";
    }
}
echo "</ul>";

// DÃ©tails si une table backup existe
$backups = preg_grep('/^mouvements_stock_backup_\\d{8}_\\d{6}$/', $tables);
if (!empty($backups)) {
    echo "<h3>Backups trouvÃ©s :</h3><ul>";
    foreach ($backups as $b) {
        echo "<li>" . htmlspecialchars($b) . "</li>";
    }
    echo "</ul>";
} else {
    echo "<p>Aucun backup 'mouvements_stock_backup_YYYYMMDD_HHMMSS' trouvÃ©.</p>";
}

// Compter lignes dans stocks_mouvements
if (in_array('stocks_mouvements', $tables)) {
    $cnt = $pdo->query("SELECT COUNT(*) FROM stocks_mouvements")->fetchColumn();
    echo "<p><strong>stocks_mouvements</strong> contient <strong>$cnt</strong> lignes.</p>";
} else {
    echo "<p>Table <strong>stocks_mouvements</strong> introuvable.</p>";
}

// Compter lignes dans mouvements_stock (si prÃ©sente)
if (in_array('mouvements_stock', $tables)) {
    $cnt = $pdo->query("SELECT COUNT(*) FROM mouvements_stock")->fetchColumn();
    echo "<p><strong>mouvements_stock</strong> contient <strong>$cnt</strong> lignes.</p>";
} else {
    echo "<p>Table <strong>mouvements_stock</strong> introuvable.</p>";
}

// Conseils
echo "<h3>Ã‰tapes suivantes recommandÃ©es</h3>";
echo "<ol>";
echo "<li>Si un backup existe (mouvements_stock_backup...), la migration a probablement dÃ©jÃ  Ã©tÃ© lancÃ©e â€” vÃ©rifie le contenu du backup avant de relancer.</li>";
echo "<li>Si tu veux que je migre depuis le backup, indique-moi le nom exact de la table backup ou autorise la migration automatique.</li>";
echo "<li>Si la migration est dÃ©jÃ  faite et que tu veux rÃ©aligner produits.stock_actuel, je peux exÃ©cuter un recalcul (update) pour tous les produits Ã  partir de stocks_mouvements.</li>";
echo "</ol>";

?>



===== FICHIER : create_admin_password.php =====

<?php
// create_admin_password.php
$hash = password_hash('admin123', PASSWORD_DEFAULT);
echo $hash;



===== FICHIER : debug_image.php =====

<?php
// Script de diagnostic pour vÃ©rifier les images
require_once __DIR__ . '/db/db.php';

$id = (int)($_GET['id'] ?? 1);

// RÃ©cupÃ©rer les infos du produit
$stmt = $pdo->prepare("SELECT id, code_produit, image_path FROM produits WHERE id = :id");
$stmt->execute(['id' => $id]);
$p = $stmt->fetch();

if (!$p) {
    die("Produit non trouvÃ©");
}

echo "<h2>Diagnostic Image - Produit ID: $id</h2>";
echo "<pre>";
echo "Code produit: " . htmlspecialchars($p['code_produit']) . "\n";
echo "Image path en BD: " . htmlspecialchars($p['image_path']) . "\n";
echo "\n";

// VÃ©rifier si le fichier existe
$basePath = __DIR__;
$testPaths = [
    $p['image_path'],
    $basePath . $p['image_path'],
    $basePath . '/assets/img/produits/' . $p['code_produit'] . '.png',
    $basePath . '/assets/img/produits/' . $p['code_produit'] . '.jpg',
    $basePath . '/assets/img/produits/' . $p['code_produit'] . '.jpeg',
];

echo "Chemins testÃ©s:\n";
foreach ($testPaths as $path) {
    $exists = file_exists($path) ? 'âœ“ EXISTE' : 'âœ— N\'existe pas';
    echo "$exists: $path\n";
}

echo "\n";
echo "Fichiers dans assets/img/produits/:\n";
$dir = $basePath . '/assets/img/produits/';
if (is_dir($dir)) {
    $files = scandir($dir);
    foreach ($files as $file) {
        if ($file !== '.' && $file !== '..') {
            echo "  - $file\n";
        }
    }
} else {
    echo "  Dossier n'existe pas!\n";
}

echo "</pre>";
?>



===== FICHIER : index.php =====

<?php
// index.php
require_once __DIR__ . '/security.php';
exigerConnexion();

include __DIR__ . '/partials/header.php';
include __DIR__ . '/partials/sidebar.php';

$utilisateur = utilisateurConnecte();
?>

<div class="container-fluid">
    <h1 class="h4 mb-4">Tableau de bord KMS</h1>

    <!-- KPIs rapides (placeholders pour le moment) -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card kms-card-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted text-uppercase small">Visiteurs showroom (jour)</div>
                            <div class="fs-4 fw-semibold">0</div>
                        </div>
                        <i class="bi bi-shop fs-2 text-primary"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- tu pourras complÃ©ter plus tard avec de vrais chiffres -->
        <div class="col-md-3">
            <div class="card kms-card-hover">
                <div class="card-body">
                    <div class="text-muted text-uppercase small">Devis du jour</div>
                    <div class="fs-4 fw-semibold">0</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card kms-card-hover">
                <div class="card-body">
                    <div class="text-muted text-uppercase small">Ventes du jour</div>
                    <div class="fs-4 fw-semibold">0</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card kms-card-hover">
                <div class="card-body">
                    <div class="text-muted text-uppercase small">Taux dâ€™occupation hÃ´tel</div>
                    <div class="fs-4 fw-semibold">0 %</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Raccourcis d'accÃ¨s rapide aux modules -->
    <h2 class="h6 text-uppercase text-muted mb-3">AccÃ¨s rapide</h2>
    <div class="row g-3">

        <!-- Produits & stock -->
        <div class="col-md-3">
            <a href="<?= url_for('produits/list.php') ?>" class="text-decoration-none">
                <div class="card kms-card-hover h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-box-seam fs-2 text-primary"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Produits & stock</div>
                            <div class="text-muted small">GÃ©rer le catalogue et les stocks</div>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <!-- Clients -->
        <div class="col-md-3">
            <a href="<?= url_for('clients/list.php') ?>" class="text-decoration-none">
                <div class="card kms-card-hover h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-people fs-2 text-primary"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Clients & prospects</div>
                            <div class="text-muted small">Base clients, pipeline commercial</div>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <!-- Ventes -->
        <div class="col-md-3">
            <a href="<?= url_for('ventes/list.php') ?>" class="text-decoration-none">
                <div class="card kms-card-hover h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-cart-check fs-2 text-primary"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Ventes</div>
                            <div class="text-muted small">Suivi des ventes & livraisons</div>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <!-- RÃ©servations hÃ´tel -->
        <div class="col-md-3">
            <a href="<?= url_for('hotel/reservations.php') ?>" class="text-decoration-none">
                <div class="card kms-card-hover h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-building fs-2 text-primary"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">RÃ©servations hÃ´tel</div>
                            <div class="text-muted small">SÃ©jours, montants et statut</div>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <!-- ðŸ”¹ NOUVEAU : Gestion des chambres -->
        <div class="col-md-3">
            <a href="<?= url_for('hotel/chambres_list.php') ?>" class="text-decoration-none">
                <div class="card kms-card-hover h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-door-closed fs-2 text-primary"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Chambres</div>
                            <div class="text-muted small">CrÃ©er, modifier et activer les chambres</div>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <!-- tu pourras ajouter dâ€™autres raccourcis (Showroom, Terrain, Formation, etc.) au besoin -->

    </div>
</div>

<?php
include __DIR__ . '/partials/footer.php';



===== FICHIER : kms_gestion (1).sql =====

-- phpMyAdmin SQL Dump
-- version 5.2.1
-- https://www.phpmyadmin.net/
--
-- Host: 127.0.0.1
-- Generation Time: Dec 09, 2025 at 04:34 PM
-- Server version: 10.4.32-MariaDB
-- PHP Version: 8.2.12

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
START TRANSACTION;
SET time_zone = "+00:00";


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;

--
-- Database: `kms_gestion`
--

-- --------------------------------------------------------

--
-- Table structure for table `achats`
--

CREATE TABLE `achats` (
  `id` int(10) UNSIGNED NOT NULL,
  `numero` varchar(50) NOT NULL,
  `date_achat` date NOT NULL,
  `fournisseur_nom` varchar(255) DEFAULT NULL,
  `fournisseur_contact` varchar(255) DEFAULT NULL,
  `montant_total_ht` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_total_ttc` decimal(15,2) NOT NULL DEFAULT 0.00,
  `statut` varchar(30) NOT NULL DEFAULT 'EN_COURS',
  `utilisateur_id` int(10) UNSIGNED DEFAULT NULL,
  `commentaires` text DEFAULT NULL,
  `date_creation` datetime NOT NULL DEFAULT current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `achats`
--

INSERT INTO `achats` (`id`, `numero`, `date_achat`, `fournisseur_nom`, `fournisseur_contact`, `montant_total_ht`, `montant_total_ttc`, `statut`, `utilisateur_id`, `commentaires`, `date_creation`) VALUES
(1, 'ACH-20251121-162559', '2025-11-21', 'China.com', '+235555555', 9000.00, 9000.00, 'EN_COURS', 1, NULL, '2025-11-21 16:25:59'),
(2, 'AC-20251126-170544', '2025-11-26', 'SORA', '+235555556', 1250000.00, 1250000.00, 'VALIDE', 1, NULL, '2025-11-26 17:05:44'),
(3, 'AC-20251202-154014', '2025-12-02', 'SORA', '+235555556', 1250000.00, 1250000.00, 'EN_COURS', 1, NULL, '2025-12-02 15:40:14');

-- --------------------------------------------------------

--
-- Table structure for table `achats_lignes`
--

CREATE TABLE `achats_lignes` (
  `id` int(10) UNSIGNED NOT NULL,
  `achat_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `quantite` decimal(15,3) NOT NULL DEFAULT 0.000,
  `prix_unitaire` decimal(15,2) NOT NULL DEFAULT 0.00,
  `remise` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_ligne_ht` decimal(15,2) NOT NULL DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `achats_lignes`
--

INSERT INTO `achats_lignes` (`id`, `achat_id`, `produit_id`, `quantite`, `prix_unitaire`, `remise`, `montant_ligne_ht`) VALUES
(7, 1, 1, 5.000, 2000.00, 1000.00, 9000.00),
(8, 2, 2, 25.000, 50000.00, 0.00, 1250000.00),
(9, 3, 3, 25.000, 50000.00, 0.00, 1250000.00);

-- --------------------------------------------------------

--
-- Table structure for table `bons_livraison`
--

CREATE TABLE `bons_livraison` (
  `id` int(10) UNSIGNED NOT NULL,
  `numero` varchar(50) NOT NULL,
  `date_bl` date NOT NULL,
  `vente_id` int(10) UNSIGNED DEFAULT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `transport_assure_par` varchar(150) DEFAULT NULL,
  `observations` text DEFAULT NULL,
  `signe_client` tinyint(1) NOT NULL DEFAULT 0,
  `magasinier_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `bons_livraison`
--

INSERT INTO `bons_livraison` (`id`, `numero`, `date_bl`, `vente_id`, `client_id`, `transport_assure_par`, `observations`, `signe_client`, `magasinier_id`) VALUES
(1, 'BL-20251118-123629', '2025-11-18', 2, 2, NULL, NULL, 1, 1),
(2, 'BL-20251118-123739', '2025-11-18', 1, 3, NULL, NULL, 0, 1),
(3, 'BL-20251118-140008', '2025-11-18', 3, 5, NULL, NULL, 0, 1),
(4, 'BL-20251118-151854', '2025-11-18', 4, 5, NULL, NULL, 0, 1),
(5, 'BL-20251120-122339', '2025-11-20', 16, 2, NULL, NULL, 0, 1),
(6, 'BL-20251121-112346', '2025-11-21', 17, 6, NULL, NULL, 1, 1);

-- --------------------------------------------------------

--
-- Table structure for table `bons_livraison_lignes`
--

CREATE TABLE `bons_livraison_lignes` (
  `id` int(10) UNSIGNED NOT NULL,
  `bon_livraison_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `quantite` int(11) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `bons_livraison_lignes`
--

INSERT INTO `bons_livraison_lignes` (`id`, `bon_livraison_id`, `produit_id`, `quantite`) VALUES
(1, 1, 4, 2),
(2, 2, 2, 1),
(3, 3, 3, 2),
(4, 4, 3, 2),
(5, 5, 4, 1),
(6, 6, 1, 4),
(7, 6, 4, 15);

-- --------------------------------------------------------

--
-- Table structure for table `canaux_vente`
--

CREATE TABLE `canaux_vente` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `libelle` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `canaux_vente`
--

INSERT INTO `canaux_vente` (`id`, `code`, `libelle`) VALUES
(1, 'SHOWROOM', 'Vente showroom'),
(2, 'TERRAIN', 'Vente terrain'),
(3, 'DIGITAL', 'Vente digital / en ligne'),
(4, 'HOTEL', 'Vente liÃ©e Ã  lâ€™â€™hÃ´tel'),
(5, 'FORMATION', 'Vente liÃ©e aux formations');

-- --------------------------------------------------------

--
-- Table structure for table `chambres`
--

CREATE TABLE `chambres` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `description` text DEFAULT NULL,
  `tarif_nuite` decimal(15,2) NOT NULL DEFAULT 0.00,
  `actif` tinyint(1) NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `chambres`
--

INSERT INTO `chambres` (`id`, `code`, `description`, `tarif_nuite`, `actif`) VALUES
(1, 'CH-101', 'Chambre standard lit double', 20000.00, 1),
(2, 'APP-201', 'Appartement meublÃ© 2 piÃ¨ces', 35000.00, 1);

-- --------------------------------------------------------

--
-- Table structure for table `clients`
--

CREATE TABLE `clients` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `type_client_id` int(10) UNSIGNED NOT NULL,
  `telephone` varchar(50) DEFAULT NULL,
  `email` varchar(150) DEFAULT NULL,
  `adresse` text DEFAULT NULL,
  `source` varchar(100) DEFAULT NULL,
  `statut` enum('PROSPECT','CLIENT','APPRENANT','HOTE') NOT NULL DEFAULT 'PROSPECT',
  `date_creation` datetime NOT NULL DEFAULT current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `clients`
--

INSERT INTO `clients` (`id`, `nom`, `type_client_id`, `telephone`, `email`, `adresse`, `source`, `statut`, `date_creation`) VALUES
(1, 'Client Showroom Test', 1, '+237650000001', 'client.showroom@test.local', 'Douala', 'Showroom', 'CLIENT', '2025-11-18 11:00:22'),
(2, 'Client Terrain Test', 2, '+237650000002', 'client.terrain@test.local', 'BonabÃ©ri', 'Terrain', 'PROSPECT', '2025-11-18 11:00:22'),
(3, 'Client Digital Test', 3, '+237650000003', 'client.digital@test.local', 'YaoundÃ©', 'Facebook', 'CLIENT', '2025-11-18 11:00:22'),
(4, 'Client HÃ´tel Test', 4, '+237650000004', 'client.hotel@test.local', 'Douala', 'RÃ©servation directe', 'HOTE', '2025-11-18 11:00:22'),
(5, 'Apprenant Formation', 5, '+237650000005', 'apprenant@test.local', 'Bafoussam', 'WhatsApp', 'APPRENANT', '2025-11-18 11:00:22'),
(6, 'romy', 5, '695657613', 'cm@kennemulti-services.com', NULL, 'facebook', 'PROSPECT', '2025-11-20 09:02:31');

-- --------------------------------------------------------

--
-- Table structure for table `connexions_utilisateur`
--

CREATE TABLE `connexions_utilisateur` (
  `id` int(10) UNSIGNED NOT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `date_connexion` datetime NOT NULL DEFAULT current_timestamp(),
  `adresse_ip` varchar(100) NOT NULL,
  `user_agent` varchar(255) NOT NULL,
  `succes` tinyint(1) NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `connexions_utilisateur`
--

INSERT INTO `connexions_utilisateur` (`id`, `utilisateur_id`, `date_connexion`, `adresse_ip`, `user_agent`, `succes`) VALUES
(1, 1, '2025-11-18 11:14:36', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(2, 1, '2025-11-18 11:30:13', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(3, 1, '2025-11-18 11:30:21', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(4, 1, '2025-11-18 11:47:19', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(5, 1, '2025-11-18 12:08:16', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(6, 1, '2025-11-18 14:28:18', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(7, 1, '2025-11-18 14:59:18', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(8, 1, '2025-11-18 15:16:01', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(9, 1, '2025-11-19 09:43:53', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(10, 1, '2025-11-19 10:07:11', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(11, 1, '2025-11-20 09:17:11', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(12, 1, '2025-11-20 11:07:05', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(13, 1, '2025-11-21 11:09:04', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(14, 1, '2025-11-21 13:10:29', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(15, 1, '2025-11-21 15:31:29', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(16, 1, '2025-11-26 14:35:12', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(17, 1, '2025-11-27 09:21:40', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 0),
(18, 1, '2025-11-27 09:21:50', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(19, 1, '2025-12-02 15:31:49', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(20, 1, '2025-12-02 15:44:39', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(21, 1, '2025-12-06 12:30:16', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36 Edg/143.0.0.0', 1),
(22, 1, '2025-12-09 10:45:31', '127.0.0.1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:145.0) Gecko/20100101 Firefox/145.0', 1),
(23, 1, '2025-12-09 15:56:24', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36 Edg/143.0.0.0', 0),
(24, 1, '2025-12-09 15:56:29', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36 Edg/143.0.0.0', 1);

-- --------------------------------------------------------

--
-- Table structure for table `devis`
--

CREATE TABLE `devis` (
  `id` int(10) UNSIGNED NOT NULL,
  `numero` varchar(50) NOT NULL,
  `date_devis` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `canal_vente_id` int(10) UNSIGNED NOT NULL,
  `statut` enum('EN_ATTENTE','ACCEPTE','REFUSE','ANNULE') NOT NULL DEFAULT 'EN_ATTENTE',
  `est_converti` tinyint(1) NOT NULL DEFAULT 0,
  `date_relance` date DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `montant_total_ht` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_total_ttc` decimal(15,2) NOT NULL DEFAULT 0.00,
  `remise_global` decimal(15,2) NOT NULL DEFAULT 0.00,
  `conditions` text DEFAULT NULL,
  `commentaires` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `devis`
--

INSERT INTO `devis` (`id`, `numero`, `date_devis`, `client_id`, `canal_vente_id`, `statut`, `est_converti`, `date_relance`, `utilisateur_id`, `montant_total_ht`, `montant_total_ttc`, `remise_global`, `conditions`, `commentaires`) VALUES
(1, 'DV-20251118-135909', '2025-11-18', 5, 3, 'ACCEPTE', 1, NULL, 1, 50000.00, 50000.00, 0.00, NULL, NULL),
(2, 'DV-20251120-105327', '2025-11-20', 2, 3, 'ACCEPTE', 1, NULL, 1, 38000.00, 38000.00, 0.00, NULL, NULL),
(3, 'DV-20251120-120352', '2025-11-20', 5, 3, 'ACCEPTE', 1, '2025-11-24', 1, 75995.00, 75995.00, 0.00, NULL, NULL),
(4, 'DV-20251120-122248', '2025-11-20', 2, 3, 'ACCEPTE', 1, NULL, 1, 38000.00, 38000.00, 0.00, NULL, NULL),
(5, 'DV-20251121-112258', '2025-11-21', 6, 1, 'ACCEPTE', 1, '2025-11-27', 1, 1290000.00, 1290000.00, 0.00, NULL, NULL);

-- --------------------------------------------------------

--
-- Table structure for table `devis_lignes`
--

CREATE TABLE `devis_lignes` (
  `id` int(10) UNSIGNED NOT NULL,
  `devis_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `quantite` int(11) NOT NULL,
  `prix_unitaire` decimal(15,2) NOT NULL,
  `remise` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_ligne_ht` decimal(15,2) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `devis_lignes`
--

INSERT INTO `devis_lignes` (`id`, `devis_id`, `produit_id`, `quantite`, `prix_unitaire`, `remise`, `montant_ligne_ht`) VALUES
(3, 1, 3, 2, 25000.00, 0.00, 50000.00),
(6, 2, 4, 1, 38000.00, 0.00, 38000.00),
(9, 3, 4, 1, 38000.00, 5.00, 37995.00),
(10, 3, 4, 1, 38000.00, 0.00, 38000.00),
(12, 4, 4, 1, 38000.00, 0.00, 38000.00),
(15, 5, 1, 4, 180000.00, 0.00, 720000.00),
(16, 5, 4, 15, 38000.00, 0.00, 570000.00);

-- --------------------------------------------------------

--
-- Table structure for table `familles_produits`
--

CREATE TABLE `familles_produits` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `familles_produits`
--

INSERT INTO `familles_produits` (`id`, `nom`) VALUES
(1, 'Meubles & amÃ©nagements intÃ©rieurs'),
(2, 'Accessoires & quincaillerie de menuiserie'),
(3, 'Machines & Ã©quipements de menuiserie'),
(4, 'Panneaux & matÃ©riaux dâ€™â€™agencement');

-- --------------------------------------------------------

--
-- Table structure for table `formations`
--

CREATE TABLE `formations` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `description` text NOT NULL,
  `tarif_total` decimal(15,2) NOT NULL DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `formations`
--

INSERT INTO `formations` (`id`, `nom`, `description`, `tarif_total`) VALUES
(1, 'Menuiserie moderne', 'Formation pratique en menuiserie et agencement', 150000.00),
(2, 'Agencement intÃ©rieur', 'Techniques dâ€™agencement et dÃ©coration intÃ©rieure', 180000.00);

-- --------------------------------------------------------

--
-- Table structure for table `fournisseurs`
--

CREATE TABLE `fournisseurs` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `contact` varchar(150) DEFAULT NULL,
  `telephone` varchar(50) DEFAULT NULL,
  `email` varchar(150) DEFAULT NULL,
  `adresse` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `fournisseurs`
--

INSERT INTO `fournisseurs` (`id`, `nom`, `contact`, `telephone`, `email`, `adresse`) VALUES
(1, 'Fournisseur GÃ©nÃ©ral KMS', 'Service commercial', '+237600000001', 'fournisseur@kms.local', 'Douala'),
(2, 'Import MatÃ©riaux Pro', 'Responsable achat', '+237600000002', 'imports@kms.local', 'Douala - Zone industrielle');

-- --------------------------------------------------------

--
-- Table structure for table `inscriptions_formation`
--

CREATE TABLE `inscriptions_formation` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_inscription` date NOT NULL,
  `apprenant_nom` varchar(150) NOT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `formation_id` int(10) UNSIGNED NOT NULL,
  `montant_paye` decimal(15,2) NOT NULL DEFAULT 0.00,
  `solde_du` decimal(15,2) NOT NULL DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `inscriptions_formation`
--

INSERT INTO `inscriptions_formation` (`id`, `date_inscription`, `apprenant_nom`, `client_id`, `formation_id`, `montant_paye`, `solde_du`) VALUES
(1, '2025-11-19', 'Martial', NULL, 2, 50000.00, 130000.00),
(2, '2025-11-19', 'Tendop', 3, 2, 150000.00, 30000.00),
(3, '2025-11-20', 'Nkolo', NULL, 1, 80000.00, 70000.00);

-- --------------------------------------------------------

--
-- Table structure for table `journal_caisse`
--

CREATE TABLE `journal_caisse` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_operation` date NOT NULL,
  `numero_piece` varchar(50) NOT NULL,
  `nature_operation` text NOT NULL,
  `sens` enum('RECETTE','DEPENSE') NOT NULL,
  `montant` decimal(15,2) NOT NULL,
  `mode_paiement_id` int(10) UNSIGNED NOT NULL,
  `vente_id` int(10) UNSIGNED DEFAULT NULL,
  `reservation_id` int(10) UNSIGNED DEFAULT NULL,
  `inscription_formation_id` int(10) UNSIGNED DEFAULT NULL,
  `responsable_encaissement_id` int(10) UNSIGNED NOT NULL,
  `observations` text DEFAULT NULL,
  `est_annule` tinyint(1) NOT NULL DEFAULT 0,
  `date_annulation` datetime DEFAULT NULL,
  `annule_par_id` int(10) UNSIGNED DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `journal_caisse`
--

INSERT INTO `journal_caisse` (`id`, `date_operation`, `numero_piece`, `nature_operation`, `sens`, `montant`, `mode_paiement_id`, `vente_id`, `reservation_id`, `inscription_formation_id`, `responsable_encaissement_id`, `observations`, `est_annule`, `date_annulation`, `annule_par_id`) VALUES
(1, '2025-11-18', 'RES-1', 'Encaissement rÃ©servation hÃ´tel', 'RECETTE', 35000.00, 4, NULL, 1, NULL, 1, '', 0, NULL, NULL),
(2, '2025-11-18', '011', 'rÃ¨glement fournissuer', 'RECETTE', 10000.00, 1, NULL, NULL, NULL, 1, NULL, 0, NULL, NULL),
(3, '2025-11-19', 'INSCR-1', 'Encaissement inscription formation', 'RECETTE', 50000.00, 3, NULL, NULL, 1, 1, NULL, 0, NULL, NULL),
(4, '2025-11-20', '5', 'rÃ¨glement fournissuer', 'RECETTE', 10000.00, 4, NULL, NULL, NULL, 1, NULL, 0, NULL, NULL),
(5, '2025-11-20', '', 'sorepco', 'RECETTE', 100000.00, 4, NULL, NULL, NULL, 1, 'recouvrement', 1, '2025-11-20 18:53:38', 1),
(6, '2025-11-20', '', 'versement mupeci', 'RECETTE', 1000000.00, 4, NULL, NULL, NULL, 1, 'recouvrement', 0, NULL, NULL),
(7, '2025-11-21', '', 'recouvrement sorepco', 'RECETTE', 150000.00, 4, NULL, NULL, NULL, 1, NULL, 0, NULL, NULL);

-- --------------------------------------------------------

--
-- Table structure for table `modes_paiement`
--

CREATE TABLE `modes_paiement` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `libelle` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `modes_paiement`
--

INSERT INTO `modes_paiement` (`id`, `code`, `libelle`) VALUES
(1, 'CASH', 'EspÃ¨ces'),
(2, 'VIREMENT', 'Virement bancaire'),
(3, 'MOBILE_MONEY', 'Mobile Money'),
(4, 'CHEQUE', 'ChÃ¨que');

-- --------------------------------------------------------

--
-- Table structure for table `mouvements_stock_backup_20251209_161710`
--

CREATE TABLE `mouvements_stock_backup_20251209_161710` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_mouvement` date NOT NULL,
  `type_mouvement` enum('ENTREE','SORTIE','CORRECTION') NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `quantite` int(11) NOT NULL,
  `source_module` varchar(50) DEFAULT NULL,
  `source_id` int(10) UNSIGNED DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED DEFAULT NULL,
  `commentaire` varchar(255) DEFAULT NULL,
  `date_creation` datetime NOT NULL DEFAULT current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `mouvements_stock_backup_20251209_161710`
--

INSERT INTO `mouvements_stock_backup_20251209_161710` (`id`, `date_mouvement`, `type_mouvement`, `produit_id`, `quantite`, `source_module`, `source_id`, `utilisateur_id`, `commentaire`, `date_creation`) VALUES
(1, '2025-11-21', 'ENTREE', 1, 22, 'ACHAT', 55222, NULL, NULL, '2025-11-21 12:50:59'),
(3, '2025-11-26', 'SORTIE', 3, 3, 'VENTE', 20, NULL, 'Sortie suite Ã  la vente V-20251126-170324', '2025-11-26 17:04:15'),
(4, '2025-11-26', 'ENTREE', 2, 25, 'ACHAT', 2, NULL, 'EntrÃ©e suite Ã  lâ€™achat AC-20251126-170544', '2025-11-26 17:05:44'),
(5, '2025-12-02', 'ENTREE', 3, 25, 'ACHAT', 3, NULL, 'EntrÃ©e suite Ã  lâ€™achat AC-20251202-154014', '2025-12-02 15:40:14');

-- --------------------------------------------------------

--
-- Table structure for table `permissions`
--

CREATE TABLE `permissions` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(100) NOT NULL,
  `description` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `permissions`
--

INSERT INTO `permissions` (`id`, `code`, `description`) VALUES
(1, 'PRODUITS_LIRE', 'Consulter le catalogue produits et les stocks'),
(2, 'PRODUITS_CREER', 'CrÃ©er de nouveaux produits'),
(3, 'PRODUITS_MODIFIER', 'Modifier les produits existants'),
(4, 'PRODUITS_SUPPRIMER', 'Supprimer des produits'),
(5, 'CLIENTS_LIRE', 'Consulter les clients / prospects'),
(6, 'CLIENTS_CREER', 'CrÃ©er ou modifier des clients'),
(7, 'DEVIS_LIRE', 'Lister et consulter les devis'),
(8, 'DEVIS_CREER', 'CrÃ©er des devis'),
(9, 'DEVIS_MODIFIER', 'Modifier le statut ou le contenu des devis'),
(10, 'VENTES_LIRE', 'Consulter les ventes et bons de livraison'),
(11, 'VENTES_CREER', 'CrÃ©er des ventes'),
(12, 'VENTES_VALIDER', 'Valider des ventes / livraisons'),
(13, 'CAISSE_LIRE', 'Consulter le journal de caisse'),
(14, 'CAISSE_ECRIRE', 'Enregistrer des opÃ©rations de caisse'),
(15, 'PROMOTIONS_GERER', 'CrÃ©er et gÃ©rer les promotions'),
(16, 'HOTEL_GERER', 'GÃ©rer les rÃ©servations hÃ´tel et upsell'),
(17, 'FORMATION_GERER', 'GÃ©rer les formations et inscriptions'),
(18, 'REPORTING_LIRE', 'AccÃ©der aux tableaux de bord et reporting'),
(19, 'SATISFACTION_GERER', 'GÃ©rer les enquÃªtes de satisfaction client'),
(20, 'ACHATS_GERER', 'GÃ©rer les achats et approvisionnements');

-- --------------------------------------------------------

--
-- Table structure for table `produits`
--

CREATE TABLE `produits` (
  `id` int(10) UNSIGNED NOT NULL,
  `code_produit` varchar(100) NOT NULL,
  `famille_id` int(10) UNSIGNED NOT NULL,
  `sous_categorie_id` int(10) UNSIGNED DEFAULT NULL,
  `designation` varchar(255) NOT NULL,
  `caracteristiques` text DEFAULT NULL,
  `description` text DEFAULT NULL,
  `fournisseur_id` int(10) UNSIGNED DEFAULT NULL,
  `localisation` varchar(150) DEFAULT NULL,
  `prix_achat` decimal(15,2) NOT NULL DEFAULT 0.00,
  `prix_vente` decimal(15,2) NOT NULL DEFAULT 0.00,
  `stock_actuel` int(11) NOT NULL DEFAULT 0,
  `seuil_alerte` int(11) NOT NULL DEFAULT 0,
  `image_path` varchar(255) DEFAULT NULL,
  `actif` tinyint(1) NOT NULL DEFAULT 1,
  `date_creation` datetime NOT NULL DEFAULT current_timestamp(),
  `date_modification` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `produits`
--

INSERT INTO `produits` (`id`, `code_produit`, `famille_id`, `sous_categorie_id`, `designation`, `caracteristiques`, `description`, `fournisseur_id`, `localisation`, `prix_achat`, `prix_vente`, `stock_actuel`, `seuil_alerte`, `image_path`, `actif`, `date_creation`, `date_modification`) VALUES
(1, 'MEU-CH-001', 1, 1, 'Lit 2 places avec chevets', 'Dimensions 160x200', 'Lit moderne pour chambre parentale', 1, 'Showroom Douala', 120000.00, 180000.00, 23, 2, '/assets/img/produits/MEU-CH-001.png', 1, '2025-11-18 11:00:22', '2025-12-02 15:58:23'),
(2, 'MEU-SAL-001', 1, 2, 'Salon 5 places', 'Structure bois, mousse haute densitÃ©', 'Salon complet 3+1+1', 1, 'Showroom Douala', 200000.00, 280000.00, 27, 1, NULL, 1, '2025-11-18 11:00:22', NULL),
(3, 'ACC-VIS-001', 2, 3, 'Lot de visserie menuiserie', 'Assortiment vis bois', 'Accessoires pour montage de meubles', 2, 'Magasin PK12', 15000.00, 25000.00, 68, 10, NULL, 1, '2025-11-18 11:00:22', NULL),
(4, 'PAN-MEL-001', 4, 5, 'Panneau mÃ©laminÃ© blanc 18mm', '2,75m x 1,83m', 'Panneau pour agencement intÃ©rieur', 2, 'Magasin PK12', 25000.00, 38000.00, 12, 5, NULL, 1, '2025-11-18 11:00:22', NULL),
(15, 'PAN-FOR-001', 2, 3, 'Panneau formica blanc 18mm', NULL, NULL, 2, 'Magasin PK12', 500.00, 2000.00, 10, 2, '/assets/img/produits/PAN-FOR-001.png', 1, '2025-12-06 12:32:22', NULL);

-- --------------------------------------------------------

--
-- Table structure for table `promotions`
--

CREATE TABLE `promotions` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `description` text DEFAULT NULL,
  `pourcentage_remise` decimal(5,2) DEFAULT NULL,
  `montant_remise` decimal(15,2) DEFAULT NULL,
  `date_debut` date NOT NULL,
  `date_fin` date NOT NULL,
  `actif` tinyint(1) NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `promotion_produit`
--

CREATE TABLE `promotion_produit` (
  `promotion_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `prospections_terrain`
--

CREATE TABLE `prospections_terrain` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_prospection` date NOT NULL,
  `prospect_nom` varchar(150) NOT NULL,
  `secteur` varchar(150) NOT NULL,
  `besoin_identifie` text NOT NULL,
  `action_menee` text NOT NULL,
  `resultat` text NOT NULL,
  `prochaine_etape` text DEFAULT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `commercial_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `prospects_formation`
--

CREATE TABLE `prospects_formation` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_prospect` date NOT NULL,
  `nom_prospect` varchar(150) NOT NULL,
  `contact` varchar(100) NOT NULL,
  `source` varchar(100) DEFAULT NULL,
  `statut_actuel` varchar(100) NOT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `prospects_formation`
--

INSERT INTO `prospects_formation` (`id`, `date_prospect`, `nom_prospect`, `contact`, `source`, `statut_actuel`, `client_id`, `utilisateur_id`) VALUES
(1, '2025-11-01', 'Anicet Mballa', '655585502', 'facebook', 'En cours', NULL, 1);

-- --------------------------------------------------------

--
-- Table structure for table `rendezvous_terrain`
--

CREATE TABLE `rendezvous_terrain` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_rdv` date NOT NULL,
  `heure_rdv` time NOT NULL,
  `client_prospect_nom` varchar(150) NOT NULL,
  `lieu` varchar(150) NOT NULL,
  `objectif` text NOT NULL,
  `statut` enum('PLANIFIE','CONFIRME','ANNULE','HONORE') NOT NULL DEFAULT 'PLANIFIE',
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `commercial_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `reservations_hotel`
--

CREATE TABLE `reservations_hotel` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_reservation` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `chambre_id` int(10) UNSIGNED NOT NULL,
  `date_debut` date NOT NULL,
  `date_fin` date NOT NULL,
  `nb_nuits` int(11) NOT NULL,
  `montant_total` decimal(15,2) NOT NULL DEFAULT 0.00,
  `statut` enum('EN_COURS','TERMINEE','ANNULEE') NOT NULL DEFAULT 'EN_COURS',
  `mode_paiement_id` int(10) UNSIGNED DEFAULT NULL,
  `concierge_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `reservations_hotel`
--

INSERT INTO `reservations_hotel` (`id`, `date_reservation`, `client_id`, `chambre_id`, `date_debut`, `date_fin`, `nb_nuits`, `montant_total`, `statut`, `mode_paiement_id`, `concierge_id`) VALUES
(1, '2025-11-18', 5, 2, '2025-11-18', '2025-11-18', 1, 35000.00, 'EN_COURS', 4, 1),
(2, '2025-11-18', 4, 2, '2025-11-18', '2025-11-20', 2, 70000.00, 'EN_COURS', NULL, 1);

-- --------------------------------------------------------

--
-- Table structure for table `retours_litiges`
--

CREATE TABLE `retours_litiges` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_retour` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `vente_id` int(10) UNSIGNED DEFAULT NULL,
  `motif` text NOT NULL,
  `responsable_suivi_id` int(10) UNSIGNED NOT NULL,
  `statut_traitement` enum('EN_COURS','RESOLU','ABANDONNE') NOT NULL DEFAULT 'EN_COURS',
  `solution` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `roles`
--

CREATE TABLE `roles` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `nom` varchar(100) NOT NULL,
  `description` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `roles`
--

INSERT INTO `roles` (`id`, `code`, `nom`, `description`) VALUES
(1, 'ADMIN', 'Administrateur', 'AccÃ¨s complet Ã  toute lâ€™â€™application'),
(2, 'SHOWROOM', 'Commercial Showroom', 'Gestion des visiteurs, devis et ventes en showroom'),
(3, 'TERRAIN', 'Commercial Terrain', 'Prospection terrain, devis et ventes terrain'),
(4, 'MAGASINIER', 'Magasinier', 'Gestion des stocks, livraisons, ruptures'),
(5, 'CAISSIER', 'Caissier', 'Journal de caisse et encaissements'),
(6, 'DIRECTION', 'Direction', 'Consultation des reportings et indicateurs globaux');

-- --------------------------------------------------------

--
-- Table structure for table `role_permission`
--

CREATE TABLE `role_permission` (
  `role_id` int(10) UNSIGNED NOT NULL,
  `permission_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `role_permission`
--

INSERT INTO `role_permission` (`role_id`, `permission_id`) VALUES
(1, 1),
(1, 2),
(1, 3),
(1, 4),
(1, 5),
(1, 6),
(1, 7),
(1, 8),
(1, 9),
(1, 10),
(1, 11),
(1, 12),
(1, 13),
(1, 14),
(1, 15),
(1, 16),
(1, 17),
(1, 18),
(1, 19),
(1, 20),
(2, 1),
(2, 5),
(2, 6),
(2, 7),
(2, 8),
(2, 9),
(2, 10),
(2, 11),
(2, 19),
(3, 1),
(3, 5),
(3, 6),
(3, 7),
(3, 8),
(3, 10),
(3, 11),
(3, 19),
(4, 1),
(4, 3),
(4, 10),
(5, 10),
(5, 13),
(5, 14),
(5, 18),
(6, 1),
(6, 5),
(6, 7),
(6, 10),
(6, 13),
(6, 16),
(6, 17),
(6, 18),
(6, 19);

-- --------------------------------------------------------

--
-- Table structure for table `ruptures_stock`
--

CREATE TABLE `ruptures_stock` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_rapport` date NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `seuil_alerte` int(11) NOT NULL,
  `stock_actuel` int(11) NOT NULL,
  `impact_commercial` text NOT NULL,
  `action_proposee` text NOT NULL,
  `magasinier_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `satisfaction_clients`
--

CREATE TABLE `satisfaction_clients` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_satisfaction` date NOT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `nom_client` varchar(150) NOT NULL,
  `service_utilise` enum('SHOWROOM','HOTEL','FORMATION','TERRAIN','DIGITAL') NOT NULL,
  `note` int(11) NOT NULL,
  `commentaire` text DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `satisfaction_clients`
--

INSERT INTO `satisfaction_clients` (`id`, `date_satisfaction`, `client_id`, `nom_client`, `service_utilise`, `note`, `commentaire`, `utilisateur_id`) VALUES
(1, '2025-11-19', NULL, 'apprenant', 'FORMATION', 4, '', 1),
(2, '2025-11-20', 4, 'Client HÃ´tel Test', 'FORMATION', 2, 'grincheux et deÃ§u', 1);

-- --------------------------------------------------------

--
-- Table structure for table `sous_categories_produits`
--

CREATE TABLE `sous_categories_produits` (
  `id` int(10) UNSIGNED NOT NULL,
  `famille_id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `sous_categories_produits`
--

INSERT INTO `sous_categories_produits` (`id`, `famille_id`, `nom`) VALUES
(1, 1, 'Chambres Ã  coucher'),
(2, 1, 'Salons'),
(3, 2, 'Quincaillerie standard'),
(4, 3, 'Machines de dÃ©coupe'),
(5, 4, 'Panneaux mÃ©laminÃ©s');

-- --------------------------------------------------------

--
-- Table structure for table `stocks_mouvements`
--

CREATE TABLE `stocks_mouvements` (
  `id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `date_mouvement` datetime NOT NULL DEFAULT current_timestamp(),
  `type_mouvement` enum('ENTREE','SORTIE','AJUSTEMENT') NOT NULL,
  `quantite` int(11) NOT NULL,
  `source_type` varchar(50) DEFAULT NULL,
  `source_id` int(11) DEFAULT NULL,
  `commentaire` text DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `stocks_mouvements`
--

INSERT INTO `stocks_mouvements` (`id`, `produit_id`, `date_mouvement`, `type_mouvement`, `quantite`, `source_type`, `source_id`, `commentaire`, `utilisateur_id`) VALUES
(1, 1, '2025-11-18 11:00:22', 'ENTREE', 5, 'INVENTAIRE', NULL, 'Stock initial lit 2 places', 1),
(2, 2, '2025-11-18 11:00:22', 'ENTREE', 3, 'INVENTAIRE', NULL, 'Stock initial salon', 1),
(3, 3, '2025-11-18 11:00:22', 'ENTREE', 50, 'INVENTAIRE', NULL, 'Stock initial visserie', 1),
(4, 4, '2025-11-18 11:00:22', 'ENTREE', 30, 'INVENTAIRE', NULL, 'Stock initial panneaux', 1),
(5, 4, '2025-11-18 12:36:29', 'SORTIE', 2, 'VENTE', 2, 'Sortie via BL BL-20251118-123629', 1),
(6, 2, '2025-11-18 12:37:39', 'SORTIE', 1, 'VENTE', 1, 'Sortie via BL BL-20251118-123739', 1),
(7, 3, '2025-11-18 14:00:08', 'SORTIE', 2, 'VENTE', 3, 'Sortie via BL BL-20251118-140008', 1),
(8, 3, '2025-11-18 15:18:54', 'SORTIE', 2, 'VENTE', 4, 'Sortie via BL BL-20251118-151854', 1),
(9, 4, '2025-11-20 12:23:39', 'SORTIE', 1, 'VENTE', 16, 'Sortie via BL BL-20251120-122339', 1),
(10, 1, '2025-11-21 11:23:46', 'SORTIE', 4, 'VENTE', 17, 'Sortie via BL BL-20251121-112346', 1),
(11, 4, '2025-11-21 11:23:46', 'SORTIE', 15, 'VENTE', 17, 'Sortie via BL BL-20251121-112346', 1),
(12, 1, '2025-12-06 12:30:51', 'ENTREE', 2, 'AJUSTEMENT', NULL, 'Ajustement manuel depuis fiche produit', 1),
(13, 1, '2025-12-06 12:31:08', 'SORTIE', 2, 'AJUSTEMENT', NULL, 'Ajustement manuel depuis fiche produit', 1),
(14, 15, '2025-12-06 12:32:22', 'ENTREE', 10, 'INVENTAIRE', NULL, 'Stock initial Ã  la crÃ©ation du produit', 1),
(15, 1, '2025-11-21 12:50:59', 'ENTREE', 22, 'ACHAT', 55222, NULL, 1),
(16, 3, '2025-11-26 17:04:15', 'SORTIE', 3, 'VENTE', 20, 'Sortie suite Ã  la vente V-20251126-170324', 1),
(17, 2, '2025-11-26 17:05:44', 'ENTREE', 25, 'ACHAT', 2, 'EntrÃ©e suite Ã  lâ€™achat AC-20251126-170544', 1),
(18, 3, '2025-12-02 15:40:14', 'ENTREE', 25, 'ACHAT', 3, 'EntrÃ©e suite Ã  lâ€™achat AC-20251202-154014', 1);

-- --------------------------------------------------------

--
-- Table structure for table `types_client`
--

CREATE TABLE `types_client` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `libelle` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `types_client`
--

INSERT INTO `types_client` (`id`, `code`, `libelle`) VALUES
(1, 'SHOWROOM', 'Client / prospect showroom'),
(2, 'TERRAIN', 'Client / prospect terrain'),
(3, 'DIGITAL', 'Client issu du digital (rÃ©seaux sociaux, site, CRM)'),
(4, 'HOTEL', 'Client hÃ©bergement / hÃ´tel'),
(5, 'FORMATION', 'Apprenant / client formation');

-- --------------------------------------------------------

--
-- Table structure for table `upsell_hotel`
--

CREATE TABLE `upsell_hotel` (
  `id` int(10) UNSIGNED NOT NULL,
  `reservation_id` int(10) UNSIGNED NOT NULL,
  `service_additionnel` varchar(150) NOT NULL,
  `montant` decimal(15,2) NOT NULL DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `utilisateurs`
--

CREATE TABLE `utilisateurs` (
  `id` int(10) UNSIGNED NOT NULL,
  `login` varchar(100) NOT NULL,
  `mot_de_passe_hash` varchar(255) NOT NULL,
  `nom_complet` varchar(150) NOT NULL,
  `email` varchar(150) DEFAULT NULL,
  `telephone` varchar(50) DEFAULT NULL,
  `actif` tinyint(1) NOT NULL DEFAULT 1,
  `date_creation` datetime NOT NULL DEFAULT current_timestamp(),
  `date_derniere_connexion` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `utilisateurs`
--

INSERT INTO `utilisateurs` (`id`, `login`, `mot_de_passe_hash`, `nom_complet`, `email`, `telephone`, `actif`, `date_creation`, `date_derniere_connexion`) VALUES
(1, 'admin', '$2b$10$j6YYUX.QLOxOoBn9eB4rJu8/ye4/NOEXPvRjcYhUY4mBiaZZFUrTi', 'Administrateur KMS', 'admin@kms.local', NULL, 1, '2025-11-18 10:59:28', '2025-12-09 15:56:29');

-- --------------------------------------------------------

--
-- Table structure for table `utilisateur_role`
--

CREATE TABLE `utilisateur_role` (
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `role_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `utilisateur_role`
--

INSERT INTO `utilisateur_role` (`utilisateur_id`, `role_id`) VALUES
(1, 1);

-- --------------------------------------------------------

--
-- Table structure for table `ventes`
--

CREATE TABLE `ventes` (
  `id` int(10) UNSIGNED NOT NULL,
  `numero` varchar(50) NOT NULL,
  `date_vente` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `canal_vente_id` int(10) UNSIGNED NOT NULL,
  `devis_id` int(10) UNSIGNED DEFAULT NULL,
  `statut` enum('EN_ATTENTE_LIVRAISON','LIVREE','ANNULEE','PARTIELLEMENT_LIVREE') NOT NULL DEFAULT 'EN_ATTENTE_LIVRAISON',
  `montant_total_ht` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_total_ttc` decimal(15,2) NOT NULL DEFAULT 0.00,
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `commentaires` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `ventes`
--

INSERT INTO `ventes` (`id`, `numero`, `date_vente`, `client_id`, `canal_vente_id`, `devis_id`, `statut`, `montant_total_ht`, `montant_total_ttc`, `utilisateur_id`, `commentaires`) VALUES
(1, 'V-20251118-114131', '2025-11-18', 3, 3, NULL, 'LIVREE', 200000.00, 238500.00, 1, NULL),
(2, 'V-20251118-122137', '2025-11-18', 2, 2, NULL, 'LIVREE', 1499994.00, 1788742.85, 1, NULL),
(3, 'V-20251118-135949', '2025-11-18', 5, 3, 1, 'LIVREE', 50000.00, 50000.00, 1, 'Vente issue du devis DV-20251118-135909'),
(4, 'V-20251118-151825', '2025-11-18', 5, 3, 1, 'LIVREE', 50000.00, 50000.00, 1, 'Vente issue du devis DV-20251118-135909'),
(5, 'V-20251118-155819', '2025-11-18', 5, 3, NULL, 'EN_ATTENTE_LIVRAISON', 50000.00, 59625.00, 1, NULL),
(6, 'V-20251120-105356', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(7, 'V-20251120-112512', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(8, 'V-20251120-112647', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(9, 'V-20251120-112839', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(10, 'V-20251120-112933', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(11, 'V-20251120-112955', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(12, 'V-20251120-113037', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(13, 'V-20251120-114844', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(14, 'V-20251120-115447', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(15, 'V-20251120-120452', '2025-11-20', 5, 3, 3, 'EN_ATTENTE_LIVRAISON', 75995.00, 75995.00, 1, 'Vente issue du devis DV-20251120-120352'),
(16, 'V-20251120-122303', '2025-11-20', 2, 3, 4, 'LIVREE', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-122248'),
(17, 'V-20251121-112325', '2025-11-21', 6, 1, 5, 'LIVREE', 1315000.00, 1568137.50, 1, 'Vente issue du devis DV-20251121-112258'),
(18, 'V-20251126-154658', '2025-11-26', 6, 1, NULL, 'EN_ATTENTE_LIVRAISON', 180000.00, 214650.00, 1, NULL),
(19, 'V-20251126-154749', '2025-11-26', 6, 1, NULL, 'LIVREE', 360000.00, 429300.00, 1, NULL),
(20, 'V-20251126-170324', '2025-11-26', 2, 4, NULL, 'LIVREE', 75000.00, 89437.50, 1, NULL);

-- --------------------------------------------------------

--
-- Table structure for table `ventes_lignes`
--

CREATE TABLE `ventes_lignes` (
  `id` int(10) UNSIGNED NOT NULL,
  `vente_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `quantite` int(11) NOT NULL,
  `prix_unitaire` decimal(15,2) NOT NULL,
  `remise` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_ligne_ht` decimal(15,2) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `ventes_lignes`
--

INSERT INTO `ventes_lignes` (`id`, `vente_id`, `produit_id`, `quantite`, `prix_unitaire`, `remise`, `montant_ligne_ht`) VALUES
(2, 1, 2, 1, 200000.00, 0.00, 200000.00),
(4, 2, 4, 2, 750000.00, 6.00, 1499994.00),
(5, 3, 3, 2, 25000.00, 0.00, 50000.00),
(6, 4, 3, 2, 25000.00, 0.00, 50000.00),
(7, 5, 3, 2, 25000.00, 0.00, 50000.00),
(8, 6, 4, 1, 38000.00, 0.00, 38000.00),
(9, 7, 4, 1, 38000.00, 0.00, 38000.00),
(10, 8, 4, 1, 38000.00, 0.00, 38000.00),
(11, 9, 4, 1, 38000.00, 0.00, 38000.00),
(12, 10, 4, 1, 38000.00, 0.00, 38000.00),
(13, 11, 4, 1, 38000.00, 0.00, 38000.00),
(14, 12, 4, 1, 38000.00, 0.00, 38000.00),
(15, 13, 4, 1, 38000.00, 0.00, 38000.00),
(16, 14, 4, 1, 38000.00, 0.00, 38000.00),
(17, 15, 4, 1, 38000.00, 5.00, 37995.00),
(18, 15, 4, 1, 38000.00, 0.00, 38000.00),
(19, 16, 4, 1, 38000.00, 0.00, 38000.00),
(25, 17, 1, 4, 180000.00, 0.00, 720000.00),
(26, 17, 4, 15, 38000.00, 0.00, 570000.00),
(27, 17, 3, 5, 5000.00, 0.00, 25000.00),
(28, 18, 1, 1, 180000.00, 0.00, 180000.00),
(31, 19, 1, 2, 180000.00, 0.00, 360000.00),
(33, 20, 3, 3, 25000.00, 0.00, 75000.00);

-- --------------------------------------------------------

--
-- Table structure for table `visiteurs_hotel`
--

CREATE TABLE `visiteurs_hotel` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_visite` date NOT NULL,
  `nom_visiteur` varchar(150) NOT NULL,
  `telephone` varchar(50) DEFAULT NULL,
  `email` varchar(150) DEFAULT NULL,
  `motif` text NOT NULL,
  `service_solicite` varchar(150) NOT NULL,
  `orientation` varchar(150) DEFAULT NULL,
  `concierge_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `visiteurs_showroom`
--

CREATE TABLE `visiteurs_showroom` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_visite` date NOT NULL,
  `client_nom` varchar(150) NOT NULL,
  `contact` varchar(100) NOT NULL,
  `produit_interet` text DEFAULT NULL,
  `orientation` varchar(100) DEFAULT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Indexes for dumped tables
--

--
-- Indexes for table `achats`
--
ALTER TABLE `achats`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_achats_utilisateur` (`utilisateur_id`);

--
-- Indexes for table `achats_lignes`
--
ALTER TABLE `achats_lignes`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_achats_lignes_achat` (`achat_id`),
  ADD KEY `fk_achats_lignes_produit` (`produit_id`);

--
-- Indexes for table `bons_livraison`
--
ALTER TABLE `bons_livraison`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `numero` (`numero`),
  ADD KEY `fk_bl_vente` (`vente_id`),
  ADD KEY `fk_bl_client` (`client_id`),
  ADD KEY `fk_bl_magasinier` (`magasinier_id`),
  ADD KEY `idx_bl_date` (`date_bl`);

--
-- Indexes for table `bons_livraison_lignes`
--
ALTER TABLE `bons_livraison_lignes`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_bl_lignes_bl` (`bon_livraison_id`),
  ADD KEY `fk_bl_lignes_produit` (`produit_id`);

--
-- Indexes for table `canaux_vente`
--
ALTER TABLE `canaux_vente`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `chambres`
--
ALTER TABLE `chambres`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `clients`
--
ALTER TABLE `clients`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_clients_type` (`type_client_id`),
  ADD KEY `idx_clients_nom` (`nom`);

--
-- Indexes for table `connexions_utilisateur`
--
ALTER TABLE `connexions_utilisateur`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_connexions_utilisateur_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_connexions_utilisateur_date` (`date_connexion`);

--
-- Indexes for table `devis`
--
ALTER TABLE `devis`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `numero` (`numero`),
  ADD KEY `fk_devis_client` (`client_id`),
  ADD KEY `fk_devis_canal` (`canal_vente_id`),
  ADD KEY `fk_devis_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_devis_date` (`date_devis`),
  ADD KEY `idx_devis_statut` (`statut`);

--
-- Indexes for table `devis_lignes`
--
ALTER TABLE `devis_lignes`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_devis_lignes_devis` (`devis_id`),
  ADD KEY `fk_devis_lignes_produit` (`produit_id`);

--
-- Indexes for table `familles_produits`
--
ALTER TABLE `familles_produits`
  ADD PRIMARY KEY (`id`);

--
-- Indexes for table `formations`
--
ALTER TABLE `formations`
  ADD PRIMARY KEY (`id`);

--
-- Indexes for table `fournisseurs`
--
ALTER TABLE `fournisseurs`
  ADD PRIMARY KEY (`id`);

--
-- Indexes for table `inscriptions_formation`
--
ALTER TABLE `inscriptions_formation`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_inscription_client` (`client_id`),
  ADD KEY `fk_inscription_formation` (`formation_id`),
  ADD KEY `idx_inscription_date` (`date_inscription`);

--
-- Indexes for table `journal_caisse`
--
ALTER TABLE `journal_caisse`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_caisse_mode_paiement` (`mode_paiement_id`),
  ADD KEY `fk_caisse_vente` (`vente_id`),
  ADD KEY `fk_caisse_reservation` (`reservation_id`),
  ADD KEY `fk_caisse_inscription` (`inscription_formation_id`),
  ADD KEY `fk_caisse_responsable` (`responsable_encaissement_id`),
  ADD KEY `idx_caisse_date` (`date_operation`),
  ADD KEY `fk_journal_caisse_annule_par` (`annule_par_id`);

--
-- Indexes for table `modes_paiement`
--
ALTER TABLE `modes_paiement`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `mouvements_stock_backup_20251209_161710`
--
ALTER TABLE `mouvements_stock_backup_20251209_161710`
  ADD PRIMARY KEY (`id`),
  ADD KEY `idx_mouvements_stock_produit` (`produit_id`),
  ADD KEY `idx_mouvements_stock_utilisateur` (`utilisateur_id`);

--
-- Indexes for table `permissions`
--
ALTER TABLE `permissions`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `produits`
--
ALTER TABLE `produits`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code_produit` (`code_produit`),
  ADD KEY `fk_produits_famille` (`famille_id`),
  ADD KEY `fk_produits_sous_categorie` (`sous_categorie_id`),
  ADD KEY `fk_produits_fournisseur` (`fournisseur_id`),
  ADD KEY `idx_produits_designation` (`designation`),
  ADD KEY `idx_produits_code` (`code_produit`);

--
-- Indexes for table `promotions`
--
ALTER TABLE `promotions`
  ADD PRIMARY KEY (`id`);

--
-- Indexes for table `promotion_produit`
--
ALTER TABLE `promotion_produit`
  ADD PRIMARY KEY (`promotion_id`,`produit_id`),
  ADD KEY `fk_promo_produit_produit` (`produit_id`);

--
-- Indexes for table `prospections_terrain`
--
ALTER TABLE `prospections_terrain`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_prospections_client` (`client_id`),
  ADD KEY `fk_prospections_commercial` (`commercial_id`),
  ADD KEY `idx_prospections_date` (`date_prospection`);

--
-- Indexes for table `prospects_formation`
--
ALTER TABLE `prospects_formation`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_prospect_formation_client` (`client_id`),
  ADD KEY `fk_prospect_formation_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_prospect_formation_date` (`date_prospect`);

--
-- Indexes for table `rendezvous_terrain`
--
ALTER TABLE `rendezvous_terrain`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_rdv_client` (`client_id`),
  ADD KEY `fk_rdv_commercial` (`commercial_id`),
  ADD KEY `idx_rdv_date` (`date_rdv`);

--
-- Indexes for table `reservations_hotel`
--
ALTER TABLE `reservations_hotel`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_reservation_client` (`client_id`),
  ADD KEY `fk_reservation_chambre` (`chambre_id`),
  ADD KEY `fk_reservation_mode_paiement` (`mode_paiement_id`),
  ADD KEY `fk_reservation_concierge` (`concierge_id`),
  ADD KEY `idx_reservation_dates` (`date_debut`,`date_fin`);

--
-- Indexes for table `retours_litiges`
--
ALTER TABLE `retours_litiges`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_litiges_client` (`client_id`),
  ADD KEY `fk_litiges_produit` (`produit_id`),
  ADD KEY `fk_litiges_vente` (`vente_id`),
  ADD KEY `fk_litiges_responsable` (`responsable_suivi_id`);

--
-- Indexes for table `roles`
--
ALTER TABLE `roles`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `role_permission`
--
ALTER TABLE `role_permission`
  ADD PRIMARY KEY (`role_id`,`permission_id`),
  ADD KEY `fk_role_permission_permission` (`permission_id`);

--
-- Indexes for table `ruptures_stock`
--
ALTER TABLE `ruptures_stock`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_ruptures_produit` (`produit_id`),
  ADD KEY `fk_ruptures_magasinier` (`magasinier_id`),
  ADD KEY `idx_ruptures_date` (`date_rapport`);

--
-- Indexes for table `satisfaction_clients`
--
ALTER TABLE `satisfaction_clients`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_satisfaction_client` (`client_id`),
  ADD KEY `fk_satisfaction_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_satisfaction_date` (`date_satisfaction`);

--
-- Indexes for table `sous_categories_produits`
--
ALTER TABLE `sous_categories_produits`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_sous_categories_famille` (`famille_id`);

--
-- Indexes for table `stocks_mouvements`
--
ALTER TABLE `stocks_mouvements`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_mouvements_produit` (`produit_id`),
  ADD KEY `fk_mouvements_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_mouvements_date` (`date_mouvement`);

--
-- Indexes for table `types_client`
--
ALTER TABLE `types_client`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `upsell_hotel`
--
ALTER TABLE `upsell_hotel`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_upsell_reservation` (`reservation_id`);

--
-- Indexes for table `utilisateurs`
--
ALTER TABLE `utilisateurs`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `login` (`login`);

--
-- Indexes for table `utilisateur_role`
--
ALTER TABLE `utilisateur_role`
  ADD PRIMARY KEY (`utilisateur_id`,`role_id`),
  ADD KEY `fk_utilisateur_role_role` (`role_id`);

--
-- Indexes for table `ventes`
--
ALTER TABLE `ventes`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `numero` (`numero`),
  ADD KEY `fk_ventes_client` (`client_id`),
  ADD KEY `fk_ventes_canal` (`canal_vente_id`),
  ADD KEY `fk_ventes_devis` (`devis_id`),
  ADD KEY `fk_ventes_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_ventes_date` (`date_vente`),
  ADD KEY `idx_ventes_statut` (`statut`);

--
-- Indexes for table `ventes_lignes`
--
ALTER TABLE `ventes_lignes`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_ventes_lignes_vente` (`vente_id`),
  ADD KEY `fk_ventes_lignes_produit` (`produit_id`);

--
-- Indexes for table `visiteurs_hotel`
--
ALTER TABLE `visiteurs_hotel`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_visiteurs_hotel_concierge` (`concierge_id`),
  ADD KEY `idx_visiteurs_hotel_date` (`date_visite`);

--
-- Indexes for table `visiteurs_showroom`
--
ALTER TABLE `visiteurs_showroom`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_visiteurs_client` (`client_id`),
  ADD KEY `fk_visiteurs_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_visiteurs_date` (`date_visite`);

--
-- AUTO_INCREMENT for dumped tables
--

--
-- AUTO_INCREMENT for table `achats`
--
ALTER TABLE `achats`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=4;

--
-- AUTO_INCREMENT for table `achats_lignes`
--
ALTER TABLE `achats_lignes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=10;

--
-- AUTO_INCREMENT for table `bons_livraison`
--
ALTER TABLE `bons_livraison`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=7;

--
-- AUTO_INCREMENT for table `bons_livraison_lignes`
--
ALTER TABLE `bons_livraison_lignes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=8;

--
-- AUTO_INCREMENT for table `canaux_vente`
--
ALTER TABLE `canaux_vente`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT for table `chambres`
--
ALTER TABLE `chambres`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT for table `clients`
--
ALTER TABLE `clients`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=7;

--
-- AUTO_INCREMENT for table `connexions_utilisateur`
--
ALTER TABLE `connexions_utilisateur`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=25;

--
-- AUTO_INCREMENT for table `devis`
--
ALTER TABLE `devis`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT for table `devis_lignes`
--
ALTER TABLE `devis_lignes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=17;

--
-- AUTO_INCREMENT for table `familles_produits`
--
ALTER TABLE `familles_produits`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=5;

--
-- AUTO_INCREMENT for table `formations`
--
ALTER TABLE `formations`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT for table `fournisseurs`
--
ALTER TABLE `fournisseurs`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT for table `inscriptions_formation`
--
ALTER TABLE `inscriptions_formation`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=4;

--
-- AUTO_INCREMENT for table `journal_caisse`
--
ALTER TABLE `journal_caisse`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=8;

--
-- AUTO_INCREMENT for table `modes_paiement`
--
ALTER TABLE `modes_paiement`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=5;

--
-- AUTO_INCREMENT for table `mouvements_stock_backup_20251209_161710`
--
ALTER TABLE `mouvements_stock_backup_20251209_161710`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT for table `permissions`
--
ALTER TABLE `permissions`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=21;

--
-- AUTO_INCREMENT for table `produits`
--
ALTER TABLE `produits`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=16;

--
-- AUTO_INCREMENT for table `promotions`
--
ALTER TABLE `promotions`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `prospections_terrain`
--
ALTER TABLE `prospections_terrain`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `prospects_formation`
--
ALTER TABLE `prospects_formation`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT for table `rendezvous_terrain`
--
ALTER TABLE `rendezvous_terrain`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `reservations_hotel`
--
ALTER TABLE `reservations_hotel`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT for table `retours_litiges`
--
ALTER TABLE `retours_litiges`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `roles`
--
ALTER TABLE `roles`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=7;

--
-- AUTO_INCREMENT for table `ruptures_stock`
--
ALTER TABLE `ruptures_stock`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `satisfaction_clients`
--
ALTER TABLE `satisfaction_clients`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT for table `sous_categories_produits`
--
ALTER TABLE `sous_categories_produits`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT for table `stocks_mouvements`
--
ALTER TABLE `stocks_mouvements`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=19;

--
-- AUTO_INCREMENT for table `types_client`
--
ALTER TABLE `types_client`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT for table `upsell_hotel`
--
ALTER TABLE `upsell_hotel`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `utilisateurs`
--
ALTER TABLE `utilisateurs`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT for table `ventes`
--
ALTER TABLE `ventes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=21;

--
-- AUTO_INCREMENT for table `ventes_lignes`
--
ALTER TABLE `ventes_lignes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=34;

--
-- AUTO_INCREMENT for table `visiteurs_hotel`
--
ALTER TABLE `visiteurs_hotel`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `visiteurs_showroom`
--
ALTER TABLE `visiteurs_showroom`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- Constraints for dumped tables
--

--
-- Constraints for table `achats`
--
ALTER TABLE `achats`
  ADD CONSTRAINT `fk_achats_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `achats_lignes`
--
ALTER TABLE `achats_lignes`
  ADD CONSTRAINT `fk_achats_lignes_achat` FOREIGN KEY (`achat_id`) REFERENCES `achats` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_achats_lignes_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `bons_livraison`
--
ALTER TABLE `bons_livraison`
  ADD CONSTRAINT `fk_bl_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_bl_magasinier` FOREIGN KEY (`magasinier_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_bl_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Constraints for table `bons_livraison_lignes`
--
ALTER TABLE `bons_livraison_lignes`
  ADD CONSTRAINT `fk_bl_lignes_bl` FOREIGN KEY (`bon_livraison_id`) REFERENCES `bons_livraison` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_bl_lignes_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `clients`
--
ALTER TABLE `clients`
  ADD CONSTRAINT `fk_clients_type` FOREIGN KEY (`type_client_id`) REFERENCES `types_client` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `connexions_utilisateur`
--
ALTER TABLE `connexions_utilisateur`
  ADD CONSTRAINT `fk_connexions_utilisateur_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `devis`
--
ALTER TABLE `devis`
  ADD CONSTRAINT `fk_devis_canal` FOREIGN KEY (`canal_vente_id`) REFERENCES `canaux_vente` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_devis_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_devis_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `devis_lignes`
--
ALTER TABLE `devis_lignes`
  ADD CONSTRAINT `fk_devis_lignes_devis` FOREIGN KEY (`devis_id`) REFERENCES `devis` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_devis_lignes_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `inscriptions_formation`
--
ALTER TABLE `inscriptions_formation`
  ADD CONSTRAINT `fk_inscription_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_inscription_formation` FOREIGN KEY (`formation_id`) REFERENCES `formations` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `journal_caisse`
--
ALTER TABLE `journal_caisse`
  ADD CONSTRAINT `fk_caisse_inscription` FOREIGN KEY (`inscription_formation_id`) REFERENCES `inscriptions_formation` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_mode_paiement` FOREIGN KEY (`mode_paiement_id`) REFERENCES `modes_paiement` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_reservation` FOREIGN KEY (`reservation_id`) REFERENCES `reservations_hotel` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_responsable` FOREIGN KEY (`responsable_encaissement_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_journal_caisse_annule_par` FOREIGN KEY (`annule_par_id`) REFERENCES `utilisateurs` (`id`) ON DELETE SET NULL;

--
-- Constraints for table `mouvements_stock_backup_20251209_161710`
--
ALTER TABLE `mouvements_stock_backup_20251209_161710`
  ADD CONSTRAINT `fk_mouvements_stock_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_mouvements_stock_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `produits`
--
ALTER TABLE `produits`
  ADD CONSTRAINT `fk_produits_famille` FOREIGN KEY (`famille_id`) REFERENCES `familles_produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_produits_fournisseur` FOREIGN KEY (`fournisseur_id`) REFERENCES `fournisseurs` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_produits_sous_categorie` FOREIGN KEY (`sous_categorie_id`) REFERENCES `sous_categories_produits` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Constraints for table `promotion_produit`
--
ALTER TABLE `promotion_produit`
  ADD CONSTRAINT `fk_promo_produit_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_promo_produit_promo` FOREIGN KEY (`promotion_id`) REFERENCES `promotions` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `prospections_terrain`
--
ALTER TABLE `prospections_terrain`
  ADD CONSTRAINT `fk_prospections_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_prospections_commercial` FOREIGN KEY (`commercial_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `prospects_formation`
--
ALTER TABLE `prospects_formation`
  ADD CONSTRAINT `fk_prospect_formation_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_prospect_formation_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `rendezvous_terrain`
--
ALTER TABLE `rendezvous_terrain`
  ADD CONSTRAINT `fk_rdv_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_rdv_commercial` FOREIGN KEY (`commercial_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `reservations_hotel`
--
ALTER TABLE `reservations_hotel`
  ADD CONSTRAINT `fk_reservation_chambre` FOREIGN KEY (`chambre_id`) REFERENCES `chambres` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_reservation_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_reservation_concierge` FOREIGN KEY (`concierge_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_reservation_mode_paiement` FOREIGN KEY (`mode_paiement_id`) REFERENCES `modes_paiement` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Constraints for table `retours_litiges`
--
ALTER TABLE `retours_litiges`
  ADD CONSTRAINT `fk_litiges_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_litiges_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_litiges_responsable` FOREIGN KEY (`responsable_suivi_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_litiges_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Constraints for table `role_permission`
--
ALTER TABLE `role_permission`
  ADD CONSTRAINT `fk_role_permission_permission` FOREIGN KEY (`permission_id`) REFERENCES `permissions` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_role_permission_role` FOREIGN KEY (`role_id`) REFERENCES `roles` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `ruptures_stock`
--
ALTER TABLE `ruptures_stock`
  ADD CONSTRAINT `fk_ruptures_magasinier` FOREIGN KEY (`magasinier_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ruptures_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `satisfaction_clients`
--
ALTER TABLE `satisfaction_clients`
  ADD CONSTRAINT `fk_satisfaction_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_satisfaction_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `sous_categories_produits`
--
ALTER TABLE `sous_categories_produits`
  ADD CONSTRAINT `fk_sous_categories_famille` FOREIGN KEY (`famille_id`) REFERENCES `familles_produits` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `stocks_mouvements`
--
ALTER TABLE `stocks_mouvements`
  ADD CONSTRAINT `fk_mouvements_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_mouvements_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `upsell_hotel`
--
ALTER TABLE `upsell_hotel`
  ADD CONSTRAINT `fk_upsell_reservation` FOREIGN KEY (`reservation_id`) REFERENCES `reservations_hotel` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `utilisateur_role`
--
ALTER TABLE `utilisateur_role`
  ADD CONSTRAINT `fk_utilisateur_role_role` FOREIGN KEY (`role_id`) REFERENCES `roles` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_utilisateur_role_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `ventes`
--
ALTER TABLE `ventes`
  ADD CONSTRAINT `fk_ventes_canal` FOREIGN KEY (`canal_vente_id`) REFERENCES `canaux_vente` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_devis` FOREIGN KEY (`devis_id`) REFERENCES `devis` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `ventes_lignes`
--
ALTER TABLE `ventes_lignes`
  ADD CONSTRAINT `fk_ventes_lignes_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_lignes_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `visiteurs_hotel`
--
ALTER TABLE `visiteurs_hotel`
  ADD CONSTRAINT `fk_visiteurs_hotel_concierge` FOREIGN KEY (`concierge_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `visiteurs_showroom`
--
ALTER TABLE `visiteurs_showroom`
  ADD CONSTRAINT `fk_visiteurs_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_visiteurs_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;
COMMIT;

/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;



===== FICHIER : login.php =====

<?php
// login.php
require_once __DIR__ . '/security.php';

// Calcule dynamiquement l'URL du dashboard (index.php) en tenant compte du rÃ©pertoire de l'app
$scriptPath   = $_SERVER['SCRIPT_NAME'];               // ex : /kms_app/login.php ou /login.php
$basePath     = rtrim(dirname($scriptPath), '/\\');    // ex : /kms_app ou /
$dashboardUrl = $basePath . '/index.php';              // ex : /kms_app/index.php ou /index.php

// Si dÃ©jÃ  connectÃ©, on renvoie au dashboard
if (utilisateurConnecte()) {
    header('Location: ' . $dashboardUrl);
    exit;
}

$erreur = null;

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $csrf = $_POST['csrf_token'] ?? '';
    verifierCsrf($csrf);

    $login       = trim($_POST['login'] ?? '');
    $motDePasse  = $_POST['mot_de_passe'] ?? '';

    if ($login === '' || $motDePasse === '') {
        $erreur = "Veuillez saisir votre identifiant et votre mot de passe.";
    } else {
        global $pdo;

        $stmt = $pdo->prepare("
            SELECT id, login, mot_de_passe_hash, actif
            FROM utilisateurs
            WHERE login = :login
            LIMIT 1
        ");
        $stmt->execute(['login' => $login]);
        $user = $stmt->fetch();

        if ($user && (int)$user['actif'] === 1) {
            $userId = (int)$user['id'];

            if (password_verify($motDePasse, $user['mot_de_passe_hash'])) {
                // Login OK
                // Mettre Ã  jour date_derniere_connexion
                $upd = $pdo->prepare("
                    UPDATE utilisateurs
                    SET date_derniere_connexion = NOW()
                    WHERE id = :id
                ");
                $upd->execute(['id' => $userId]);

                // Charger permissions
                chargerPermissionsUtilisateur($userId);

                // Journal connexion OK
                enregistrerConnexion($userId, 1);

                // Redirection dashboard
                header('Location: ' . $dashboardUrl);
                exit;
            } else {
                // Mot de passe incorrect
                enregistrerConnexion($userId, 0);
                $erreur = "Identifiants incorrects.";
            }
        } else {
            // Login inconnu ou utilisateur inactif
            // (pas de journal car on n'a pas d'ID valide dans la FK)
            $erreur = "Identifiants incorrects.";
        }
    }
}

$csrfToken = getCsrfToken();
?>
<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>Connexion â€“ KMS Back-office</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    >
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    >
    <link rel="stylesheet" href="/assets/css/custom.css">
    <style>
        body {
            min-height: 100vh;
            background: radial-gradient(circle at top left, #1f2933, #020617 60%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kms-login-card {
            max-width: 420px;
            width: 100%;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(15,23,42,0.45);
        }
        .kms-login-header {
            background: linear-gradient(135deg, #0f172a, #1d4ed8);
            color: #f9fafb;
        }
        .kms-login-logo {
            width: 52px;
            height: 52px;
            border-radius: 999px;
            background: rgba(15,23,42,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kms-login-logo img {
            max-height: 36px;
        }
        .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(37,99,235,0.35);
            border-color: #2563eb;
        }
    </style>
</head>
<body>

<div class="kms-login-card bg-white">
    <div class="kms-login-header p-4 d-flex gap-3 align-items-center">
        <div class="kms-login-logo">
            <img src="/assets/img/logo-kms.png" alt="KMS">
        </div>
        <div>
            <h1 class="h5 mb-1">Kenne Multi-Services</h1>
            <p class="mb-0 small text-light opacity-75">
                Back-office marketing & commercial
            </p>
        </div>
    </div>

    <div class="p-4">
        <?php if ($erreur): ?>
            <div class="alert alert-danger py-2 mb-3">
                <i class="bi bi-exclamation-circle me-1"></i>
                <?= htmlspecialchars($erreur) ?>
            </div>
        <?php else: ?>
            <p class="small text-muted mb-3">
                Connectez-vous pour accÃ©der au tableau de bord et aux modules internes KMS.
            </p>
        <?php endif; ?>

        <form method="post" novalidate>
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">

            <div class="mb-3">
                <label for="login" class="form-label small">Identifiant</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-person"></i>
                    </span>
                    <input
                        type="text"
                        class="form-control"
                        id="login"
                        name="login"
                        required
                        autocomplete="username"
                        value="<?= isset($login) ? htmlspecialchars($login) : '' ?>"
                    >
                </div>
            </div>

            <div class="mb-3">
                <label for="mot_de_passe" class="form-label small">Mot de passe</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-lock"></i>
                    </span>
                    <input
                        type="password"
                        class="form-control"
                        id="mot_de_passe"
                        name="mot_de_passe"
                        required
                        autocomplete="current-password"
                    >
                    <button type="button" class="btn btn-outline-secondary" id="togglePassword" tabindex="-1">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-2">
                <i class="bi bi-box-arrow-in-right me-1"></i>
                Se connecter
            </button>

            <p class="mt-3 mb-0 text-muted small">
                Premier accÃ¨s : utilisez <code>admin</code> / <code>admin123</code>,
                puis crÃ©ez de nouveaux utilisateurs dans lâ€™interface dâ€™administration.
            </p>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script>
    // Afficher / masquer le mot de passe
    const togglePasswordBtn = document.getElementById('togglePassword');
    const pwdInput = document.getElementById('mot_de_passe');

    if (togglePasswordBtn && pwdInput) {
        togglePasswordBtn.addEventListener('click', () => {
            const type = pwdInput.getAttribute('type') === 'password' ? 'text' : 'password';
            pwdInput.setAttribute('type', type);
            togglePasswordBtn.querySelector('i').classList.toggle('bi-eye');
            togglePasswordBtn.querySelector('i').classList.toggle('bi-eye-slash');
        });
    }
</script>
</body>
</html>



===== FICHIER : logout.php =====

<?php
// logout.php
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// On nettoie la session
$_SESSION = [];
session_unset();
session_destroy();

// Optionnel : supprimer cookie de session
if (ini_get("session.use_cookies")) {
    $params = session_get_cookie_params();
    setcookie(
        session_name(),
        '',
        time() - 42000,
        $params["path"],
        $params["domain"],
        $params["secure"],
        $params["httponly"]
    );
}

/**
 * Calcul dynamique de l'URL de login
 * Exemple en local :
 *  - DocumentRoot : C:/xampp/htdocs
 *  - App root FS  : C:/xampp/htdocs/kms_app
 *  => /kms_app/login.php
 */
$docRoot   = rtrim(str_replace('\\', '/', $_SERVER['DOCUMENT_ROOT']), '/');
$appRootFs = str_replace('\\', '/', __DIR__); // dossier racine de l'app

if (strpos($appRootFs, $docRoot) === 0) {
    $relative   = substr($appRootFs, strlen($docRoot)); // ex : '/kms_app' ou ''
    $appBaseUrl = rtrim($relative, '/');
} else {
    // fallback si jamais les chemins ne matchent pas
    $appBaseUrl = '';
}

$loginUrl = ($appBaseUrl !== '' ? $appBaseUrl : '') . '/login.php';

// Redirection vers la page de login
header('Location: ' . $loginUrl);
exit;



===== FICHIER : migrate_stock.php =====

<?php
// migrate_stock.php
// Attention : exÃ©cuter une fois depuis le serveur (via navigateur ou CLI)
// 1) Script qui migre les donnÃ©es de `mouvements_stock` vers `stocks_mouvements`
// 2) Met Ã  jour `produits.stock_actuel` Ã  partir de la somme des `stocks_mouvements`
// 3) Renomme (si souhaitÃ©) la table source en backup

require_once __DIR__ . '/db/db.php';

// Mode safe : run=1 pour exÃ©cuter la migration, sinon dry-run (preview)
$run = isset($_GET['run']) && $_GET['run'] == '1';

try {
    echo "<h2>MIGRATION mouvements_stock -> stocks_mouvements</h2>";

    // Check existence of tables
    $hasMouvementsStock = (bool)$pdo->query("SHOW TABLES LIKE 'mouvements_stock'")->fetch();
    $hasStocksMouvements = (bool)$pdo->query("SHOW TABLES LIKE 'stocks_mouvements'")->fetch();

    if (!$hasMouvementsStock) {
        echo "<p style='color:orange;'>Table <strong>mouvements_stock</strong> introuvable. Rien Ã  migrer.</p>";
        exit;
    }
    if (!$hasStocksMouvements) {
        throw new RuntimeException('Table stocks_mouvements introuvable. Migration annulÃ©e.');
    }

    // Fetch rows to migrate
    $stmt = $pdo->query("SELECT * FROM mouvements_stock ORDER BY id");
    $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);

    $count = count($rows);
    echo "<p>Enregistrements trouvÃ©s dans <em>mouvements_stock</em> : <strong>$count</strong></p>";

    if ($count === 0) {
        echo "<p>Aucun enregistrement Ã  migrer.</p>";
        exit;
    }

    // Show a small preview (first 10)
    echo "<h3>AperÃ§u (10 premiÃ¨res lignes)</h3>";
    echo "<table border=1 cellpadding=5><tr><th>id</th><th>date_mouvement</th><th>type</th><th>produit_id</th><th>quantite</th><th>source_module</th></tr>";
    $i = 0;
    foreach ($rows as $r) {
        if ($i++ >= 10) break;
        echo "<tr><td>{$r['id']}</td><td>{$r['date_mouvement']}</td><td>{$r['type_mouvement']}</td><td>{$r['produit_id']}</td><td>{$r['quantite']}</td><td>{$r['source_module']}</td></tr>";
    }
    echo "</table>";

    if (!$run) {
        echo "<p style='color:blue;'>Mode preview â€” la migration n'a pas Ã©tÃ© exÃ©cutÃ©e.<br>Si tu veux lancer la migration, ouvre : <code>?run=1</code> (ex : <a href=\"?run=1\">?run=1</a>).</p>";
        exit;
    }

    // Execution path
    $pdo->beginTransaction();

    $insert = $pdo->prepare(
        "INSERT INTO stocks_mouvements (
            produit_id, date_mouvement, type_mouvement, quantite, source_type, source_id, commentaire, utilisateur_id
        ) VALUES (
            :produit_id, :date_mouvement, :type_mouvement, :quantite, :source_type, :source_id, :commentaire, :utilisateur_id
        )"
    );

    $migrated = 0;
    foreach ($rows as $r) {
        $produit_id = (int)$r['produit_id'];
        $date_mouvement = $r['date_creation'] ?? ($r['date_mouvement'] . ' 00:00:00');
        $type = $r['type_mouvement'];
        if ($type === 'CORRECTION') $type = 'AJUSTEMENT';
        $quantite = (int)$r['quantite'];
        $source_type = $r['source_module'] ?? null;
        $source_id = $r['source_id'] ?? null;
        $commentaire = $r['commentaire'] ?? null;
        $utilisateur_id = $r['utilisateur_id'] ? (int)$r['utilisateur_id'] : 1;

        $insert->execute([
            ':produit_id' => $produit_id,
            ':date_mouvement' => $date_mouvement,
            ':type_mouvement' => $type,
            ':quantite' => $quantite,
            ':source_type' => $source_type,
            ':source_id' => $source_id,
            ':commentaire' => $commentaire,
            ':utilisateur_id' => $utilisateur_id,
        ]);
        $migrated++;
    }

    echo "<p>ImportÃ©s <strong>$migrated</strong> enregistrements.</p>";

    // Recalculate produits.stock_actuel
    $updateStmt = $pdo->prepare(
        "UPDATE produits p
         LEFT JOIN (
            SELECT produit_id, COALESCE(SUM(
                CASE
                    WHEN type_mouvement = 'ENTREE' THEN quantite
                    WHEN type_mouvement = 'SORTIE' THEN -quantite
                    WHEN type_mouvement = 'AJUSTEMENT' THEN quantite
                    ELSE 0
                END
            ),0) AS qte
            FROM stocks_mouvements
            GROUP BY produit_id
         ) s ON p.id = s.produit_id
         SET p.stock_actuel = COALESCE(s.qte, 0)
    "
    );
    $updateStmt->execute();
    $rowsUpdated = $updateStmt->rowCount();
    echo "<p>Mise Ã  jour de <strong>$rowsUpdated</strong> lignes dans <em>produits</em>.</p>";

    // Rename backup
    $backupName = 'mouvements_stock_backup_' . date('Ymd_His');
    $pdo->exec("RENAME TABLE mouvements_stock TO `$backupName`");
    echo "<p>Table renommÃ©e en <strong>$backupName</strong>.</p>";

    $pdo->commit();
    echo "<p style='color:green;'><strong>Migration exÃ©cutÃ©e avec succÃ¨s.</strong></p>";

} catch (Throwable $e) {
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }
    echo "<p style='color:red;'><strong>Erreur :</strong> " . htmlspecialchars($e->getMessage()) . "</p>";
    echo "<pre>" . htmlspecialchars($e->getTraceAsString()) . "</pre>";
}

echo "<p>Supprime ou protÃ¨ge ce script aprÃ¨s usage.</p>";
?>


===== FICHIER : recalc_all_stock.php =====

<?php
// recalc_all_stock.php
// Recalcule produits.stock_actuel Ã  partir de stocks_mouvements
require_once __DIR__ . '/db/db.php';

echo "<h2>Recalcule global : produits.stock_actuel depuis stocks_mouvements</h2>";

try {
    $pdo->beginTransaction();

    // RÃ©cupÃ©rer toutes les quantitÃ©s calculÃ©es depuis stocks_mouvements
    $sql = "
        SELECT produit_id, COALESCE(SUM(
            CASE
                WHEN type_mouvement = 'ENTREE' THEN quantite
                WHEN type_mouvement = 'SORTIE' THEN -quantite
                WHEN type_mouvement = 'AJUSTEMENT' THEN quantite
                ELSE 0
            END
        ),0) AS qte
        FROM stocks_mouvements
        GROUP BY produit_id
    ";
    $stmt = $pdo->query($sql);
    $calc = [];
    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
        $calc[(int)$row['produit_id']] = (int)$row['qte'];
    }

    // RÃ©cupÃ©rer tous les produits
    $stmt = $pdo->query("SELECT id, code_produit, stock_actuel FROM produits ORDER BY id");
    $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);

    $updated = 0;
    $diffs = [];
    foreach ($rows as $p) {
        $id = (int)$p['id'];
        $old = (int)$p['stock_actuel'];
        $new = $calc[$id] ?? 0;
        if ($old !== $new) {
            $u = $pdo->prepare("UPDATE produits SET stock_actuel = :stock WHERE id = :id");
            $u->execute(['stock' => $new, 'id' => $id]);
            $updated++;
            $diffs[] = [
                'id' => $id,
                'code' => $p['code_produit'],
                'old' => $old,
                'new' => $new,
            ];
        }
    }

    $pdo->commit();

    echo "<p>Mise Ã  jour effectuÃ©e : <strong>$updated</strong> produits modifiÃ©s.</p>";

    if ($updated > 0) {
        echo "<h3>DÃ©tails des changements</h3>";
        echo "<table border=1 cellpadding=6><tr><th>ID</th><th>Code</th><th>Ancien</th><th>Nouveau</th></tr>";
        foreach ($diffs as $d) {
            echo "<tr><td>{$d['id']}</td><td>" . htmlspecialchars($d['code']) . "</td><td>{$d['old']}</td><td>{$d['new']}</td></tr>";
        }
        echo "</table>";
    } else {
        echo "<p>Aucune diffÃ©rence dÃ©tectÃ©e â€” tout est dÃ©jÃ  cohÃ©rent.</p>";
    }

} catch (Throwable $e) {
    if ($pdo->inTransaction()) $pdo->rollBack();
    echo "<p style='color:red;'>Erreur : " . htmlspecialchars($e->getMessage()) . "</p>";
}

echo "<p>AprÃ¨s vÃ©rification, supprime ou protÃ¨ge ce script.</p>";
?>


===== FICHIER : security.php =====

<?php
// security.php

// 1. Session
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// 2. Chemin racine de l'application (adapter si tu changes le dossier)
if (!defined('BASE_PATH')) {
    // Ton projet est dans http://localhost/kms_app/
    define('BASE_PATH', '/kms_app');
}

/**
 * GÃ©nÃ¨re une URL interne correcte
 * Ex : url_for('produits/list.php') â†’ /kms_app/produits/list.php
 */
function url_for(string $path): string
{
    $path = ltrim($path, '/');
    return BASE_PATH . '/' . $path;
}

// 3. Connexion PDO
require_once __DIR__ . '/db/db.php';

/**
 * Retourne l'utilisateur connectÃ© ou null.
 */
function utilisateurConnecte(): ?array
{
    return $_SESSION['utilisateur'] ?? null;
}

/**
 * Exige qu'un utilisateur soit connectÃ©, sinon redirige vers login.
 */
function exigerConnexion(): void
{
    if (!utilisateurConnecte()) {
        header('Location: ' . url_for('login.php'));
        exit;
    }
}

/**
 * Exige une permission.
 */
function exigerPermission(string $codePermission): void
{
    exigerConnexion();

    $permissions = $_SESSION['permissions'] ?? [];
    if (!in_array($codePermission, $permissions, true)) {
        http_response_code(403);
        echo "AccÃ¨s refusÃ©.";
        exit;
    }
}

/**
 * CSRF : gÃ©nÃ©ration token.
 */
function getCsrfToken(): string
{
    if (empty($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }
    return $_SESSION['csrf_token'];
}

/**
 * CSRF : vÃ©rification token.
 */
function verifierCsrf(string $tokenFormulaire): void
{
    $tokenSession = $_SESSION['csrf_token'] ?? '';
    if (!$tokenSession || !hash_equals($tokenSession, $tokenFormulaire)) {
        http_response_code(400);
        echo "RequÃªte invalide (CSRF).";
        exit;
    }
}

/**
 * Charge les infos & permissions en session aprÃ¨s login.
 */
function chargerPermissionsUtilisateur(int $utilisateurId): void
{
    global $pdo;

    // Utilisateur
    $stmt = $pdo->prepare("
        SELECT id, login, nom_complet, email
        FROM utilisateurs
        WHERE id = :id AND actif = 1
    ");
    $stmt->execute(['id' => $utilisateurId]);
    $utilisateur = $stmt->fetch();

    if (!$utilisateur) {
        $_SESSION['utilisateur'] = null;
        $_SESSION['permissions'] = [];
        return;
    }

    // Permissions
    $sql = "
        SELECT DISTINCT p.code
        FROM permissions p
        JOIN role_permission rp ON rp.permission_id = p.id
        JOIN utilisateur_role ur ON ur.role_id = rp.role_id
        WHERE ur.utilisateur_id = :uid
    ";
    $stmt = $pdo->prepare($sql);
    $stmt->execute(['uid' => $utilisateurId]);
    $permissions = array_column($stmt->fetchAll(), 'code');

    $_SESSION['utilisateur'] = $utilisateur;
    $_SESSION['permissions'] = $permissions;
}

/**
 * IP client pour le journal de connexions.
 */
function getClientIp(): string
{
    $keys = [
        'HTTP_CLIENT_IP',
        'HTTP_X_FORWARDED_FOR',
        'REMOTE_ADDR'
    ];

    foreach ($keys as $key) {
        if (!empty($_SERVER[$key])) {
            $ipList = explode(',', $_SERVER[$key]);
            return trim($ipList[0]);
        }
    }

    return 'UNKNOWN';
}

/**
 * Enregistre une ligne dans connexions_utilisateur.
 */
function enregistrerConnexion(int $utilisateurId, int $succes): void
{
    global $pdo;

    $stmt = $pdo->prepare("
        INSERT INTO connexions_utilisateur (utilisateur_id, date_connexion, adresse_ip, user_agent, succes)
        VALUES (:uid, NOW(), :ip, :ua, :succes)
    ");

    $stmt->execute([
        'uid'    => $utilisateurId,
        'ip'     => getClientIp(),
        'ua'     => substr($_SERVER['HTTP_USER_AGENT'] ?? 'UNKNOWN', 0, 255),
        'succes' => $succes ? 1 : 0,
    ]);
}



===== FICHIER : test_export_csv.php =====

<?php
session_start();
$_SESSION['user_id'] = 1;

require_once __DIR__ . '/db/db.php';

// Test: vÃ©rifier que la table journal_caisse existe
try {
    $stmt = $pdo->query('SELECT COUNT(*) FROM journal_caisse LIMIT 1');
    $count = $stmt->fetchColumn();
    echo "âœ“ Journal caisse table found with: $count rows\n";
    
    // Afficher les colonnes de la table
    $stmt = $pdo->query('DESCRIBE journal_caisse');
    $columns = $stmt->fetchAll(PDO::FETCH_ASSOC);
    echo "\nTable columns:\n";
    foreach ($columns as $col) {
        echo "  - {$col['Field']} ({$col['Type']})\n";
    }
} catch (Exception $e) {
    echo "âœ— Error: " . $e->getMessage() . "\n";
}
?>



===== FICHIER : achats\edit.php =====

<?php
// achats/edit.php
require_once __DIR__ . '/../security.php';
require_once __DIR__ . '/../lib/stock.php';
require_once __DIR__ . '/../lib/caisse.php';

exigerConnexion();
exigerPermission('ACHATS_GERER');

global $pdo;

$id     = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$isEdit = $id > 0;

// Produits (pour les lignes)
$stmt = $pdo->query("
    SELECT id, code_produit, designation
    FROM produits
    WHERE actif = 1
    ORDER BY designation
");
$produits = $stmt->fetchAll();
$produitsById = [];
foreach ($produits as $p) {
    $produitsById[(int)$p['id']] = $p;
}

// Valeurs par dÃ©faut
$data = [
    'numero'              => '',
    'date_achat'          => date('Y-m-d'),
    'fournisseur_nom'     => '',
    'fournisseur_contact' => '',
    'statut'              => 'EN_COURS',
    'commentaires'        => '',
];

$lignes = [];
$montant_total_ht  = 0.0;
$montant_total_ttc = 0.0;

if ($isEdit && $_SERVER['REQUEST_METHOD'] === 'GET') {
    // Chargement de l'achat
    $stmt = $pdo->prepare("SELECT * FROM achats WHERE id = :id");
    $stmt->execute(['id' => $id]);
    $achat = $stmt->fetch();

    if (!$achat) {
        $_SESSION['flash_error'] = "Achat introuvable.";
        header('Location: ' . url_for('achats/list.php'));
        exit;
    }

    $data = [
        'numero'              => $achat['numero'],
        'date_achat'          => $achat['date_achat'],
        'fournisseur_nom'     => $achat['fournisseur_nom'] ?? '',
        'fournisseur_contact' => $achat['fournisseur_contact'] ?? '',
        'statut'              => $achat['statut'],
        'commentaires'        => $achat['commentaires'] ?? '',
    ];
    $montant_total_ht  = (float)$achat['montant_total_ht'];
    $montant_total_ttc = (float)$achat['montant_total_ttc'];

    // Lignes d'achat
    $stmt = $pdo->prepare("
        SELECT al.*, p.code_produit, p.designation
        FROM achats_lignes al
        JOIN produits p ON p.id = al.produit_id
        WHERE al.achat_id = :id
        ORDER BY al.id
    ");
    $stmt->execute(['id' => $id]);
    $lignes = $stmt->fetchAll();
} elseif (!$isEdit) {
    // Au moins une ligne vide par dÃ©faut
    $lignes = [
        ['produit_id' => '', 'quantite' => '', 'prix_unitaire' => '', 'remise' => '', 'montant_ligne_ht' => ''],
    ];
}

$errors = [];

// POST : crÃ©ation / mise Ã  jour
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $id     = (int)($_POST['id'] ?? 0);
    $isEdit = $id > 0;

    $data['numero']              = trim($_POST['numero'] ?? '');
    $data['date_achat']          = $_POST['date_achat'] ?? date('Y-m-d');
    $data['fournisseur_nom']     = trim($_POST['fournisseur_nom'] ?? '');
    $data['fournisseur_contact'] = trim($_POST['fournisseur_contact'] ?? '');
    $data['statut']              = $_POST['statut'] ?? 'EN_COURS';
    $data['commentaires']        = trim($_POST['commentaires'] ?? '');

    // Lignes
    $produitIds = $_POST['produit_id'] ?? [];
    $qtes       = $_POST['quantite'] ?? [];
    $prixUnit   = $_POST['prix_unitaire'] ?? [];
    $remises    = $_POST['remise'] ?? [];

    $lignes = [];
    $montant_total_ht = 0.0;

    foreach ($produitIds as $idx => $prodIdRaw) {
        $prodId = (int)$prodIdRaw;
        $q      = (float)str_replace(',', '.', $qtes[$idx] ?? '0');
        $pu     = (float)str_replace(',', '.', $prixUnit[$idx] ?? '0');
        $rem    = (float)str_replace(',', '.', $remises[$idx] ?? '0');

        if ($prodId <= 0 || $q <= 0 || $pu <= 0) {
            continue;
        }

        $montantBrut = $pu * $q;
        $montantLigneHT = max(0, $montantBrut - $rem);

        $lignes[] = [
            'produit_id'       => $prodId,
            'quantite'         => $q,
            'prix_unitaire'    => $pu,
            'remise'           => $rem,
            'montant_ligne_ht' => $montantLigneHT,
        ];

        $montant_total_ht += $montantLigneHT;
    }

    // Validations
    if ($data['date_achat'] === '') {
        $errors[] = "La date d'achat est obligatoire.";
    }
    if ($data['fournisseur_nom'] === '') {
        $errors[] = "Le nom du fournisseur est obligatoire.";
    }
    if (!in_array($data['statut'], ['EN_COURS','VALIDE','ANNULE'], true)) {
        $errors[] = "Statut d'achat invalide.";
    }
    if (empty($lignes)) {
        $errors[] = "L'achat doit contenir au moins une ligne produit.";
    }

    // Ici on suppose pas de TVA dÃ©taillÃ©e : HT = TTC pour simplifier
    $montant_total_ttc = $montant_total_ht;

    if (empty($errors)) {
        try {
            $pdo->beginTransaction();
            $utilisateur = utilisateurConnecte();
            $userId = (int)($utilisateur['id'] ?? 0);

            if ($data['numero'] === '') {
                $data['numero'] = 'AC-' . date('Ymd-His');
            }

            if ($isEdit) {
                // UPDATE entÃªte achat
                $stmt = $pdo->prepare("
                UPDATE achats
                SET numero = :numero,
                    date_achat = :date_achat,
                    fournisseur_nom = :fournisseur_nom,
                    fournisseur_contact = :fournisseur_contact,
                    montant_total_ht = :mtht,
                    montant_total_ttc = :mtttc,
                    statut = :statut,
                    utilisateur_id = :utilisateur_id,
                    commentaires = :commentaires
                WHERE id = :id
            ");
            $stmt->execute([
                'numero'              => $data['numero'],
                'date_achat'          => $data['date_achat'],
                'fournisseur_nom'     => $data['fournisseur_nom'] ?: null,
                'fournisseur_contact' => $data['fournisseur_contact'] ?: null,
                'mtht'                => $montant_total_ht,
                'mtttc'               => $montant_total_ttc,
                'statut'              => $data['statut'],
                'utilisateur_id'      => $userId ?: null,
                'commentaires'        => $data['commentaires'] ?: null,
                'id'                  => $id,
            ]);

            // Supprimer les anciennes lignes
            $stmt = $pdo->prepare("DELETE FROM achats_lignes WHERE achat_id = :id");
            $stmt->execute(['id' => $id]);

            $achatId = $id;

            } else {
                // INSERT entÃªte achat
                $stmt = $pdo->prepare("
                INSERT INTO achats (
                    numero, date_achat, fournisseur_nom, fournisseur_contact,
                    montant_total_ht, montant_total_ttc, statut, utilisateur_id, commentaires
                ) VALUES (
                    :numero, :date_achat, :fournisseur_nom, :fournisseur_contact,
                    :mtht, :mtttc, :statut, :utilisateur_id, :commentaires
                )
            ");
                $stmt->execute([
                    'numero'              => $data['numero'],
                    'date_achat'          => $data['date_achat'],
                    'fournisseur_nom'     => $data['fournisseur_nom'] ?: null,
                    'fournisseur_contact' => $data['fournisseur_contact'] ?: null,
                    'mtht'                => $montant_total_ht,
                    'mtttc'               => $montant_total_ttc,
                    'statut'              => $data['statut'],
                    'utilisateur_id'      => $userId ?: null,
                    'commentaires'        => $data['commentaires'] ?: null,
                ]);

                $achatId = (int)$pdo->lastInsertId();
            }

            // INSERT lignes
                $stmtL = $pdo->prepare("
                INSERT INTO achats_lignes (
                    achat_id, produit_id, quantite,
                    prix_unitaire, remise, montant_ligne_ht
                ) VALUES (
                    :achat_id, :produit_id, :quantite,
                    :prix_unitaire, :remise, :montant_ligne_ht
                )
            ");
            foreach ($lignes as $lg) {
                $stmtL->execute([
                    'achat_id'         => $achatId,
                    'produit_id'       => $lg['produit_id'],
                    'quantite'         => $lg['quantite'],
                    'prix_unitaire'    => $lg['prix_unitaire'],
                    'remise'           => $lg['remise'],
                    'montant_ligne_ht' => $lg['montant_ligne_ht'],
                ]);
            }

            // ðŸ”— Synchronisation stock (entrÃ©es liÃ©es Ã  cet achat)
            stock_synchroniser_achat($pdo, $achatId);

            // Enregistrer Ã©criture en caisse (sortie de trÃ©sorerie pour achat)
            // Sens = 'SORTIE' car c'est un paiement / dÃ©pense
            try {
                caisse_enregistrer_ecriture(
                    $pdo,
                    'SORTIE',
                    (float)$montant_total_ttc,
                    'ACHAT',
                    $achatId,
                    'Achat ' . $data['numero'],
                    $userId ?: null
                );
            } catch (Throwable $e) {
                // Ne pas bloquer l'enregistrement d'achat si l'Ã©criture caisse Ã©choue,
                // mais loguer l'erreur si nÃ©cessaire.
            }

            $pdo->commit();

            $_SESSION['flash_success'] = $isEdit
                ? "Achat mis Ã  jour avec succÃ¨s."
                : "Achat crÃ©Ã© avec succÃ¨s.";

            header('Location: ' . url_for('achats/list.php'));
            exit;
        } catch (Throwable $e) {
            if ($pdo->inTransaction()) $pdo->rollBack();
            $errors[] = "Erreur lors de l'enregistrement de l'achat : " . $e->getMessage();
        }
    }
}

$csrfToken = getCsrfToken();

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $isEdit ? 'Modifier un achat' : 'Nouvel achat / approvisionnement' ?>
        </h1>
        <a href="<?= url_for('achats/list.php') ?>" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
        </a>
    </div>

    <?php if (!empty($errors)): ?>
        <div class="alert alert-danger">
            <h2 class="h6 mb-2"><i class="bi bi-exclamation-triangle me-1"></i> Erreurs</h2>
            <ul class="mb-0">
                <?php foreach ($errors as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <form method="post" class="card">
        <div class="card-body">
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">
            <input type="hidden" name="id" value="<?= (int)$id ?>">

            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <label class="form-label small">NÂ° achat</label>
                    <input type="text" name="numero" class="form-control"
                           value="<?= htmlspecialchars($data['numero']) ?>"
                           placeholder="Auto si vide (AC-YYYYMMJJ-HHMMSS)">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Date d'achat *</label>
                    <input type="date" name="date_achat" class="form-control"
                           value="<?= htmlspecialchars($data['date_achat']) ?>" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Statut *</label>
                    <select name="statut" class="form-select" required>
                        <?php foreach (['EN_COURS','VALIDE','ANNULE'] as $s): ?>
                            <option value="<?= $s ?>" <?= $data['statut'] === $s ? 'selected' : '' ?>>
                                <?= $s ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label small">Fournisseur *</label>
                    <input type="text" name="fournisseur_nom" class="form-control" required
                           value="<?= htmlspecialchars($data['fournisseur_nom']) ?>">
                </div>
                <div class="col-md-6">
                    <label class="form-label small">Contact fournisseur</label>
                    <input type="text" name="fournisseur_contact" class="form-control"
                           value="<?= htmlspecialchars($data['fournisseur_contact']) ?>">
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label small">Commentaires (facultatif)</label>
                <textarea name="commentaires" class="form-control" rows="2"><?= htmlspecialchars($data['commentaires']) ?></textarea>
            </div>

            <hr>

            <h2 class="h6 mb-2">Lignes d'achat</h2>
            <p class="text-muted small mb-2">
                Saisis les produits, quantitÃ©s et prix d'achat. Les montants HT sont calculÃ©s Ã  lâ€™enregistrement.
            </p>

            <div class="table-responsive mb-2">
                <table class="table table-sm align-middle">
                    <thead class="table-light">
                    <tr>
                        <th style="width: 40%;">Produit</th>
                        <th style="width: 15%;">QtÃ©</th>
                        <th style="width: 20%;">Prix unitaire (achat)</th>
                        <th style="width: 15%;">Remise</th>
                        <th style="width: 10%;">Montant HT (indicatif)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <?php
                    $nbLignesAffichees = max(count($lignes), 3);
                    for ($i = 0; $i < $nbLignesAffichees; $i++):
                        $lg = $lignes[$i] ?? [
                            'produit_id' => '',
                            'quantite'   => '',
                            'prix_unitaire' => '',
                            'remise'     => '',
                            'montant_ligne_ht' => '',
                        ];
                        $prodId = (int)($lg['produit_id'] ?? 0);
                        $montLigne = $lg['montant_ligne_ht'] ?? '';
                    ?>
                        <tr>
                            <td>
                                <select name="produit_id[]" class="form-select">
                                    <option value="">-- SÃ©lectionner --</option>
                                    <?php foreach ($produits as $p): ?>
                                        <option value="<?= (int)$p['id'] ?>"
                                            <?= $prodId === (int)$p['id'] ? 'selected' : '' ?>>
                                            <?= htmlspecialchars($p['code_produit']) ?> â€“ <?= htmlspecialchars($p['designation']) ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </td>
                            <td>
                                <input type="number" step="0.01" name="quantite[]" class="form-control"
                                       value="<?= htmlspecialchars((string)$lg['quantite']) ?>">
                            </td>
                            <td>
                                <input type="number" step="0.01" name="prix_unitaire[]" class="form-control"
                                       value="<?= htmlspecialchars((string)$lg['prix_unitaire']) ?>">
                            </td>
                            <td>
                                <input type="number" step="0.01" name="remise[]" class="form-control"
                                       value="<?= htmlspecialchars((string)$lg['remise']) ?>">
                            </td>
                            <td>
                                <?php if ($montLigne !== ''): ?>
                                    <?= number_format((float)$montLigne, 0, ',', ' ') ?> FCFA
                                <?php else: ?>
                                    <span class="text-muted small">CalculÃ© Ã  lâ€™enregistrement</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php endfor; ?>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="4" class="text-end fw-semibold">Total HT indicatif</td>
                        <td class="text-end fw-bold">
                            <?= number_format($montant_total_ht, 0, ',', ' ') ?> FCFA
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
            <a href="<?= url_for('achats/list.php') ?>" class="btn btn-outline-secondary">Annuler</a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>
                <?= $isEdit ? 'Enregistrer l\'achat' : 'CrÃ©er l\'achat' ?>
            </button>
        </div>
    </form>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : achats\list.php =====

<?php
// achats/list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('ACHATS_GERER');

global $pdo;

// --- Filtres ---
$dateDebut  = $_GET['date_debut'] ?? date('Y-m-01');
$dateFin    = $_GET['date_fin'] ?? date('Y-m-d');
$statut     = $_GET['statut'] ?? '';
$searchFournisseur = trim($_GET['fournisseur'] ?? '');

$where  = [];
$params = [];

if ($dateDebut !== '') {
    $where[] = "a.date_achat >= :date_debut";
    $params['date_debut'] = $dateDebut;
}

if ($dateFin !== '') {
    $where[] = "a.date_achat <= :date_fin";
    $params['date_fin'] = $dateFin;
}

$statutsPossibles = ['EN_COURS','VALIDE','ANNULE'];
if ($statut !== '' && in_array($statut, $statutsPossibles, true)) {
    $where[] = "a.statut = :statut";
    $params['statut'] = $statut;
}

if ($searchFournisseur !== '') {
    $where[] = "(a.fournisseur_nom LIKE :fournisseur OR a.fournisseur_contact LIKE :fournisseur)";
    $params['fournisseur'] = '%' . $searchFournisseur . '%';
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// --- RÃ©cupÃ©ration des achats ---
$sql = "
    SELECT
        a.*,
        u.nom_complet AS utilisateur_nom
    FROM achats a
    LEFT JOIN utilisateurs u ON u.id = a.utilisateur_id
    $whereSql
    ORDER BY a.date_achat DESC, a.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$achats = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Achats & approvisionnements</h1>
        <a href="<?= url_for('achats/edit.php') ?>" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> Nouvel achat
        </a>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Statut</label>
                    <select name="statut" class="form-select">
                        <option value="">Tous</option>
                        <?php foreach ($statutsPossibles as $s): ?>
                            <option value="<?= $s ?>" <?= $statut === $s ? 'selected' : '' ?>>
                                <?= $s ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Fournisseur (nom/contact)</label>
                    <input type="text" name="fournisseur" class="form-control"
                           placeholder="Rechercher un fournisseur..."
                           value="<?= htmlspecialchars($searchFournisseur) ?>">
                </div>
                <div class="col-12 d-flex gap-2 mt-3">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('achats/list.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des achats -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($achats)): ?>
                <p class="text-muted mb-0">
                    Aucun achat trouvÃ© pour les filtres sÃ©lectionnÃ©s.
                </p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>NumÃ©ro</th>
                            <th>Fournisseur</th>
                            <th class="text-end">Montant HT</th>
                            <th class="text-end">Montant TTC</th>
                            <th>Statut</th>
                            <th>EnregistrÃ© par</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($achats as $a): ?>
                            <tr>
                                <td><?= htmlspecialchars($a['date_achat']) ?></td>
                                <td class="fw-semibold"><?= htmlspecialchars($a['numero']) ?></td>
                                <td>
                                    <?php if (!empty($a['fournisseur_nom'])): ?>
                                        <div><?= htmlspecialchars($a['fournisseur_nom']) ?></div>
                                    <?php endif; ?>
                                    <?php if (!empty($a['fournisseur_contact'])): ?>
                                        <div class="text-muted small">
                                            <?= htmlspecialchars($a['fournisseur_contact']) ?>
                                        </div>
                                    <?php endif; ?>
                                </td>
                                <td class="text-end">
                                    <?= number_format((float)$a['montant_total_ht'], 0, ',', ' ') ?> FCFA
                                </td>
                                <td class="text-end">
                                    <?= number_format((float)$a['montant_total_ttc'], 0, ',', ' ') ?> FCFA
                                </td>
                                <td>
                                    <?php
                                    $badgeClass = 'bg-secondary';
                                    if ($a['statut'] === 'EN_COURS') $badgeClass = 'bg-warning text-dark';
                                    if ($a['statut'] === 'VALIDE')  $badgeClass = 'bg-success';
                                    if ($a['statut'] === 'ANNULE')  $badgeClass = 'bg-danger';
                                    ?>
                                    <span class="badge <?= $badgeClass ?>">
                                        <?= htmlspecialchars($a['statut']) ?>
                                    </span>
                                </td>
                                <td>
                                    <?= htmlspecialchars($a['utilisateur_nom'] ?? '') ?>
                                </td>
                                <td class="text-end">
                                    <a href="<?= url_for('achats/edit.php?id=' . (int)$a['id']) ?>"
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil-square me-1"></i> Ouvrir
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : ajax\clients_search.php =====

<?php
// ajax/clients_search.php
require_once __DIR__ . '/../security.php';
exigerConnexion();

header('Content-Type: application/json; charset=utf-8');

global $pdo;

$q = trim($_GET['q'] ?? '');
$resultats = [];

// On lance la recherche dÃ¨s qu'il y a au moins 1 caractÃ¨re
if ($q !== '') {
    $like = '%' . $q . '%';

    $sql = "
        SELECT 
            id,
            nom,
            telephone,
            email
        FROM clients
        WHERE 
            nom LIKE ?
            OR telephone LIKE ?
            OR email LIKE ?
        ORDER BY nom ASC
        LIMIT 20
    ";

    $stmt = $pdo->prepare($sql);
    $stmt->execute([$like, $like, $like]);

    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
        $parts = [];

        if (!empty($row['nom'])) {
            $parts[] = $row['nom'];
        }
        if (!empty($row['telephone'])) {
            $parts[] = $row['telephone'];
        }
        if (!empty($row['email'])) {
            $parts[] = $row['email'];
        }

        $label = implode(' â€¢ ', $parts);

        $resultats[] = [
            'id'    => (int) $row['id'],
            'label' => $label !== '' ? $label : ('Client #' . (int)$row['id']),
        ];
    }
}

echo json_encode($resultats);



===== FICHIER : api\clients_recherche.php =====

<?php
// ajax/clients_search.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('CLIENTS_LIRE');

header('Content-Type: application/json; charset=utf-8');

global $pdo;

$term = trim($_GET['term'] ?? '');

if ($term === '' || mb_strlen($term) < 2) {
    echo json_encode([]);
    exit;
}

// On recherche dans nom / tÃ©lÃ©phone / email de la table `clients`
$sql = "
    SELECT id, nom, telephone, email
    FROM clients
    WHERE nom LIKE :term
       OR telephone LIKE :term
       OR email LIKE :term
    ORDER BY nom
    LIMIT 10
";

$stmt = $pdo->prepare($sql);
$like = '%' . $term . '%';
$stmt->execute(['term' => $like]);

$rows = $stmt->fetchAll(PDO::FETCH_ASSOC);

$result = [];
foreach ($rows as $row) {
    $parts = [$row['nom']];

    if (!empty($row['telephone'])) {
        $parts[] = $row['telephone'];
    }
    if (!empty($row['email'])) {
        $parts[] = $row['email'];
    }

    $result[] = [
        'id'        => (int)$row['id'],
        'nom'       => $row['nom'],
        'telephone' => $row['telephone'],
        'email'     => $row['email'],
        'label'     => implode(' â€¢ ', $parts),
    ];
}

echo json_encode($result);



===== FICHIER : api\produits_recherche.php =====

<?php
// api/produits_recherche.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('PRODUITS_LIRE');

header('Content-Type: application/json; charset=utf-8');

global $pdo;

$term = trim($_GET['term'] ?? '');
$limit = 20;

if ($term === '') {
    echo json_encode([]);
    exit;
}

$sql = "
    SELECT
        id,
        code_produit,
        designation,
        prix_vente,
        stock_actuel
    FROM produits
    WHERE actif = 1
      AND (code_produit LIKE :t OR designation LIKE :t2)
    ORDER BY designation ASC
    LIMIT :lim
";

$stmt = $pdo->prepare($sql);
$like = '%' . $term . '%';
$stmt->bindValue(':t',  $like, PDO::PARAM_STR);
$stmt->bindValue(':t2', $like, PDO::PARAM_STR);
$stmt->bindValue(':lim', (int)$limit, PDO::PARAM_INT);
$stmt->execute();

$results = $stmt->fetchAll();

echo json_encode($results);



===== FICHIER : assets\css\custom.css =====

/* assets/css/custom.css */

body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

/* Sidebar */
.kms-sidebar {
    width: 250px;
    min-height: calc(100vh - 56px); /* navbar height */
    position: sticky;
    top: 56px;
    background: #f8fafc;
}

.kms-sidebar .list-group-item {
    border: none;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    transition: background-color .2s ease, transform .1s ease;
}

.kms-sidebar .list-group-item i {
    font-size: 1.1rem;
}

.kms-sidebar .list-group-item:hover {
    background-color: #e5f2ff;
    transform: translateX(2px);
}

/* Contenu principal */
.kms-main {
    min-height: calc(100vh - 56px);
}

/* Cartes dashboard hover */
.kms-card-hover {
    transition: transform .12s ease, box-shadow .12s ease;
}

.kms-card-hover:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
}



===== FICHIER : caisse\journal.php =====

<?php
// caisse/journal.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('CAISSE_LIRE');

global $pdo;

$peutEcrire = in_array('CAISSE_ECRIRE', $_SESSION['permissions'] ?? [], true);

// --- Traitement POST : ajout / annulation d'une opÃ©ration de caisse ---
if ($_SERVER['REQUEST_METHOD'] === 'POST' && $peutEcrire) {
    try {
        verifierCsrf($_POST['csrf_token'] ?? '');

        // 1) Annulation d'une opÃ©ration existante
        if (isset($_POST['annuler_operation_id'])) {
            $opId = (int)$_POST['annuler_operation_id'];

            if ($opId > 0) {
                $utilisateur  = utilisateurConnecte();
                $annuleParId  = $utilisateur['id'] ?? null;

                $stmt = $pdo->prepare("
                    UPDATE journal_caisse
                    SET est_annule = 1,
                        date_annulation = NOW(),
                        annule_par_id = :annule_par_id
                    WHERE id = :id
                      AND est_annule = 0
                ");
                $stmt->execute([
                    'id'            => $opId,
                    'annule_par_id' => $annuleParId,
                ]);

                $_SESSION['flash_success'] = "L'opÃ©ration de caisse a Ã©tÃ© annulÃ©e.";
            }

            header('Location: ' . url_for('caisse/journal.php'));
            exit;
        }

        // 2) CrÃ©ation d'une nouvelle opÃ©ration de caisse
        $dateOperation = trim($_POST['date_operation'] ?? '');
        $sens          = $_POST['sens'] ?? '';
        $nature        = trim($_POST['nature_operation'] ?? '');
        $numeroPiece   = trim($_POST['numero_piece'] ?? '');
        $montant       = (float)str_replace(',', '.', $_POST['montant'] ?? '0');
        $modeId        = (int)($_POST['mode_paiement_id'] ?? 0);

        $venteId       = isset($_POST['vente_id']) ? (int)$_POST['vente_id'] : null;
        $reservationId = isset($_POST['reservation_id']) ? (int)$_POST['reservation_id'] : null;
        $inscriptionId = isset($_POST['inscription_formation_id']) ? (int)$_POST['inscription_formation_id'] : null;

        $observations  = trim($_POST['observations'] ?? '');

        // Validations simples
        $erreurs = [];
        if ($dateOperation === '') {
            $erreurs[] = "La date d'opÃ©ration est obligatoire.";
        }
        if (!in_array($sens, ['RECETTE','DEPENSE'], true)) {
            $erreurs[] = "Le sens de l'opÃ©ration est invalide.";
        }
        if ($montant <= 0) {
            $erreurs[] = "Le montant doit Ãªtre supÃ©rieur Ã  0.";
        }
        if ($modeId <= 0) {
            $erreurs[] = "Le mode de paiement est obligatoire.";
        }

        if (!empty($erreurs)) {
            $_SESSION['flash_error'] = implode(' ', $erreurs);
            header('Location: ' . url_for('caisse/journal.php'));
            exit;
        }

        $stmt = $pdo->prepare("
            INSERT INTO journal_caisse 
            (date_operation, numero_piece, nature_operation, sens, montant, 
             mode_paiement_id, vente_id, reservation_id, inscription_formation_id,
             responsable_encaissement_id, observations)
            VALUES 
            (:date_operation, :numero_piece, :nature_operation, :sens, :montant,
             :mode_paiement_id, :vente_id, :reservation_id, :inscription_formation_id,
             :resp_id, :observations)
        ");

        $utilisateur = utilisateurConnecte();
        $respId = $utilisateur['id'] ?? null;

        // IMPORTANT : si le champ est vide, on envoie une chaÃ®ne vide (et pas NULL)
        $numeroPieceValue = ($numeroPiece !== '') ? $numeroPiece : '';

        $stmt->execute([
            'date_operation'            => $dateOperation,
            'numero_piece'             => $numeroPieceValue,
            'nature_operation'         => $nature,
            'sens'                     => $sens,
            'montant'                  => $montant,
            'mode_paiement_id'         => $modeId,
            'vente_id'                 => $venteId ?: null,
            'reservation_id'           => $reservationId ?: null,
            'inscription_formation_id' => $inscriptionId ?: null,
            'resp_id'                  => $respId,
            'observations'             => $observations !== '' ? $observations : null,
        ]);

        $_SESSION['flash_success'] = "OpÃ©ration de caisse enregistrÃ©e avec succÃ¨s.";
        header('Location: ' . url_for('caisse/journal.php'));
        exit;

    } catch (Throwable $e) {
        // Tu peux dÃ©commenter la ligne suivante pour debug si besoin :
        // error_log('Erreur journal_caisse: ' . $e->getMessage());
        $_SESSION['flash_error'] = "Erreur lors de l'enregistrement de l'opÃ©ration de caisse.";
        header('Location: ' . url_for('caisse/journal.php'));
        exit;
    }
}

// --- Export CSV ---
if (isset($_GET['export']) && $_GET['export'] === 'csv') {
    $today      = date('Y-m-d');
    $dateDebut  = $_GET['date_debut'] ?? $today;
    $dateFin    = $_GET['date_fin'] ?? $today;
    $modeFiltre = isset($_GET['mode_id']) ? (int)$_GET['mode_id'] : 0;

    $where  = [];
    $params = [];

    if ($dateDebut !== '') {
        $where[] = "j.date_operation >= :date_debut";
        $params['date_debut'] = $dateDebut;
    }
    if ($dateFin !== '') {
        $where[] = "j.date_operation <= :date_fin";
        $params['date_fin'] = $dateFin;
    }
    if ($modeFiltre > 0) {
        $where[] = "j.mode_paiement_id = :mode_id";
        $params['mode_id'] = $modeFiltre;
    }

    $whereSql = '';
    if (!empty($where)) {
        $whereSql = 'WHERE ' . implode(' AND ', $where);
    }

    $sql = "
        SELECT
            j.id,
            j.date_operation,
            j.numero_piece,
            j.nature_operation,
            j.sens,
            j.montant,
            mp.code AS mode_code,
            mp.libelle AS mode_libelle,
            v.numero AS vente_numero,
            c.nom   AS client_nom,
            rh.id   AS reservation_numero,
            f.nom   AS formation_nom,
            u.nom_complet AS responsable_nom,
            j.observations,
            j.est_annule
        FROM journal_caisse j
        JOIN modes_paiement mp ON mp.id = j.mode_paiement_id
        LEFT JOIN ventes v ON v.id = j.vente_id
        LEFT JOIN clients c ON c.id = v.client_id
        LEFT JOIN reservations_hotel rh ON rh.id = j.reservation_id
        LEFT JOIN inscriptions_formation inf ON inf.id = j.inscription_formation_id
        LEFT JOIN formations f ON f.id = inf.formation_id
        LEFT JOIN utilisateurs u ON u.id = j.responsable_encaissement_id
        $whereSql
        ORDER BY j.date_operation DESC, j.id DESC
    ";
    $stmt = $pdo->prepare($sql);
    $stmt->execute($params);
    $operations = $stmt->fetchAll();

    header('Content-Type: text/csv; charset=utf-8-sig');
    header('Content-Disposition: attachment; filename="journal_caisse_' . date('Ymd_His') . '.csv"');
    
    $output = fopen('php://output', 'w');
    fprintf($output, chr(0xEF).chr(0xBB).chr(0xBF)); // BOM UTF-8
    
    fputcsv($output, [
        'Date OpÃ©ration',
        'NumÃ©ro PiÃ¨ce',
        'Nature',
        'Sens',
        'Montant (FCFA)',
        'Mode de paiement',
        'LibellÃ© mode',
        'Vente nÂ°',
        'Client',
        'RÃ©servation hÃ´tel',
        'Formation',
        'Caissier',
        'Observations',
        'Statut'
    ], ';');
    
    foreach ($operations as $op) {
        $statut = (int)($op['est_annule'] ?? 0) === 1 ? 'AnnulÃ©e' : 'Valide';
        fputcsv($output, [
            $op['date_operation'] ?? '',
            $op['numero_piece'] ?? '',
            $op['nature_operation'] ?? '',
            $op['sens'] ?? '',
            number_format((float)($op['montant'] ?? 0), 2, '.', ''),
            $op['mode_code'] ?? '',
            $op['mode_libelle'] ?? '',
            $op['vente_numero'] ?? '',
            $op['client_nom'] ?? '',
            $op['reservation_numero'] ?? '',
            $op['formation_nom'] ?? '',
            $op['responsable_nom'] ?? '',
            $op['observations'] ?? '',
            $statut
        ], ';');
    }
    
    fclose($output);
    exit;
}

// --- Filtres liste (GET) ---
$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

$today      = date('Y-m-d');
$dateDebut  = $_GET['date_debut'] ?? $today;
$dateFin    = $_GET['date_fin'] ?? $today;
$modeFiltre = isset($_GET['mode_id']) ? (int)$_GET['mode_id'] : 0;

// Modes de paiement
$stmt = $pdo->query("SELECT id, code, libelle FROM modes_paiement ORDER BY code");
$modesPaiement = $stmt->fetchAll();

// Construction WHERE
$where  = [];
$params = [];

if ($dateDebut !== '') {
    $where[] = "j.date_operation >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "j.date_operation <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($modeFiltre > 0) {
    $where[] = "j.mode_paiement_id = :mode_id";
    $params['mode_id'] = $modeFiltre;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// Journal de caisse
$sql = "
    SELECT
        j.*,
        mp.code AS mode_code,
        mp.libelle AS mode_libelle,
        v.numero AS vente_numero,
        c.nom   AS client_nom,
        rh.id   AS reservation_numero,
        f.nom   AS formation_nom,
        u.nom_complet AS responsable_nom
    FROM journal_caisse j
    JOIN modes_paiement mp ON mp.id = j.mode_paiement_id
    LEFT JOIN ventes v ON v.id = j.vente_id
    LEFT JOIN clients c ON c.id = v.client_id
    LEFT JOIN reservations_hotel rh ON rh.id = j.reservation_id
    LEFT JOIN inscriptions_formation inf ON inf.id = j.inscription_formation_id
    LEFT JOIN formations f ON f.id = inf.formation_id
    LEFT JOIN utilisateurs u ON u.id = j.responsable_encaissement_id
    $whereSql
    ORDER BY j.date_operation DESC, j.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$operations = $stmt->fetchAll();

// Totaux (on ignore les opÃ©rations annulÃ©es)
$totalRecettes = 0;
$totalDepenses = 0;

foreach ($operations as $op) {
    if (!empty($op['est_annule']) && (int)$op['est_annule'] === 1) {
        continue;
    }
    if ($op['sens'] === 'RECETTE') {
        $totalRecettes += (float)$op['montant'];
    } elseif ($op['sens'] === 'DEPENSE') {
        $totalDepenses += (float)$op['montant'];
    }
}
$solde = $totalRecettes - $totalDepenses;

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Journal de caisse</h1>
        <div class="d-flex gap-2">
            <a href="<?= url_for('caisse/ventes_encaissements.php') ?>" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-list-check me-1"></i> Ventes vs encaissements
            </a>
        </div>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- RÃ©sumÃ© journalier (hors opÃ©rations annulÃ©es) -->
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div class="card border-success-subtle">
                <div class="card-body">
                    <div class="text-muted small text-uppercase mb-1">Total recettes</div>
                    <div class="fs-4 fw-semibold">
                        <?= number_format($totalRecettes, 0, ',', ' ') ?> FCFA
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-danger-subtle">
                <div class="card-body">
                    <div class="text-muted small text-uppercase mb-1">Total dÃ©penses</div>
                    <div class="fs-4 fw-semibold">
                        <?= number_format($totalDepenses, 0, ',', ' ') ?> FCFA
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-primary-subtle">
                <div class="card-body">
                    <div class="text-muted small text-uppercase mb-1">Solde</div>
                    <div class="fs-4 fw-semibold">
                        <?= number_format($solde, 0, ',', ' ') ?> FCFA
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end" method="get">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Mode de paiement</label>
                    <select name="mode_id" class="form-select">
                        <option value="0">Tous</option>
                        <?php foreach ($modesPaiement as $mp): ?>
                            <option value="<?= (int)$mp['id'] ?>"
                                <?= $modeFiltre === (int)$mp['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($mp['code']) ?> â€“ <?= htmlspecialchars($mp['libelle']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary mt-4">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('caisse/journal.php') ?>" class="btn btn-outline-secondary mt-4">
                        RÃ©initialiser
                    </a>
                    <a href="?export=csv&date_debut=<?= htmlspecialchars($dateDebut) ?>&date_fin=<?= htmlspecialchars($dateFin) ?>&mode_id=<?= (int)$modeFiltre ?>" 
                       class="btn btn-outline-success mt-4">
                        <i class="bi bi-download me-1"></i> Export CSV
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Formulaire ajout opÃ©ration -->
    <?php if ($peutEcrire): ?>
        <div class="card mb-3">
            <div class="card-header">
                <strong>Nouvelle opÃ©ration de caisse</strong>
            </div>
            <div class="card-body">
                <form method="post">
                    <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label small">Date opÃ©ration</label>
                            <input type="date" name="date_operation" class="form-control"
                                   value="<?= htmlspecialchars($today) ?>" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Sens</label>
                            <select name="sens" class="form-select" required>
                                <option value="RECETTE">RECETTE</option>
                                <option value="DEPENSE">DEPENSE</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Montant (FCFA)</label>
                            <input type="number" step="0.01" name="montant" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Mode de paiement</label>
                            <select name="mode_paiement_id" class="form-select" required>
                                <option value="">-- SÃ©lectionner --</option>
                                <?php foreach ($modesPaiement as $mp): ?>
                                    <option value="<?= (int)$mp['id'] ?>">
                                        <?= htmlspecialchars($mp['code']) ?> â€“ <?= htmlspecialchars($mp['libelle']) ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Nature / LibellÃ©</label>
                            <input type="text" name="nature_operation" class="form-control"
                                   placeholder="Ex : Encaissement facture, RÃ¨glement fournisseur...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">NÂ° piÃ¨ce (facultatif)</label>
                            <input type="text" name="numero_piece" class="form-control"
                                   placeholder="NÂ° facture, reÃ§u...">
                        </div>

                        <div class="col-md-5">
                            <label class="form-label small">Lien (optionnel)</label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <input type="number" name="vente_id" class="form-control"
                                           placeholder="ID vente">
                                </div>
                                <div class="col-md-4">
                                    <input type="number" name="reservation_id" class="form-control"
                                           placeholder="ID rÃ©servation hÃ´tel">
                                </div>
                                <div class="col-md-4">
                                    <input type="number" name="inscription_formation_id" class="form-control"
                                           placeholder="ID inscription formation">
                                </div>
                            </div>
                            <small class="text-muted">
                                Renseigner lâ€™ID correspondant si l'opÃ©ration est liÃ©e Ã  une vente, une rÃ©servation ou une inscription.
                            </small>
                        </div>

                        <div class="col-12">
                            <label class="form-label small">Observations</label>
                            <textarea name="observations" class="form-control" rows="2"
                                      placeholder="Note interne (facultatif)"></textarea>
                        </div>

                        <div class="col-12 d-flex justify-content-end">
                            <button type="submit" class="btn btnSuccess">
                                <i class="bi bi-check-circle me-1"></i> Enregistrer l'opÃ©ration
                            </button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    <?php endif; ?>

    <!-- Liste des opÃ©rations -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($operations)): ?>
                <p class="text-muted mb-0">Aucune opÃ©ration trouvÃ©e pour les filtres sÃ©lectionnÃ©s.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>PiÃ¨ce</th>
                            <th>Nature</th>
                            <th>Mode</th>
                            <th class="text-center">Sens</th>
                            <th class="text-end">Montant</th>
                            <th>Caissier</th>
                            <th>Lien</th>
                            <th class="text-center">Statut</th>
                            <th>Observations</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($operations as $op): ?>
                            <tr>
                                <td><?= htmlspecialchars($op['date_operation']) ?></td>
                                <td><?= htmlspecialchars($op['numero_piece'] ?? '') ?></td>
                                <td><?= htmlspecialchars($op['nature_operation'] ?? '') ?></td>
                                <td>
                                    <span class="badge bg-secondary-subtle text-secondary">
                                        <?= htmlspecialchars($op['mode_code']) ?>
                                    </span>
                                    <span class="text-muted small d-block">
                                        <?= htmlspecialchars($op['mode_libelle']) ?>
                                    </span>
                                </td>
                                <td class="text-center">
                                    <?php if ($op['sens'] === 'RECETTE'): ?>
                                        <span class="badge bg-success-subtle text-success">RECETTE</span>
                                    <?php else: ?>
                                        <span class="badge bg-danger-subtle text-danger">DEPENSE</span>
                                    <?php endif; ?>
                                </td>
                                <td class="text-end">
                                    <?= number_format((float)$op['montant'], 0, ',', ' ') ?> FCFA
                                </td>
                                <td>
                                    <?= htmlspecialchars($op['responsable_nom'] ?? '') ?>
                                </td>
                                <td>
                                    <?php if (!empty($op['vente_id'])): ?>
                                        <div class="small">
                                            Vente nÂ° <?= htmlspecialchars($op['vente_numero'] ?? $op['vente_id']) ?>
                                            <?php if (!empty($op['client_nom'])): ?>
                                                <br><span class="text-muted">Client : <?= htmlspecialchars($op['client_nom']) ?></span>
                                            <?php endif; ?>
                                        </div>
                                    <?php elseif (!empty($op['reservation_id'])): ?>
                                        <div class="small">
                                            RÃ©servation hÃ´tel #<?= (int)$op['reservation_id'] ?>
                                        </div>
                                    <?php elseif (!empty($op['inscription_formation_id'])): ?>
                                        <div class="small">
                                            Inscription formation #<?= (int)$op['inscription_formation_id'] ?>
                                            <?php if (!empty($op['formation_nom'])): ?>
                                                <br><span class="text-muted"><?= htmlspecialchars($op['formation_nom']) ?></span>
                                            <?php endif; ?>
                                        </div>
                                    <?php else: ?>
                                        <span class="text-muted small">N/A</span>
                                    <?php endif; ?>
                                </td>
                                <td class="text-center">
                                    <?php if (!empty($op['est_annule']) && (int)$op['est_annule'] === 1): ?>
                                        <span class="badge bg-danger-subtle text-danger">AnnulÃ©e</span>
                                    <?php else: ?>
                                        <span class="badge bg-success-subtle text-success">Valide</span>
                                    <?php endif; ?>
                                </td>
                                <td><?= nl2br(htmlspecialchars($op['observations'] ?? '')) ?></td>
                                <td class="text-end">
                                    <?php if ($peutEcrire && (empty($op['est_annule']) || (int)$op['est_annule'] === 0)): ?>
                                        <form method="post" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">
                                            <input type="hidden" name="annuler_operation_id" value="<?= (int)$op['id'] ?>">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('Confirmer l\'annulation de cette opÃ©ration ?');">
                                                <i class="bi bi-x-circle me-1"></i> Annuler
                                            </button>
                                        </form>
                                    <?php else: ?>
                                        <span class="text-muted small">â€”</span>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : caisse\ventes_encaissements.php =====

<?php
// caisse/ventes_encaissements.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('CAISSE_LIRE');

global $pdo;

$today     = date('Y-m-d');
$dateDebut = $_GET['date_debut'] ?? $today;
$dateFin   = $_GET['date_fin'] ?? $today;

// Optionnel : filtrer seulement les ventes livrÃ©es / partiellement livrÃ©es
$statut    = $_GET['statut'] ?? 'LIVREES';

// Construction WHERE ventes
$where  = [];
$params = [];

if ($dateDebut !== '') {
    $where[] = "v.date_vente >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "v.date_vente <= :date_fin";
    $params['date_fin'] = $dateFin;
}

if ($statut === 'LIVREES') {
    $where[] = "v.statut IN ('LIVREE','PARTIELLEMENT_LIVREE')";
} elseif ($statut === 'TOUTES') {
    // rien
} else {
    // fallback simple
    $where[] = "v.statut IN ('LIVREE','PARTIELLEMENT_LIVREE')";
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// RÃ©cup ventes + encaissements
$sql = "
    SELECT
        v.id,
        v.numero,
        v.date_vente,
        v.montant_total_ttc,
        v.statut,
        c.nom AS client_nom,
        cv.code AS canal_code,
        cv.libelle AS canal_libelle,
        COALESCE(jc.total_encaisse, 0) AS montant_encaisse
    FROM ventes v
    JOIN clients c ON c.id = v.client_id
    JOIN canaux_vente cv ON cv.id = v.canal_vente_id
    LEFT JOIN (
        SELECT vente_id, SUM(montant) AS total_encaisse
        FROM journal_caisse
        WHERE sens = 'RECETTE' AND vente_id IS NOT NULL
        GROUP BY vente_id
    ) jc ON jc.vente_id = v.id
    $whereSql
    ORDER BY v.date_vente DESC, v.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$ventes = $stmt->fetchAll();

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Ventes livrÃ©es vs encaissements</h1>
        <a href="<?= url_for('caisse/journal.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Retour au journal de caisse
        </a>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end" method="get">
                <div class="col-md-3">
                    <label class="form-label small">Date vente - du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Filtre statut</label>
                    <select name="statut" class="form-select">
                        <option value="LIVREES" <?= $statut === 'LIVREES' ? 'selected' : '' ?>>
                            LivrÃ©es / Partiellement livrÃ©es
                        </option>
                        <option value="TOUTES" <?= $statut === 'TOUTES' ? 'selected' : '' ?>>
                            Toutes les ventes
                        </option>
                    </select>
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary mt-4">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('caisse/ventes_encaissements.php') ?>" class="btn btn-outline-secondary mt-4">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <?php if (empty($ventes)): ?>
                <p class="text-muted mb-0">
                    Aucune vente trouvÃ©e pour la pÃ©riode sÃ©lectionnÃ©e.
                </p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>NÂ° vente</th>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Canal</th>
                            <th class="text-end">Montant TTC</th>
                            <th class="text-end">Montant encaissÃ©</th>
                            <th class="text-center">Statut encaissement</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($ventes as $v): ?>
                            <?php
                            $total   = (float)$v['montant_total_ttc'];
                            $enc     = (float)$v['montant_encaisse'];
                            $ratio   = ($total > 0) ? $enc / $total : 0;

                            if ($enc <= 0.0001) {
                                $encStatut = 'Aucun encaissement';
                                $badge     = 'bg-danger-subtle text-danger';
                            } elseif (abs($enc - $total) < 0.01) {
                                $encStatut = 'Encaissement complet';
                                $badge     = 'bg-success-subtle text-success';
                            } elseif ($enc > 0 && $enc < $total) {
                                $encStatut = 'Encaissement partiel';
                                $badge     = 'bg-warning-subtle text-warning';
                            } else {
                                $encStatut = 'IncohÃ©rence (Ã  vÃ©rifier)';
                                $badge     = 'bg-dark-subtle text-dark';
                            }
                            ?>
                            <tr>
                                <td><?= htmlspecialchars($v['numero']) ?></td>
                                <td><?= htmlspecialchars($v['date_vente']) ?></td>
                                <td><?= htmlspecialchars($v['client_nom']) ?></td>
                                <td>
                                    <span class="badge bg-primary-subtle text-primary">
                                        <?= htmlspecialchars($v['canal_code']) ?>
                                    </span>
                                    <span class="text-muted small d-block">
                                        <?= htmlspecialchars($v['canal_libelle']) ?>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <?= number_format($total, 0, ',', ' ') ?> FCFA
                                </td>
                                <td class="text-end">
                                    <?= number_format($enc, 0, ',', ' ') ?> FCFA
                                </td>
                                <td class="text-center">
                                    <span class="badge <?= $badge ?>">
                                        <?= htmlspecialchars($encStatut) ?>
                                    </span>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : clients\edit.php =====

<?php 
// clients/edit.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('CLIENTS_CREER');

global $pdo;

// URL de base pour la liste des clients (inclut le rÃ©pertoire du projet)
$basePath = rtrim(dirname($_SERVER['SCRIPT_NAME']), '/\\');
$clientsListUrl = $basePath . '/list.php';

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$modeEdition = $id > 0;

// Types client
$stmtTypes = $pdo->query("SELECT id, code, libelle FROM types_client ORDER BY code");
$typesClient = $stmtTypes->fetchAll();

$nom        = '';
$type_id    = $typesClient[0]['id'] ?? 0;
$telephone  = '';
$email      = '';
$adresse    = '';
$source     = '';
$statut     = 'PROSPECT';

$erreurs = [];

// Chargement en Ã©dition (GET)
if ($modeEdition && $_SERVER['REQUEST_METHOD'] === 'GET') {
    $stmt = $pdo->prepare("
        SELECT * FROM clients WHERE id = :id
    ");
    $stmt->execute(['id' => $id]);
    $c = $stmt->fetch();

    if (!$c) {
        http_response_code(404);
        echo "Client introuvable.";
        exit;
    }

    $nom       = $c['nom'];
    $type_id   = (int)$c['type_client_id'];
    $telephone = $c['telephone'] ?? '';
    $email     = $c['email'] ?? '';
    $adresse   = $c['adresse'] ?? '';
    $source    = $c['source'] ?? '';
    $statut    = $c['statut'];
}

// POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $csrf = $_POST['csrf_token'] ?? '';
    verifierCsrf($csrf);

    $id          = (int)($_POST['id'] ?? 0);
    $modeEdition = $id > 0;

    $nom       = trim($_POST['nom'] ?? '');
    $type_id   = (int)($_POST['type_id'] ?? 0);
    $telephone = trim($_POST['telephone'] ?? '');
    $email     = trim($_POST['email'] ?? '');
    $adresse   = trim($_POST['adresse'] ?? '');
    $source    = trim($_POST['source'] ?? '');
    $statut    = trim($_POST['statut'] ?? 'PROSPECT');

    if ($nom === '') {
        $erreurs[] = "Le nom du client est obligatoire.";
    }
    if ($type_id <= 0) {
        $erreurs[] = "Veuillez sÃ©lectionner un type de client.";
    }
    if (!in_array($statut, ['PROSPECT','CLIENT','APPRENANT','HOTE'], true)) {
        $erreurs[] = "Statut de client invalide.";
    }

    if (empty($erreurs)) {
        if ($modeEdition) {
            $sql = "
                UPDATE clients
                SET nom = :nom,
                    type_client_id = :type_id,
                    telephone = :telephone,
                    email = :email,
                    adresse = :adresse,
                    source = :source,
                    statut = :statut
                WHERE id = :id
            ";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([
                'nom'       => $nom,
                'type_id'   => $type_id,
                'telephone' => $telephone ?: null,
                'email'     => $email ?: null,
                'adresse'   => $adresse ?: null,
                'source'    => $source ?: null,
                'statut'    => $statut,
                'id'        => $id
            ]);
            $_SESSION['flash_success'] = "Le client a Ã©tÃ© mis Ã  jour avec succÃ¨s.";
        } else {
            $sql = "
                INSERT INTO clients (
                    nom, type_client_id, telephone, email, adresse, source, statut, date_creation
                )
                VALUES (
                    :nom, :type_id, :telephone, :email, :adresse, :source, :statut, NOW()
                )
            ";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([
                'nom'       => $nom,
                'type_id'   => $type_id,
                'telephone' => $telephone ?: null,
                'email'     => $email ?: null,
                'adresse'   => $adresse ?: null,
                'source'    => $source ?: null,
                'statut'    => $statut
            ]);

            $_SESSION['flash_success'] = "Le client a Ã©tÃ© crÃ©Ã© avec succÃ¨s.";
        }

        header('Location: ' . $clientsListUrl);
        exit;
    }
}

$csrfToken = getCsrfToken();

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $modeEdition ? 'Modifier un client' : 'Nouveau client' ?>
        </h1>
        <a href="<?= $clientsListUrl ?>" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
        </a>
    </div>

    <?php if (!empty($erreurs)): ?>
        <div class="alert alert-danger">
            <h2 class="h6 mb-2"><i class="bi bi-exclamation-triangle me-1"></i> Erreurs</h2>
            <ul class="mb-0">
                <?php foreach ($erreurs as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <form method="post" class="card">
        <div class="card-body">
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">
            <input type="hidden" name="id" value="<?= (int)$id ?>">

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label small">Nom du client *</label>
                    <input type="text" name="nom" class="form-control" required
                           value="<?= htmlspecialchars($nom) ?>">
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Type *</label>
                    <select name="type_id" class="form-select" required>
                        <option value="">SÃ©lectionner...</option>
                        <?php foreach ($typesClient as $t): ?>
                            <option value="<?= (int)$t['id'] ?>"
                                <?= $type_id === (int)$t['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($t['libelle']) ?>
                                (<?= htmlspecialchars($t['code']) ?>)
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Statut *</label>
                    <select name="statut" class="form-select" required>
                        <?php foreach (['PROSPECT','CLIENT','APPRENANT','HOTE'] as $s): ?>
                            <option value="<?= $s ?>" <?= $statut === $s ? 'selected' : '' ?>>
                                <?= $s ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label small">TÃ©lÃ©phone</label>
                    <input type="text" name="telephone" class="form-control"
                           value="<?= htmlspecialchars($telephone) ?>">
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Email</label>
                    <input type="email" name="email" class="form-control"
                           value="<?= htmlspecialchars($email) ?>">
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Source (Facebook, WhatsApp...)</label>
                    <input type="text" name="source" class="form-control"
                           value="<?= htmlspecialchars($source) ?>">
                </div>

                <div class="col-md-12">
                    <label class="form-label small">Adresse</label>
                    <textarea name="adresse" class="form-control" rows="2"><?= htmlspecialchars($adresse) ?></textarea>
                </div>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
            <a href="<?= $clientsListUrl ?>" class="btn btn-outline-secondary">Annuler</a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>
                <?= $modeEdition ? 'Enregistrer' : 'CrÃ©er le client' ?>
            </button>
        </div>
    </form>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : clients\list.php =====

<?php
// clients/list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('CLIENTS_LIRE');

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';

global $pdo;

// RÃ©cup types client pour filtre
$stmtTypes = $pdo->query("SELECT id, code, libelle FROM types_client ORDER BY code");
$typesClient = $stmtTypes->fetchAll();

// Filtres
$typeId = isset($_GET['type_id']) ? (int)$_GET['type_id'] : 0;
$statut = trim($_GET['statut'] ?? '');
$q      = trim($_GET['q'] ?? '');

$where  = [];
$params = [];

if ($typeId > 0) {
    $where[] = "c.type_client_id = :type_id";
    $params['type_id'] = $typeId;
}
if ($statut !== '') {
    $where[] = "c.statut = :statut";
    $params['statut'] = $statut;
}
if ($q !== '') {
    $where[] = "(c.nom LIKE :q OR c.telephone LIKE :q2 OR c.email LIKE :q3)";
    $params['q']  = '%' . $q . '%';
    $params['q2'] = '%' . $q . '%';
    $params['q3'] = '%' . $q . '%';
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

$sql = "
    SELECT 
        c.*,
        t.code AS type_code,
        t.libelle AS type_libelle
    FROM clients c
    JOIN types_client t ON t.id = c.type_client_id
    $whereSql
    ORDER BY c.date_creation DESC, c.nom ASC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$clients = $stmt->fetchAll();

$peutCreer = in_array('CLIENTS_CREER', $_SESSION['permissions'] ?? [], true);

$flashSuccess = $_SESSION['flash_success'] ?? null;
unset($_SESSION['flash_success']);
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Clients & prospects</h1>
        <?php if ($peutCreer): ?>
            <a href="<?= url_for('clients/edit.php') ?>" class="btn btn-primary">
                <i class="bi bi-person-plus me-1"></i> Nouveau client
            </a>
        <?php endif; ?>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <div class="card mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small">Recherche</label>
                    <input type="text" name="q" class="form-control"
                           placeholder="Nom, tÃ©lÃ©phone, email..."
                           value="<?= htmlspecialchars($q) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Type</label>
                    <select name="type_id" class="form-select">
                        <option value="0">Tous les types</option>
                        <?php foreach ($typesClient as $t): ?>
                            <option value="<?= (int)$t['id'] ?>"
                                <?= $typeId === (int)$t['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($t['libelle']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Statut</label>
                    <select name="statut" class="form-select">
                        <option value="">Tous les statuts</option>
                        <?php
                        $statuts = ['PROSPECT','CLIENT','APPRENANT','HOTE'];
                        foreach ($statuts as $s):
                        ?>
                            <option value="<?= $s ?>" <?= $statut === $s ? 'selected' : '' ?>>
                                <?= $s ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary mt-4">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('clients/list.php') ?>" class="btn btn-outline-secondary mt-4">
                        RÃ©init.
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <?php if (empty($clients)): ?>
                <p class="text-muted mb-0">Aucun client trouvÃ©.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Nom</th>
                            <th>Type</th>
                            <th>Statut</th>
                            <th>TÃ©lÃ©phone</th>
                            <th>Email</th>
                            <th>Source</th>
                            <th>Date crÃ©ation</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($clients as $c): ?>
                            <tr>
                                <td><?= htmlspecialchars($c['nom']) ?></td>
                                <td>
                                    <span class="badge bg-primary-subtle text-primary">
                                        <?= htmlspecialchars($c['type_code']) ?>
                                    </span>
                                    <span class="text-muted small d-block">
                                        <?= htmlspecialchars($c['type_libelle']) ?>
                                    </span>
                                </td>
                                <td>
                                    <?php
                                    $badgeClass = 'bg-secondary-subtle text-secondary';
                                    if ($c['statut'] === 'CLIENT') $badgeClass = 'bg-success-subtle text-success';
                                    elseif ($c['statut'] === 'PROSPECT') $badgeClass = 'bg-warning-subtle text-warning';
                                    elseif ($c['statut'] === 'APPRENANT') $badgeClass = 'bg-info-subtle text-info';
                                    elseif ($c['statut'] === 'HOTE') $badgeClass = 'bg-purple-subtle text-purple';
                                    ?>
                                    <span class="badge <?= $badgeClass ?>">
                                        <?= htmlspecialchars($c['statut']) ?>
                                    </span>
                                </td>
                                <td><?= htmlspecialchars($c['telephone'] ?? '') ?></td>
                                <td><?= htmlspecialchars($c['email'] ?? '') ?></td>
                                <td><?= htmlspecialchars($c['source'] ?? '') ?></td>
                                <td><?= htmlspecialchars($c['date_creation']) ?></td>
                                <td class="text-end">
                                    <?php if ($peutCreer): ?>
                                        <a href="<?= url_for('clients/edit.php') . '?id=' . (int)$c['id'] ?>"
                                           class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-pencil-square me-1"></i> Modifier
                                        </a>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : db\1.sql =====

-- ------------------------------------------------------------------
--  KENNE MULTI-SERVICES (KMS)
--  SchÃ©ma base de donnÃ©es - Partie 1
--  Socle : utilisateurs, rÃ´les, permissions, clients, canaux, familles
-- ------------------------------------------------------------------

-- (Optionnel) crÃ©ation de la base
CREATE DATABASE IF NOT EXISTS kms_gestion
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;

USE kms_gestion;

SET NAMES utf8mb4;
SET sql_mode = 'STRICT_ALL_TABLES';

-- -----------------------------------------------------
--  TABLE: roles
-- -----------------------------------------------------
DROP TABLE IF EXISTS role_permission;
DROP TABLE IF EXISTS utilisateur_role;
DROP TABLE IF EXISTS connexions_utilisateur;
DROP TABLE IF EXISTS utilisateurs;
DROP TABLE IF EXISTS permissions;
DROP TABLE IF EXISTS roles;
DROP TABLE IF EXISTS types_client;
DROP TABLE IF EXISTS canaux_vente;
DROP TABLE IF EXISTS familles_produits;

CREATE TABLE roles (
    id          INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    code        VARCHAR(50)  NOT NULL UNIQUE,
    nom         VARCHAR(100) NOT NULL,
    description TEXT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: permissions
-- -----------------------------------------------------
CREATE TABLE permissions (
    id          INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    code        VARCHAR(100) NOT NULL UNIQUE,
    description TEXT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: utilisateurs
-- -----------------------------------------------------
CREATE TABLE utilisateurs (
    id                     INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    login                  VARCHAR(100) NOT NULL UNIQUE,
    mot_de_passe_hash      VARCHAR(255) NOT NULL,
    nom_complet            VARCHAR(150) NOT NULL,
    email                  VARCHAR(150) NULL,
    telephone              VARCHAR(50)  NULL,
    actif                  TINYINT(1)   NOT NULL DEFAULT 1,
    date_creation          DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    date_derniere_connexion DATETIME    NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: utilisateur_role (N-N)
-- -----------------------------------------------------
CREATE TABLE utilisateur_role (
    utilisateur_id INT UNSIGNED NOT NULL,
    role_id        INT UNSIGNED NOT NULL,
    PRIMARY KEY (utilisateur_id, role_id),
    CONSTRAINT fk_utilisateur_role_utilisateur
        FOREIGN KEY (utilisateur_id) REFERENCES utilisateurs(id)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_utilisateur_role_role
        FOREIGN KEY (role_id) REFERENCES roles(id)
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: role_permission (N-N)
-- -----------------------------------------------------
CREATE TABLE role_permission (
    role_id       INT UNSIGNED NOT NULL,
    permission_id INT UNSIGNED NOT NULL,
    PRIMARY KEY (role_id, permission_id),
    CONSTRAINT fk_role_permission_role
        FOREIGN KEY (role_id) REFERENCES roles(id)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_role_permission_permission
        FOREIGN KEY (permission_id) REFERENCES permissions(id)
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: connexions_utilisateur (journal connexions)
-- -----------------------------------------------------
CREATE TABLE connexions_utilisateur (
    id            INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    utilisateur_id INT UNSIGNED NOT NULL,
    date_connexion DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    adresse_ip     VARCHAR(100) NOT NULL,
    user_agent     VARCHAR(255) NOT NULL,
    succes         TINYINT(1)   NOT NULL DEFAULT 1,
    CONSTRAINT fk_connexions_utilisateur_utilisateur
        FOREIGN KEY (utilisateur_id) REFERENCES utilisateurs(id)
        ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX idx_connexions_utilisateur_date (date_connexion)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: types_client
-- -----------------------------------------------------
CREATE TABLE types_client (
    id      INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    code    VARCHAR(50)  NOT NULL UNIQUE, -- SHOWROOM, TERRAIN, DIGITAL, HOTEL, FORMATION
    libelle VARCHAR(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: canaux_vente
-- -----------------------------------------------------
CREATE TABLE canaux_vente (
    id      INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    code    VARCHAR(50)  NOT NULL UNIQUE, -- SHOWROOM, TERRAIN, DIGITAL, HOTEL, FORMATION
    libelle VARCHAR(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: familles_produits
-- -----------------------------------------------------
CREATE TABLE familles_produits (
    id  INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- =================================================================
--  SEED INITIAL
-- =================================================================

-- -----------------------------------------------------
--  INSERT ROLES
-- -----------------------------------------------------
INSERT INTO roles (code, nom, description) VALUES
 ('ADMIN',       'Administrateur',        'AccÃ¨s complet Ã  toute lâ€™â€™application'),
 ('SHOWROOM',    'Commercial Showroom',   'Gestion des visiteurs, devis et ventes en showroom'),
 ('TERRAIN',     'Commercial Terrain',    'Prospection terrain, devis et ventes terrain'),
 ('MAGASINIER',  'Magasinier',           'Gestion des stocks, livraisons, ruptures'),
 ('CAISSIER',    'Caissier',             'Journal de caisse et encaissements'),
 ('DIRECTION',   'Direction',            'Consultation des reportings et indicateurs globaux');

-- -----------------------------------------------------
--  INSERT PERMISSIONS
--  (codes utilisÃ©s dans les menus et modules principaux)
-- -----------------------------------------------------
INSERT INTO permissions (code, description) VALUES
 ('PRODUITS_LIRE',      'Consulter le catalogue produits et les stocks'),
 ('PRODUITS_CREER',     'CrÃ©er de nouveaux produits'),
 ('PRODUITS_MODIFIER',  'Modifier les produits existants'),
 ('PRODUITS_SUPPRIMER', 'Supprimer des produits'),

 ('CLIENTS_LIRE',       'Consulter les clients / prospects'),
 ('CLIENTS_CREER',      'CrÃ©er ou modifier des clients'),

 ('DEVIS_LIRE',         'Lister et consulter les devis'),
 ('DEVIS_CREER',        'CrÃ©er des devis'),
 ('DEVIS_MODIFIER',     'Modifier le statut ou le contenu des devis'),

 ('VENTES_LIRE',        'Consulter les ventes et bons de livraison'),
 ('VENTES_CREER',       'CrÃ©er des ventes'),
 ('VENTES_VALIDER',     'Valider des ventes / livraisons'),

 ('CAISSE_LIRE',        'Consulter le journal de caisse'),
 ('CAISSE_ECRIRE',      'Enregistrer des opÃ©rations de caisse'),

 ('PROMOTIONS_GERER',   'CrÃ©er et gÃ©rer les promotions'),

 ('HOTEL_GERER',        'GÃ©rer les rÃ©servations hÃ´tel et upsell'),
 ('FORMATION_GERER',    'GÃ©rer les formations et inscriptions'),

 ('REPORTING_LIRE',     'AccÃ©der aux tableaux de bord et reporting');

-- -----------------------------------------------------
--  ASSOCIATION ROLES â†” PERMISSIONS
-- -----------------------------------------------------

-- ADMIN : toutes les permissions
INSERT INTO role_permission (role_id, permission_id)
SELECT r.id, p.id
FROM roles r
JOIN permissions p
WHERE r.code = 'ADMIN';

-- SHOWROOM : clients, devis, ventes, lecture produits
INSERT INTO role_permission (role_id, permission_id)
SELECT r.id, p.id FROM roles r
JOIN permissions p
  ON p.code IN ('CLIENTS_LIRE','CLIENTS_CREER',
                'DEVIS_LIRE','DEVIS_CREER','DEVIS_MODIFIER',
                'VENTES_LIRE','VENTES_CREER',
                'PRODUITS_LIRE')
WHERE r.code = 'SHOWROOM';

-- TERRAIN : similaire showroom, orientÃ© terrain
INSERT INTO role_permission (role_id, permission_id)
SELECT r.id, p.id FROM roles r
JOIN permissions p
  ON p.code IN ('CLIENTS_LIRE','CLIENTS_CREER',
                'DEVIS_LIRE','DEVIS_CREER',
                'VENTES_LIRE','VENTES_CREER',
                'PRODUITS_LIRE')
WHERE r.code = 'TERRAIN';

-- MAGASINIER : lecture produits + modif stock, ventes lire
INSERT INTO role_permission (role_id, permission_id)
SELECT r.id, p.id FROM roles r
JOIN permissions p
  ON p.code IN ('PRODUITS_LIRE','PRODUITS_MODIFIER',
                'VENTES_LIRE')
WHERE r.code = 'MAGASINIER';

-- CAISSIER : caisse + ventes lire + reporting basique
INSERT INTO role_permission (role_id, permission_id)
SELECT r.id, p.id FROM roles r
JOIN permissions p
  ON p.code IN ('CAISSE_LIRE','CAISSE_ECRIRE',
                'VENTES_LIRE',
                'REPORTING_LIRE')
WHERE r.code = 'CAISSIER';

-- DIRECTION : lecture globale orientÃ©e reporting
INSERT INTO role_permission (role_id, permission_id)
SELECT r.id, p.id FROM roles r
JOIN permissions p
  ON p.code IN ('PRODUITS_LIRE',
                'CLIENTS_LIRE',
                'DEVIS_LIRE',
                'VENTES_LIRE',
                'CAISSE_LIRE',
                'HOTEL_GERER',
                'FORMATION_GERER',
                'REPORTING_LIRE')
WHERE r.code = 'DIRECTION';

-- -----------------------------------------------------
--  UTILISATEUR ADMIN PAR DÃ‰FAUT
--  login : admin
--  mot de passe : admin123
-- -----------------------------------------------------
INSERT INTO utilisateurs (login, mot_de_passe_hash, nom_complet, email, telephone, actif)
VALUES (
    'admin',
    '$2b$10$j6YYUX.QLOxOoBn9eB4rJu8/ye4/NOEXPvRjcYhUY4mBiaZZFUrTi',
    'Administrateur KMS',
    'admin@kms.local',
    NULL,
    1
);

-- Association de lâ€™admin au rÃ´le ADMIN
INSERT INTO utilisateur_role (utilisateur_id, role_id)
SELECT u.id, r.id
FROM utilisateurs u, roles r
WHERE u.login = 'admin' AND r.code = 'ADMIN';

-- -----------------------------------------------------
--  SEED TYPES CLIENT
-- -----------------------------------------------------
INSERT INTO types_client (code, libelle) VALUES
 ('SHOWROOM',  'Client / prospect showroom'),
 ('TERRAIN',   'Client / prospect terrain'),
 ('DIGITAL',   'Client issu du digital (rÃ©seaux sociaux, site, CRM)'),
 ('HOTEL',     'Client hÃ©bergement / hÃ´tel'),
 ('FORMATION', 'Apprenant / client formation');

-- -----------------------------------------------------
--  SEED CANAUX VENTE
-- -----------------------------------------------------
INSERT INTO canaux_vente (code, libelle) VALUES
 ('SHOWROOM',  'Vente showroom'),
 ('TERRAIN',   'Vente terrain'),
 ('DIGITAL',   'Vente digital / en ligne'),
 ('HOTEL',     'Vente liÃ©e Ã  lâ€™â€™hÃ´tel'),
 ('FORMATION', 'Vente liÃ©e aux formations');

-- -----------------------------------------------------
--  SEED FAMILLES PRODUITS
-- -----------------------------------------------------
INSERT INTO familles_produits (nom) VALUES
 ('Meubles & amÃ©nagements intÃ©rieurs'),
 ('Accessoires & quincaillerie de menuiserie'),
 ('Machines & Ã©quipements de menuiserie'),
 ('Panneaux & matÃ©riaux dâ€™â€™agencement');



===== FICHIER : db\2.sql =====

-- =================================================================
--  PARTIE 2 : Catalogue produits, clients, terrain, ventes, hÃ´tel,
--             formation, caisse, satisfaction
-- =================================================================

-- -----------------------------------------------------
--  TABLE: sous_categories_produits
-- -----------------------------------------------------
CREATE TABLE sous_categories_produits (
    id          INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    famille_id  INT UNSIGNED NOT NULL,
    nom         VARCHAR(100) NOT NULL,
    CONSTRAINT fk_sous_categories_famille
        FOREIGN KEY (famille_id) REFERENCES familles_produits(id)
        ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: fournisseurs
-- -----------------------------------------------------
CREATE TABLE fournisseurs (
    id       INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    nom      VARCHAR(150) NOT NULL,
    contact  VARCHAR(150) NULL,
    telephone VARCHAR(50) NULL,
    email    VARCHAR(150) NULL,
    adresse  TEXT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: produits
-- -----------------------------------------------------
CREATE TABLE produits (
    id               INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    code_produit     VARCHAR(100) NOT NULL UNIQUE,
    famille_id       INT UNSIGNED NOT NULL,
    sous_categorie_id INT UNSIGNED NULL,
    designation      VARCHAR(255) NOT NULL,
    caracteristiques TEXT NULL,
    description      TEXT NULL,
    fournisseur_id   INT UNSIGNED NULL,
    localisation     VARCHAR(150) NULL,
    prix_achat       DECIMAL(15,2) NOT NULL DEFAULT 0,
    prix_vente       DECIMAL(15,2) NOT NULL DEFAULT 0,
    stock_actuel     INT NOT NULL DEFAULT 0,
    seuil_alerte     INT NOT NULL DEFAULT 0,
    image_path       VARCHAR(255) NULL,
    actif            TINYINT(1) NOT NULL DEFAULT 1,
    date_creation    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    date_modification DATETIME NULL,
    CONSTRAINT fk_produits_famille
        FOREIGN KEY (famille_id) REFERENCES familles_produits(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_produits_sous_categorie
        FOREIGN KEY (sous_categorie_id) REFERENCES sous_categories_produits(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_produits_fournisseur
        FOREIGN KEY (fournisseur_id) REFERENCES fournisseurs(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_produits_designation (designation),
    INDEX idx_produits_code (code_produit)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: stocks_mouvements
-- -----------------------------------------------------
CREATE TABLE stocks_mouvements (
    id             INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    produit_id     INT UNSIGNED NOT NULL,
    date_mouvement DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    type_mouvement ENUM('ENTREE','SORTIE','AJUSTEMENT') NOT NULL,
    quantite       INT NOT NULL,
    source_type    VARCHAR(50) NULL,   -- VENTE, ACHAT, INVENTAIRE, LITIGE, etc.
    source_id      INT NULL,
    commentaire    TEXT NULL,
    utilisateur_id INT UNSIGNED NOT NULL,
    CONSTRAINT fk_mouvements_produit
        FOREIGN KEY (produit_id) REFERENCES produits(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_mouvements_utilisateur
        FOREIGN KEY (utilisateur_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_mouvements_date (date_mouvement)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: clients
-- -----------------------------------------------------
CREATE TABLE clients (
    id             INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    nom            VARCHAR(150) NOT NULL,
    type_client_id INT UNSIGNED NOT NULL,
    telephone      VARCHAR(50) NULL,
    email          VARCHAR(150) NULL,
    adresse        TEXT NULL,
    source         VARCHAR(100) NULL, -- Facebook, WhatsApp, Terrain, Showroom...
    statut         ENUM('PROSPECT','CLIENT','APPRENANT','HOTE') NOT NULL DEFAULT 'PROSPECT',
    date_creation  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_clients_type
        FOREIGN KEY (type_client_id) REFERENCES types_client(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_clients_nom (nom)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: visiteurs_showroom
-- -----------------------------------------------------
CREATE TABLE visiteurs_showroom (
    id            INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    date_visite   DATE NOT NULL,
    client_nom    VARCHAR(150) NOT NULL,
    contact       VARCHAR(100) NOT NULL,
    produit_interet TEXT NULL,
    orientation   VARCHAR(100) NULL,  -- devis, hÃ´tel, formationâ€¦
    client_id     INT UNSIGNED NULL,
    utilisateur_id INT UNSIGNED NOT NULL,
    CONSTRAINT fk_visiteurs_client
        FOREIGN KEY (client_id) REFERENCES clients(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_visiteurs_utilisateur
        FOREIGN KEY (utilisateur_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_visiteurs_date (date_visite)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: prospections_terrain
-- -----------------------------------------------------
CREATE TABLE prospections_terrain (
    id              INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    date_prospection DATE NOT NULL,
    prospect_nom    VARCHAR(150) NOT NULL,
    secteur         VARCHAR(150) NOT NULL,
    besoin_identifie TEXT NOT NULL,
    action_menee    TEXT NOT NULL,
    resultat        TEXT NOT NULL,
    prochaine_etape TEXT NULL,
    client_id       INT UNSIGNED NULL,
    commercial_id   INT UNSIGNED NOT NULL,
    CONSTRAINT fk_prospections_client
        FOREIGN KEY (client_id) REFERENCES clients(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_prospections_commercial
        FOREIGN KEY (commercial_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_prospections_date (date_prospection)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: rendezvous_terrain
-- -----------------------------------------------------
CREATE TABLE rendezvous_terrain (
    id                 INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    date_rdv           DATE NOT NULL,
    heure_rdv          TIME NOT NULL,
    client_prospect_nom VARCHAR(150) NOT NULL,
    lieu               VARCHAR(150) NOT NULL,
    objectif           TEXT NOT NULL,
    statut             ENUM('PLANIFIE','CONFIRME','ANNULE','HONORE') NOT NULL DEFAULT 'PLANIFIE',
    client_id          INT UNSIGNED NULL,
    commercial_id      INT UNSIGNED NOT NULL,
    CONSTRAINT fk_rdv_client
        FOREIGN KEY (client_id) REFERENCES clients(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_rdv_commercial
        FOREIGN KEY (commercial_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_rdv_date (date_rdv)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: devis
-- -----------------------------------------------------
CREATE TABLE devis (
    id               INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    numero           VARCHAR(50) NOT NULL UNIQUE,
    date_devis       DATE NOT NULL,
    client_id        INT UNSIGNED NOT NULL,
    canal_vente_id   INT UNSIGNED NOT NULL,
    statut           ENUM('EN_ATTENTE','ACCEPTE','REFUSE','ANNULE') NOT NULL DEFAULT 'EN_ATTENTE',
    date_relance     DATE NULL,
    utilisateur_id   INT UNSIGNED NOT NULL,
    montant_total_ht DECIMAL(15,2) NOT NULL DEFAULT 0,
    montant_total_ttc DECIMAL(15,2) NOT NULL DEFAULT 0,
    remise_global    DECIMAL(15,2) NOT NULL DEFAULT 0,
    conditions       TEXT NULL,
    commentaires     TEXT NULL,
    CONSTRAINT fk_devis_client
        FOREIGN KEY (client_id) REFERENCES clients(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_devis_canal
        FOREIGN KEY (canal_vente_id) REFERENCES canaux_vente(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_devis_utilisateur
        FOREIGN KEY (utilisateur_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_devis_date (date_devis),
    INDEX idx_devis_statut (statut)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: devis_lignes
-- -----------------------------------------------------
CREATE TABLE devis_lignes (
    id              INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    devis_id        INT UNSIGNED NOT NULL,
    produit_id      INT UNSIGNED NOT NULL,
    quantite        INT NOT NULL,
    prix_unitaire   DECIMAL(15,2) NOT NULL,
    remise          DECIMAL(15,2) NOT NULL DEFAULT 0,
    montant_ligne_ht DECIMAL(15,2) NOT NULL,
    CONSTRAINT fk_devis_lignes_devis
        FOREIGN KEY (devis_id) REFERENCES devis(id)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_devis_lignes_produit
        FOREIGN KEY (produit_id) REFERENCES produits(id)
        ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: ventes
-- -----------------------------------------------------
CREATE TABLE ventes (
    id               INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    numero           VARCHAR(50) NOT NULL UNIQUE,
    date_vente       DATE NOT NULL,
    client_id        INT UNSIGNED NOT NULL,
    canal_vente_id   INT UNSIGNED NOT NULL,
    devis_id         INT UNSIGNED NULL,
    statut           ENUM('EN_ATTENTE_LIVRAISON','LIVREE','ANNULEE','PARTIELLEMENT_LIVREE')
                     NOT NULL DEFAULT 'EN_ATTENTE_LIVRAISON',
    montant_total_ht DECIMAL(15,2) NOT NULL DEFAULT 0,
    montant_total_ttc DECIMAL(15,2) NOT NULL DEFAULT 0,
    utilisateur_id   INT UNSIGNED NOT NULL,
    commentaires     TEXT NULL,
    CONSTRAINT fk_ventes_client
        FOREIGN KEY (client_id) REFERENCES clients(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_ventes_canal
        FOREIGN KEY (canal_vente_id) REFERENCES canaux_vente(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_ventes_devis
        FOREIGN KEY (devis_id) REFERENCES devis(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_ventes_utilisateur
        FOREIGN KEY (utilisateur_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_ventes_date (date_vente),
    INDEX idx_ventes_statut (statut)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: ventes_lignes
-- -----------------------------------------------------
CREATE TABLE ventes_lignes (
    id              INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    vente_id        INT UNSIGNED NOT NULL,
    produit_id      INT UNSIGNED NOT NULL,
    quantite        INT NOT NULL,
    prix_unitaire   DECIMAL(15,2) NOT NULL,
    remise          DECIMAL(15,2) NOT NULL DEFAULT 0,
    montant_ligne_ht DECIMAL(15,2) NOT NULL,
    CONSTRAINT fk_ventes_lignes_vente
        FOREIGN KEY (vente_id) REFERENCES ventes(id)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_ventes_lignes_produit
        FOREIGN KEY (produit_id) REFERENCES produits(id)
        ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: bons_livraison
-- -----------------------------------------------------
CREATE TABLE bons_livraison (
    id                INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    numero            VARCHAR(50) NOT NULL UNIQUE,
    date_bl           DATE NOT NULL,
    vente_id          INT UNSIGNED NULL,
    client_id         INT UNSIGNED NOT NULL,
    transport_assure_par VARCHAR(150) NULL,
    observations      TEXT NULL,
    signe_client      TINYINT(1) NOT NULL DEFAULT 0,
    magasinier_id     INT UNSIGNED NOT NULL,
    CONSTRAINT fk_bl_vente
        FOREIGN KEY (vente_id) REFERENCES ventes(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_bl_client
        FOREIGN KEY (client_id) REFERENCES clients(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_bl_magasinier
        FOREIGN KEY (magasinier_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_bl_date (date_bl)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: bons_livraison_lignes
-- -----------------------------------------------------
CREATE TABLE bons_livraison_lignes (
    id               INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    bon_livraison_id INT UNSIGNED NOT NULL,
    produit_id       INT UNSIGNED NOT NULL,
    quantite         INT NOT NULL,
    CONSTRAINT fk_bl_lignes_bl
        FOREIGN KEY (bon_livraison_id) REFERENCES bons_livraison(id)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_bl_lignes_produit
        FOREIGN KEY (produit_id) REFERENCES produits(id)
        ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: retours_litiges
-- -----------------------------------------------------
CREATE TABLE retours_litiges (
    id                   INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    date_retour          DATE NOT NULL,
    client_id            INT UNSIGNED NOT NULL,
    produit_id           INT UNSIGNED NOT NULL,
    vente_id             INT UNSIGNED NULL,
    motif                TEXT NOT NULL,
    responsable_suivi_id INT UNSIGNED NOT NULL,
    statut_traitement    ENUM('EN_COURS','RESOLU','ABANDONNE') NOT NULL DEFAULT 'EN_COURS',
    solution             TEXT NULL,
    CONSTRAINT fk_litiges_client
        FOREIGN KEY (client_id) REFERENCES clients(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_litiges_produit
        FOREIGN KEY (produit_id) REFERENCES produits(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_litiges_vente
        FOREIGN KEY (vente_id) REFERENCES ventes(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_litiges_responsable
        FOREIGN KEY (responsable_suivi_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: ruptures_stock
-- -----------------------------------------------------
CREATE TABLE ruptures_stock (
    id              INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    date_rapport    DATE NOT NULL,
    produit_id      INT UNSIGNED NOT NULL,
    seuil_alerte    INT NOT NULL,
    stock_actuel    INT NOT NULL,
    impact_commercial TEXT NOT NULL,
    action_proposee TEXT NOT NULL,
    magasinier_id   INT UNSIGNED NOT NULL,
    CONSTRAINT fk_ruptures_produit
        FOREIGN KEY (produit_id) REFERENCES produits(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_ruptures_magasinier
        FOREIGN KEY (magasinier_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_ruptures_date (date_rapport)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: modes_paiement
-- -----------------------------------------------------
CREATE TABLE modes_paiement (
    id      INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    code    VARCHAR(50)  NOT NULL UNIQUE, -- CASH, VIREMENT, MOBILE_MONEY, CHEQUE
    libelle VARCHAR(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: chambres (HÃ´tel)
-- -----------------------------------------------------
CREATE TABLE chambres (
    id          INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    code        VARCHAR(50) NOT NULL UNIQUE,
    description TEXT NULL,
    tarif_nuite DECIMAL(15,2) NOT NULL DEFAULT 0,
    actif       TINYINT(1) NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: formations
-- -----------------------------------------------------
CREATE TABLE formations (
    id          INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    nom         VARCHAR(150) NOT NULL,
    description TEXT NOT NULL,
    tarif_total DECIMAL(15,2) NOT NULL DEFAULT 0
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: reservations_hotel
-- -----------------------------------------------------
CREATE TABLE reservations_hotel (
    id               INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    date_reservation DATE NOT NULL,
    client_id        INT UNSIGNED NOT NULL,
    chambre_id       INT UNSIGNED NOT NULL,
    date_debut       DATE NOT NULL,
    date_fin         DATE NOT NULL,
    nb_nuits         INT NOT NULL,
    montant_total    DECIMAL(15,2) NOT NULL DEFAULT 0,
    statut           ENUM('EN_COURS','TERMINEE','ANNULEE') NOT NULL DEFAULT 'EN_COURS',
    mode_paiement_id INT UNSIGNED NULL,
    concierge_id     INT UNSIGNED NOT NULL,
    CONSTRAINT fk_reservation_client
        FOREIGN KEY (client_id) REFERENCES clients(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_reservation_chambre
        FOREIGN KEY (chambre_id) REFERENCES chambres(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_reservation_mode_paiement
        FOREIGN KEY (mode_paiement_id) REFERENCES modes_paiement(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_reservation_concierge
        FOREIGN KEY (concierge_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_reservation_dates (date_debut, date_fin)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: upsell_hotel
-- -----------------------------------------------------
CREATE TABLE upsell_hotel (
    id              INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    reservation_id  INT UNSIGNED NOT NULL,
    service_additionnel VARCHAR(150) NOT NULL,
    montant         DECIMAL(15,2) NOT NULL DEFAULT 0,
    CONSTRAINT fk_upsell_reservation
        FOREIGN KEY (reservation_id) REFERENCES reservations_hotel(id)
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: visiteurs_hotel
-- -----------------------------------------------------
CREATE TABLE visiteurs_hotel (
    id            INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    date_visite   DATE NOT NULL,
    nom_visiteur  VARCHAR(150) NOT NULL,
    motif         TEXT NOT NULL,
    service_solicite VARCHAR(150) NOT NULL,
    orientation   VARCHAR(150) NULL,
    concierge_id  INT UNSIGNED NOT NULL,
    CONSTRAINT fk_visiteurs_hotel_concierge
        FOREIGN KEY (concierge_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_visiteurs_hotel_date (date_visite)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: prospects_formation
-- -----------------------------------------------------
CREATE TABLE prospects_formation (
    id             INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    date_prospect  DATE NOT NULL,
    nom_prospect   VARCHAR(150) NOT NULL,
    contact        VARCHAR(100) NOT NULL,
    source         VARCHAR(100) NULL,
    statut_actuel  VARCHAR(100) NOT NULL,
    client_id      INT UNSIGNED NULL,
    utilisateur_id INT UNSIGNED NOT NULL,
    CONSTRAINT fk_prospect_formation_client
        FOREIGN KEY (client_id) REFERENCES clients(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_prospect_formation_utilisateur
        FOREIGN KEY (utilisateur_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_prospect_formation_date (date_prospect)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: inscriptions_formation
-- -----------------------------------------------------
CREATE TABLE inscriptions_formation (
    id              INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    date_inscription DATE NOT NULL,
    apprenant_nom   VARCHAR(150) NOT NULL,
    client_id       INT UNSIGNED NULL,
    formation_id    INT UNSIGNED NOT NULL,
    montant_paye    DECIMAL(15,2) NOT NULL DEFAULT 0,
    solde_du        DECIMAL(15,2) NOT NULL DEFAULT 0,
    CONSTRAINT fk_inscription_client
        FOREIGN KEY (client_id) REFERENCES clients(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_inscription_formation
        FOREIGN KEY (formation_id) REFERENCES formations(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_inscription_date (date_inscription)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: journal_caisse
-- -----------------------------------------------------
CREATE TABLE journal_caisse (
    id                       INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    date_operation           DATE NOT NULL,
    numero_piece             VARCHAR(50) NOT NULL,
    nature_operation         TEXT NOT NULL,
    sens                     ENUM('RECETTE','DEPENSE') NOT NULL,
    montant                  DECIMAL(15,2) NOT NULL,
    mode_paiement_id         INT UNSIGNED NOT NULL,
    vente_id                 INT UNSIGNED NULL,
    reservation_id           INT UNSIGNED NULL,
    inscription_formation_id INT UNSIGNED NULL,
    responsable_encaissement_id INT UNSIGNED NOT NULL,
    observations             TEXT NULL,
    CONSTRAINT fk_caisse_mode_paiement
        FOREIGN KEY (mode_paiement_id) REFERENCES modes_paiement(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_caisse_vente
        FOREIGN KEY (vente_id) REFERENCES ventes(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_caisse_reservation
        FOREIGN KEY (reservation_id) REFERENCES reservations_hotel(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_caisse_inscription
        FOREIGN KEY (inscription_formation_id) REFERENCES inscriptions_formation(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_caisse_responsable
        FOREIGN KEY (responsable_encaissement_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_caisse_date (date_operation)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: promotions
-- -----------------------------------------------------
CREATE TABLE promotions (
    id                INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    nom               VARCHAR(150) NOT NULL,
    description       TEXT NULL,
    pourcentage_remise DECIMAL(5,2) NULL,
    montant_remise    DECIMAL(15,2) NULL,
    date_debut        DATE NOT NULL,
    date_fin          DATE NOT NULL,
    actif             TINYINT(1) NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: promotion_produit (N-N)
-- -----------------------------------------------------
CREATE TABLE promotion_produit (
    promotion_id INT UNSIGNED NOT NULL,
    produit_id   INT UNSIGNED NOT NULL,
    PRIMARY KEY (promotion_id, produit_id),
    CONSTRAINT fk_promo_produit_promo
        FOREIGN KEY (promotion_id) REFERENCES promotions(id)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_promo_produit_produit
        FOREIGN KEY (produit_id) REFERENCES produits(id)
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- -----------------------------------------------------
--  TABLE: satisfaction_clients
-- -----------------------------------------------------
CREATE TABLE satisfaction_clients (
    id             INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    date_satisfaction DATE NOT NULL,
    client_id      INT UNSIGNED NULL,
    nom_client     VARCHAR(150) NOT NULL,
    service_utilise ENUM('SHOWROOM','HOTEL','FORMATION','TERRAIN','DIGITAL') NOT NULL,
    note           INT NOT NULL, -- 1 Ã  5
    commentaire    TEXT NULL,
    utilisateur_id INT UNSIGNED NOT NULL,
    CONSTRAINT fk_satisfaction_client
        FOREIGN KEY (client_id) REFERENCES clients(id)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_satisfaction_utilisateur
        FOREIGN KEY (utilisateur_id) REFERENCES utilisateurs(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_satisfaction_date (date_satisfaction)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- =================================================================
--  SEED COMPLÃ‰MENTAIRE
-- =================================================================

-- Modes de paiement
INSERT INTO modes_paiement (code, libelle) VALUES
 ('CASH',         'EspÃ¨ces'),
 ('VIREMENT',     'Virement bancaire'),
 ('MOBILE_MONEY', 'Mobile Money'),
 ('CHEQUE',       'ChÃ¨que');

-- Fournisseurs de base
INSERT INTO fournisseurs (nom, contact, telephone, email, adresse) VALUES
 ('Fournisseur GÃ©nÃ©ral KMS', 'Service commercial', '+237600000001', 'fournisseur@kms.local', 'Douala'),
 ('Import MatÃ©riaux Pro',    'Responsable achat',  '+237600000002', 'imports@kms.local',     'Douala - Zone industrielle');

-- Sous-catÃ©gories exemples (en supposant les familles 1..4)
INSERT INTO sous_categories_produits (famille_id, nom) VALUES
 (1, 'Chambres Ã  coucher'),
 (1, 'Salons'),
 (2, 'Quincaillerie standard'),
 (3, 'Machines de dÃ©coupe'),
 (4, 'Panneaux mÃ©laminÃ©s');

-- Produits de test
INSERT INTO produits (code_produit, famille_id, sous_categorie_id, designation,
                      caracteristiques, description, fournisseur_id,
                      localisation, prix_achat, prix_vente,
                      stock_actuel, seuil_alerte)
VALUES
 ('MEU-CH-001', 1, 1, 'Lit 2 places avec chevets',
  'Dimensions 160x200', 'Lit moderne pour chambre parentale', 1,
  'Showroom Douala', 120000, 180000, 5, 1),

 ('MEU-SAL-001', 1, 2, 'Salon 5 places',
  'Structure bois, mousse haute densitÃ©', 'Salon complet 3+1+1', 1,
  'Showroom Douala', 200000, 280000, 3, 1),

 ('ACC-VIS-001', 2, 3, 'Lot de visserie menuiserie',
  'Assortiment vis bois', 'Accessoires pour montage de meubles', 2,
  'Magasin PK12', 15000, 25000, 50, 10),

 ('PAN-MEL-001', 4, 5, 'Panneau mÃ©laminÃ© blanc 18mm',
  '2,75m x 1,83m', 'Panneau pour agencement intÃ©rieur', 2,
  'Magasin PK12', 25000, 38000, 30, 5);

-- Mouvement de stock initial (exemple) liÃ© Ã  lâ€™utilisateur admin (id=1)
INSERT INTO stocks_mouvements (produit_id, type_mouvement, quantite, source_type, source_id, commentaire, utilisateur_id)
VALUES
 (1, 'ENTREE', 5,  'INVENTAIRE', NULL, 'Stock initial lit 2 places', 1),
 (2, 'ENTREE', 3,  'INVENTAIRE', NULL, 'Stock initial salon', 1),
 (3, 'ENTREE', 50, 'INVENTAIRE', NULL, 'Stock initial visserie', 1),
 (4, 'ENTREE', 30, 'INVENTAIRE', NULL, 'Stock initial panneaux', 1);

-- Clients de test (en supposant lâ€™ordre dâ€™insertion des types_client)
-- 1: SHOWROOM, 2: TERRAIN, 3: DIGITAL, 4: HOTEL, 5: FORMATION
INSERT INTO clients (nom, type_client_id, telephone, email, adresse, source, statut)
VALUES
 ('Client Showroom Test', 1, '+237650000001', 'client.showroom@test.local', 'Douala', 'Showroom', 'CLIENT'),
 ('Client Terrain Test',  2, '+237650000002', 'client.terrain@test.local',  'BonabÃ©ri', 'Terrain', 'PROSPECT'),
 ('Client Digital Test',  3, '+237650000003', 'client.digital@test.local',  'YaoundÃ©', 'Facebook', 'CLIENT'),
 ('Client HÃ´tel Test',    4, '+237650000004', 'client.hotel@test.local',    'Douala', 'RÃ©servation directe', 'HOTE'),
 ('Apprenant Formation',  5, '+237650000005', 'apprenant@test.local',       'Bafoussam', 'WhatsApp', 'APPRENANT');

-- Chambres test
INSERT INTO chambres (code, description, tarif_nuite, actif) VALUES
 ('CH-101', 'Chambre standard lit double', 20000, 1),
 ('APP-201','Appartement meublÃ© 2 piÃ¨ces', 35000, 1);

-- Formations test
INSERT INTO formations (nom, description, tarif_total) VALUES
 ('Menuiserie moderne', 'Formation pratique en menuiserie et agencement', 150000),
 ('Agencement intÃ©rieur', 'Techniques dâ€™agencement et dÃ©coration intÃ©rieure', 180000);



===== FICHIER : db\3.sql =====

-- ==========================================================
--  PERMISSION : gestion des utilisateurs (ADMIN uniquement)
-- ==========================================================

INSERT INTO permissions (code, description) VALUES
 ('UTILISATEURS_GERER', 'CrÃ©er, modifier et dÃ©sactiver les utilisateurs internes');

-- Associer la permission UTILISATEURS_GERER au rÃ´le ADMIN
INSERT INTO role_permission (role_id, permission_id)
SELECT r.id, p.id
FROM roles r
JOIN permissions p
  ON p.code = 'UTILISATEURS_GERER'
WHERE r.code = 'ADMIN';



===== FICHIER : db\4.sql =====

<?php
// hotel/upsell_list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('HOTEL_GERER');

global $pdo;

// -------------------------------------------------
// 1. RÃ©cup des rÃ©servations pour le formulaire & filtre
// -------------------------------------------------

// On rÃ©cupÃ¨re les rÃ©servations les plus rÃ©centes (ex : 200 derniÃ¨res)
$stmtRes = $pdo->query("
    SELECT 
        r.id,
        r.date_reservation,
        r.date_debut,
        r.date_fin,
        c.nom AS client_nom,
        ch.code AS chambre_code
    FROM reservations_hotel r
    JOIN clients c  ON c.id  = r.client_id
    JOIN chambres ch ON ch.id = r.chambre_id
    ORDER BY r.date_reservation DESC, r.id DESC
    LIMIT 200
");
$reservations = $stmtRes->fetchAll();

// Index simple [id => label] pour rÃ©utiliser dans le select
$optionsReservations = [];
foreach ($reservations as $r) {
    $label = sprintf(
        '%s â€“ %s (%s â†’ %s)',
        $r['chambre_code'],
        $r['client_nom'],
        $r['date_debut'],
        $r['date_fin']
    );
    $optionsReservations[$r['id']] = $label;
}

// -------------------------------------------------
// 2. Traitement ajout d'un upsell
// -------------------------------------------------
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $reservationId = isset($_POST['reservation_id']) ? (int)$_POST['reservation_id'] : 0;
    $service       = trim($_POST['service_additionnel'] ?? '');
    $montant       = str_replace(',', '.', $_POST['montant'] ?? '0');
    $montant       = (float)$montant;

    $errors = [];

    if ($reservationId <= 0) {
        $errors[] = "SÃ©lectionne une rÃ©servation.";
    }
    if ($service === '') {
        $errors[] = "Le libellÃ© du service additionnel est obligatoire.";
    }
    if ($montant <= 0) {
        $errors[] = "Le montant doit Ãªtre strictement positif.";
    }

    if (empty($errors)) {
        $stmt = $pdo->prepare("
            INSERT INTO upsell_hotel (reservation_id, service_additionnel, montant)
            VALUES (:reservation_id, :service, :montant)
        ");
        $stmt->execute([
            'reservation_id' => $reservationId,
            'service'        => $service,
            'montant'        => $montant,
        ]);

        $_SESSION['flash_success'] = "Service additionnel enregistrÃ© avec succÃ¨s.";
        // On reste sur la page, optionnellement on peut garder un filtre sur la rÃ©servation
        header('Location: ' . url_for('hotel/upsell_list.php') . '?reservation_id=' . $reservationId);
        exit;
    } else {
        $_SESSION['flash_error'] = implode(' ', $errors);
        header('Location: ' . url_for('hotel/upsell_list.php'));
        exit;
    }
}

// -------------------------------------------------
// 3. Filtres pour la liste des upsell
// -------------------------------------------------
$today      = date('Y-m-d');
$firstMonth = date('Y-m-01');

$dateDeb       = $_GET['date_debut'] ?? $firstMonth;
$dateFin       = $_GET['date_fin'] ?? $today;
$filterResId   = isset($_GET['reservation_id']) ? (int)$_GET['reservation_id'] : 0;

$where  = [];
$params = [];

if ($dateDeb !== '') {
    $where[] = "r.date_reservation >= :date_debut";
    $params['date_debut'] = $dateDeb;
}
if ($dateFin !== '') {
    $where[] = "r.date_reservation <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($filterResId > 0) {
    $where[] = "u.reservation_id = :reservation_id";
    $params['reservation_id'] = $filterResId;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// Liste upsell
$sql = "
    SELECT
        u.id,
        u.service_additionnel,
        u.montant,
        r.id AS reservation_id,
        r.date_reservation,
        r.date_debut,
        r.date_fin,
        c.nom AS client_nom,
        ch.code AS chambre_code
    FROM upsell_hotel u
    JOIN reservations_hotel r ON r.id = u.reservation_id
    JOIN clients c            ON c.id = r.client_id
    JOIN chambres ch          ON ch.id = r.chambre_id
    $whereSql
    ORDER BY r.date_reservation DESC, u.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$upsells = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Upsell hÃ´tel â€“ services additionnels</h1>
        <a href="<?= url_for('hotel/reservations.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-building me-1"></i> Retour aux rÃ©servations
        </a>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Formulaire d'ajout d'upsell -->
    <div class="card mb-3">
        <div class="card-body">
            <h2 class="h6 mb-3">Ajouter un service additionnel</h2>

            <?php if (empty($reservations)): ?>
                <p class="text-muted mb-0">
                    Aucune rÃ©servation trouvÃ©e. CrÃ©e dâ€™abord une rÃ©servation avant dâ€™ajouter un upsell.
                </p>
            <?php else: ?>
                <form method="post" class="row g-3">
                    <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                    <div class="col-md-6">
                        <label class="form-label small">RÃ©servation</label>
                        <select name="reservation_id" class="form-select" required>
                            <option value="">SÃ©lectionner une rÃ©servation...</option>
                            <?php foreach ($optionsReservations as $id => $label): ?>
                                <option value="<?= (int)$id ?>"
                                    <?= $filterResId === (int)$id ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($label) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                        <div class="form-text">
                            Chambre â€“ Client (pÃ©riode de sÃ©jour).
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small">Service additionnel</label>
                        <input type="text" name="service_additionnel" class="form-control"
                               placeholder="Petit-dÃ©jeuner, transport, excursion..." required>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small">Montant</label>
                        <div class="input-group">
                            <input type="number" step="100" min="0" name="montant" class="form-control"
                                   placeholder="0" required>
                            <span class="input-group-text">FCFA</span>
                        </div>
                    </div>

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i> Enregistrer lâ€™upsell
                        </button>
                    </div>
                </form>
            <?php endif; ?>
        </div>
    </div>

    <!-- Filtres liste -->
    <div class="card mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end" method="get">
                <div class="col-md-3">
                    <label class="form-label small">Du (date rÃ©servation)</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDeb) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-4">
                    <label class="form-label small">RÃ©servation</label>
                    <select name="reservation_id" class="form-select">
                        <option value="0">Toutes</option>
                        <?php foreach ($optionsReservations as $id => $label): ?>
                            <option value="<?= (int)$id ?>"
                                <?= $filterResId === (int)$id ? 'selected' : '' ?>>
                                <?= htmlspecialchars($label) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-2 d-flex gap-2 mt-3 mt-md-0">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('hotel/upsell_list.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des upsell -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($upsells)): ?>
                <p class="text-muted mb-0">Aucun service additionnel enregistrÃ© pour la pÃ©riode sÃ©lectionnÃ©e.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date rÃ©servation</th>
                            <th>Client</th>
                            <th>Chambre</th>
                            <th>PÃ©riode</th>
                            <th>Service additionnel</th>
                            <th class="text-end">Montant</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($upsells as $u): ?>
                            <tr>
                                <td><?= htmlspecialchars($u['date_reservation']) ?></td>
                                <td class="fw-semibold"><?= htmlspecialchars($u['client_nom']) ?></td>
                                <td><?= htmlspecialchars($u['chambre_code']) ?></td>
                                <td>
                                    <?= htmlspecialchars($u['date_debut']) ?> â†’ <?= htmlspecialchars($u['date_fin']) ?>
                                </td>
                                <td><?= htmlspecialchars($u['service_additionnel']) ?></td>
                                <td class="text-end">
                                    <?= number_format((float)$u['montant'], 0, ',', ' ') ?> FCFA
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : db\db.php =====

<?php
// db/db.php

$DB_HOST = 'localhost';
$DB_NAME = 'kms_gestion';
$DB_USER = 'root';
$DB_PASS = ''; // Ã  adapter Ã  ton hÃ©bergement

$DB_DSN = "mysql:host={$DB_HOST};dbname={$DB_NAME};charset=utf8mb4";

$options = [
    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    PDO::ATTR_EMULATE_PREPARES   => false,
];

try {
    $pdo = new PDO($DB_DSN, $DB_USER, $DB_PASS, $options);
} catch (PDOException $e) {
    // Ne pas exposer le message complet en prod
    die('Erreur de connexion Ã  la base de donnÃ©es.');
}



===== FICHIER : db\kms_gestion (1).sql =====

-- phpMyAdmin SQL Dump
-- version 5.2.1
-- https://www.phpmyadmin.net/
--
-- HÃ´te : 127.0.0.1
-- GÃ©nÃ©rÃ© le : jeu. 20 nov. 2025 Ã  12:37
-- Version du serveur : 10.4.32-MariaDB
-- Version de PHP : 8.2.12

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
START TRANSACTION;
SET time_zone = "+00:00";


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;

--
-- Base de donnÃ©es : `kms_gestion`
--

-- --------------------------------------------------------

--
-- Structure de la table `bons_livraison`
--

CREATE TABLE `bons_livraison` (
  `id` int(10) UNSIGNED NOT NULL,
  `numero` varchar(50) NOT NULL,
  `date_bl` date NOT NULL,
  `vente_id` int(10) UNSIGNED DEFAULT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `transport_assure_par` varchar(150) DEFAULT NULL,
  `observations` text DEFAULT NULL,
  `signe_client` tinyint(1) NOT NULL DEFAULT 0,
  `magasinier_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `bons_livraison`
--

INSERT INTO `bons_livraison` (`id`, `numero`, `date_bl`, `vente_id`, `client_id`, `transport_assure_par`, `observations`, `signe_client`, `magasinier_id`) VALUES
(1, 'BL-20251118-123629', '2025-11-18', 2, 2, NULL, NULL, 1, 1),
(2, 'BL-20251118-123739', '2025-11-18', 1, 3, NULL, NULL, 0, 1),
(3, 'BL-20251118-140008', '2025-11-18', 3, 5, NULL, NULL, 0, 1),
(4, 'BL-20251118-151854', '2025-11-18', 4, 5, NULL, NULL, 0, 1),
(5, 'BL-20251120-122339', '2025-11-20', 16, 2, NULL, NULL, 0, 1);

-- --------------------------------------------------------

--
-- Structure de la table `bons_livraison_lignes`
--

CREATE TABLE `bons_livraison_lignes` (
  `id` int(10) UNSIGNED NOT NULL,
  `bon_livraison_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `quantite` int(11) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `bons_livraison_lignes`
--

INSERT INTO `bons_livraison_lignes` (`id`, `bon_livraison_id`, `produit_id`, `quantite`) VALUES
(1, 1, 4, 2),
(2, 2, 2, 1),
(3, 3, 3, 2),
(4, 4, 3, 2),
(5, 5, 4, 1);

-- --------------------------------------------------------

--
-- Structure de la table `canaux_vente`
--

CREATE TABLE `canaux_vente` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `libelle` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `canaux_vente`
--

INSERT INTO `canaux_vente` (`id`, `code`, `libelle`) VALUES
(1, 'SHOWROOM', 'Vente showroom'),
(2, 'TERRAIN', 'Vente terrain'),
(3, 'DIGITAL', 'Vente digital / en ligne'),
(4, 'HOTEL', 'Vente liÃ©e Ã  lâ€™â€™hÃ´tel'),
(5, 'FORMATION', 'Vente liÃ©e aux formations');

-- --------------------------------------------------------

--
-- Structure de la table `chambres`
--

CREATE TABLE `chambres` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `description` text DEFAULT NULL,
  `tarif_nuite` decimal(15,2) NOT NULL DEFAULT 0.00,
  `actif` tinyint(1) NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `chambres`
--

INSERT INTO `chambres` (`id`, `code`, `description`, `tarif_nuite`, `actif`) VALUES
(1, 'CH-101', 'Chambre standard lit double', 20000.00, 1),
(2, 'APP-201', 'Appartement meublÃ© 2 piÃ¨ces', 35000.00, 1);

-- --------------------------------------------------------

--
-- Structure de la table `clients`
--

CREATE TABLE `clients` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `type_client_id` int(10) UNSIGNED NOT NULL,
  `telephone` varchar(50) DEFAULT NULL,
  `email` varchar(150) DEFAULT NULL,
  `adresse` text DEFAULT NULL,
  `source` varchar(100) DEFAULT NULL,
  `statut` enum('PROSPECT','CLIENT','APPRENANT','HOTE') NOT NULL DEFAULT 'PROSPECT',
  `date_creation` datetime NOT NULL DEFAULT current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `clients`
--

INSERT INTO `clients` (`id`, `nom`, `type_client_id`, `telephone`, `email`, `adresse`, `source`, `statut`, `date_creation`) VALUES
(1, 'Client Showroom Test', 1, '+237650000001', 'client.showroom@test.local', 'Douala', 'Showroom', 'CLIENT', '2025-11-18 11:00:22'),
(2, 'Client Terrain Test', 2, '+237650000002', 'client.terrain@test.local', 'BonabÃ©ri', 'Terrain', 'PROSPECT', '2025-11-18 11:00:22'),
(3, 'Client Digital Test', 3, '+237650000003', 'client.digital@test.local', 'YaoundÃ©', 'Facebook', 'CLIENT', '2025-11-18 11:00:22'),
(4, 'Client HÃ´tel Test', 4, '+237650000004', 'client.hotel@test.local', 'Douala', 'RÃ©servation directe', 'HOTE', '2025-11-18 11:00:22'),
(5, 'Apprenant Formation', 5, '+237650000005', 'apprenant@test.local', 'Bafoussam', 'WhatsApp', 'APPRENANT', '2025-11-18 11:00:22'),
(6, 'romy', 5, '695657613', 'cm@kennemulti-services.com', NULL, 'facebook', 'PROSPECT', '2025-11-20 09:02:31');

-- --------------------------------------------------------

--
-- Structure de la table `connexions_utilisateur`
--

CREATE TABLE `connexions_utilisateur` (
  `id` int(10) UNSIGNED NOT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `date_connexion` datetime NOT NULL DEFAULT current_timestamp(),
  `adresse_ip` varchar(100) NOT NULL,
  `user_agent` varchar(255) NOT NULL,
  `succes` tinyint(1) NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `connexions_utilisateur`
--

INSERT INTO `connexions_utilisateur` (`id`, `utilisateur_id`, `date_connexion`, `adresse_ip`, `user_agent`, `succes`) VALUES
(1, 1, '2025-11-18 11:14:36', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(2, 1, '2025-11-18 11:30:13', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(3, 1, '2025-11-18 11:30:21', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(4, 1, '2025-11-18 11:47:19', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(5, 1, '2025-11-18 12:08:16', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(6, 1, '2025-11-18 14:28:18', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(7, 1, '2025-11-18 14:59:18', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(8, 1, '2025-11-18 15:16:01', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(9, 1, '2025-11-19 09:43:53', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(10, 1, '2025-11-19 10:07:11', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(11, 1, '2025-11-20 09:17:11', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1),
(12, 1, '2025-11-20 11:07:05', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1);

-- --------------------------------------------------------

--
-- Structure de la table `devis`
--

CREATE TABLE `devis` (
  `id` int(10) UNSIGNED NOT NULL,
  `numero` varchar(50) NOT NULL,
  `date_devis` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `canal_vente_id` int(10) UNSIGNED NOT NULL,
  `statut` enum('EN_ATTENTE','ACCEPTE','REFUSE','ANNULE') NOT NULL DEFAULT 'EN_ATTENTE',
  `est_converti` tinyint(1) NOT NULL DEFAULT 0,
  `date_relance` date DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `montant_total_ht` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_total_ttc` decimal(15,2) NOT NULL DEFAULT 0.00,
  `remise_global` decimal(15,2) NOT NULL DEFAULT 0.00,
  `conditions` text DEFAULT NULL,
  `commentaires` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `devis`
--

INSERT INTO `devis` (`id`, `numero`, `date_devis`, `client_id`, `canal_vente_id`, `statut`, `est_converti`, `date_relance`, `utilisateur_id`, `montant_total_ht`, `montant_total_ttc`, `remise_global`, `conditions`, `commentaires`) VALUES
(1, 'DV-20251118-135909', '2025-11-18', 5, 3, 'ACCEPTE', 1, NULL, 1, 50000.00, 50000.00, 0.00, NULL, NULL),
(2, 'DV-20251120-105327', '2025-11-20', 2, 3, 'ACCEPTE', 1, NULL, 1, 38000.00, 38000.00, 0.00, NULL, NULL),
(3, 'DV-20251120-120352', '2025-11-20', 5, 3, 'ACCEPTE', 1, '2025-11-24', 1, 75995.00, 75995.00, 0.00, NULL, NULL),
(4, 'DV-20251120-122248', '2025-11-20', 2, 3, 'ACCEPTE', 1, NULL, 1, 38000.00, 38000.00, 0.00, NULL, NULL);

-- --------------------------------------------------------

--
-- Structure de la table `devis_lignes`
--

CREATE TABLE `devis_lignes` (
  `id` int(10) UNSIGNED NOT NULL,
  `devis_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `quantite` int(11) NOT NULL,
  `prix_unitaire` decimal(15,2) NOT NULL,
  `remise` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_ligne_ht` decimal(15,2) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `devis_lignes`
--

INSERT INTO `devis_lignes` (`id`, `devis_id`, `produit_id`, `quantite`, `prix_unitaire`, `remise`, `montant_ligne_ht`) VALUES
(3, 1, 3, 2, 25000.00, 0.00, 50000.00),
(6, 2, 4, 1, 38000.00, 0.00, 38000.00),
(9, 3, 4, 1, 38000.00, 5.00, 37995.00),
(10, 3, 4, 1, 38000.00, 0.00, 38000.00),
(12, 4, 4, 1, 38000.00, 0.00, 38000.00);

-- --------------------------------------------------------

--
-- Structure de la table `familles_produits`
--

CREATE TABLE `familles_produits` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `familles_produits`
--

INSERT INTO `familles_produits` (`id`, `nom`) VALUES
(1, 'Meubles & amÃ©nagements intÃ©rieurs'),
(2, 'Accessoires & quincaillerie de menuiserie'),
(3, 'Machines & Ã©quipements de menuiserie'),
(4, 'Panneaux & matÃ©riaux dâ€™â€™agencement');

-- --------------------------------------------------------

--
-- Structure de la table `formations`
--

CREATE TABLE `formations` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `description` text NOT NULL,
  `tarif_total` decimal(15,2) NOT NULL DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `formations`
--

INSERT INTO `formations` (`id`, `nom`, `description`, `tarif_total`) VALUES
(1, 'Menuiserie moderne', 'Formation pratique en menuiserie et agencement', 150000.00),
(2, 'Agencement intÃ©rieur', 'Techniques dâ€™agencement et dÃ©coration intÃ©rieure', 180000.00);

-- --------------------------------------------------------

--
-- Structure de la table `fournisseurs`
--

CREATE TABLE `fournisseurs` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `contact` varchar(150) DEFAULT NULL,
  `telephone` varchar(50) DEFAULT NULL,
  `email` varchar(150) DEFAULT NULL,
  `adresse` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `fournisseurs`
--

INSERT INTO `fournisseurs` (`id`, `nom`, `contact`, `telephone`, `email`, `adresse`) VALUES
(1, 'Fournisseur GÃ©nÃ©ral KMS', 'Service commercial', '+237600000001', 'fournisseur@kms.local', 'Douala'),
(2, 'Import MatÃ©riaux Pro', 'Responsable achat', '+237600000002', 'imports@kms.local', 'Douala - Zone industrielle');

-- --------------------------------------------------------

--
-- Structure de la table `inscriptions_formation`
--

CREATE TABLE `inscriptions_formation` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_inscription` date NOT NULL,
  `apprenant_nom` varchar(150) NOT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `formation_id` int(10) UNSIGNED NOT NULL,
  `montant_paye` decimal(15,2) NOT NULL DEFAULT 0.00,
  `solde_du` decimal(15,2) NOT NULL DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `inscriptions_formation`
--

INSERT INTO `inscriptions_formation` (`id`, `date_inscription`, `apprenant_nom`, `client_id`, `formation_id`, `montant_paye`, `solde_du`) VALUES
(1, '2025-11-19', 'Martial', NULL, 2, 50000.00, 130000.00),
(2, '2025-11-19', 'Tendop', 3, 2, 150000.00, 30000.00);

-- --------------------------------------------------------

--
-- Structure de la table `journal_caisse`
--

CREATE TABLE `journal_caisse` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_operation` date NOT NULL,
  `numero_piece` varchar(50) NOT NULL,
  `nature_operation` text NOT NULL,
  `sens` enum('RECETTE','DEPENSE') NOT NULL,
  `montant` decimal(15,2) NOT NULL,
  `mode_paiement_id` int(10) UNSIGNED NOT NULL,
  `vente_id` int(10) UNSIGNED DEFAULT NULL,
  `reservation_id` int(10) UNSIGNED DEFAULT NULL,
  `inscription_formation_id` int(10) UNSIGNED DEFAULT NULL,
  `responsable_encaissement_id` int(10) UNSIGNED NOT NULL,
  `observations` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `journal_caisse`
--

INSERT INTO `journal_caisse` (`id`, `date_operation`, `numero_piece`, `nature_operation`, `sens`, `montant`, `mode_paiement_id`, `vente_id`, `reservation_id`, `inscription_formation_id`, `responsable_encaissement_id`, `observations`) VALUES
(1, '2025-11-18', 'RES-1', 'Encaissement rÃ©servation hÃ´tel', 'RECETTE', 35000.00, 4, NULL, 1, NULL, 1, ''),
(2, '2025-11-18', '011', 'rÃ¨glement fournissuer', 'RECETTE', 10000.00, 1, NULL, NULL, NULL, 1, NULL),
(3, '2025-11-19', 'INSCR-1', 'Encaissement inscription formation', 'RECETTE', 50000.00, 3, NULL, NULL, 1, 1, NULL),
(4, '2025-11-20', '5', 'rÃ¨glement fournissuer', 'RECETTE', 10000.00, 4, NULL, NULL, NULL, 1, NULL);

-- --------------------------------------------------------

--
-- Structure de la table `modes_paiement`
--

CREATE TABLE `modes_paiement` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `libelle` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `modes_paiement`
--

INSERT INTO `modes_paiement` (`id`, `code`, `libelle`) VALUES
(1, 'CASH', 'EspÃ¨ces'),
(2, 'VIREMENT', 'Virement bancaire'),
(3, 'MOBILE_MONEY', 'Mobile Money'),
(4, 'CHEQUE', 'ChÃ¨que');

-- --------------------------------------------------------

--
-- Structure de la table `permissions`
--

CREATE TABLE `permissions` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(100) NOT NULL,
  `description` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `permissions`
--

INSERT INTO `permissions` (`id`, `code`, `description`) VALUES
(1, 'PRODUITS_LIRE', 'Consulter le catalogue produits et les stocks'),
(2, 'PRODUITS_CREER', 'CrÃ©er de nouveaux produits'),
(3, 'PRODUITS_MODIFIER', 'Modifier les produits existants'),
(4, 'PRODUITS_SUPPRIMER', 'Supprimer des produits'),
(5, 'CLIENTS_LIRE', 'Consulter les clients / prospects'),
(6, 'CLIENTS_CREER', 'CrÃ©er ou modifier des clients'),
(7, 'DEVIS_LIRE', 'Lister et consulter les devis'),
(8, 'DEVIS_CREER', 'CrÃ©er des devis'),
(9, 'DEVIS_MODIFIER', 'Modifier le statut ou le contenu des devis'),
(10, 'VENTES_LIRE', 'Consulter les ventes et bons de livraison'),
(11, 'VENTES_CREER', 'CrÃ©er des ventes'),
(12, 'VENTES_VALIDER', 'Valider des ventes / livraisons'),
(13, 'CAISSE_LIRE', 'Consulter le journal de caisse'),
(14, 'CAISSE_ECRIRE', 'Enregistrer des opÃ©rations de caisse'),
(15, 'PROMOTIONS_GERER', 'CrÃ©er et gÃ©rer les promotions'),
(16, 'HOTEL_GERER', 'GÃ©rer les rÃ©servations hÃ´tel et upsell'),
(17, 'FORMATION_GERER', 'GÃ©rer les formations et inscriptions'),
(18, 'REPORTING_LIRE', 'AccÃ©der aux tableaux de bord et reporting'),
(19, 'SATISFACTION_GERER', 'GÃ©rer les enquÃªtes de satisfaction client');

-- --------------------------------------------------------

--
-- Structure de la table `produits`
--

CREATE TABLE `produits` (
  `id` int(10) UNSIGNED NOT NULL,
  `code_produit` varchar(100) NOT NULL,
  `famille_id` int(10) UNSIGNED NOT NULL,
  `sous_categorie_id` int(10) UNSIGNED DEFAULT NULL,
  `designation` varchar(255) NOT NULL,
  `caracteristiques` text DEFAULT NULL,
  `description` text DEFAULT NULL,
  `fournisseur_id` int(10) UNSIGNED DEFAULT NULL,
  `localisation` varchar(150) DEFAULT NULL,
  `prix_achat` decimal(15,2) NOT NULL DEFAULT 0.00,
  `prix_vente` decimal(15,2) NOT NULL DEFAULT 0.00,
  `stock_actuel` int(11) NOT NULL DEFAULT 0,
  `seuil_alerte` int(11) NOT NULL DEFAULT 0,
  `image_path` varchar(255) DEFAULT NULL,
  `actif` tinyint(1) NOT NULL DEFAULT 1,
  `date_creation` datetime NOT NULL DEFAULT current_timestamp(),
  `date_modification` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `produits`
--

INSERT INTO `produits` (`id`, `code_produit`, `famille_id`, `sous_categorie_id`, `designation`, `caracteristiques`, `description`, `fournisseur_id`, `localisation`, `prix_achat`, `prix_vente`, `stock_actuel`, `seuil_alerte`, `image_path`, `actif`, `date_creation`, `date_modification`) VALUES
(1, 'MEU-CH-001', 1, 1, 'Lit 2 places avec chevets', 'Dimensions 160x200', 'Lit moderne pour chambre parentale', 1, 'Showroom Douala', 120000.00, 180000.00, 5, 1, NULL, 1, '2025-11-18 11:00:22', NULL),
(2, 'MEU-SAL-001', 1, 2, 'Salon 5 places', 'Structure bois, mousse haute densitÃ©', 'Salon complet 3+1+1', 1, 'Showroom Douala', 200000.00, 280000.00, 2, 1, NULL, 1, '2025-11-18 11:00:22', NULL),
(3, 'ACC-VIS-001', 2, 3, 'Lot de visserie menuiserie', 'Assortiment vis bois', 'Accessoires pour montage de meubles', 2, 'Magasin PK12', 15000.00, 25000.00, 46, 10, NULL, 1, '2025-11-18 11:00:22', NULL),
(4, 'PAN-MEL-001', 4, 5, 'Panneau mÃ©laminÃ© blanc 18mm', '2,75m x 1,83m', 'Panneau pour agencement intÃ©rieur', 2, 'Magasin PK12', 25000.00, 38000.00, 27, 5, NULL, 1, '2025-11-18 11:00:22', NULL);

-- --------------------------------------------------------

--
-- Structure de la table `promotions`
--

CREATE TABLE `promotions` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `description` text DEFAULT NULL,
  `pourcentage_remise` decimal(5,2) DEFAULT NULL,
  `montant_remise` decimal(15,2) DEFAULT NULL,
  `date_debut` date NOT NULL,
  `date_fin` date NOT NULL,
  `actif` tinyint(1) NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Structure de la table `promotion_produit`
--

CREATE TABLE `promotion_produit` (
  `promotion_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Structure de la table `prospections_terrain`
--

CREATE TABLE `prospections_terrain` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_prospection` date NOT NULL,
  `prospect_nom` varchar(150) NOT NULL,
  `secteur` varchar(150) NOT NULL,
  `besoin_identifie` text NOT NULL,
  `action_menee` text NOT NULL,
  `resultat` text NOT NULL,
  `prochaine_etape` text DEFAULT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `commercial_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Structure de la table `prospects_formation`
--

CREATE TABLE `prospects_formation` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_prospect` date NOT NULL,
  `nom_prospect` varchar(150) NOT NULL,
  `contact` varchar(100) NOT NULL,
  `source` varchar(100) DEFAULT NULL,
  `statut_actuel` varchar(100) NOT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `prospects_formation`
--

INSERT INTO `prospects_formation` (`id`, `date_prospect`, `nom_prospect`, `contact`, `source`, `statut_actuel`, `client_id`, `utilisateur_id`) VALUES
(1, '2025-11-01', 'Anicet Mballa', '655585502', 'facebook', 'En cours', NULL, 1);

-- --------------------------------------------------------

--
-- Structure de la table `rendezvous_terrain`
--

CREATE TABLE `rendezvous_terrain` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_rdv` date NOT NULL,
  `heure_rdv` time NOT NULL,
  `client_prospect_nom` varchar(150) NOT NULL,
  `lieu` varchar(150) NOT NULL,
  `objectif` text NOT NULL,
  `statut` enum('PLANIFIE','CONFIRME','ANNULE','HONORE') NOT NULL DEFAULT 'PLANIFIE',
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `commercial_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Structure de la table `reservations_hotel`
--

CREATE TABLE `reservations_hotel` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_reservation` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `chambre_id` int(10) UNSIGNED NOT NULL,
  `date_debut` date NOT NULL,
  `date_fin` date NOT NULL,
  `nb_nuits` int(11) NOT NULL,
  `montant_total` decimal(15,2) NOT NULL DEFAULT 0.00,
  `statut` enum('EN_COURS','TERMINEE','ANNULEE') NOT NULL DEFAULT 'EN_COURS',
  `mode_paiement_id` int(10) UNSIGNED DEFAULT NULL,
  `concierge_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `reservations_hotel`
--

INSERT INTO `reservations_hotel` (`id`, `date_reservation`, `client_id`, `chambre_id`, `date_debut`, `date_fin`, `nb_nuits`, `montant_total`, `statut`, `mode_paiement_id`, `concierge_id`) VALUES
(1, '2025-11-18', 5, 2, '2025-11-18', '2025-11-18', 1, 35000.00, 'EN_COURS', 4, 1),
(2, '2025-11-18', 4, 2, '2025-11-18', '2025-11-20', 2, 70000.00, 'EN_COURS', NULL, 1);

-- --------------------------------------------------------

--
-- Structure de la table `retours_litiges`
--

CREATE TABLE `retours_litiges` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_retour` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `vente_id` int(10) UNSIGNED DEFAULT NULL,
  `motif` text NOT NULL,
  `responsable_suivi_id` int(10) UNSIGNED NOT NULL,
  `statut_traitement` enum('EN_COURS','RESOLU','ABANDONNE') NOT NULL DEFAULT 'EN_COURS',
  `solution` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Structure de la table `roles`
--

CREATE TABLE `roles` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `nom` varchar(100) NOT NULL,
  `description` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `roles`
--

INSERT INTO `roles` (`id`, `code`, `nom`, `description`) VALUES
(1, 'ADMIN', 'Administrateur', 'AccÃ¨s complet Ã  toute lâ€™â€™application'),
(2, 'SHOWROOM', 'Commercial Showroom', 'Gestion des visiteurs, devis et ventes en showroom'),
(3, 'TERRAIN', 'Commercial Terrain', 'Prospection terrain, devis et ventes terrain'),
(4, 'MAGASINIER', 'Magasinier', 'Gestion des stocks, livraisons, ruptures'),
(5, 'CAISSIER', 'Caissier', 'Journal de caisse et encaissements'),
(6, 'DIRECTION', 'Direction', 'Consultation des reportings et indicateurs globaux');

-- --------------------------------------------------------

--
-- Structure de la table `role_permission`
--

CREATE TABLE `role_permission` (
  `role_id` int(10) UNSIGNED NOT NULL,
  `permission_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `role_permission`
--

INSERT INTO `role_permission` (`role_id`, `permission_id`) VALUES
(1, 1),
(1, 2),
(1, 3),
(1, 4),
(1, 5),
(1, 6),
(1, 7),
(1, 8),
(1, 9),
(1, 10),
(1, 11),
(1, 12),
(1, 13),
(1, 14),
(1, 15),
(1, 16),
(1, 17),
(1, 18),
(1, 19),
(2, 1),
(2, 5),
(2, 6),
(2, 7),
(2, 8),
(2, 9),
(2, 10),
(2, 11),
(2, 19),
(3, 1),
(3, 5),
(3, 6),
(3, 7),
(3, 8),
(3, 10),
(3, 11),
(3, 19),
(4, 1),
(4, 3),
(4, 10),
(5, 10),
(5, 13),
(5, 14),
(5, 18),
(6, 1),
(6, 5),
(6, 7),
(6, 10),
(6, 13),
(6, 16),
(6, 17),
(6, 18),
(6, 19);

-- --------------------------------------------------------

--
-- Structure de la table `ruptures_stock`
--

CREATE TABLE `ruptures_stock` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_rapport` date NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `seuil_alerte` int(11) NOT NULL,
  `stock_actuel` int(11) NOT NULL,
  `impact_commercial` text NOT NULL,
  `action_proposee` text NOT NULL,
  `magasinier_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Structure de la table `satisfaction_clients`
--

CREATE TABLE `satisfaction_clients` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_satisfaction` date NOT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `nom_client` varchar(150) NOT NULL,
  `service_utilise` enum('SHOWROOM','HOTEL','FORMATION','TERRAIN','DIGITAL') NOT NULL,
  `note` int(11) NOT NULL,
  `commentaire` text DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `satisfaction_clients`
--

INSERT INTO `satisfaction_clients` (`id`, `date_satisfaction`, `client_id`, `nom_client`, `service_utilise`, `note`, `commentaire`, `utilisateur_id`) VALUES
(1, '2025-11-19', NULL, 'apprenant', 'FORMATION', 4, '', 1),
(2, '2025-11-20', 4, 'Client HÃ´tel Test', 'FORMATION', 2, 'grincheux et deÃ§u', 1);

-- --------------------------------------------------------

--
-- Structure de la table `sous_categories_produits`
--

CREATE TABLE `sous_categories_produits` (
  `id` int(10) UNSIGNED NOT NULL,
  `famille_id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `sous_categories_produits`
--

INSERT INTO `sous_categories_produits` (`id`, `famille_id`, `nom`) VALUES
(1, 1, 'Chambres Ã  coucher'),
(2, 1, 'Salons'),
(3, 2, 'Quincaillerie standard'),
(4, 3, 'Machines de dÃ©coupe'),
(5, 4, 'Panneaux mÃ©laminÃ©s');

-- --------------------------------------------------------

--
-- Structure de la table `stocks_mouvements`
--

CREATE TABLE `stocks_mouvements` (
  `id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `date_mouvement` datetime NOT NULL DEFAULT current_timestamp(),
  `type_mouvement` enum('ENTREE','SORTIE','AJUSTEMENT') NOT NULL,
  `quantite` int(11) NOT NULL,
  `source_type` varchar(50) DEFAULT NULL,
  `source_id` int(11) DEFAULT NULL,
  `commentaire` text DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `stocks_mouvements`
--

INSERT INTO `stocks_mouvements` (`id`, `produit_id`, `date_mouvement`, `type_mouvement`, `quantite`, `source_type`, `source_id`, `commentaire`, `utilisateur_id`) VALUES
(1, 1, '2025-11-18 11:00:22', 'ENTREE', 5, 'INVENTAIRE', NULL, 'Stock initial lit 2 places', 1),
(2, 2, '2025-11-18 11:00:22', 'ENTREE', 3, 'INVENTAIRE', NULL, 'Stock initial salon', 1),
(3, 3, '2025-11-18 11:00:22', 'ENTREE', 50, 'INVENTAIRE', NULL, 'Stock initial visserie', 1),
(4, 4, '2025-11-18 11:00:22', 'ENTREE', 30, 'INVENTAIRE', NULL, 'Stock initial panneaux', 1),
(5, 4, '2025-11-18 12:36:29', 'SORTIE', 2, 'VENTE', 2, 'Sortie via BL BL-20251118-123629', 1),
(6, 2, '2025-11-18 12:37:39', 'SORTIE', 1, 'VENTE', 1, 'Sortie via BL BL-20251118-123739', 1),
(7, 3, '2025-11-18 14:00:08', 'SORTIE', 2, 'VENTE', 3, 'Sortie via BL BL-20251118-140008', 1),
(8, 3, '2025-11-18 15:18:54', 'SORTIE', 2, 'VENTE', 4, 'Sortie via BL BL-20251118-151854', 1),
(9, 4, '2025-11-20 12:23:39', 'SORTIE', 1, 'VENTE', 16, 'Sortie via BL BL-20251120-122339', 1);

-- --------------------------------------------------------

--
-- Structure de la table `types_client`
--

CREATE TABLE `types_client` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `libelle` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `types_client`
--

INSERT INTO `types_client` (`id`, `code`, `libelle`) VALUES
(1, 'SHOWROOM', 'Client / prospect showroom'),
(2, 'TERRAIN', 'Client / prospect terrain'),
(3, 'DIGITAL', 'Client issu du digital (rÃ©seaux sociaux, site, CRM)'),
(4, 'HOTEL', 'Client hÃ©bergement / hÃ´tel'),
(5, 'FORMATION', 'Apprenant / client formation');

-- --------------------------------------------------------

--
-- Structure de la table `upsell_hotel`
--

CREATE TABLE `upsell_hotel` (
  `id` int(10) UNSIGNED NOT NULL,
  `reservation_id` int(10) UNSIGNED NOT NULL,
  `service_additionnel` varchar(150) NOT NULL,
  `montant` decimal(15,2) NOT NULL DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Structure de la table `utilisateurs`
--

CREATE TABLE `utilisateurs` (
  `id` int(10) UNSIGNED NOT NULL,
  `login` varchar(100) NOT NULL,
  `mot_de_passe_hash` varchar(255) NOT NULL,
  `nom_complet` varchar(150) NOT NULL,
  `email` varchar(150) DEFAULT NULL,
  `telephone` varchar(50) DEFAULT NULL,
  `actif` tinyint(1) NOT NULL DEFAULT 1,
  `date_creation` datetime NOT NULL DEFAULT current_timestamp(),
  `date_derniere_connexion` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `utilisateurs`
--

INSERT INTO `utilisateurs` (`id`, `login`, `mot_de_passe_hash`, `nom_complet`, `email`, `telephone`, `actif`, `date_creation`, `date_derniere_connexion`) VALUES
(1, 'admin', '$2b$10$j6YYUX.QLOxOoBn9eB4rJu8/ye4/NOEXPvRjcYhUY4mBiaZZFUrTi', 'Administrateur KMS', 'admin@kms.local', NULL, 1, '2025-11-18 10:59:28', '2025-11-20 11:07:05');

-- --------------------------------------------------------

--
-- Structure de la table `utilisateur_role`
--

CREATE TABLE `utilisateur_role` (
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `role_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `utilisateur_role`
--

INSERT INTO `utilisateur_role` (`utilisateur_id`, `role_id`) VALUES
(1, 1);

-- --------------------------------------------------------

--
-- Structure de la table `ventes`
--

CREATE TABLE `ventes` (
  `id` int(10) UNSIGNED NOT NULL,
  `numero` varchar(50) NOT NULL,
  `date_vente` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `canal_vente_id` int(10) UNSIGNED NOT NULL,
  `devis_id` int(10) UNSIGNED DEFAULT NULL,
  `statut` enum('EN_ATTENTE_LIVRAISON','LIVREE','ANNULEE','PARTIELLEMENT_LIVREE') NOT NULL DEFAULT 'EN_ATTENTE_LIVRAISON',
  `montant_total_ht` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_total_ttc` decimal(15,2) NOT NULL DEFAULT 0.00,
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `commentaires` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `ventes`
--

INSERT INTO `ventes` (`id`, `numero`, `date_vente`, `client_id`, `canal_vente_id`, `devis_id`, `statut`, `montant_total_ht`, `montant_total_ttc`, `utilisateur_id`, `commentaires`) VALUES
(1, 'V-20251118-114131', '2025-11-18', 3, 3, NULL, 'LIVREE', 200000.00, 238500.00, 1, NULL),
(2, 'V-20251118-122137', '2025-11-18', 2, 2, NULL, 'LIVREE', 1499994.00, 1788742.85, 1, NULL),
(3, 'V-20251118-135949', '2025-11-18', 5, 3, 1, 'LIVREE', 50000.00, 50000.00, 1, 'Vente issue du devis DV-20251118-135909'),
(4, 'V-20251118-151825', '2025-11-18', 5, 3, 1, 'LIVREE', 50000.00, 50000.00, 1, 'Vente issue du devis DV-20251118-135909'),
(5, 'V-20251118-155819', '2025-11-18', 5, 3, NULL, 'EN_ATTENTE_LIVRAISON', 50000.00, 59625.00, 1, NULL),
(6, 'V-20251120-105356', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(7, 'V-20251120-112512', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(8, 'V-20251120-112647', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(9, 'V-20251120-112839', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(10, 'V-20251120-112933', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(11, 'V-20251120-112955', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(12, 'V-20251120-113037', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(13, 'V-20251120-114844', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(14, 'V-20251120-115447', '2025-11-20', 2, 3, 2, 'EN_ATTENTE_LIVRAISON', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-105327'),
(15, 'V-20251120-120452', '2025-11-20', 5, 3, 3, 'EN_ATTENTE_LIVRAISON', 75995.00, 75995.00, 1, 'Vente issue du devis DV-20251120-120352'),
(16, 'V-20251120-122303', '2025-11-20', 2, 3, 4, 'LIVREE', 38000.00, 38000.00, 1, 'Vente issue du devis DV-20251120-122248');

-- --------------------------------------------------------

--
-- Structure de la table `ventes_lignes`
--

CREATE TABLE `ventes_lignes` (
  `id` int(10) UNSIGNED NOT NULL,
  `vente_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `quantite` int(11) NOT NULL,
  `prix_unitaire` decimal(15,2) NOT NULL,
  `remise` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_ligne_ht` decimal(15,2) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- DÃ©chargement des donnÃ©es de la table `ventes_lignes`
--

INSERT INTO `ventes_lignes` (`id`, `vente_id`, `produit_id`, `quantite`, `prix_unitaire`, `remise`, `montant_ligne_ht`) VALUES
(2, 1, 2, 1, 200000.00, 0.00, 200000.00),
(4, 2, 4, 2, 750000.00, 6.00, 1499994.00),
(5, 3, 3, 2, 25000.00, 0.00, 50000.00),
(6, 4, 3, 2, 25000.00, 0.00, 50000.00),
(7, 5, 3, 2, 25000.00, 0.00, 50000.00),
(8, 6, 4, 1, 38000.00, 0.00, 38000.00),
(9, 7, 4, 1, 38000.00, 0.00, 38000.00),
(10, 8, 4, 1, 38000.00, 0.00, 38000.00),
(11, 9, 4, 1, 38000.00, 0.00, 38000.00),
(12, 10, 4, 1, 38000.00, 0.00, 38000.00),
(13, 11, 4, 1, 38000.00, 0.00, 38000.00),
(14, 12, 4, 1, 38000.00, 0.00, 38000.00),
(15, 13, 4, 1, 38000.00, 0.00, 38000.00),
(16, 14, 4, 1, 38000.00, 0.00, 38000.00),
(17, 15, 4, 1, 38000.00, 5.00, 37995.00),
(18, 15, 4, 1, 38000.00, 0.00, 38000.00),
(19, 16, 4, 1, 38000.00, 0.00, 38000.00);

-- --------------------------------------------------------

--
-- Structure de la table `visiteurs_hotel`
--

CREATE TABLE `visiteurs_hotel` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_visite` date NOT NULL,
  `nom_visiteur` varchar(150) NOT NULL,
  `telephone` varchar(50) DEFAULT NULL,
  `email` varchar(150) DEFAULT NULL,
  `motif` text NOT NULL,
  `service_solicite` varchar(150) NOT NULL,
  `orientation` varchar(150) DEFAULT NULL,
  `concierge_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Structure de la table `visiteurs_showroom`
--

CREATE TABLE `visiteurs_showroom` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_visite` date NOT NULL,
  `client_nom` varchar(150) NOT NULL,
  `contact` varchar(100) NOT NULL,
  `produit_interet` text DEFAULT NULL,
  `orientation` varchar(100) DEFAULT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Index pour les tables dÃ©chargÃ©es
--

--
-- Index pour la table `bons_livraison`
--
ALTER TABLE `bons_livraison`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `numero` (`numero`),
  ADD KEY `fk_bl_vente` (`vente_id`),
  ADD KEY `fk_bl_client` (`client_id`),
  ADD KEY `fk_bl_magasinier` (`magasinier_id`),
  ADD KEY `idx_bl_date` (`date_bl`);

--
-- Index pour la table `bons_livraison_lignes`
--
ALTER TABLE `bons_livraison_lignes`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_bl_lignes_bl` (`bon_livraison_id`),
  ADD KEY `fk_bl_lignes_produit` (`produit_id`);

--
-- Index pour la table `canaux_vente`
--
ALTER TABLE `canaux_vente`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Index pour la table `chambres`
--
ALTER TABLE `chambres`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Index pour la table `clients`
--
ALTER TABLE `clients`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_clients_type` (`type_client_id`),
  ADD KEY `idx_clients_nom` (`nom`);

--
-- Index pour la table `connexions_utilisateur`
--
ALTER TABLE `connexions_utilisateur`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_connexions_utilisateur_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_connexions_utilisateur_date` (`date_connexion`);

--
-- Index pour la table `devis`
--
ALTER TABLE `devis`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `numero` (`numero`),
  ADD KEY `fk_devis_client` (`client_id`),
  ADD KEY `fk_devis_canal` (`canal_vente_id`),
  ADD KEY `fk_devis_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_devis_date` (`date_devis`),
  ADD KEY `idx_devis_statut` (`statut`);

--
-- Index pour la table `devis_lignes`
--
ALTER TABLE `devis_lignes`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_devis_lignes_devis` (`devis_id`),
  ADD KEY `fk_devis_lignes_produit` (`produit_id`);

--
-- Index pour la table `familles_produits`
--
ALTER TABLE `familles_produits`
  ADD PRIMARY KEY (`id`);

--
-- Index pour la table `formations`
--
ALTER TABLE `formations`
  ADD PRIMARY KEY (`id`);

--
-- Index pour la table `fournisseurs`
--
ALTER TABLE `fournisseurs`
  ADD PRIMARY KEY (`id`);

--
-- Index pour la table `inscriptions_formation`
--
ALTER TABLE `inscriptions_formation`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_inscription_client` (`client_id`),
  ADD KEY `fk_inscription_formation` (`formation_id`),
  ADD KEY `idx_inscription_date` (`date_inscription`);

--
-- Index pour la table `journal_caisse`
--
ALTER TABLE `journal_caisse`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_caisse_mode_paiement` (`mode_paiement_id`),
  ADD KEY `fk_caisse_vente` (`vente_id`),
  ADD KEY `fk_caisse_reservation` (`reservation_id`),
  ADD KEY `fk_caisse_inscription` (`inscription_formation_id`),
  ADD KEY `fk_caisse_responsable` (`responsable_encaissement_id`),
  ADD KEY `idx_caisse_date` (`date_operation`);

--
-- Index pour la table `modes_paiement`
--
ALTER TABLE `modes_paiement`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Index pour la table `permissions`
--
ALTER TABLE `permissions`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Index pour la table `produits`
--
ALTER TABLE `produits`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code_produit` (`code_produit`),
  ADD KEY `fk_produits_famille` (`famille_id`),
  ADD KEY `fk_produits_sous_categorie` (`sous_categorie_id`),
  ADD KEY `fk_produits_fournisseur` (`fournisseur_id`),
  ADD KEY `idx_produits_designation` (`designation`),
  ADD KEY `idx_produits_code` (`code_produit`);

--
-- Index pour la table `promotions`
--
ALTER TABLE `promotions`
  ADD PRIMARY KEY (`id`);

--
-- Index pour la table `promotion_produit`
--
ALTER TABLE `promotion_produit`
  ADD PRIMARY KEY (`promotion_id`,`produit_id`),
  ADD KEY `fk_promo_produit_produit` (`produit_id`);

--
-- Index pour la table `prospections_terrain`
--
ALTER TABLE `prospections_terrain`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_prospections_client` (`client_id`),
  ADD KEY `fk_prospections_commercial` (`commercial_id`),
  ADD KEY `idx_prospections_date` (`date_prospection`);

--
-- Index pour la table `prospects_formation`
--
ALTER TABLE `prospects_formation`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_prospect_formation_client` (`client_id`),
  ADD KEY `fk_prospect_formation_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_prospect_formation_date` (`date_prospect`);

--
-- Index pour la table `rendezvous_terrain`
--
ALTER TABLE `rendezvous_terrain`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_rdv_client` (`client_id`),
  ADD KEY `fk_rdv_commercial` (`commercial_id`),
  ADD KEY `idx_rdv_date` (`date_rdv`);

--
-- Index pour la table `reservations_hotel`
--
ALTER TABLE `reservations_hotel`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_reservation_client` (`client_id`),
  ADD KEY `fk_reservation_chambre` (`chambre_id`),
  ADD KEY `fk_reservation_mode_paiement` (`mode_paiement_id`),
  ADD KEY `fk_reservation_concierge` (`concierge_id`),
  ADD KEY `idx_reservation_dates` (`date_debut`,`date_fin`);

--
-- Index pour la table `retours_litiges`
--
ALTER TABLE `retours_litiges`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_litiges_client` (`client_id`),
  ADD KEY `fk_litiges_produit` (`produit_id`),
  ADD KEY `fk_litiges_vente` (`vente_id`),
  ADD KEY `fk_litiges_responsable` (`responsable_suivi_id`);

--
-- Index pour la table `roles`
--
ALTER TABLE `roles`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Index pour la table `role_permission`
--
ALTER TABLE `role_permission`
  ADD PRIMARY KEY (`role_id`,`permission_id`),
  ADD KEY `fk_role_permission_permission` (`permission_id`);

--
-- Index pour la table `ruptures_stock`
--
ALTER TABLE `ruptures_stock`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_ruptures_produit` (`produit_id`),
  ADD KEY `fk_ruptures_magasinier` (`magasinier_id`),
  ADD KEY `idx_ruptures_date` (`date_rapport`);

--
-- Index pour la table `satisfaction_clients`
--
ALTER TABLE `satisfaction_clients`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_satisfaction_client` (`client_id`),
  ADD KEY `fk_satisfaction_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_satisfaction_date` (`date_satisfaction`);

--
-- Index pour la table `sous_categories_produits`
--
ALTER TABLE `sous_categories_produits`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_sous_categories_famille` (`famille_id`);

--
-- Index pour la table `stocks_mouvements`
--
ALTER TABLE `stocks_mouvements`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_mouvements_produit` (`produit_id`),
  ADD KEY `fk_mouvements_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_mouvements_date` (`date_mouvement`);

--
-- Index pour la table `types_client`
--
ALTER TABLE `types_client`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Index pour la table `upsell_hotel`
--
ALTER TABLE `upsell_hotel`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_upsell_reservation` (`reservation_id`);

--
-- Index pour la table `utilisateurs`
--
ALTER TABLE `utilisateurs`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `login` (`login`);

--
-- Index pour la table `utilisateur_role`
--
ALTER TABLE `utilisateur_role`
  ADD PRIMARY KEY (`utilisateur_id`,`role_id`),
  ADD KEY `fk_utilisateur_role_role` (`role_id`);

--
-- Index pour la table `ventes`
--
ALTER TABLE `ventes`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `numero` (`numero`),
  ADD KEY `fk_ventes_client` (`client_id`),
  ADD KEY `fk_ventes_canal` (`canal_vente_id`),
  ADD KEY `fk_ventes_devis` (`devis_id`),
  ADD KEY `fk_ventes_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_ventes_date` (`date_vente`),
  ADD KEY `idx_ventes_statut` (`statut`);

--
-- Index pour la table `ventes_lignes`
--
ALTER TABLE `ventes_lignes`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_ventes_lignes_vente` (`vente_id`),
  ADD KEY `fk_ventes_lignes_produit` (`produit_id`);

--
-- Index pour la table `visiteurs_hotel`
--
ALTER TABLE `visiteurs_hotel`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_visiteurs_hotel_concierge` (`concierge_id`),
  ADD KEY `idx_visiteurs_hotel_date` (`date_visite`);

--
-- Index pour la table `visiteurs_showroom`
--
ALTER TABLE `visiteurs_showroom`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_visiteurs_client` (`client_id`),
  ADD KEY `fk_visiteurs_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_visiteurs_date` (`date_visite`);

--
-- AUTO_INCREMENT pour les tables dÃ©chargÃ©es
--

--
-- AUTO_INCREMENT pour la table `bons_livraison`
--
ALTER TABLE `bons_livraison`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT pour la table `bons_livraison_lignes`
--
ALTER TABLE `bons_livraison_lignes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT pour la table `canaux_vente`
--
ALTER TABLE `canaux_vente`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT pour la table `chambres`
--
ALTER TABLE `chambres`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT pour la table `clients`
--
ALTER TABLE `clients`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=7;

--
-- AUTO_INCREMENT pour la table `connexions_utilisateur`
--
ALTER TABLE `connexions_utilisateur`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=13;

--
-- AUTO_INCREMENT pour la table `devis`
--
ALTER TABLE `devis`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=5;

--
-- AUTO_INCREMENT pour la table `devis_lignes`
--
ALTER TABLE `devis_lignes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=13;

--
-- AUTO_INCREMENT pour la table `familles_produits`
--
ALTER TABLE `familles_produits`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=5;

--
-- AUTO_INCREMENT pour la table `formations`
--
ALTER TABLE `formations`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT pour la table `fournisseurs`
--
ALTER TABLE `fournisseurs`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT pour la table `inscriptions_formation`
--
ALTER TABLE `inscriptions_formation`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT pour la table `journal_caisse`
--
ALTER TABLE `journal_caisse`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=5;

--
-- AUTO_INCREMENT pour la table `modes_paiement`
--
ALTER TABLE `modes_paiement`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=5;

--
-- AUTO_INCREMENT pour la table `permissions`
--
ALTER TABLE `permissions`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=20;

--
-- AUTO_INCREMENT pour la table `produits`
--
ALTER TABLE `produits`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=5;

--
-- AUTO_INCREMENT pour la table `promotions`
--
ALTER TABLE `promotions`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT pour la table `prospections_terrain`
--
ALTER TABLE `prospections_terrain`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT pour la table `prospects_formation`
--
ALTER TABLE `prospects_formation`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT pour la table `rendezvous_terrain`
--
ALTER TABLE `rendezvous_terrain`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT pour la table `reservations_hotel`
--
ALTER TABLE `reservations_hotel`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT pour la table `retours_litiges`
--
ALTER TABLE `retours_litiges`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT pour la table `roles`
--
ALTER TABLE `roles`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=7;

--
-- AUTO_INCREMENT pour la table `ruptures_stock`
--
ALTER TABLE `ruptures_stock`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT pour la table `satisfaction_clients`
--
ALTER TABLE `satisfaction_clients`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT pour la table `sous_categories_produits`
--
ALTER TABLE `sous_categories_produits`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT pour la table `stocks_mouvements`
--
ALTER TABLE `stocks_mouvements`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=10;

--
-- AUTO_INCREMENT pour la table `types_client`
--
ALTER TABLE `types_client`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT pour la table `upsell_hotel`
--
ALTER TABLE `upsell_hotel`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT pour la table `utilisateurs`
--
ALTER TABLE `utilisateurs`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT pour la table `ventes`
--
ALTER TABLE `ventes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=17;

--
-- AUTO_INCREMENT pour la table `ventes_lignes`
--
ALTER TABLE `ventes_lignes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=20;

--
-- AUTO_INCREMENT pour la table `visiteurs_hotel`
--
ALTER TABLE `visiteurs_hotel`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT pour la table `visiteurs_showroom`
--
ALTER TABLE `visiteurs_showroom`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- Contraintes pour les tables dÃ©chargÃ©es
--

--
-- Contraintes pour la table `bons_livraison`
--
ALTER TABLE `bons_livraison`
  ADD CONSTRAINT `fk_bl_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_bl_magasinier` FOREIGN KEY (`magasinier_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_bl_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Contraintes pour la table `bons_livraison_lignes`
--
ALTER TABLE `bons_livraison_lignes`
  ADD CONSTRAINT `fk_bl_lignes_bl` FOREIGN KEY (`bon_livraison_id`) REFERENCES `bons_livraison` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_bl_lignes_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `clients`
--
ALTER TABLE `clients`
  ADD CONSTRAINT `fk_clients_type` FOREIGN KEY (`type_client_id`) REFERENCES `types_client` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `connexions_utilisateur`
--
ALTER TABLE `connexions_utilisateur`
  ADD CONSTRAINT `fk_connexions_utilisateur_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Contraintes pour la table `devis`
--
ALTER TABLE `devis`
  ADD CONSTRAINT `fk_devis_canal` FOREIGN KEY (`canal_vente_id`) REFERENCES `canaux_vente` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_devis_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_devis_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `devis_lignes`
--
ALTER TABLE `devis_lignes`
  ADD CONSTRAINT `fk_devis_lignes_devis` FOREIGN KEY (`devis_id`) REFERENCES `devis` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_devis_lignes_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `inscriptions_formation`
--
ALTER TABLE `inscriptions_formation`
  ADD CONSTRAINT `fk_inscription_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_inscription_formation` FOREIGN KEY (`formation_id`) REFERENCES `formations` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `journal_caisse`
--
ALTER TABLE `journal_caisse`
  ADD CONSTRAINT `fk_caisse_inscription` FOREIGN KEY (`inscription_formation_id`) REFERENCES `inscriptions_formation` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_mode_paiement` FOREIGN KEY (`mode_paiement_id`) REFERENCES `modes_paiement` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_reservation` FOREIGN KEY (`reservation_id`) REFERENCES `reservations_hotel` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_responsable` FOREIGN KEY (`responsable_encaissement_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Contraintes pour la table `produits`
--
ALTER TABLE `produits`
  ADD CONSTRAINT `fk_produits_famille` FOREIGN KEY (`famille_id`) REFERENCES `familles_produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_produits_fournisseur` FOREIGN KEY (`fournisseur_id`) REFERENCES `fournisseurs` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_produits_sous_categorie` FOREIGN KEY (`sous_categorie_id`) REFERENCES `sous_categories_produits` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Contraintes pour la table `promotion_produit`
--
ALTER TABLE `promotion_produit`
  ADD CONSTRAINT `fk_promo_produit_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_promo_produit_promo` FOREIGN KEY (`promotion_id`) REFERENCES `promotions` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Contraintes pour la table `prospections_terrain`
--
ALTER TABLE `prospections_terrain`
  ADD CONSTRAINT `fk_prospections_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_prospections_commercial` FOREIGN KEY (`commercial_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `prospects_formation`
--
ALTER TABLE `prospects_formation`
  ADD CONSTRAINT `fk_prospect_formation_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_prospect_formation_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `rendezvous_terrain`
--
ALTER TABLE `rendezvous_terrain`
  ADD CONSTRAINT `fk_rdv_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_rdv_commercial` FOREIGN KEY (`commercial_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `reservations_hotel`
--
ALTER TABLE `reservations_hotel`
  ADD CONSTRAINT `fk_reservation_chambre` FOREIGN KEY (`chambre_id`) REFERENCES `chambres` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_reservation_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_reservation_concierge` FOREIGN KEY (`concierge_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_reservation_mode_paiement` FOREIGN KEY (`mode_paiement_id`) REFERENCES `modes_paiement` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Contraintes pour la table `retours_litiges`
--
ALTER TABLE `retours_litiges`
  ADD CONSTRAINT `fk_litiges_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_litiges_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_litiges_responsable` FOREIGN KEY (`responsable_suivi_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_litiges_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Contraintes pour la table `role_permission`
--
ALTER TABLE `role_permission`
  ADD CONSTRAINT `fk_role_permission_permission` FOREIGN KEY (`permission_id`) REFERENCES `permissions` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_role_permission_role` FOREIGN KEY (`role_id`) REFERENCES `roles` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Contraintes pour la table `ruptures_stock`
--
ALTER TABLE `ruptures_stock`
  ADD CONSTRAINT `fk_ruptures_magasinier` FOREIGN KEY (`magasinier_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ruptures_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `satisfaction_clients`
--
ALTER TABLE `satisfaction_clients`
  ADD CONSTRAINT `fk_satisfaction_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_satisfaction_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `sous_categories_produits`
--
ALTER TABLE `sous_categories_produits`
  ADD CONSTRAINT `fk_sous_categories_famille` FOREIGN KEY (`famille_id`) REFERENCES `familles_produits` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `stocks_mouvements`
--
ALTER TABLE `stocks_mouvements`
  ADD CONSTRAINT `fk_mouvements_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_mouvements_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `upsell_hotel`
--
ALTER TABLE `upsell_hotel`
  ADD CONSTRAINT `fk_upsell_reservation` FOREIGN KEY (`reservation_id`) REFERENCES `reservations_hotel` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Contraintes pour la table `utilisateur_role`
--
ALTER TABLE `utilisateur_role`
  ADD CONSTRAINT `fk_utilisateur_role_role` FOREIGN KEY (`role_id`) REFERENCES `roles` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_utilisateur_role_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Contraintes pour la table `ventes`
--
ALTER TABLE `ventes`
  ADD CONSTRAINT `fk_ventes_canal` FOREIGN KEY (`canal_vente_id`) REFERENCES `canaux_vente` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_devis` FOREIGN KEY (`devis_id`) REFERENCES `devis` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `ventes_lignes`
--
ALTER TABLE `ventes_lignes`
  ADD CONSTRAINT `fk_ventes_lignes_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_lignes_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Contraintes pour la table `visiteurs_hotel`
--
ALTER TABLE `visiteurs_hotel`
  ADD CONSTRAINT `fk_visiteurs_hotel_concierge` FOREIGN KEY (`concierge_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Contraintes pour la table `visiteurs_showroom`
--
ALTER TABLE `visiteurs_showroom`
  ADD CONSTRAINT `fk_visiteurs_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_visiteurs_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;
COMMIT;

/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;



===== FICHIER : db\schema.sql =====

-- phpMyAdmin SQL Dump
-- version 5.2.1
-- https://www.phpmyadmin.net/
--
-- Host: 127.0.0.1
-- Generation Time: Nov 17, 2025 at 05:41 PM
-- Server version: 10.4.32-MariaDB
-- PHP Version: 8.2.12

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
START TRANSACTION;
SET time_zone = "+00:00";


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;

--
-- Database: `kms_gestion`
--

-- --------------------------------------------------------

--
-- Table structure for table `bons_livraison`
--

CREATE TABLE `bons_livraison` (
  `id` int(10) UNSIGNED NOT NULL,
  `numero` varchar(50) NOT NULL,
  `date_bl` date NOT NULL,
  `vente_id` int(10) UNSIGNED DEFAULT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `transport_assure_par` varchar(150) DEFAULT NULL,
  `observations` text DEFAULT NULL,
  `signe_client` tinyint(1) NOT NULL DEFAULT 0,
  `magasinier_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `bons_livraison_lignes`
--

CREATE TABLE `bons_livraison_lignes` (
  `id` int(10) UNSIGNED NOT NULL,
  `bon_livraison_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `quantite` int(11) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `canaux_vente`
--

CREATE TABLE `canaux_vente` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `libelle` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `canaux_vente`
--

INSERT INTO `canaux_vente` (`id`, `code`, `libelle`) VALUES
(1, 'SHOWROOM', 'Vente showroom'),
(2, 'TERRAIN', 'Vente terrain'),
(3, 'DIGITAL', 'Vente digital / en ligne'),
(4, 'HOTEL', 'Vente liÃ©e Ã  lâ€™â€™hÃ´tel'),
(5, 'FORMATION', 'Vente liÃ©e aux formations');

-- --------------------------------------------------------

--
-- Table structure for table `chambres`
--

CREATE TABLE `chambres` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `description` text DEFAULT NULL,
  `tarif_nuite` decimal(15,2) NOT NULL DEFAULT 0.00,
  `actif` tinyint(1) NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `chambres`
--

INSERT INTO `chambres` (`id`, `code`, `description`, `tarif_nuite`, `actif`) VALUES
(1, 'CH-101', 'Chambre standard lit double', 20000.00, 1),
(2, 'APP-201', 'Appartement meublÃ© 2 piÃ¨ces', 35000.00, 1);

-- --------------------------------------------------------

--
-- Table structure for table `clients`
--

CREATE TABLE `clients` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `type_client_id` int(10) UNSIGNED NOT NULL,
  `telephone` varchar(50) DEFAULT NULL,
  `email` varchar(150) DEFAULT NULL,
  `adresse` text DEFAULT NULL,
  `source` varchar(100) DEFAULT NULL,
  `statut` enum('PROSPECT','CLIENT','APPRENANT','HOTE') NOT NULL DEFAULT 'PROSPECT',
  `date_creation` datetime NOT NULL DEFAULT current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `clients`
--

INSERT INTO `clients` (`id`, `nom`, `type_client_id`, `telephone`, `email`, `adresse`, `source`, `statut`, `date_creation`) VALUES
(1, 'Client Showroom Test', 1, '+237650000001', 'client.showroom@test.local', 'Douala', 'Showroom', 'CLIENT', '2025-11-17 17:25:20'),
(2, 'Client Terrain Test', 2, '+237650000002', 'client.terrain@test.local', 'BonabÃ©ri', 'Terrain', 'PROSPECT', '2025-11-17 17:25:20'),
(3, 'Client Digital Test', 3, '+237650000003', 'client.digital@test.local', 'YaoundÃ©', 'Facebook', 'CLIENT', '2025-11-17 17:25:20'),
(4, 'Client HÃ´tel Test', 4, '+237650000004', 'client.hotel@test.local', 'Douala', 'RÃ©servation directe', 'HOTE', '2025-11-17 17:25:20'),
(5, 'Apprenant Formation', 5, '+237650000005', 'apprenant@test.local', 'Bafoussam', 'WhatsApp', 'APPRENANT', '2025-11-17 17:25:20');

-- --------------------------------------------------------

--
-- Table structure for table `connexions_utilisateur`
--

CREATE TABLE `connexions_utilisateur` (
  `id` int(10) UNSIGNED NOT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `date_connexion` datetime NOT NULL DEFAULT current_timestamp(),
  `adresse_ip` varchar(100) NOT NULL,
  `user_agent` varchar(255) NOT NULL,
  `succes` tinyint(1) NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `connexions_utilisateur`
--

INSERT INTO `connexions_utilisateur` (`id`, `utilisateur_id`, `date_connexion`, `adresse_ip`, `user_agent`, `succes`) VALUES
(1, 1, '2025-11-17 17:37:35', '::1', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0', 1);

-- --------------------------------------------------------

--
-- Table structure for table `devis`
--

CREATE TABLE `devis` (
  `id` int(10) UNSIGNED NOT NULL,
  `numero` varchar(50) NOT NULL,
  `date_devis` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `canal_vente_id` int(10) UNSIGNED NOT NULL,
  `statut` enum('EN_ATTENTE','ACCEPTE','REFUSE','ANNULE') NOT NULL DEFAULT 'EN_ATTENTE',
  `date_relance` date DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `montant_total_ht` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_total_ttc` decimal(15,2) NOT NULL DEFAULT 0.00,
  `remise_global` decimal(15,2) NOT NULL DEFAULT 0.00,
  `conditions` text DEFAULT NULL,
  `commentaires` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `devis_lignes`
--

CREATE TABLE `devis_lignes` (
  `id` int(10) UNSIGNED NOT NULL,
  `devis_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `quantite` int(11) NOT NULL,
  `prix_unitaire` decimal(15,2) NOT NULL,
  `remise` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_ligne_ht` decimal(15,2) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `familles_produits`
--

CREATE TABLE `familles_produits` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `familles_produits`
--

INSERT INTO `familles_produits` (`id`, `nom`) VALUES
(1, 'Meubles & amÃ©nagements intÃ©rieurs'),
(2, 'Accessoires & quincaillerie de menuiserie'),
(3, 'Machines & Ã©quipements de menuiserie'),
(4, 'Panneaux & matÃ©riaux dâ€™â€™agencement');

-- --------------------------------------------------------

--
-- Table structure for table `formations`
--

CREATE TABLE `formations` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `description` text NOT NULL,
  `tarif_total` decimal(15,2) NOT NULL DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `formations`
--

INSERT INTO `formations` (`id`, `nom`, `description`, `tarif_total`) VALUES
(1, 'Menuiserie moderne', 'Formation pratique en menuiserie et agencement', 150000.00),
(2, 'Agencement intÃ©rieur', 'Techniques dâ€™agencement et dÃ©coration intÃ©rieure', 180000.00);

-- --------------------------------------------------------

--
-- Table structure for table `fournisseurs`
--

CREATE TABLE `fournisseurs` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `contact` varchar(150) DEFAULT NULL,
  `telephone` varchar(50) DEFAULT NULL,
  `email` varchar(150) DEFAULT NULL,
  `adresse` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `fournisseurs`
--

INSERT INTO `fournisseurs` (`id`, `nom`, `contact`, `telephone`, `email`, `adresse`) VALUES
(1, 'Fournisseur GÃ©nÃ©ral KMS', 'Service commercial', '+237600000001', 'fournisseur@kms.local', 'Douala'),
(2, 'Import MatÃ©riaux Pro', 'Responsable achat', '+237600000002', 'imports@kms.local', 'Douala - Zone industrielle');

-- --------------------------------------------------------

--
-- Table structure for table `inscriptions_formation`
--

CREATE TABLE `inscriptions_formation` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_inscription` date NOT NULL,
  `apprenant_nom` varchar(150) NOT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `formation_id` int(10) UNSIGNED NOT NULL,
  `montant_paye` decimal(15,2) NOT NULL DEFAULT 0.00,
  `solde_du` decimal(15,2) NOT NULL DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `journal_caisse`
--

CREATE TABLE `journal_caisse` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_operation` date NOT NULL,
  `numero_piece` varchar(50) NOT NULL,
  `nature_operation` text NOT NULL,
  `sens` enum('RECETTE','DEPENSE') NOT NULL,
  `montant` decimal(15,2) NOT NULL,
  `mode_paiement_id` int(10) UNSIGNED NOT NULL,
  `vente_id` int(10) UNSIGNED DEFAULT NULL,
  `reservation_id` int(10) UNSIGNED DEFAULT NULL,
  `inscription_formation_id` int(10) UNSIGNED DEFAULT NULL,
  `responsable_encaissement_id` int(10) UNSIGNED NOT NULL,
  `observations` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `modes_paiement`
--

CREATE TABLE `modes_paiement` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `libelle` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `modes_paiement`
--

INSERT INTO `modes_paiement` (`id`, `code`, `libelle`) VALUES
(1, 'CASH', 'EspÃ¨ces'),
(2, 'VIREMENT', 'Virement bancaire'),
(3, 'MOBILE_MONEY', 'Mobile Money'),
(4, 'CHEQUE', 'ChÃ¨que');

-- --------------------------------------------------------

--
-- Table structure for table `permissions`
--

CREATE TABLE `permissions` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(100) NOT NULL,
  `description` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `permissions`
--

INSERT INTO `permissions` (`id`, `code`, `description`) VALUES
(1, 'PRODUITS_LIRE', 'Consulter le catalogue produits et les stocks'),
(2, 'PRODUITS_CREER', 'CrÃ©er de nouveaux produits'),
(3, 'PRODUITS_MODIFIER', 'Modifier les produits existants'),
(4, 'PRODUITS_SUPPRIMER', 'Supprimer des produits'),
(5, 'CLIENTS_LIRE', 'Consulter les clients / prospects'),
(6, 'CLIENTS_CREER', 'CrÃ©er ou modifier des clients'),
(7, 'DEVIS_LIRE', 'Lister et consulter les devis'),
(8, 'DEVIS_CREER', 'CrÃ©er des devis'),
(9, 'DEVIS_MODIFIER', 'Modifier le statut ou le contenu des devis'),
(10, 'VENTES_LIRE', 'Consulter les ventes et bons de livraison'),
(11, 'VENTES_CREER', 'CrÃ©er des ventes'),
(12, 'VENTES_VALIDER', 'Valider des ventes / livraisons'),
(13, 'CAISSE_LIRE', 'Consulter le journal de caisse'),
(14, 'CAISSE_ECRIRE', 'Enregistrer des opÃ©rations de caisse'),
(15, 'PROMOTIONS_GERER', 'CrÃ©er et gÃ©rer les promotions'),
(16, 'HOTEL_GERER', 'GÃ©rer les rÃ©servations hÃ´tel et upsell'),
(17, 'FORMATION_GERER', 'GÃ©rer les formations et inscriptions'),
(18, 'REPORTING_LIRE', 'AccÃ©der aux tableaux de bord et reporting');

-- --------------------------------------------------------

--
-- Table structure for table `produits`
--

CREATE TABLE `produits` (
  `id` int(10) UNSIGNED NOT NULL,
  `code_produit` varchar(100) NOT NULL,
  `famille_id` int(10) UNSIGNED NOT NULL,
  `sous_categorie_id` int(10) UNSIGNED DEFAULT NULL,
  `designation` varchar(255) NOT NULL,
  `caracteristiques` text DEFAULT NULL,
  `description` text DEFAULT NULL,
  `fournisseur_id` int(10) UNSIGNED DEFAULT NULL,
  `localisation` varchar(150) DEFAULT NULL,
  `prix_achat` decimal(15,2) NOT NULL DEFAULT 0.00,
  `prix_vente` decimal(15,2) NOT NULL DEFAULT 0.00,
  `stock_actuel` int(11) NOT NULL DEFAULT 0,
  `seuil_alerte` int(11) NOT NULL DEFAULT 0,
  `image_path` varchar(255) DEFAULT NULL,
  `actif` tinyint(1) NOT NULL DEFAULT 1,
  `date_creation` datetime NOT NULL DEFAULT current_timestamp(),
  `date_modification` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `produits`
--

INSERT INTO `produits` (`id`, `code_produit`, `famille_id`, `sous_categorie_id`, `designation`, `caracteristiques`, `description`, `fournisseur_id`, `localisation`, `prix_achat`, `prix_vente`, `stock_actuel`, `seuil_alerte`, `image_path`, `actif`, `date_creation`, `date_modification`) VALUES
(1, 'MEU-CH-001', 1, 1, 'Lit 2 places avec chevets', 'Dimensions 160x200', 'Lit moderne pour chambre parentale', 1, 'Showroom Douala', 120000.00, 180000.00, 5, 1, NULL, 1, '2025-11-17 17:25:20', NULL),
(2, 'MEU-SAL-001', 1, 2, 'Salon 5 places', 'Structure bois, mousse haute densitÃ©', 'Salon complet 3+1+1', 1, 'Showroom Douala', 200000.00, 280000.00, 3, 1, NULL, 1, '2025-11-17 17:25:20', NULL),
(3, 'ACC-VIS-001', 2, 3, 'Lot de visserie menuiserie', 'Assortiment vis bois', 'Accessoires pour montage de meubles', 2, 'Magasin PK12', 15000.00, 25000.00, 50, 10, NULL, 1, '2025-11-17 17:25:20', NULL),
(4, 'PAN-MEL-001', 4, 5, 'Panneau mÃ©laminÃ© blanc 18mm', '2,75m x 1,83m', 'Panneau pour agencement intÃ©rieur', 2, 'Magasin PK12', 25000.00, 38000.00, 30, 5, NULL, 1, '2025-11-17 17:25:20', NULL);

-- --------------------------------------------------------

--
-- Table structure for table `promotions`
--

CREATE TABLE `promotions` (
  `id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(150) NOT NULL,
  `description` text DEFAULT NULL,
  `pourcentage_remise` decimal(5,2) DEFAULT NULL,
  `montant_remise` decimal(15,2) DEFAULT NULL,
  `date_debut` date NOT NULL,
  `date_fin` date NOT NULL,
  `actif` tinyint(1) NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `promotion_produit`
--

CREATE TABLE `promotion_produit` (
  `promotion_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `prospections_terrain`
--

CREATE TABLE `prospections_terrain` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_prospection` date NOT NULL,
  `prospect_nom` varchar(150) NOT NULL,
  `secteur` varchar(150) NOT NULL,
  `besoin_identifie` text NOT NULL,
  `action_menee` text NOT NULL,
  `resultat` text NOT NULL,
  `prochaine_etape` text DEFAULT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `commercial_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `prospects_formation`
--

CREATE TABLE `prospects_formation` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_prospect` date NOT NULL,
  `nom_prospect` varchar(150) NOT NULL,
  `contact` varchar(100) NOT NULL,
  `source` varchar(100) DEFAULT NULL,
  `statut_actuel` varchar(100) NOT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `rendezvous_terrain`
--

CREATE TABLE `rendezvous_terrain` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_rdv` date NOT NULL,
  `heure_rdv` time NOT NULL,
  `client_prospect_nom` varchar(150) NOT NULL,
  `lieu` varchar(150) NOT NULL,
  `objectif` text NOT NULL,
  `statut` enum('PLANIFIE','CONFIRME','ANNULE','HONORE') NOT NULL DEFAULT 'PLANIFIE',
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `commercial_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `reservations_hotel`
--

CREATE TABLE `reservations_hotel` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_reservation` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `chambre_id` int(10) UNSIGNED NOT NULL,
  `date_debut` date NOT NULL,
  `date_fin` date NOT NULL,
  `nb_nuits` int(11) NOT NULL,
  `montant_total` decimal(15,2) NOT NULL DEFAULT 0.00,
  `statut` enum('EN_COURS','TERMINEE','ANNULEE') NOT NULL DEFAULT 'EN_COURS',
  `mode_paiement_id` int(10) UNSIGNED DEFAULT NULL,
  `concierge_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `retours_litiges`
--

CREATE TABLE `retours_litiges` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_retour` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `vente_id` int(10) UNSIGNED DEFAULT NULL,
  `motif` text NOT NULL,
  `responsable_suivi_id` int(10) UNSIGNED NOT NULL,
  `statut_traitement` enum('EN_COURS','RESOLU','ABANDONNE') NOT NULL DEFAULT 'EN_COURS',
  `solution` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `roles`
--

CREATE TABLE `roles` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `nom` varchar(100) NOT NULL,
  `description` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `roles`
--

INSERT INTO `roles` (`id`, `code`, `nom`, `description`) VALUES
(1, 'ADMIN', 'Administrateur', 'AccÃ¨s complet Ã  toute lâ€™â€™application'),
(2, 'SHOWROOM', 'Commercial Showroom', 'Gestion des visiteurs, devis et ventes en showroom'),
(3, 'TERRAIN', 'Commercial Terrain', 'Prospection terrain, devis et ventes terrain'),
(4, 'MAGASINIER', 'Magasinier', 'Gestion des stocks, livraisons, ruptures'),
(5, 'CAISSIER', 'Caissier', 'Journal de caisse et encaissements'),
(6, 'DIRECTION', 'Direction', 'Consultation des reportings et indicateurs globaux');

-- --------------------------------------------------------

--
-- Table structure for table `role_permission`
--

CREATE TABLE `role_permission` (
  `role_id` int(10) UNSIGNED NOT NULL,
  `permission_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `role_permission`
--

INSERT INTO `role_permission` (`role_id`, `permission_id`) VALUES
(1, 1),
(1, 2),
(1, 3),
(1, 4),
(1, 5),
(1, 6),
(1, 7),
(1, 8),
(1, 9),
(1, 10),
(1, 11),
(1, 12),
(1, 13),
(1, 14),
(1, 15),
(1, 16),
(1, 17),
(1, 18),
(2, 1),
(2, 5),
(2, 6),
(2, 7),
(2, 8),
(2, 9),
(2, 10),
(2, 11),
(3, 1),
(3, 5),
(3, 6),
(3, 7),
(3, 8),
(3, 10),
(3, 11),
(4, 1),
(4, 3),
(4, 10),
(5, 10),
(5, 13),
(5, 14),
(5, 18),
(6, 1),
(6, 5),
(6, 7),
(6, 10),
(6, 13),
(6, 16),
(6, 17),
(6, 18);

-- --------------------------------------------------------

--
-- Table structure for table `ruptures_stock`
--

CREATE TABLE `ruptures_stock` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_rapport` date NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `seuil_alerte` int(11) NOT NULL,
  `stock_actuel` int(11) NOT NULL,
  `impact_commercial` text NOT NULL,
  `action_proposee` text NOT NULL,
  `magasinier_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `satisfaction_clients`
--

CREATE TABLE `satisfaction_clients` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_satisfaction` date NOT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `nom_client` varchar(150) NOT NULL,
  `service_utilise` enum('SHOWROOM','HOTEL','FORMATION','TERRAIN','DIGITAL') NOT NULL,
  `note` int(11) NOT NULL,
  `commentaire` text DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `sous_categories_produits`
--

CREATE TABLE `sous_categories_produits` (
  `id` int(10) UNSIGNED NOT NULL,
  `famille_id` int(10) UNSIGNED NOT NULL,
  `nom` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `sous_categories_produits`
--

INSERT INTO `sous_categories_produits` (`id`, `famille_id`, `nom`) VALUES
(1, 1, 'Chambres Ã  coucher'),
(2, 1, 'Salons'),
(3, 2, 'Quincaillerie standard'),
(4, 3, 'Machines de dÃ©coupe'),
(5, 4, 'Panneaux mÃ©laminÃ©s');

-- --------------------------------------------------------

--
-- Table structure for table `stocks_mouvements`
--

CREATE TABLE `stocks_mouvements` (
  `id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `date_mouvement` datetime NOT NULL DEFAULT current_timestamp(),
  `type_mouvement` enum('ENTREE','SORTIE','AJUSTEMENT') NOT NULL,
  `quantite` int(11) NOT NULL,
  `source_type` varchar(50) DEFAULT NULL,
  `source_id` int(11) DEFAULT NULL,
  `commentaire` text DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `stocks_mouvements`
--

INSERT INTO `stocks_mouvements` (`id`, `produit_id`, `date_mouvement`, `type_mouvement`, `quantite`, `source_type`, `source_id`, `commentaire`, `utilisateur_id`) VALUES
(1, 1, '2025-11-17 17:25:20', 'ENTREE', 5, 'INVENTAIRE', NULL, 'Stock initial lit 2 places', 1),
(2, 2, '2025-11-17 17:25:20', 'ENTREE', 3, 'INVENTAIRE', NULL, 'Stock initial salon', 1),
(3, 3, '2025-11-17 17:25:20', 'ENTREE', 50, 'INVENTAIRE', NULL, 'Stock initial visserie', 1),
(4, 4, '2025-11-17 17:25:20', 'ENTREE', 30, 'INVENTAIRE', NULL, 'Stock initial panneaux', 1);

-- --------------------------------------------------------

--
-- Table structure for table `types_client`
--

CREATE TABLE `types_client` (
  `id` int(10) UNSIGNED NOT NULL,
  `code` varchar(50) NOT NULL,
  `libelle` varchar(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `types_client`
--

INSERT INTO `types_client` (`id`, `code`, `libelle`) VALUES
(1, 'SHOWROOM', 'Client / prospect showroom'),
(2, 'TERRAIN', 'Client / prospect terrain'),
(3, 'DIGITAL', 'Client issu du digital (rÃ©seaux sociaux, site, CRM)'),
(4, 'HOTEL', 'Client hÃ©bergement / hÃ´tel'),
(5, 'FORMATION', 'Apprenant / client formation');

-- --------------------------------------------------------

--
-- Table structure for table `upsell_hotel`
--

CREATE TABLE `upsell_hotel` (
  `id` int(10) UNSIGNED NOT NULL,
  `reservation_id` int(10) UNSIGNED NOT NULL,
  `service_additionnel` varchar(150) NOT NULL,
  `montant` decimal(15,2) NOT NULL DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `utilisateurs`
--

CREATE TABLE `utilisateurs` (
  `id` int(10) UNSIGNED NOT NULL,
  `login` varchar(100) NOT NULL,
  `mot_de_passe_hash` varchar(255) NOT NULL,
  `nom_complet` varchar(150) NOT NULL,
  `email` varchar(150) DEFAULT NULL,
  `telephone` varchar(50) DEFAULT NULL,
  `actif` tinyint(1) NOT NULL DEFAULT 1,
  `date_creation` datetime NOT NULL DEFAULT current_timestamp(),
  `date_derniere_connexion` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `utilisateurs`
--

INSERT INTO `utilisateurs` (`id`, `login`, `mot_de_passe_hash`, `nom_complet`, `email`, `telephone`, `actif`, `date_creation`, `date_derniere_connexion`) VALUES
(1, 'admin', '$2b$10$j6YYUX.QLOxOoBn9eB4rJu8/ye4/NOEXPvRjcYhUY4mBiaZZFUrTi', 'Administrateur KMS', 'admin@kms.local', NULL, 1, '2025-11-17 17:19:55', '2025-11-17 17:37:35');

-- --------------------------------------------------------

--
-- Table structure for table `utilisateur_role`
--

CREATE TABLE `utilisateur_role` (
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `role_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Dumping data for table `utilisateur_role`
--

INSERT INTO `utilisateur_role` (`utilisateur_id`, `role_id`) VALUES
(1, 1);

-- --------------------------------------------------------

--
-- Table structure for table `ventes`
--

CREATE TABLE `ventes` (
  `id` int(10) UNSIGNED NOT NULL,
  `numero` varchar(50) NOT NULL,
  `date_vente` date NOT NULL,
  `client_id` int(10) UNSIGNED NOT NULL,
  `canal_vente_id` int(10) UNSIGNED NOT NULL,
  `devis_id` int(10) UNSIGNED DEFAULT NULL,
  `statut` enum('EN_ATTENTE_LIVRAISON','LIVREE','ANNULEE','PARTIELLEMENT_LIVREE') NOT NULL DEFAULT 'EN_ATTENTE_LIVRAISON',
  `montant_total_ht` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_total_ttc` decimal(15,2) NOT NULL DEFAULT 0.00,
  `utilisateur_id` int(10) UNSIGNED NOT NULL,
  `commentaires` text DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `ventes_lignes`
--

CREATE TABLE `ventes_lignes` (
  `id` int(10) UNSIGNED NOT NULL,
  `vente_id` int(10) UNSIGNED NOT NULL,
  `produit_id` int(10) UNSIGNED NOT NULL,
  `quantite` int(11) NOT NULL,
  `prix_unitaire` decimal(15,2) NOT NULL,
  `remise` decimal(15,2) NOT NULL DEFAULT 0.00,
  `montant_ligne_ht` decimal(15,2) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `visiteurs_hotel`
--

CREATE TABLE `visiteurs_hotel` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_visite` date NOT NULL,
  `nom_visiteur` varchar(150) NOT NULL,
  `motif` text NOT NULL,
  `service_solicite` varchar(150) NOT NULL,
  `orientation` varchar(150) DEFAULT NULL,
  `concierge_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- --------------------------------------------------------

--
-- Table structure for table `visiteurs_showroom`
--

CREATE TABLE `visiteurs_showroom` (
  `id` int(10) UNSIGNED NOT NULL,
  `date_visite` date NOT NULL,
  `client_nom` varchar(150) NOT NULL,
  `contact` varchar(100) NOT NULL,
  `produit_interet` text DEFAULT NULL,
  `orientation` varchar(100) DEFAULT NULL,
  `client_id` int(10) UNSIGNED DEFAULT NULL,
  `utilisateur_id` int(10) UNSIGNED NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Indexes for dumped tables
--

--
-- Indexes for table `bons_livraison`
--
ALTER TABLE `bons_livraison`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `numero` (`numero`),
  ADD KEY `fk_bl_vente` (`vente_id`),
  ADD KEY `fk_bl_client` (`client_id`),
  ADD KEY `fk_bl_magasinier` (`magasinier_id`),
  ADD KEY `idx_bl_date` (`date_bl`);

--
-- Indexes for table `bons_livraison_lignes`
--
ALTER TABLE `bons_livraison_lignes`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_bl_lignes_bl` (`bon_livraison_id`),
  ADD KEY `fk_bl_lignes_produit` (`produit_id`);

--
-- Indexes for table `canaux_vente`
--
ALTER TABLE `canaux_vente`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `chambres`
--
ALTER TABLE `chambres`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `clients`
--
ALTER TABLE `clients`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_clients_type` (`type_client_id`),
  ADD KEY `idx_clients_nom` (`nom`);

--
-- Indexes for table `connexions_utilisateur`
--
ALTER TABLE `connexions_utilisateur`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_connexions_utilisateur_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_connexions_utilisateur_date` (`date_connexion`);

--
-- Indexes for table `devis`
--
ALTER TABLE `devis`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `numero` (`numero`),
  ADD KEY `fk_devis_client` (`client_id`),
  ADD KEY `fk_devis_canal` (`canal_vente_id`),
  ADD KEY `fk_devis_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_devis_date` (`date_devis`),
  ADD KEY `idx_devis_statut` (`statut`);

--
-- Indexes for table `devis_lignes`
--
ALTER TABLE `devis_lignes`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_devis_lignes_devis` (`devis_id`),
  ADD KEY `fk_devis_lignes_produit` (`produit_id`);

--
-- Indexes for table `familles_produits`
--
ALTER TABLE `familles_produits`
  ADD PRIMARY KEY (`id`);

--
-- Indexes for table `formations`
--
ALTER TABLE `formations`
  ADD PRIMARY KEY (`id`);

--
-- Indexes for table `fournisseurs`
--
ALTER TABLE `fournisseurs`
  ADD PRIMARY KEY (`id`);

--
-- Indexes for table `inscriptions_formation`
--
ALTER TABLE `inscriptions_formation`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_inscription_client` (`client_id`),
  ADD KEY `fk_inscription_formation` (`formation_id`),
  ADD KEY `idx_inscription_date` (`date_inscription`);

--
-- Indexes for table `journal_caisse`
--
ALTER TABLE `journal_caisse`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_caisse_mode_paiement` (`mode_paiement_id`),
  ADD KEY `fk_caisse_vente` (`vente_id`),
  ADD KEY `fk_caisse_reservation` (`reservation_id`),
  ADD KEY `fk_caisse_inscription` (`inscription_formation_id`),
  ADD KEY `fk_caisse_responsable` (`responsable_encaissement_id`),
  ADD KEY `idx_caisse_date` (`date_operation`);

--
-- Indexes for table `modes_paiement`
--
ALTER TABLE `modes_paiement`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `permissions`
--
ALTER TABLE `permissions`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `produits`
--
ALTER TABLE `produits`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code_produit` (`code_produit`),
  ADD KEY `fk_produits_famille` (`famille_id`),
  ADD KEY `fk_produits_sous_categorie` (`sous_categorie_id`),
  ADD KEY `fk_produits_fournisseur` (`fournisseur_id`),
  ADD KEY `idx_produits_designation` (`designation`),
  ADD KEY `idx_produits_code` (`code_produit`);

--
-- Indexes for table `promotions`
--
ALTER TABLE `promotions`
  ADD PRIMARY KEY (`id`);

--
-- Indexes for table `promotion_produit`
--
ALTER TABLE `promotion_produit`
  ADD PRIMARY KEY (`promotion_id`,`produit_id`),
  ADD KEY `fk_promo_produit_produit` (`produit_id`);

--
-- Indexes for table `prospections_terrain`
--
ALTER TABLE `prospections_terrain`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_prospections_client` (`client_id`),
  ADD KEY `fk_prospections_commercial` (`commercial_id`),
  ADD KEY `idx_prospections_date` (`date_prospection`);

--
-- Indexes for table `prospects_formation`
--
ALTER TABLE `prospects_formation`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_prospect_formation_client` (`client_id`),
  ADD KEY `fk_prospect_formation_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_prospect_formation_date` (`date_prospect`);

--
-- Indexes for table `rendezvous_terrain`
--
ALTER TABLE `rendezvous_terrain`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_rdv_client` (`client_id`),
  ADD KEY `fk_rdv_commercial` (`commercial_id`),
  ADD KEY `idx_rdv_date` (`date_rdv`);

--
-- Indexes for table `reservations_hotel`
--
ALTER TABLE `reservations_hotel`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_reservation_client` (`client_id`),
  ADD KEY `fk_reservation_chambre` (`chambre_id`),
  ADD KEY `fk_reservation_mode_paiement` (`mode_paiement_id`),
  ADD KEY `fk_reservation_concierge` (`concierge_id`),
  ADD KEY `idx_reservation_dates` (`date_debut`,`date_fin`);

--
-- Indexes for table `retours_litiges`
--
ALTER TABLE `retours_litiges`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_litiges_client` (`client_id`),
  ADD KEY `fk_litiges_produit` (`produit_id`),
  ADD KEY `fk_litiges_vente` (`vente_id`),
  ADD KEY `fk_litiges_responsable` (`responsable_suivi_id`);

--
-- Indexes for table `roles`
--
ALTER TABLE `roles`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `role_permission`
--
ALTER TABLE `role_permission`
  ADD PRIMARY KEY (`role_id`,`permission_id`),
  ADD KEY `fk_role_permission_permission` (`permission_id`);

--
-- Indexes for table `ruptures_stock`
--
ALTER TABLE `ruptures_stock`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_ruptures_produit` (`produit_id`),
  ADD KEY `fk_ruptures_magasinier` (`magasinier_id`),
  ADD KEY `idx_ruptures_date` (`date_rapport`);

--
-- Indexes for table `satisfaction_clients`
--
ALTER TABLE `satisfaction_clients`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_satisfaction_client` (`client_id`),
  ADD KEY `fk_satisfaction_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_satisfaction_date` (`date_satisfaction`);

--
-- Indexes for table `sous_categories_produits`
--
ALTER TABLE `sous_categories_produits`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_sous_categories_famille` (`famille_id`);

--
-- Indexes for table `stocks_mouvements`
--
ALTER TABLE `stocks_mouvements`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_mouvements_produit` (`produit_id`),
  ADD KEY `fk_mouvements_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_mouvements_date` (`date_mouvement`);

--
-- Indexes for table `types_client`
--
ALTER TABLE `types_client`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `upsell_hotel`
--
ALTER TABLE `upsell_hotel`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_upsell_reservation` (`reservation_id`);

--
-- Indexes for table `utilisateurs`
--
ALTER TABLE `utilisateurs`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `login` (`login`);

--
-- Indexes for table `utilisateur_role`
--
ALTER TABLE `utilisateur_role`
  ADD PRIMARY KEY (`utilisateur_id`,`role_id`),
  ADD KEY `fk_utilisateur_role_role` (`role_id`);

--
-- Indexes for table `ventes`
--
ALTER TABLE `ventes`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `numero` (`numero`),
  ADD KEY `fk_ventes_client` (`client_id`),
  ADD KEY `fk_ventes_canal` (`canal_vente_id`),
  ADD KEY `fk_ventes_devis` (`devis_id`),
  ADD KEY `fk_ventes_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_ventes_date` (`date_vente`),
  ADD KEY `idx_ventes_statut` (`statut`);

--
-- Indexes for table `ventes_lignes`
--
ALTER TABLE `ventes_lignes`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_ventes_lignes_vente` (`vente_id`),
  ADD KEY `fk_ventes_lignes_produit` (`produit_id`);

--
-- Indexes for table `visiteurs_hotel`
--
ALTER TABLE `visiteurs_hotel`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_visiteurs_hotel_concierge` (`concierge_id`),
  ADD KEY `idx_visiteurs_hotel_date` (`date_visite`);

--
-- Indexes for table `visiteurs_showroom`
--
ALTER TABLE `visiteurs_showroom`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_visiteurs_client` (`client_id`),
  ADD KEY `fk_visiteurs_utilisateur` (`utilisateur_id`),
  ADD KEY `idx_visiteurs_date` (`date_visite`);

--
-- AUTO_INCREMENT for dumped tables
--

--
-- AUTO_INCREMENT for table `bons_livraison`
--
ALTER TABLE `bons_livraison`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `bons_livraison_lignes`
--
ALTER TABLE `bons_livraison_lignes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `canaux_vente`
--
ALTER TABLE `canaux_vente`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT for table `chambres`
--
ALTER TABLE `chambres`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT for table `clients`
--
ALTER TABLE `clients`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT for table `connexions_utilisateur`
--
ALTER TABLE `connexions_utilisateur`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT for table `devis`
--
ALTER TABLE `devis`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `devis_lignes`
--
ALTER TABLE `devis_lignes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `familles_produits`
--
ALTER TABLE `familles_produits`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=5;

--
-- AUTO_INCREMENT for table `formations`
--
ALTER TABLE `formations`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT for table `fournisseurs`
--
ALTER TABLE `fournisseurs`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT for table `inscriptions_formation`
--
ALTER TABLE `inscriptions_formation`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `journal_caisse`
--
ALTER TABLE `journal_caisse`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `modes_paiement`
--
ALTER TABLE `modes_paiement`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=5;

--
-- AUTO_INCREMENT for table `permissions`
--
ALTER TABLE `permissions`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=19;

--
-- AUTO_INCREMENT for table `produits`
--
ALTER TABLE `produits`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=5;

--
-- AUTO_INCREMENT for table `promotions`
--
ALTER TABLE `promotions`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `prospections_terrain`
--
ALTER TABLE `prospections_terrain`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `prospects_formation`
--
ALTER TABLE `prospects_formation`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `rendezvous_terrain`
--
ALTER TABLE `rendezvous_terrain`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `reservations_hotel`
--
ALTER TABLE `reservations_hotel`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `retours_litiges`
--
ALTER TABLE `retours_litiges`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `roles`
--
ALTER TABLE `roles`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=7;

--
-- AUTO_INCREMENT for table `ruptures_stock`
--
ALTER TABLE `ruptures_stock`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `satisfaction_clients`
--
ALTER TABLE `satisfaction_clients`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `sous_categories_produits`
--
ALTER TABLE `sous_categories_produits`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT for table `stocks_mouvements`
--
ALTER TABLE `stocks_mouvements`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=5;

--
-- AUTO_INCREMENT for table `types_client`
--
ALTER TABLE `types_client`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT for table `upsell_hotel`
--
ALTER TABLE `upsell_hotel`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `utilisateurs`
--
ALTER TABLE `utilisateurs`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=2;

--
-- AUTO_INCREMENT for table `ventes`
--
ALTER TABLE `ventes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `ventes_lignes`
--
ALTER TABLE `ventes_lignes`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `visiteurs_hotel`
--
ALTER TABLE `visiteurs_hotel`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `visiteurs_showroom`
--
ALTER TABLE `visiteurs_showroom`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

--
-- Constraints for dumped tables
--

--
-- Constraints for table `bons_livraison`
--
ALTER TABLE `bons_livraison`
  ADD CONSTRAINT `fk_bl_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_bl_magasinier` FOREIGN KEY (`magasinier_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_bl_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Constraints for table `bons_livraison_lignes`
--
ALTER TABLE `bons_livraison_lignes`
  ADD CONSTRAINT `fk_bl_lignes_bl` FOREIGN KEY (`bon_livraison_id`) REFERENCES `bons_livraison` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_bl_lignes_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `clients`
--
ALTER TABLE `clients`
  ADD CONSTRAINT `fk_clients_type` FOREIGN KEY (`type_client_id`) REFERENCES `types_client` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `connexions_utilisateur`
--
ALTER TABLE `connexions_utilisateur`
  ADD CONSTRAINT `fk_connexions_utilisateur_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `devis`
--
ALTER TABLE `devis`
  ADD CONSTRAINT `fk_devis_canal` FOREIGN KEY (`canal_vente_id`) REFERENCES `canaux_vente` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_devis_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_devis_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `devis_lignes`
--
ALTER TABLE `devis_lignes`
  ADD CONSTRAINT `fk_devis_lignes_devis` FOREIGN KEY (`devis_id`) REFERENCES `devis` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_devis_lignes_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `inscriptions_formation`
--
ALTER TABLE `inscriptions_formation`
  ADD CONSTRAINT `fk_inscription_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_inscription_formation` FOREIGN KEY (`formation_id`) REFERENCES `formations` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `journal_caisse`
--
ALTER TABLE `journal_caisse`
  ADD CONSTRAINT `fk_caisse_inscription` FOREIGN KEY (`inscription_formation_id`) REFERENCES `inscriptions_formation` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_mode_paiement` FOREIGN KEY (`mode_paiement_id`) REFERENCES `modes_paiement` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_reservation` FOREIGN KEY (`reservation_id`) REFERENCES `reservations_hotel` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_responsable` FOREIGN KEY (`responsable_encaissement_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_caisse_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Constraints for table `produits`
--
ALTER TABLE `produits`
  ADD CONSTRAINT `fk_produits_famille` FOREIGN KEY (`famille_id`) REFERENCES `familles_produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_produits_fournisseur` FOREIGN KEY (`fournisseur_id`) REFERENCES `fournisseurs` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_produits_sous_categorie` FOREIGN KEY (`sous_categorie_id`) REFERENCES `sous_categories_produits` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Constraints for table `promotion_produit`
--
ALTER TABLE `promotion_produit`
  ADD CONSTRAINT `fk_promo_produit_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_promo_produit_promo` FOREIGN KEY (`promotion_id`) REFERENCES `promotions` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `prospections_terrain`
--
ALTER TABLE `prospections_terrain`
  ADD CONSTRAINT `fk_prospections_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_prospections_commercial` FOREIGN KEY (`commercial_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `prospects_formation`
--
ALTER TABLE `prospects_formation`
  ADD CONSTRAINT `fk_prospect_formation_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_prospect_formation_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `rendezvous_terrain`
--
ALTER TABLE `rendezvous_terrain`
  ADD CONSTRAINT `fk_rdv_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_rdv_commercial` FOREIGN KEY (`commercial_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `reservations_hotel`
--
ALTER TABLE `reservations_hotel`
  ADD CONSTRAINT `fk_reservation_chambre` FOREIGN KEY (`chambre_id`) REFERENCES `chambres` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_reservation_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_reservation_concierge` FOREIGN KEY (`concierge_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_reservation_mode_paiement` FOREIGN KEY (`mode_paiement_id`) REFERENCES `modes_paiement` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Constraints for table `retours_litiges`
--
ALTER TABLE `retours_litiges`
  ADD CONSTRAINT `fk_litiges_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_litiges_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_litiges_responsable` FOREIGN KEY (`responsable_suivi_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_litiges_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Constraints for table `role_permission`
--
ALTER TABLE `role_permission`
  ADD CONSTRAINT `fk_role_permission_permission` FOREIGN KEY (`permission_id`) REFERENCES `permissions` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_role_permission_role` FOREIGN KEY (`role_id`) REFERENCES `roles` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `ruptures_stock`
--
ALTER TABLE `ruptures_stock`
  ADD CONSTRAINT `fk_ruptures_magasinier` FOREIGN KEY (`magasinier_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ruptures_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `satisfaction_clients`
--
ALTER TABLE `satisfaction_clients`
  ADD CONSTRAINT `fk_satisfaction_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_satisfaction_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `sous_categories_produits`
--
ALTER TABLE `sous_categories_produits`
  ADD CONSTRAINT `fk_sous_categories_famille` FOREIGN KEY (`famille_id`) REFERENCES `familles_produits` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `stocks_mouvements`
--
ALTER TABLE `stocks_mouvements`
  ADD CONSTRAINT `fk_mouvements_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_mouvements_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `upsell_hotel`
--
ALTER TABLE `upsell_hotel`
  ADD CONSTRAINT `fk_upsell_reservation` FOREIGN KEY (`reservation_id`) REFERENCES `reservations_hotel` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `utilisateur_role`
--
ALTER TABLE `utilisateur_role`
  ADD CONSTRAINT `fk_utilisateur_role_role` FOREIGN KEY (`role_id`) REFERENCES `roles` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_utilisateur_role_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `ventes`
--
ALTER TABLE `ventes`
  ADD CONSTRAINT `fk_ventes_canal` FOREIGN KEY (`canal_vente_id`) REFERENCES `canaux_vente` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_devis` FOREIGN KEY (`devis_id`) REFERENCES `devis` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `ventes_lignes`
--
ALTER TABLE `ventes_lignes`
  ADD CONSTRAINT `fk_ventes_lignes_produit` FOREIGN KEY (`produit_id`) REFERENCES `produits` (`id`) ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_ventes_lignes_vente` FOREIGN KEY (`vente_id`) REFERENCES `ventes` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Constraints for table `visiteurs_hotel`
--
ALTER TABLE `visiteurs_hotel`
  ADD CONSTRAINT `fk_visiteurs_hotel_concierge` FOREIGN KEY (`concierge_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;

--
-- Constraints for table `visiteurs_showroom`
--
ALTER TABLE `visiteurs_showroom`
  ADD CONSTRAINT `fk_visiteurs_client` FOREIGN KEY (`client_id`) REFERENCES `clients` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  ADD CONSTRAINT `fk_visiteurs_utilisateur` FOREIGN KEY (`utilisateur_id`) REFERENCES `utilisateurs` (`id`) ON UPDATE CASCADE;
COMMIT;

/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;


-- ==========================================================
--  PERMISSION : gestion des utilisateurs (ADMIN uniquement)
-- ==========================================================

INSERT INTO permissions (code, description) VALUES
 ('UTILISATEURS_GERER', 'CrÃ©er, modifier et dÃ©sactiver les utilisateurs internes');

-- Associer la permission UTILISATEURS_GERER au rÃ´le ADMIN
INSERT INTO role_permission (role_id, permission_id)
SELECT r.id, p.id
FROM roles r
JOIN permissions p
  ON p.code = 'UTILISATEURS_GERER'
WHERE r.code = 'ADMIN';



===== FICHIER : devis\convertir_en_vente.php =====

<?php
// devis/convertir_en_vente.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('VENTES_CREER');

global $pdo;

// Base URLs dynamiques, quel que soit le rÃ©pertoire du projet
$appBasePath    = rtrim(dirname(dirname($_SERVER['SCRIPT_NAME'])), '/\\'); // ex : /kms_app ou ''
$devisBasePath  = $appBasePath . '/devis';
$ventesBasePath = $appBasePath . '/ventes';

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
if ($id <= 0) {
    http_response_code(400);
    echo "Devis invalide.";
    exit;
}

// Charger le devis
$stmt = $pdo->prepare("SELECT * FROM devis WHERE id = :id");
$stmt->execute(['id' => $id]);
$devis = $stmt->fetch();

if (!$devis) {
    http_response_code(404);
    echo "Devis introuvable.";
    exit;
}

// 1) VÃ©rifier le statut : seuls les devis ACCEPTES sont convertibles
if ($devis['statut'] !== 'ACCEPTE') {
    $_SESSION['flash_success'] = "Seuls les devis acceptÃ©s peuvent Ãªtre convertis en vente.";
    header('Location: ' . $devisBasePath . '/list.php');
    exit;
}

// 2) VÃ©rifier si dÃ©jÃ  marquÃ© comme converti
if (!empty($devis['est_converti'])) {
    $_SESSION['flash_success'] = "Ce devis a dÃ©jÃ  Ã©tÃ© converti en vente.";
    header('Location: ' . $devisBasePath . '/list.php');
    exit;
}

// 3) SÃ©curitÃ© supplÃ©mentaire : vÃ©rifier si une vente existe dÃ©jÃ  pour ce devis
$stmt = $pdo->prepare("SELECT id, numero FROM ventes WHERE devis_id = :id LIMIT 1");
$stmt->execute(['id' => $id]);
$venteExistante = $stmt->fetch();

if ($venteExistante) {
    // On marque le devis comme converti pour les prochaines fois
    $stmtUpdate = $pdo->prepare("UPDATE devis SET est_converti = 1 WHERE id = :id");
    $stmtUpdate->execute(['id' => $id]);

    $_SESSION['flash_success'] = "Ce devis Ã©tait dÃ©jÃ  liÃ© Ã  la vente " . $venteExistante['numero'] . ".";
    header('Location: ' . $ventesBasePath . '/detail.php?id=' . (int)$venteExistante['id']);
    exit;
}

// 4) Charger les lignes du devis
$stmt = $pdo->prepare("SELECT * FROM devis_lignes WHERE devis_id = :id");
$stmt->execute(['id' => $id]);
$lignes = $stmt->fetchAll();

if (empty($lignes)) {
    $_SESSION['flash_success'] = "Ce devis ne contient aucune ligne.";
    header('Location: ' . $devisBasePath . '/list.php');
    exit;
}

// 5) Utilisateur courant
$utilisateur = utilisateurConnecte();
$userId      = (int)($utilisateur['id'] ?? 0);

// 6) CrÃ©ation de la vente
$numeroVente = 'V-' . date('Ymd-His');

$sqlVente = "
    INSERT INTO ventes (
        numero, date_vente, client_id, canal_vente_id,
        devis_id, statut, montant_total_ht, montant_total_ttc,
        utilisateur_id, commentaires
    ) VALUES (
        :numero, CURDATE(), :client_id, :canal_id,
        :devis_id, 'EN_ATTENTE_LIVRAISON', :mtht, :mtttc,
        :utilisateur_id, :commentaires
    )
";
$stmt = $pdo->prepare($sqlVente);
$stmt->execute([
    'numero'         => $numeroVente,
    'client_id'      => $devis['client_id'],
    'canal_id'       => $devis['canal_vente_id'],
    'devis_id'       => $devis['id'],
    'mtht'           => $devis['montant_total_ht'],
    'mtttc'          => $devis['montant_total_ttc'],
    'utilisateur_id' => $userId,
    'commentaires'   => 'Vente issue du devis ' . $devis['numero'],
]);

$venteId = (int)$pdo->lastInsertId();

// 7) Copier les lignes du devis vers la vente
$stmtLigne = $pdo->prepare("
    INSERT INTO ventes_lignes (
        vente_id, produit_id, quantite,
        prix_unitaire, remise, montant_ligne_ht
    ) VALUES (
        :vente_id, :produit_id, :quantite,
        :prix_unitaire, :remise, :montant_ligne_ht
    )
");
foreach ($lignes as $l) {
    $stmtLigne->execute([
        'vente_id'         => $venteId,
        'produit_id'       => $l['produit_id'],
        'quantite'         => $l['quantite'],
        'prix_unitaire'    => $l['prix_unitaire'],
        'remise'           => $l['remise'],
        'montant_ligne_ht' => $l['montant_ligne_ht'],
    ]);
}

// 8) Marquer le devis comme converti
$stmt = $pdo->prepare("UPDATE devis SET est_converti = 1 WHERE id = :id");
$stmt->execute(['id' => $id]);

$_SESSION['flash_success'] = "Le devis a Ã©tÃ© converti en vente ($numeroVente).";
header('Location: ' . $ventesBasePath . '/detail.php?id=' . $venteId);
exit;



===== FICHIER : devis\edit.php =====

<?php
// devis/edit.php
require_once __DIR__ . '/../security.php';
exigerConnexion();

global $pdo;

// URL de base pour la liste des devis (inclut le rÃ©pertoire du projet)
$basePath = rtrim(dirname($_SERVER['SCRIPT_NAME']), '/\\');
$devisListUrl = $basePath . '/list.php';

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$modeEdition = $id > 0;

if ($modeEdition) {
    exigerPermission('DEVIS_MODIFIER');
} else {
    exigerPermission('DEVIS_CREER');
}

// Canaux
$stmt = $pdo->query("SELECT id, code, libelle FROM canaux_vente ORDER BY code");
$canaux = $stmt->fetchAll();

// Produits pour sÃ©lection
$stmt = $pdo->query("
    SELECT id, code_produit, designation, prix_vente
    FROM produits
    WHERE actif = 1
    ORDER BY designation
");
$produits = $stmt->fetchAll();
$produitsMap = [];
foreach ($produits as $p) {
    $produitsMap[(int)$p['id']] = $p;
}

// Champs header
$numero            = '';
$date_devis        = date('Y-m-d');
$client_id         = 0;
$clientNom         = ''; // pour afficher le libellÃ© dans le champ de recherche AJAX
$canal_id          = $canaux[0]['id'] ?? 0;
$statut            = 'EN_ATTENTE';
$date_relance      = '';
$conditions        = '';
$commentaires      = '';
$montant_total_ht  = 0;
$montant_total_ttc = 0;

// Lignes
$lignes = [];

// Chargement en Ã©dition
if ($modeEdition && $_SERVER['REQUEST_METHOD'] === 'GET') {
    $stmt = $pdo->prepare("SELECT * FROM devis WHERE id = :id");
    $stmt->execute(['id' => $id]);
    $d = $stmt->fetch();
    if (!$d) {
        http_response_code(404);
        echo "Devis introuvable.";
        exit;
    }

    $numero           = $d['numero'];
    $date_devis       = $d['date_devis'];
    $client_id        = (int)$d['client_id'];
    $canal_id         = (int)$d['canal_vente_id'];
    $statut           = $d['statut'];
    $date_relance     = $d['date_relance'] ?? '';
    $conditions       = $d['conditions'] ?? '';
    $commentaires     = $d['commentaires'] ?? '';
    $montant_total_ht = (float)$d['montant_total_ht'];
    $montant_total_ttc= (float)$d['montant_total_ttc'];

    // RÃ©cupÃ©rer le nom du client pour affichage dans le champ de recherche
    if ($client_id > 0) {
        $stmtCli = $pdo->prepare("SELECT nom FROM clients WHERE id = :id");
        $stmtCli->execute(['id' => $client_id]);
        $cli = $stmtCli->fetch();
        if ($cli) {
            $clientNom = $cli['nom'];
        }
    }

    $stmt = $pdo->prepare("
        SELECT dl.*, p.code_produit, p.designation
        FROM devis_lignes dl
        JOIN produits p ON p.id = dl.produit_id
        WHERE dl.devis_id = :id
        ORDER BY dl.id
    ");
    $stmt->execute(['id' => $id]);
    $lignes = $stmt->fetchAll();
}

// POST
$erreurs = [];
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $csrf = $_POST['csrf_token'] ?? '';
    verifierCsrf($csrf);

    $id          = (int)($_POST['id'] ?? 0);
    $modeEdition = $id > 0;

    $numero       = trim($_POST['numero'] ?? '');
    $date_devis   = $_POST['date_devis'] ?? date('Y-m-d');
    $client_id    = (int)($_POST['client_id'] ?? 0);
    $canal_id     = (int)($_POST['canal_vente_id'] ?? 0);
    $statut       = $_POST['statut'] ?? 'EN_ATTENTE';
    $date_relance = $_POST['date_relance'] ?? '';
    $conditions   = trim($_POST['conditions'] ?? '');
    $commentaires = trim($_POST['commentaires'] ?? '');

    if ($client_id <= 0)  $erreurs[] = "Veuillez sÃ©lectionner un client.";
    if ($canal_id <= 0)   $erreurs[] = "Veuillez sÃ©lectionner un canal de vente.";
    if (!in_array($statut, ['EN_ATTENTE','ACCEPTE','REFUSE','ANNULE'], true)) {
        $erreurs[] = "Statut de devis invalide.";
    }

    // RÃ©cup nom client pour rÃ©affichage si erreur
    if ($client_id > 0) {
        $stmtCli = $pdo->prepare("SELECT nom FROM clients WHERE id = :id");
        $stmtCli->execute(['id' => $client_id]);
        $cli = $stmtCli->fetch();
        if ($cli) {
            $clientNom = $cli['nom'];
        }
    } else {
        $clientNom = '';
    }

    // GÃ©nÃ©ration numÃ©ro si vide
    if ($numero === '') {
        $numero = 'DV-' . date('Ymd-His');
    }

    // Traitement lignes
    $ligne_produit_id = $_POST['ligne_produit_id'] ?? [];
    $ligne_quantite   = $_POST['ligne_quantite'] ?? [];
    $ligne_prix       = $_POST['ligne_prix'] ?? [];
    $ligne_remise     = $_POST['ligne_remise'] ?? [];

    $lignes = [];
    $montant_total_ht = 0.0;

    $count = max(
        count($ligne_produit_id),
        count($ligne_quantite),
        count($ligne_prix),
        count($ligne_remise)
    );

    for ($i = 0; $i < $count; $i++) {
        $pid = isset($ligne_produit_id[$i]) ? (int)$ligne_produit_id[$i] : 0;
        $qte = isset($ligne_quantite[$i]) ? (int)$ligne_quantite[$i] : 0;
        $pu  = isset($ligne_prix[$i]) ? (float)$ligne_prix[$i] : 0;
        $rem = isset($ligne_remise[$i]) ? (float)$ligne_remise[$i] : 0;

        if ($pid <= 0 || $qte <= 0) {
            continue;
        }

        if ($pu <= 0 && isset($produitsMap[$pid])) {
            $pu = (float)$produitsMap[$pid]['prix_vente'];
        }

        $montant_ligne = $qte * $pu - $rem;
        if ($montant_ligne < 0) $montant_ligne = 0;
        $montant_total_ht += $montant_ligne;

        $lignes[] = [
            'produit_id'        => $pid,
            'quantite'          => $qte,
            'prix_unitaire'     => $pu,
            'remise'            => $rem,
            'montant_ligne_ht'  => $montant_ligne,
        ];
    }

    if (empty($lignes)) {
        $erreurs[] = "Le devis doit contenir au moins une ligne produit.";
    }

    // Pour simplifier : HT = TTC (pas de TVA gÃ©rÃ©e ici)
    $montant_total_ttc = $montant_total_ht;

    if (empty($erreurs)) {
        $utilisateur = utilisateurConnecte();
        $userId      = (int)$utilisateur['id'];

        if ($modeEdition) {
            // UPDATE devis
            $sql = "
                UPDATE devis
                SET numero = :numero,
                    date_devis = :date_devis,
                    client_id = :client_id,
                    canal_vente_id = :canal_vente_id,
                    statut = :statut,
                    date_relance = :date_relance,
                    montant_total_ht = :mtht,
                    montant_total_ttc = :mtttc,
                    remise_global = :remise_global,
                    conditions = :conditions,
                    commentaires = :commentaires
                WHERE id = :id
            ";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([
                'numero'         => $numero,
                'date_devis'     => $date_devis,
                'client_id'      => $client_id,
                'canal_vente_id' => $canal_id,
                'statut'         => $statut,
                'date_relance'   => $date_relance ?: null,
                'mtht'           => $montant_total_ht,
                'mtttc'          => $montant_total_ttc,
                'remise_global'  => 0,
                'conditions'     => $conditions ?: null,
                'commentaires'   => $commentaires ?: null,
                'id'             => $id
            ]);

            // Suppression + rÃ©insertion des lignes
            $stmt = $pdo->prepare("DELETE FROM devis_lignes WHERE devis_id = :id");
            $stmt->execute(['id' => $id]);

        } else {
            // INSERT devis
            $sql = "
                INSERT INTO devis (
                    numero, date_devis, client_id, canal_vente_id,
                    statut, date_relance, utilisateur_id,
                    montant_total_ht, montant_total_ttc, remise_global,
                    conditions, commentaires
                ) VALUES (
                    :numero, :date_devis, :client_id, :canal_vente_id,
                    :statut, :date_relance, :utilisateur_id,
                    :mtht, :mtttc, :remise_global,
                    :conditions, :commentaires
                )
            ";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([
                'numero'         => $numero,
                'date_devis'     => $date_devis,
                'client_id'      => $client_id,
                'canal_vente_id' => $canal_id,
                'statut'         => $statut,
                'date_relance'   => $date_relance ?: null,
                'utilisateur_id' => $userId,
                'mtht'           => $montant_total_ht,
                'mtttc'          => $montant_total_ttc,
                'remise_global'  => 0,
                'conditions'     => $conditions ?: null,
                'commentaires'   => $commentaires ?: null,
            ]);
            $id = (int)$pdo->lastInsertId();
            $modeEdition = true;
        }

        // Insertion des lignes
        $stmt = $pdo->prepare("
            INSERT INTO devis_lignes (
                devis_id, produit_id, quantite,
                prix_unitaire, remise, montant_ligne_ht
            ) VALUES (
                :devis_id, :produit_id, :quantite,
                :prix_unitaire, :remise, :montant_ligne_ht
            )
        ");
        foreach ($lignes as $l) {
            $stmt->execute([
                'devis_id'        => $id,
                'produit_id'      => $l['produit_id'],
                'quantite'        => $l['quantite'],
                'prix_unitaire'   => $l['prix_unitaire'],
                'remise'          => $l['remise'],
                'montant_ligne_ht'=> $l['montant_ligne_ht'],
            ]);
        }

        $_SESSION['flash_success'] = $modeEdition
            ? "Le devis a Ã©tÃ© mis Ã  jour."
            : "Le devis a Ã©tÃ© crÃ©Ã©.";
        header('Location: ' . $devisListUrl);
        exit;
    }
}

$csrfToken = getCsrfToken();

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $modeEdition ? 'Modifier un devis' : 'Nouveau devis' ?>
        </h1>
        <a href="<?= $devisListUrl ?>" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
        </a>
    </div>

    <?php if (!empty($erreurs)): ?>
        <div class="alert alert-danger">
            <h2 class="h6 mb-2"><i class="bi bi-exclamation-triangle me-1"></i> Erreurs</h2>
            <ul class="mb-0">
                <?php foreach ($erreurs as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <form method="post" class="card">
        <div class="card-body">
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">
            <input type="hidden" name="id" value="<?= (int)$id ?>">

            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <label class="form-label small">NÂ° devis</label>
                    <input type="text" name="numero" class="form-control"
                           value="<?= htmlspecialchars($numero) ?>"
                           placeholder="Auto si vide">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Date devis</label>
                    <input type="date" name="date_devis" class="form-control"
                           value="<?= htmlspecialchars($date_devis) ?>">
                </div>

                <!-- Client avec recherche AJAX -->
                <div class="col-md-3 position-relative">
                    <label class="form-label small">Client (BD KMS) *</label>
                    <input type="hidden" name="client_id" id="client_id" value="<?= (int)$client_id ?>">
                    <input type="text"
                           id="client_search"
                           class="form-control"
                           placeholder="Rechercher un client par nom, tÃ©lÃ©phone ou email..."
                           value="<?= htmlspecialchars($clientNom) ?>">
                    <div id="client_search_results"
                         class="list-group position-absolute w-100 shadow-sm"
                         style="z-index: 1050; max-height: 250px; overflow-y: auto; display:none;"></div>
                    <div class="form-text">
                        Tape quelques lettres puis sÃ©lectionne un client dans la liste.
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Canal *</label>
                    <select name="canal_vente_id" class="form-select" required>
                        <?php foreach ($canaux as $cv): ?>
                            <option value="<?= (int)$cv['id'] ?>"
                                <?= $canal_id === (int)$cv['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($cv['code']) ?> â€“ <?= htmlspecialchars($cv['libelle']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Statut</label>
                    <select name="statut" class="form-select">
                        <?php foreach (['EN_ATTENTE','ACCEPTE','REFUSE','ANNULE'] as $s): ?>
                            <option value="<?= $s ?>" <?= $statut === $s ? 'selected' : '' ?>>
                                <?= $s ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Date de relance</label>
                    <input type="date" name="date_relance" class="form-control"
                           value="<?= htmlspecialchars($date_relance) ?>">
                </div>
            </div>

            <hr>

            <!-- Lignes de devis -->
            <h2 class="h6 mb-2">Lignes du devis</h2>
            <p class="text-muted small mb-2">
                Ajoutez les produits, quantitÃ©s et remises Ã©ventuelles.
            </p>

            <div class="table-responsive mb-2">
                <table class="table table-sm align-middle" id="table-lignes">
                    <thead class="table-light">
                    <tr>
                        <th style="width: 35%;">Produit</th>
                        <th style="width: 10%;">QtÃ©</th>
                        <th style="width: 15%;">Prix unitaire</th>
                        <th style="width: 15%;">Remise</th>
                        <th style="width: 15%;">Montant HT</th>
                        <th style="width: 10%;"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <?php
                    if (!empty($lignes)) {
                        foreach ($lignes as $index => $l):
                            $pid = (int)$l['produit_id'] ?? (int)$l['id'];
                            $qte = (int)($l['quantite'] ?? 1);
                            $pu  = (float)($l['prix_unitaire'] ?? 0);
                            $rem = (float)($l['remise'] ?? 0);
                            $mt  = (float)($l['montant_ligne_ht'] ?? ($qte * $pu - $rem));
                    ?>
                        <tr>
                            <td>
                                <select name="ligne_produit_id[]" class="form-select form-select-sm ligne-produit">
                                    <option value="">SÃ©lectionner...</option>
                                    <?php foreach ($produits as $p): ?>
                                        <option value="<?= (int)$p['id'] ?>"
                                            <?= $pid === (int)$p['id'] ? 'selected' : '' ?>
                                            data-prix="<?= (float)$p['prix_vente'] ?>">
                                            <?= htmlspecialchars($p['code_produit']) ?> â€“ <?= htmlspecialchars($p['designation']) ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </td>
                            <td>
                                <input type="number" name="ligne_quantite[]" class="form-control form-control-sm ligne-quantite"
                                       value="<?= $qte ?>" min="1">
                            </td>
                            <td>
                                <input type="number" step="0.01" name="ligne_prix[]" class="form-control form-control-sm ligne-prix"
                                       value="<?= $pu ?>">
                            </td>
                            <td>
                                <input type="number" step="0.01" name="ligne_remise[]" class="form-control form-control-sm ligne-remise"
                                       value="<?= $rem ?>">
                            </td>
                            <td class="text-end">
                                <span class="ligne-montant">
                                    <?= number_format($mt, 0, ',', ' ') ?>
                                </span>
                            </td>
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-outline-danger btn-remove-ligne">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    <?php
                        endforeach;
                    } else {
                        // au moins une ligne vide par dÃ©faut
                    ?>
                        <tr>
                            <td>
                                <select name="ligne_produit_id[]" class="form-select form-select-sm ligne-produit">
                                    <option value="">SÃ©lectionner...</option>
                                    <?php foreach ($produits as $p): ?>
                                        <option value="<?= (int)$p['id'] ?>" data-prix="<?= (float)$p['prix_vente'] ?>">
                                            <?= htmlspecialchars($p['code_produit']) ?> â€“ <?= htmlspecialchars($p['designation']) ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </td>
                            <td>
                                <input type="number" name="ligne_quantite[]" class="form-control form-control-sm ligne-quantite"
                                       value="1" min="1">
                            </td>
                            <td>
                                <input type="number" step="0.01" name="ligne_prix[]" class="form-control form-control-sm ligne-prix"
                                       value="0">
                            </td>
                            <td>
                                <input type="number" step="0.01" name="ligne_remise[]" class="form-control form-control-sm ligne-remise"
                                       value="0">
                            </td>
                            <td class="text-end">
                                <span class="ligne-montant">0</span>
                            </td>
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-outline-danger btn-remove-ligne">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    <?php } ?>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="4" class="text-end fw-semibold">Total HT estimÃ©</td>
                        <td class="text-end fw-bold" id="total_ht_cell">
                            <?= number_format($montant_total_ht, 0, ',', ' ') ?>
                        </td>
                        <td></td>
                    </tr>
                    </tfoot>
                </table>
            </div>

            <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-ligne">
                <i class="bi bi-plus-circle me-1"></i> Ajouter une ligne
            </button>

            <hr>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label small">Conditions</label>
                    <textarea name="conditions" class="form-control" rows="3"><?= htmlspecialchars($conditions) ?></textarea>
                </div>
                <div class="col-md-6">
                    <label class="form-label small">Commentaires internes</label>
                    <textarea name="commentaires" class="form-control" rows="3"><?= htmlspecialchars($commentaires) ?></textarea>
                </div>
            </div>
        </div>

        <div class="card-footer d-flex justify-content-end gap-2">
            <a href="<?= $devisListUrl ?>" class="btn btn-outline-secondary">Annuler</a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>
                <?= $modeEdition ? 'Enregistrer le devis' : 'CrÃ©er le devis' ?>
            </button>
        </div>
    </form>
</div>

<!-- Script recherche AJAX client (mÃªme logique que satisfaction) -->
<script>
(function() {
    const input      = document.getElementById('client_search');
    const hiddenId   = document.getElementById('client_id');
    const resultsBox = document.getElementById('client_search_results');

    if (!input || !hiddenId || !resultsBox) {
        return;
    }

    let timer = null;

    function clearResults() {
        resultsBox.innerHTML = '';
        resultsBox.style.display = 'none';
    }

    function selectClient(button) {
        hiddenId.value = button.dataset.id;
        input.value    = button.dataset.label;
        clearResults();
    }

    input.addEventListener('input', function() {
        const q = this.value.trim();
        hiddenId.value = '';

        if (timer) {
            clearTimeout(timer);
        }

        if (q.length < 2) {
            clearResults();
            return;
        }

        timer = setTimeout(function() {
            fetch('<?= url_for('ajax/clients_search.php') ?>?q=' + encodeURIComponent(q), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    resultsBox.innerHTML = '';

                    if (!Array.isArray(data) || data.length === 0) {
                        clearResults();
                        return;
                    }

                    data.forEach(function(row) {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'list-group-item list-group-item-action py-1';
                        btn.textContent = row.label;
                        btn.dataset.id = row.id;
                        btn.dataset.label = row.label;
                        btn.addEventListener('click', function() {
                            selectClient(btn);
                        });
                        resultsBox.appendChild(btn);
                    });

                    resultsBox.style.display = 'block';
                })
                .catch(function() {
                    clearResults();
                });
        }, 300);
    });

    document.addEventListener('click', function(e) {
        if (!resultsBox.contains(e.target) && e.target !== input) {
            clearResults();
        }
    });
})();
</script>

<script>
    const table = document.getElementById('table-lignes').querySelector('tbody');
    const btnAdd = document.getElementById('btn-add-ligne');
    const totalHtCell = document.getElementById('total_ht_cell');

    function recalculerLignes() {
        let total = 0;
        table.querySelectorAll('tr').forEach(tr => {
            const qteInput = tr.querySelector('.ligne-quantite');
            const prixInput = tr.querySelector('.ligne-prix');
            const remInput  = tr.querySelector('.ligne-remise');
            const montantSpan = tr.querySelector('.ligne-montant');

            const qte = parseFloat(qteInput.value || '0');
            const pu  = parseFloat(prixInput.value || '0');
            const rem = parseFloat(remInput.value || '0');

            let mt = qte * pu - rem;
            if (!isFinite(mt) || mt < 0) mt = 0;
            montantSpan.textContent = Math.round(mt).toLocaleString('fr-FR');
            total += mt;
        });

        totalHtCell.textContent = Math.round(total).toLocaleString('fr-FR');
    }

    function attachEvents(tr) {
        tr.querySelectorAll('.ligne-quantite, .ligne-prix, .ligne-remise')
          .forEach(input => input.addEventListener('input', recalculerLignes));

        const select = tr.querySelector('.ligne-produit');
        if (select) {
            select.addEventListener('change', () => {
                const opt = select.selectedOptions[0];
                if (opt && opt.dataset.prix) {
                    const prixInput = tr.querySelector('.ligne-prix');
                    prixInput.value = opt.dataset.prix;
                    recalculerLignes();
                }
            });
        }

        const btnRemove = tr.querySelector('.btn-remove-ligne');
        btnRemove.addEventListener('click', () => {
            tr.remove();
            recalculerLignes();
        });
    }

    table.querySelectorAll('tr').forEach(attachEvents);

    btnAdd.addEventListener('click', () => {
        const tr = document.createElement('tr');
        tr.innerHTML = <?= json_encode(
"<td>
    <select name=\"ligne_produit_id[]\" class=\"form-select form-select-sm ligne-produit\">
        <option value=\"\">SÃ©lectionner...</option>" .
        implode('', array_map(function($p){
            return '<option value="'.$p['id'].'" data-prix="'.$p['prix_vente'].'">'.
                   htmlspecialchars($p['code_produit'] . ' â€“ ' . $p['designation'], ENT_QUOTES) .
                   '</option>';
        }, $produits)) .
    "</select>
</td>
<td>
    <input type=\"number\" name=\"ligne_quantite[]\" class=\"form-control form-control-sm ligne-quantite\" value=\"1\" min=\"1\">
</td>
<td>
    <input type=\"number\" step=\"0.01\" name=\"ligne_prix[]\" class=\"form-control form-control-sm ligne-prix\" value=\"0\">
</td>
<td>
    <input type=\"number\" step=\"0.01\" name=\"ligne_remise[]\" class=\"form-control form-control-sm ligne-remise\" value=\"0\">
</td>
<td class=\"text-end\">
    <span class=\"ligne-montant\">0</span>
</td>
<td class=\"text-end\">
    <button type=\"button\" class=\"btn btn-sm btn-outline-danger btn-remove-ligne\">
        <i class=\"bi bi-trash\"></i>
    </button>
</td>"
, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES); ?>;
        table.appendChild(tr);
        attachEvents(tr);
        recalculerLignes();
    });

    recalculerLignes();
</script>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : devis\list.php =====

<?php
// devis/list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('DEVIS_LIRE');

global $pdo;

// Base URL du dossier /devis, quel que soit le rÃ©pertoire de l'app
$devisBasePath = rtrim(dirname($_SERVER['SCRIPT_NAME']), '/\\');

$today = date('Y-m-d');

$dateDebut = $_GET['date_debut'] ?? $today;
$dateFin   = $_GET['date_fin'] ?? $today;
$statut    = $_GET['statut'] ?? '';
$clientId  = isset($_GET['client_id']) ? (int)$_GET['client_id'] : 0;
$canalId   = isset($_GET['canal_id']) ? (int)$_GET['canal_id'] : 0;

// Clients pour filtre
$stmt = $pdo->query("SELECT id, nom FROM clients ORDER BY nom");
$clients = $stmt->fetchAll();

// Canaux de vente pour filtre
$stmt = $pdo->query("SELECT id, code, libelle FROM canaux_vente ORDER BY code");
$canaux = $stmt->fetchAll();

$where  = [];
$params = [];

if ($dateDebut !== '') {
    $where[] = "d.date_devis >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "d.date_devis <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($statut !== '' && in_array($statut, ['EN_ATTENTE','ACCEPTE','REFUSE','ANNULE'], true)) {
    $where[] = "d.statut = :statut";
    $params['statut'] = $statut;
}
if ($clientId > 0) {
    $where[] = "d.client_id = :client_id";
    $params['client_id'] = $clientId;
}
if ($canalId > 0) {
    $where[] = "d.canal_vente_id = :canal_id";
    $params['canal_id'] = $canalId;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

$sql = "
    SELECT
        d.*,
        c.nom AS client_nom,
        cv.code AS canal_code,
        cv.libelle AS canal_libelle,
        u.nom_complet AS commercial_nom
    FROM devis d
    JOIN clients c ON c.id = d.client_id
    JOIN canaux_vente cv ON cv.id = d.canal_vente_id
    JOIN utilisateurs u ON u.id = d.utilisateur_id
    $whereSql
    ORDER BY d.date_devis DESC, d.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$devis = $stmt->fetchAll();

$peutCreerDevis = in_array('DEVIS_CREER', $_SESSION['permissions'] ?? [], true);
$peutCreerVente = in_array('VENTES_CREER', $_SESSION['permissions'] ?? [], true);

$flashSuccess = $_SESSION['flash_success'] ?? null;
unset($_SESSION['flash_success']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Devis</h1>
        <?php if ($peutCreerDevis): ?>
            <a href="<?= htmlspecialchars($devisBasePath . '/edit.php') ?>" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i> Nouveau devis
            </a>
        <?php endif; ?>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <div class="card mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Statut</label>
                    <select name="statut" class="form-select">
                        <option value="">Tous</option>
                        <?php foreach (['EN_ATTENTE','ACCEPTE','REFUSE','ANNULE'] as $s): ?>
                            <option value="<?= $s ?>" <?= $statut === $s ? 'selected' : '' ?>>
                                <?= $s ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Client</label>
                    <select name="client_id" class="form-select">
                        <option value="0">Tous</option>
                        <?php foreach ($clients as $cl): ?>
                            <option value="<?= (int)$cl['id'] ?>"
                                <?= $clientId === (int)$cl['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($cl['nom']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Canal</label>
                    <select name="canal_id" class="form-select">
                        <option value="0">Tous</option>
                        <?php foreach ($canaux as $cv): ?>
                            <option value="<?= (int)$cv['id'] ?>"
                                <?= $canalId === (int)$cv['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($cv['code']) ?> â€“ <?= htmlspecialchars($cv['libelle']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-12 d-flex gap-2 mt-2">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= htmlspecialchars($devisBasePath . '/list.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <?php if (empty($devis)): ?>
                <p class="text-muted mb-0">Aucun devis trouvÃ© pour les filtres sÃ©lectionnÃ©s.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>NÂ° devis</th>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Canal</th>
                            <th>Commercial</th>
                            <th class="text-end">Montant HT</th>
                            <th class="text-center">Statut</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($devis as $d): ?>
                            <tr>
                                <td><?= htmlspecialchars($d['numero']) ?></td>
                                <td><?= htmlspecialchars($d['date_devis']) ?></td>
                                <td><?= htmlspecialchars($d['client_nom']) ?></td>
                                <td>
                                    <span class="badge bg-primary-subtle text-primary">
                                        <?= htmlspecialchars($d['canal_code']) ?>
                                    </span>
                                    <span class="text-muted small d-block">
                                        <?= htmlspecialchars($d['canal_libelle']) ?>
                                    </span>
                                </td>
                                <td><?= htmlspecialchars($d['commercial_nom']) ?></td>
                                <td class="text-end">
                                    <?= number_format((float)$d['montant_total_ht'], 0, ',', ' ') ?> FCFA
                                </td>
                                <td class="text-center">
                                    <?php
                                    $badgeClass = 'bg-secondary-subtle text-secondary';
                                    if ($d['statut'] === 'EN_ATTENTE') {
                                        $badgeClass = 'bg-warning-subtle text-warning';
                                    } elseif ($d['statut'] === 'ACCEPTE') {
                                        $badgeClass = 'bg-success-subtle text-success';
                                    } elseif ($d['statut'] === 'REFUSE') {
                                        $badgeClass = 'bg-danger-subtle text-danger';
                                    } elseif ($d['statut'] === 'ANNULE') {
                                        $badgeClass = 'bg-dark-subtle text-dark';
                                    }

                                    $libelleStatut = $d['statut'];
                                    if ($d['statut'] === 'ACCEPTE' && !empty($d['est_converti'])) {
                                        $libelleStatut = 'ACCEPTE (converti)';
                                    }
                                    ?>
                                    <span class="badge <?= $badgeClass ?>">
                                        <?= htmlspecialchars($libelleStatut) ?>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <a href="<?= htmlspecialchars($devisBasePath . '/edit.php?id=' . (int)$d['id']) ?>"
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil-square me-1"></i> Ouvrir
                                    </a>
                                    <?php if (
                                        $peutCreerVente
                                        && $d['statut'] === 'ACCEPTE'
                                        && empty($d['est_converti'])
                                    ): ?>
                                        <a href="<?= htmlspecialchars($devisBasePath . '/convertir_en_vente.php?id=' . (int)$d['id']) ?>"
                                           class="btn btn-sm btn-outline-success">
                                            <i class="bi bi-cart-check me-1"></i> Convertir en vente
                                        </a>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : formation\formations_edit.php =====

<?php
// formation/formations_edit.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('FORMATION_GERER');

global $pdo;

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$editing = $id > 0;
$formation = [
    'nom'         => '',
    'description' => '',
    'tarif_total' => 0,
];

// Chargement si Ã©dition
if ($editing) {
    $stmt = $pdo->prepare("SELECT * FROM formations WHERE id = :id");
    $stmt->execute(['id' => $id]);
    $formation = $stmt->fetch();

    if (!$formation) {
        $_SESSION['flash_error'] = "Formation introuvable.";
        header('Location: ' . url_for('formation/formations_list.php'));
        exit;
    }
}

// Traitement POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $nom    = trim($_POST['nom'] ?? '');
    $desc   = trim($_POST['description'] ?? '');
    $tarif  = str_replace(',', '.', $_POST['tarif_total'] ?? '0');
    $tarif  = (float)$tarif;

    $errors = [];

    if ($nom === '') {
        $errors[] = "Le nom de la formation est obligatoire.";
    }
    if ($tarif <= 0) {
        $errors[] = "Le tarif doit Ãªtre strictement positif.";
    }

    if (empty($errors)) {
        if ($editing) {
            $stmt = $pdo->prepare("
                UPDATE formations
                SET nom = :nom, description = :description, tarif_total = :tarif
                WHERE id = :id
            ");
            $stmt->execute([
                'nom'         => $nom,
                'description' => $desc,
                'tarif'       => $tarif,
                'id'          => $id,
            ]);

            $_SESSION['flash_success'] = "Formation mise Ã  jour avec succÃ¨s.";
        } else {
            $stmt = $pdo->prepare("
                INSERT INTO formations (nom, description, tarif_total)
                VALUES (:nom, :description, :tarif)
            ");
            $stmt->execute([
                'nom'         => $nom,
                'description' => $desc,
                'tarif'       => $tarif,
            ]);

            $_SESSION['flash_success'] = "Formation crÃ©Ã©e avec succÃ¨s.";
        }

        header('Location: ' . url_for('formation/formations_list.php'));
        exit;
    } else {
        $_SESSION['flash_error'] = implode(' ', $errors);
        header('Location: ' . $_SERVER['REQUEST_URI']);
        exit;
    }
}

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $editing ? 'Modifier la formation' : 'Nouvelle formation' ?>
        </h1>
        <a href="<?= url_for('formation/formations_list.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Retour au catalogue
        </a>
    </div>

    <?php if (!empty($_SESSION['flash_error'])): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($_SESSION['flash_error']) ?>
        </div>
        <?php unset($_SESSION['flash_error']); ?>
    <?php endif; ?>

    <div class="card">
        <div class="card-body">
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                <div class="col-md-6">
                    <label class="form-label small">Nom de la formation</label>
                    <input type="text" name="nom" class="form-control"
                           value="<?= htmlspecialchars($formation['nom']) ?>" required>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Tarif total</label>
                    <div class="input-group">
                        <input type="number" step="100" min="0" name="tarif_total" class="form-control"
                               value="<?= htmlspecialchars((float)$formation['tarif_total']) ?>" required>
                        <span class="input-group-text">FCFA</span>
                    </div>
                </div>

                <div class="col-12">
                    <label class="form-label small">Description</label>
                    <textarea name="description" rows="4" class="form-control"
                              placeholder="Contenu, objectifs, durÃ©e, prÃ©requis..."><?= htmlspecialchars($formation['description']) ?></textarea>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : formation\formations_list.php =====

<?php
// formation/formations_list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('FORMATION_GERER');

global $pdo;

// RÃ©cup liste des formations
$stmt = $pdo->query("
    SELECT *
    FROM formations
    ORDER BY nom ASC
");
$formations = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Formations (catalogue)</h1>
        <a href="<?= url_for('formation/formations_edit.php') ?>" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> Nouvelle formation
        </a>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <div class="card">
        <div class="card-body">
            <?php if (empty($formations)): ?>
                <p class="text-muted mb-0">Aucune formation dÃ©finie pour le moment.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Nom</th>
                            <th>Description</th>
                            <th class="text-end">Tarif total</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($formations as $f): ?>
                            <tr>
                                <td class="fw-semibold"><?= htmlspecialchars($f['nom']) ?></td>
                                <td><?= nl2br(htmlspecialchars($f['description'] ?? '')) ?></td>
                                <td class="text-end">
                                    <?= number_format((float)$f['tarif_total'], 0, ',', ' ') ?> FCFA
                                </td>
                                <td class="text-end">
                                    <a href="<?= url_for('formation/formations_edit.php') . '?id=' . (int)$f['id'] ?>"
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil-square me-1"></i> Modifier
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : formation\inscriptions.php =====

<?php
// formation/inscriptions.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('FORMATION_GERER');

global $pdo;

// --- RÃ©cupÃ©ration des formations (schÃ©ma rÃ©el : nom, tarif_total) ---
$stmt = $pdo->query("
    SELECT id, nom, description, tarif_total
    FROM formations
    ORDER BY nom
");
$formations = $stmt->fetchAll();
$formationsMap = [];
foreach ($formations as $f) {
    $formationsMap[(int)$f['id']] = $f;
}

// --- RÃ©cupÃ©ration des clients (simple select pour l'instant) ---
$stmt = $pdo->query("
    SELECT id, nom
    FROM clients
    ORDER BY nom
");
$clients = $stmt->fetchAll();

// --- Traitement ajout / enregistrement d'une inscription ---
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $dateInscription = $_POST['date_inscription'] ?? date('Y-m-d');
    $formationId     = isset($_POST['formation_id']) ? (int)$_POST['formation_id'] : 0;
    $apprenantNom    = trim($_POST['apprenant_nom'] ?? '');
    $clientId        = isset($_POST['client_id']) && $_POST['client_id'] !== ''
        ? (int)$_POST['client_id']
        : null;
    $montantPayeRaw  = str_replace(',', '.', $_POST['montant_paye'] ?? '0');
    $soldeDuRaw      = str_replace(',', '.', $_POST['solde_du'] ?? '');

    $montantPaye = (float)$montantPayeRaw;
    $soldeDu     = ($soldeDuRaw === '') ? null : (float)$soldeDuRaw;

    $errors = [];

    if ($dateInscription === '') {
        $errors[] = "La date d'inscription est obligatoire.";
    }

    if ($formationId <= 0 || !isset($formationsMap[$formationId])) {
        $errors[] = "Veuillez sÃ©lectionner une formation valide.";
    }

    if ($apprenantNom === '' && $clientId === null) {
        $errors[] = "Veuillez renseigner au moins le nom de l'apprenant ou sÃ©lectionner un client existant.";
    }

    if ($montantPaye < 0) {
        $errors[] = "Le montant payÃ© ne peut pas Ãªtre nÃ©gatif.";
    }

    // Si la formation existe, on peut calculer un solde par dÃ©faut Ã  partir de tarif_total
    if ($soldeDu === null && isset($formationsMap[$formationId])) {
        $tarif = (float)$formationsMap[$formationId]['tarif_total'];
        $soldeDu = max(0, $tarif - $montantPaye);
    }

    if ($soldeDu < 0) {
        $errors[] = "Le solde dÃ» ne peut pas Ãªtre nÃ©gatif.";
    }

    if (empty($errors)) {
        // Si client_id renseignÃ© mais pas de nom apprenant, on recopie le nom du client
        if ($clientId !== null && $apprenantNom === '') {
            $stmt = $pdo->prepare("SELECT nom FROM clients WHERE id = :id");
            $stmt->execute(['id' => $clientId]);
            $cli = $stmt->fetch();
            if ($cli) {
                $apprenantNom = $cli['nom'];
            }
        }

        $stmt = $pdo->prepare("
            INSERT INTO inscriptions_formation (
                date_inscription,
                apprenant_nom,
                client_id,
                formation_id,
                montant_paye,
                solde_du
            ) VALUES (
                :date_inscription,
                :apprenant_nom,
                :client_id,
                :formation_id,
                :montant_paye,
                :solde_du
            )
        ");
        $stmt->execute([
            'date_inscription' => $dateInscription,
            'apprenant_nom'    => $apprenantNom,
            'client_id'        => $clientId,
            'formation_id'     => $formationId,
            'montant_paye'     => $montantPaye,
            'solde_du'         => $soldeDu,
        ]);

        $_SESSION['flash_success'] = "Inscription Ã  la formation enregistrÃ©e avec succÃ¨s.";
        header('Location: ' . url_for('formation/inscriptions.php'));
        exit;
    } else {
        $_SESSION['flash_error'] = implode(' ', $errors);
        header('Location: ' . url_for('formation/inscriptions.php'));
        exit;
    }
}

// --- Filtres liste ---
$dateDebut       = $_GET['date_debut'] ?? date('Y-m-01');
$dateFin         = $_GET['date_fin'] ?? date('Y-m-d');
$formationFilter = isset($_GET['formation_id']) ? (int)$_GET['formation_id'] : 0;

$where  = [];
$params = [];

if ($dateDebut !== '') {
    $where[] = "i.date_inscription >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "i.date_inscription <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($formationFilter > 0) {
    $where[] = "i.formation_id = :formation_id";
    $params['formation_id'] = $formationFilter;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// --- RÃ©cupÃ©ration des inscriptions ---
// SchÃ©ma rÃ©el : formations.nom, formations.tarif_total
$sql = "
    SELECT
        i.*,
        f.nom         AS formation_nom,
        f.tarif_total AS formation_tarif_total,
        c.nom         AS client_nom
    FROM inscriptions_formation i
    JOIN formations f ON f.id = i.formation_id
    LEFT JOIN clients c ON c.id = i.client_id
    $whereSql
    ORDER BY i.date_inscription DESC, i.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$inscriptions = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

$csrfToken = getCsrfToken();

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Inscriptions aux formations</h1>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Formulaire rapide d'inscription -->
    <div class="card mb-3">
        <div class="card-body">
            <h2 class="h6 mb-3">Enregistrer une nouvelle inscription</h2>
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">

                <div class="col-md-3">
                    <label class="form-label small">Date d'inscription</label>
                    <input type="date"
                           name="date_inscription"
                           class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Formation *</label>
                    <select name="formation_id" class="form-select" required>
                        <option value="">SÃ©lectionner une formation...</option>
                        <?php foreach ($formations as $f): ?>
                            <option value="<?= (int)$f['id'] ?>">
                                <?= htmlspecialchars($f['nom']) ?>
                                â€“ <?= number_format((float)$f['tarif_total'], 0, ',', ' ') ?> FCFA
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <div class="form-text">
                        La liste reprend toutes les formations enregistrÃ©es.
                    </div>
                </div>

                <div class="col-md-5">
                    <label class="form-label small">Apprenant (nom libre)</label>
                    <input type="text" name="apprenant_nom" class="form-control"
                           placeholder="Nom de l'apprenant (si diffÃ©rent ou pas dans la base)">
                    <div class="form-text">
                        Tu peux laisser vide si tu sÃ©lectionnes un client ci-dessous.
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label small">Client (BD KMS - facultatif)</label>
                    <select name="client_id" class="form-select">
                        <option value="">Aucun / non existant</option>
                        <?php foreach ($clients as $c): ?>
                            <option value="<?= (int)$c['id'] ?>">
                                <?= htmlspecialchars($c['nom']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <div class="form-text">
                        Pour l'instant sÃ©lection simple ; on uniformisera plus tard avec la recherche.
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Montant payÃ© (FCFA)</label>
                    <input type="number" step="0.01" min="0"
                           name="montant_paye"
                           class="form-control"
                           value="0">
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Solde dÃ» (FCFA)</label>
                    <input type="number" step="0.01" min="0"
                           name="solde_du"
                           class="form-control"
                           placeholder="Auto selon tarif si laissÃ© vide">
                    <div class="form-text">
                        Si tu laisses vide, le solde sera calculÃ© Ã  partir du tarif de la formation.
                    </div>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Enregistrer l'inscription
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtres liste -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-4">
                    <label class="form-label small">Formation</label>
                    <select name="formation_id" class="form-select">
                        <option value="0">Toutes</option>
                        <?php foreach ($formations as $f): ?>
                            <option value="<?= (int)$f['id'] ?>"
                                <?= $formationFilter === (int)$f['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($f['nom']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-2 d-flex gap-2 mt-3 mt-md-0">
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('formation/inscriptions.php') ?>" class="btn btn-outline-secondary w-100">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des inscriptions -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($inscriptions)): ?>
                <p class="text-muted mb-0">
                    Aucune inscription trouvÃ©e pour les filtres sÃ©lectionnÃ©s.
                </p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Apprenant</th>
                            <th>Client (BD)</th>
                            <th>Formation</th>
                            <th class="text-end">Montant payÃ©</th>
                            <th class="text-end">Solde dÃ»</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($inscriptions as $i): ?>
                            <tr>
                                <td><?= htmlspecialchars($i['date_inscription']) ?></td>
                                <td class="fw-semibold">
                                    <?= htmlspecialchars($i['apprenant_nom']) ?>
                                </td>
                                <td>
                                    <?php if (!empty($i['client_id'])): ?>
                                        <span class="badge bg-primary-subtle text-primary">
                                            <?= htmlspecialchars($i['client_nom'] ?? ('ID #' . (int)$i['client_id'])) ?>
                                        </span>
                                    <?php else: ?>
                                        <span class="text-muted small">Non rattachÃ©</span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <span class="fw-semibold">
                                        <?= htmlspecialchars($i['formation_nom']) ?>
                                    </span><br>
                                    <span class="text-muted small">
                                        Tarif : <?= number_format((float)$i['formation_tarif_total'], 0, ',', ' ') ?> FCFA
                                    </span>
                                </td>
                                <td class="text-end">
                                    <?= number_format((float)$i['montant_paye'], 0, ',', ' ') ?> FCFA
                                </td>
                                <td class="text-end">
                                    <?= number_format((float)$i['solde_du'], 0, ',', ' ') ?> FCFA
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : formation\prospects_list.php =====

<?php
// formation/prospects_list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('FORMATION_GERER');

global $pdo;

// Formations pour select
$stmtForm = $pdo->query("SELECT id, nom FROM formations ORDER BY nom");
$formations = $stmtForm->fetchAll();

// Traitement ajout prospect
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $dateProspect = $_POST['date_prospect'] ?? date('Y-m-d');
    $nom          = trim($_POST['nom_prospect'] ?? '');
    $contact      = trim($_POST['contact'] ?? '');
    $source       = trim($_POST['source'] ?? '');
    $statut       = trim($_POST['statut_actuel'] ?? '');
    $clientId     = isset($_POST['client_id']) ? (int)$_POST['client_id'] : null;

    $errors = [];

    if ($nom === '') {
        $errors[] = "Le nom du prospect est obligatoire.";
    }
    if ($contact === '') {
        $errors[] = "Le contact est recommandÃ© (tÃ©lÃ©phone, email...).";
    }
    if ($statut === '') {
        $statut = 'Nouveau';
    }

    if (empty($errors)) {
        $stmt = $pdo->prepare("
            INSERT INTO prospects_formation
                (date_prospect, nom_prospect, contact, source, statut_actuel, client_id, utilisateur_id)
            VALUES
                (:date_prospect, :nom, :contact, :source, :statut, :client_id, :user_id)
        ");
        $stmt->execute([
            'date_prospect' => $dateProspect,
            'nom'           => $nom,
            'contact'       => $contact,
            'source'        => $source,
            'statut'        => $statut,
            'client_id'     => $clientId ?: null,
            'user_id'       => utilisateurConnecte()['id'] ?? null,
        ]);

        $_SESSION['flash_success'] = "Prospect formation enregistrÃ©.";
        header('Location: ' . url_for('formation/prospects_list.php'));
        exit;
    } else {
        $_SESSION['flash_error'] = implode(' ', $errors);
        header('Location: ' . url_for('formation/prospects_list.php'));
        exit;
    }
}

// Filtres liste
$today      = date('Y-m-d');
$firstMonth = date('Y-m-01');

$dateDeb = $_GET['date_debut'] ?? $firstMonth;
$dateFin = $_GET['date_fin'] ?? $today;
$statut  = trim($_GET['statut'] ?? '');

$where  = [];
$params = [];

if ($dateDeb !== '') {
    $where[] = "p.date_prospect >= :date_debut";
    $params['date_debut'] = $dateDeb;
}
if ($dateFin !== '') {
    $where[] = "p.date_prospect <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($statut !== '') {
    $where[] = "p.statut_actuel = :statut";
    $params['statut'] = $statut;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

$sql = "
    SELECT
        p.*,
        u.nom_complet AS commercial_nom
    FROM prospects_formation p
    LEFT JOIN utilisateurs u ON u.id = p.utilisateur_id
    $whereSql
    ORDER BY p.date_prospect DESC, p.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$prospects = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Prospects formation</h1>
        <a href="<?= url_for('formation/inscriptions.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-person-check me-1"></i> Aller aux inscriptions
        </a>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Formulaire ajout prospect -->
    <div class="card mb-3">
        <div class="card-body">
            <h2 class="h6 mb-3">Enregistrer un prospect formation</h2>
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                <div class="col-md-2">
                    <label class="form-label small">Date</label>
                    <input type="date" name="date_prospect" class="form-control"
                           value="<?= htmlspecialchars($dateDeb) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Nom du prospect</label>
                    <input type="text" name="nom_prospect" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Contact</label>
                    <input type="text" name="contact" class="form-control"
                           placeholder="TÃ©lÃ©phone, email...">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Source</label>
                    <input type="text" name="source" class="form-control"
                           placeholder="Facebook, appel, visite...">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Statut actuel</label>
                    <select name="statut_actuel" class="form-select">
                        <?php
                        $statuts = ['Nouveau','En cours','RelancÃ©','Inscrit','Perdu'];
                        foreach ($statuts as $s):
                        ?>
                            <option value="<?= $s ?>"><?= $s ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Enregistrer le prospect
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtres liste -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDeb) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Statut</label>
                    <select name="statut" class="form-select">
                        <option value="">Tous</option>
                        <?php foreach (['Nouveau','En cours','RelancÃ©','Inscrit','Perdu'] as $s): ?>
                            <option value="<?= $s ?>" <?= $statut === $s ? 'selected' : '' ?>>
                                <?= $s ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3 d-flex gap-2 mt-3 mt-md-0">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('formation/prospects_list.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste prospects -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($prospects)): ?>
                <p class="text-muted mb-0">Aucun prospect trouvÃ© pour la pÃ©riode sÃ©lectionnÃ©e.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Nom</th>
                            <th>Contact</th>
                            <th>Source</th>
                            <th>Statut</th>
                            <th>Commercial</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($prospects as $p): ?>
                            <tr>
                                <td><?= htmlspecialchars($p['date_prospect']) ?></td>
                                <td class="fw-semibold"><?= htmlspecialchars($p['nom_prospect']) ?></td>
                                <td><?= htmlspecialchars($p['contact'] ?? '') ?></td>
                                <td><?= htmlspecialchars($p['source'] ?? '') ?></td>
                                <td>
                                    <span class="badge bg-primary-subtle text-primary">
                                        <?= htmlspecialchars($p['statut_actuel']) ?>
                                    </span>
                                </td>
                                <td><?= htmlspecialchars($p['commercial_nom'] ?? '') ?></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : hotel\chambres_edit.php =====

<?php
// hotel/chambres_edit.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('HOTEL_GERER');

global $pdo;

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$isEdit = $id > 0;

$errors = [];
$chambre = [
    'code'        => '',
    'description' => '',
    'tarif_nuite' => '',
    'actif'       => 1,
];

// Chargement pour Ã©dition
if ($isEdit) {
    $stmt = $pdo->prepare("SELECT * FROM chambres WHERE id = :id");
    $stmt->execute(['id' => $id]);
    $chambre = $stmt->fetch();

    if (!$chambre) {
        $_SESSION['flash_error'] = "Chambre introuvable.";
        header('Location: ' . url_for('hotel/chambres_list.php'));
        exit;
    }
}

// Traitement du formulaire
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $code        = trim($_POST['code'] ?? '');
    $description = trim($_POST['description'] ?? '');
    $tarif       = str_replace([' ', ','], ['', '.'], $_POST['tarif_nuite'] ?? '');
    $actif       = isset($_POST['actif']) ? 1 : 0;

    if ($code === '') {
        $errors[] = "Le code de la chambre est obligatoire.";
    }
    if ($tarif === '' || !is_numeric($tarif) || $tarif < 0) {
        $errors[] = "Le tarif de la nuitÃ© est invalide.";
    }

    if (empty($errors)) {
        if ($isEdit) {
            $stmt = $pdo->prepare("
                UPDATE chambres
                SET code = :code,
                    description = :descr,
                    tarif_nuite = :tarif,
                    actif = :actif
                WHERE id = :id
            ");
            $stmt->execute([
                'code'  => $code,
                'descr' => $description,
                'tarif' => $tarif,
                'actif' => $actif,
                'id'    => $id,
            ]);
            $_SESSION['flash_success'] = "Chambre mise Ã  jour avec succÃ¨s.";
        } else {
            $stmt = $pdo->prepare("
                INSERT INTO chambres (code, description, tarif_nuite, actif)
                VALUES (:code, :descr, :tarif, :actif)
            ");
            $stmt->execute([
                'code'  => $code,
                'descr' => $description,
                'tarif' => $tarif,
                'actif' => $actif,
            ]);
            $_SESSION['flash_success'] = "Chambre crÃ©Ã©e avec succÃ¨s.";
        }

        header('Location: ' . url_for('hotel/chambres_list.php'));
        exit;
    } else {
        // RÃ©injecter valeurs
        $chambre['code']        = $code;
        $chambre['description'] = $description;
        $chambre['tarif_nuite'] = $tarif;
        $chambre['actif']       = $actif;
    }
}

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $isEdit ? 'Modifier la chambre' : 'Nouvelle chambre' ?>
        </h1>
        <a href="<?= url_for('hotel/chambres_list.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
        </a>
    </div>

    <?php if (!empty($errors)): ?>
        <div class="alert alert-danger py-2">
            <ul class="mb-0 small">
                <?php foreach ($errors as $e): ?>
                    <li><?= htmlspecialchars($e) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <div class="card">
        <div class="card-body">
            <form method="post">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                <div class="mb-3">
                    <label class="form-label">Code de la chambre</label>
                    <input type="text" name="code" class="form-control"
                           value="<?= htmlspecialchars($chambre['code']) ?>" required>
                    <div class="form-text">Ex : CH-01, APPART-2B, SUITE-3, ...</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-control" rows="3"><?= htmlspecialchars($chambre['description'] ?? '') ?></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Tarif nuitÃ© (FCFA)</label>
                    <input type="number" step="0.01" min="0" name="tarif_nuite" class="form-control"
                           value="<?= htmlspecialchars($chambre['tarif_nuite']) ?>" required>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="actif" name="actif"
                           <?= (int)$chambre['actif'] === 1 ? 'checked' : '' ?>>
                    <label class="form-check-label" for="actif">
                        Chambre active (rÃ©servable)
                    </label>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i> Enregistrer
                </button>
            </form>
        </div>
    </div>
</div>
<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : hotel\chambres_list.php =====

<?php
// hotel/chambres_list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('HOTEL_GERER');

global $pdo;

// RÃ©cupÃ©ration des chambres
$stmt = $pdo->query("
    SELECT *
    FROM chambres
    ORDER BY code ASC
");
$chambres = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Chambres</h1>
        <a href="<?= url_for('hotel/chambres_edit.php') ?>" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> Nouvelle chambre
        </a>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i><?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i><?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <div class="card">
        <div class="card-body">
            <?php if (empty($chambres)): ?>
                <p class="text-muted mb-0">Aucune chambre enregistrÃ©e.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Code</th>
                            <th>Description</th>
                            <th class="text-end">Tarif nuitÃ©</th>
                            <th class="text-center">Statut</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($chambres as $c): ?>
                            <tr>
                                <td class="fw-semibold"><?= htmlspecialchars($c['code']) ?></td>
                                <td><?= nl2br(htmlspecialchars($c['description'] ?? '')) ?></td>
                                <td class="text-end">
                                    <?= number_format((float)$c['tarif_nuite'], 0, ',', ' ') ?> FCFA
                                </td>
                                <td class="text-center">
                                    <?php if ((int)$c['actif'] === 1): ?>
                                        <span class="badge bg-success-subtle text-success">Active</span>
                                    <?php else: ?>
                                        <span class="badge bg-secondary-subtle text-secondary">Inactive</span>
                                    <?php endif; ?>
                                </td>
                                <td class="text-end">
                                    <a href="<?= url_for('hotel/chambres_edit.php') . '?id=' . (int)$c['id'] ?>"
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil-square me-1"></i> Modifier
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>
<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : hotel\reservations.php =====

<?php
// hotel/reservations.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('HOTEL_GERER');

global $pdo;

$today   = date('Y-m-d');
$dateDeb = $_GET['date_debut'] ?? $today;
$dateFin = $_GET['date_fin'] ?? $today;
$statut  = $_GET['statut'] ?? '';
$clientId  = isset($_GET['client_id']) ? (int)$_GET['client_id'] : 0;
$chambreId = isset($_GET['chambre_id']) ? (int)$_GET['chambre_id'] : 0;

// Clients
$stmt = $pdo->query("SELECT id, nom FROM clients ORDER BY nom");
$clients = $stmt->fetchAll();

// Chambres
$stmt = $pdo->query("SELECT id, code FROM chambres WHERE actif = 1 ORDER BY code");
$chambres = $stmt->fetchAll();

// Filtres
$where  = [];
$params = [];

if ($dateDeb !== '') {
    $where[] = "r.date_debut >= :date_debut";
    $params['date_debut'] = $dateDeb;
}
if ($dateFin !== '') {
    $where[] = "r.date_fin <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($statut !== '' && in_array($statut, ['EN_COURS','TERMINEE','ANNULEE'], true)) {
    $where[] = "r.statut = :statut";
    $params['statut'] = $statut;
}
if ($clientId > 0) {
    $where[] = "r.client_id = :client_id";
    $params['client_id'] = $clientId;
}
if ($chambreId > 0) {
    $where[] = "r.chambre_id = :chambre_id";
    $params['chambre_id'] = $chambreId;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// RequÃªte principale
$sql = "
    SELECT
        r.*,
        c.nom AS client_nom,
        ch.code AS chambre_code,
        mp.libelle AS mode_paiement_libelle
    FROM reservations_hotel r
    JOIN clients c ON c.id = r.client_id
    JOIN chambres ch ON ch.id = r.chambre_id
    LEFT JOIN modes_paiement mp ON mp.id = r.mode_paiement_id
    $whereSql
    ORDER BY r.date_debut DESC, r.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$reservations = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">

    <!-- EN-TÃŠTE AVEC RACCOURCIS -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">RÃ©servations hÃ´tel</h1>

        <div class="d-flex gap-2">
            <a href="<?= url_for('hotel/chambres_list.php') ?>" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-door-closed me-1"></i> Chambres
            </a>
            <a href="<?= url_for('hotel/visiteurs_list.php') ?>" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-person-walking me-1"></i> Visiteurs
            </a>
            <a href="<?= url_for('hotel/upsell_list.php') ?>" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-plus-circle-dotted me-1"></i> Upsell
            </a>
            <a href="<?= url_for('hotel/reservation_edit.php') ?>" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-circle me-1"></i> Nouvelle rÃ©servation
            </a>
        </div>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end" method="get">
                <div class="col-md-2">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDeb) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Statut</label>
                    <select name="statut" class="form-select">
                        <option value="">Tous</option>
                        <?php foreach (['EN_COURS','TERMINEE','ANNULEE'] as $s): ?>
                            <option value="<?= $s ?>" <?= $statut === $s ? 'selected' : '' ?>>
                                <?= $s ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Client</label>
                    <select name="client_id" class="form-select">
                        <option value="0">Tous</option>
                        <?php foreach ($clients as $cl): ?>
                            <option value="<?= (int)$cl['id'] ?>"
                                <?= $clientId === (int)$cl['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($cl['nom']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Chambre</label>
                    <select name="chambre_id" class="form-select">
                        <option value="0">Toutes</option>
                        <?php foreach ($chambres as $ch): ?>
                            <option value="<?= (int)$ch['id'] ?>"
                                <?= $chambreId === (int)$ch['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($ch['code']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-12 d-flex gap-2 mt-2">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('hotel/reservations.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des rÃ©servations -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($reservations)): ?>
                <p class="text-muted mb-0">Aucune rÃ©servation trouvÃ©e pour les filtres sÃ©lectionnÃ©s.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Client</th>
                            <th>Chambre</th>
                            <th>PÃ©riode</th>
                            <th class="text-center">Nuits</th>
                            <th>Statut</th>
                            <th>Mode de paiement</th>
                            <th class="text-end">Montant total</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($reservations as $r): ?>
                            <?php
                            $badgeClass = 'bg-secondary-subtle text-secondary';
                            if ($r['statut'] === 'EN_COURS') $badgeClass = 'bg-warning-subtle text-warning';
                            elseif ($r['statut'] === 'TERMINEE') $badgeClass = 'bg-success-subtle text-success';
                            elseif ($r['statut'] === 'ANNULEE') $badgeClass = 'bg-dark-subtle text-dark';
                            ?>
                            <tr>
                                <td><?= htmlspecialchars($r['client_nom']) ?></td>
                                <td><?= htmlspecialchars($r['chambre_code']) ?></td>
                                <td>
                                    <?= htmlspecialchars($r['date_debut']) ?> â†’ <?= htmlspecialchars($r['date_fin']) ?>
                                </td>
                                <td class="text-center"><?= (int)$r['nb_nuits'] ?></td>
                                <td>
                                    <span class="badge <?= $badgeClass ?>">
                                        <?= htmlspecialchars($r['statut']) ?>
                                    </span>
                                </td>
                                <td><?= htmlspecialchars($r['mode_paiement_libelle'] ?? 'Non renseignÃ©') ?></td>
                                <td class="text-end">
                                    <?= number_format((float)$r['montant_total'], 0, ',', ' ') ?> FCFA
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : hotel\reservation_edit.php =====

<?php
// hotel/reservation_edit.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('HOTEL_GERER');

global $pdo;

$id     = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$isEdit = $id > 0;

$errors = [];

// Listes
$stmt = $pdo->query("SELECT id, nom FROM clients ORDER BY nom");
$clients = $stmt->fetchAll();

$stmt = $pdo->query("SELECT id, code, tarif_nuite FROM chambres WHERE actif = 1 ORDER BY code");
$chambres = $stmt->fetchAll();

$stmt = $pdo->query("SELECT id, libelle FROM modes_paiement ORDER BY libelle");
$modesPaiement = $stmt->fetchAll();

$reservation = [
    'client_id'        => '',
    'chambre_id'       => '',
    'date_debut'       => date('Y-m-d'),
    'date_fin'         => date('Y-m-d'),
    'nb_nuits'         => 1,
    'montant_total'    => 0,
    'statut'           => 'EN_COURS',
    'mode_paiement_id' => null,
];

// Charge la rÃ©servation si Ã©dition
if ($isEdit) {
    $stmt = $pdo->prepare("SELECT * FROM reservations_hotel WHERE id = :id");
    $stmt->execute(['id' => $id]);
    $reservation = $stmt->fetch();

    if (!$reservation) {
        $_SESSION['flash_error'] = "RÃ©servation introuvable.";
        header('Location: ' . url_for('hotel/reservations.php'));
        exit;
    }
}

// Traitement formulaire
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $clientId  = (int)($_POST['client_id'] ?? 0);
    $chambreId = (int)($_POST['chambre_id'] ?? 0);
    $dateDeb   = $_POST['date_debut'] ?? '';
    $dateFin   = $_POST['date_fin'] ?? '';
    $statut    = $_POST['statut'] ?? 'EN_COURS';
    $modePaiementId = isset($_POST['mode_paiement_id']) && $_POST['mode_paiement_id'] !== ''
        ? (int)$_POST['mode_paiement_id']
        : null;
    $enregistrerCaisse = isset($_POST['enregistrer_caisse']);

    if ($clientId <= 0) {
        $errors[] = "Le client est obligatoire.";
    }
    if ($chambreId <= 0) {
        $errors[] = "La chambre est obligatoire.";
    }
    if ($dateDeb === '' || $dateFin === '') {
        $errors[] = "Les dates de dÃ©but et de fin sont obligatoires.";
    }

    $nbNuits = 1;
    if ($dateDeb && $dateFin) {
        try {
            $d1 = new DateTime($dateDeb);
            $d2 = new DateTime($dateFin);
            if ($d2 < $d1) {
                $errors[] = "La date de fin doit Ãªtre supÃ©rieure ou Ã©gale Ã  la date de dÃ©but.";
            } else {
                $nbNuits = (int)$d1->diff($d2)->days;
                if ($nbNuits <= 0) {
                    $nbNuits = 1;
                }
            }
        } catch (Exception $e) {
            $errors[] = "Format de date invalide.";
        }
    }

    // RÃ©cup tarif nuitÃ© de la chambre
    $tarifNuite = 0;
    if ($chambreId > 0) {
        $stmt = $pdo->prepare("SELECT tarif_nuite FROM chambres WHERE id = :id");
        $stmt->execute(['id' => $chambreId]);
        $rowTarif = $stmt->fetch();
        if ($rowTarif) {
            $tarifNuite = (float)$rowTarif['tarif_nuite'];
        }
    }
    $montantTotal = $tarifNuite * $nbNuits;

    if (empty($errors)) {
        if ($isEdit) {
            $stmt = $pdo->prepare("
                UPDATE reservations_hotel
                SET client_id = :client_id,
                    chambre_id = :chambre_id,
                    date_debut = :date_debut,
                    date_fin = :date_fin,
                    nb_nuits = :nb_nuits,
                    montant_total = :montant_total,
                    statut = :statut,
                    mode_paiement_id = :mode_paiement_id,
                    concierge_id = :concierge_id
                WHERE id = :id
            ");
            $stmt->execute([
                'client_id'        => $clientId,
                'chambre_id'       => $chambreId,
                'date_debut'       => $dateDeb,
                'date_fin'         => $dateFin,
                'nb_nuits'         => $nbNuits,
                'montant_total'    => $montantTotal,
                'statut'           => $statut,
                'mode_paiement_id' => $modePaiementId,
                'concierge_id'     => utilisateurConnecte()['id'] ?? null,
                'id'               => $id,
            ]);
            $reservationId = $id;
            $_SESSION['flash_success'] = "RÃ©servation mise Ã  jour avec succÃ¨s.";
        } else {
            $stmt = $pdo->prepare("
                INSERT INTO reservations_hotel
                    (date_reservation, client_id, chambre_id, date_debut, date_fin,
                     nb_nuits, montant_total, statut, mode_paiement_id, concierge_id)
                VALUES
                    (NOW(), :client_id, :chambre_id, :date_debut, :date_fin,
                     :nb_nuits, :montant_total, :statut, :mode_paiement_id, :concierge_id)
            ");
            $stmt->execute([
                'client_id'        => $clientId,
                'chambre_id'       => $chambreId,
                'date_debut'       => $dateDeb,
                'date_fin'         => $dateFin,
                'nb_nuits'         => $nbNuits,
                'montant_total'    => $montantTotal,
                'statut'           => $statut,
                'mode_paiement_id' => $modePaiementId,
                'concierge_id'     => utilisateurConnecte()['id'] ?? null,
            ]);
            $reservationId = (int)$pdo->lastInsertId();
            $_SESSION['flash_success'] = "RÃ©servation crÃ©Ã©e avec succÃ¨s.";
        }

        // Enregistrement caisse optionnel
        if ($enregistrerCaisse && $modePaiementId && $montantTotal > 0) {
            $stmt = $pdo->prepare("
                INSERT INTO journal_caisse
                    (date_operation, numero_piece, nature_operation, sens,
                     montant, mode_paiement_id, reservation_id,
                     responsable_encaissement_id, observations)
                VALUES
                    (CURDATE(), :num_piece, :nature, 'RECETTE',
                     :montant, :mode_paiement_id, :reservation_id,
                     :resp_id, :obs)
            ");
            $stmt->execute([
                'num_piece'        => 'RES-' . $reservationId,
                'nature'           => 'Encaissement rÃ©servation hÃ´tel',
                'montant'          => $montantTotal,
                'mode_paiement_id' => $modePaiementId,
                'reservation_id'   => $reservationId,
                'resp_id'          => utilisateurConnecte()['id'] ?? null,
                'obs'              => '',
            ]);
        }

        header('Location: ' . url_for('hotel/reservations.php'));
        exit;
    }

    // RÃ©injecter dans $reservation pour rÃ©affichage
    $reservation['client_id']        = $clientId;
    $reservation['chambre_id']       = $chambreId;
    $reservation['date_debut']       = $dateDeb;
    $reservation['date_fin']         = $dateFin;
    $reservation['nb_nuits']         = $nbNuits;
    $reservation['montant_total']    = $montantTotal;
    $reservation['statut']           = $statut;
    $reservation['mode_paiement_id'] = $modePaiementId;
}

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $isEdit ? 'Modifier la rÃ©servation' : 'Nouvelle rÃ©servation' ?>
        </h1>
        <a href="<?= url_for('hotel/reservations.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
        </a>
    </div>

    <?php if (!empty($errors)): ?>
        <div class="alert alert-danger py-2">
            <ul class="mb-0 small">
                <?php foreach ($errors as $e): ?>
                    <li><?= htmlspecialchars($e) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <div class="card">
        <div class="card-body">
            <form method="post">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Client</label>
                        <select name="client_id" class="form-select" required>
                            <option value="">SÃ©lectionner...</option>
                            <?php foreach ($clients as $cl): ?>
                                <option value="<?= (int)$cl['id'] ?>"
                                    <?= (int)$reservation['client_id'] === (int)$cl['id'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($cl['nom']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Chambre</label>
                        <select name="chambre_id" class="form-select" required>
                            <option value="">SÃ©lectionner...</option>
                            <?php foreach ($chambres as $ch): ?>
                                <option value="<?= (int)$ch['id'] ?>"
                                    <?= (int)$reservation['chambre_id'] === (int)$ch['id'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($ch['code']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Du</label>
                        <input type="date" name="date_debut" class="form-control"
                               value="<?= htmlspecialchars($reservation['date_debut']) ?>" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Au</label>
                        <input type="date" name="date_fin" class="form-control"
                               value="<?= htmlspecialchars($reservation['date_fin']) ?>" required>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Statut</label>
                        <select name="statut" class="form-select">
                            <?php foreach (['EN_COURS','TERMINEE','ANNULEE'] as $s): ?>
                                <option value="<?= $s ?>" <?= $reservation['statut'] === $s ? 'selected' : '' ?>>
                                    <?= $s ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Mode de paiement</label>
                        <select name="mode_paiement_id" class="form-select">
                            <option value="">Non renseignÃ©</option>
                            <?php foreach ($modesPaiement as $mp): ?>
                                <option value="<?= (int)$mp['id'] ?>"
                                    <?= (int)($reservation['mode_paiement_id'] ?? 0) === (int)$mp['id'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($mp['libelle']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                        <div class="form-text small">
                            UtilisÃ© si tu enregistres lâ€™encaissement dans la caisse ci-dessous.
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Nombre de nuits</label>
                        <input type="number" class="form-control"
                               id="nb_nuits_display"
                               value="<?= (int)$reservation['nb_nuits'] ?>"
                               disabled>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Montant total (estimÃ©)</label>
                        <input type="text" class="form-control"
                               id="montant_total_display"
                               value="<?= number_format((float)$reservation['montant_total'], 0, ',', ' ') ?> FCFA"
                               disabled>
                    </div>

                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enregistrer_caisse" name="enregistrer_caisse">
                            <label class="form-check-label" for="enregistrer_caisse">
                                Enregistrer immÃ©diatement lâ€™encaissement dans la caisse
                            </label>
                        </div>
                        <div class="form-text small">
                            Si cochÃ©e, une ligne de recette sera ajoutÃ©e au journal de caisse pour le montant total.
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary mt-3">
                    <i class="bi bi-save me-1"></i> Enregistrer
                </button>
            </form>
        </div>
    </div>
</div>

<?php
// Construction dâ€™un tableau [id_chambre => tarif_nuite] pour le JS
$tarifsParChambre = [];
foreach ($chambres as $ch) {
    $tarifsParChambre[(int)$ch['id']] = (float)$ch['tarif_nuite'];
}
?>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const chambresTarifs = <?= json_encode($tarifsParChambre, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES); ?>;

    const dateDebInput   = document.querySelector('input[name="date_debut"]');
    const dateFinInput   = document.querySelector('input[name="date_fin"]');
    const chambreSelect  = document.querySelector('select[name="chambre_id"]');
    const nbNuitsInput   = document.getElementById('nb_nuits_display');
    const montantInput   = document.getElementById('montant_total_display');

    function parseDate(str) {
        if (!str) return null;
        const parts = str.split('-');
        if (parts.length !== 3) return null;
        const year  = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const day   = parseInt(parts[2], 10);
        return new Date(year, month, day);
    }

    function recalc() {
        const d1 = parseDate(dateDebInput.value);
        const d2 = parseDate(dateFinInput.value);

        let nbNuits = 1;
        if (d1 && d2) {
            const diffMs = d2 - d1;
            if (diffMs > 0) {
                nbNuits = Math.round(diffMs / (1000 * 60 * 60 * 24));
            }
        }
        if (!Number.isFinite(nbNuits) || nbNuits < 1) {
            nbNuits = 1;
        }
        if (nbNuitsInput) {
            nbNuitsInput.value = nbNuits;
        }

        const chambreId = chambreSelect.value;
        const tarif     = chambresTarifs[chambreId] ? parseFloat(chambresTarifs[chambreId]) : 0;
        const montant   = tarif * nbNuits;

        if (montantInput) {
            const formatted = new Intl.NumberFormat('fr-FR', {
                maximumFractionDigits: 0
            }).format(isNaN(montant) ? 0 : montant) + ' FCFA';
            montantInput.value = formatted;
        }
    }

    if (dateDebInput)  dateDebInput.addEventListener('change', recalc);
    if (dateFinInput)  dateFinInput.addEventListener('change', recalc);
    if (chambreSelect) chambreSelect.addEventListener('change', recalc);

    // Initialisation au chargement
    recalc();
});
</script>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : hotel\upsell_list.php =====

<?php
// hotel/upsell_list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('HOTEL_GERER');

global $pdo;

// RÃ©cup des rÃ©servations pour le sÃ©lecteur
$stmt = $pdo->query("
    SELECT r.id, r.date_debut, r.date_fin, c.nom AS client_nom, ch.code AS chambre_code
    FROM reservations_hotel r
    JOIN clients c ON c.id = r.client_id
    JOIN chambres ch ON ch.id = r.chambre_id
    ORDER BY r.date_debut DESC, r.id DESC
");
$reservations = $stmt->fetchAll();

// Traitement ajout upsell
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $reservationId = (int)($_POST['reservation_id'] ?? 0);
    $service       = trim($_POST['service_additionnel'] ?? '');
    $montant       = (float)str_replace(' ', '', $_POST['montant'] ?? '0');

    $errors = [];
    if ($reservationId <= 0) {
        $errors[] = "La rÃ©servation est obligatoire.";
    }
    if ($service === '') {
        $errors[] = "Le service additionnel est obligatoire.";
    }

    if (empty($errors)) {
        $stmt = $pdo->prepare("
            INSERT INTO upsell_hotel (reservation_id, service_additionnel, montant)
            VALUES (:reservation_id, :service, :montant)
        ");
        $stmt->execute([
            'reservation_id' => $reservationId,
            'service'        => $service,
            'montant'        => $montant,
        ]);

        $_SESSION['flash_success'] = "Service additionnel enregistrÃ©.";
        header('Location: ' . url_for('hotel/upsell_list.php'));
        exit;
    } else {
        $_SESSION['flash_error'] = implode(' ', $errors);
        header('Location: ' . url_for('hotel/upsell_list.php'));
        exit;
    }
}

// Filtres
$dateDeb = $_GET['date_debut'] ?? '';
$dateFin = $_GET['date_fin'] ?? '';
$resId   = isset($_GET['reservation_id']) ? (int)$_GET['reservation_id'] : 0;

$where  = [];
$params = [];

if ($dateDeb !== '') {
    $where[] = "r.date_debut >= :date_debut";
    $params['date_debut'] = $dateDeb;
}
if ($dateFin !== '') {
    $where[] = "r.date_fin <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($resId > 0) {
    $where[] = "u.reservation_id = :res_id";
    $params['res_id'] = $resId;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// Liste upsell
$sql = "
    SELECT
        u.*,
        r.date_debut,
        r.date_fin,
        c.nom AS client_nom,
        ch.code AS chambre_code
    FROM upsell_hotel u
    JOIN reservations_hotel r ON r.id = u.reservation_id
    JOIN clients c ON c.id = r.client_id
    JOIN chambres ch ON ch.id = r.chambre_id
    $whereSql
    ORDER BY r.date_debut DESC, u.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$upsells = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Upsell hÃ´tel (services additionnels)</h1>
        <a href="<?= url_for('hotel/reservations.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-building me-1"></i> Retour aux rÃ©servations
        </a>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Formulaire ajout upsell -->
    <div class="card mb-3">
        <div class="card-body">
            <h2 class="h6 mb-3">Ajouter un service additionnel</h2>
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                <div class="col-md-6">
                    <label class="form-label small">RÃ©servation</label>
                    <select name="reservation_id" class="form-select" required>
                        <option value="">SÃ©lectionner...</option>
                        <?php foreach ($reservations as $r): ?>
                            <option value="<?= (int)$r['id'] ?>">
                                <?= 'RES-' . (int)$r['id'] ?> |
                                <?= htmlspecialchars($r['client_nom']) ?> |
                                Chambre <?= htmlspecialchars($r['chambre_code']) ?> |
                                <?= htmlspecialchars($r['date_debut']) ?> â†’ <?= htmlspecialchars($r['date_fin']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Service additionnel</label>
                    <input type="text" name="service_additionnel" class="form-control"
                           placeholder="Petit-dÃ©jeuner, taxi, etc." required>
                </div>

                <div class="col-md-2">
                    <label class="form-label small">Montant (FCFA)</label>
                    <input type="number" name="montant" class="form-control" min="0" step="1" required>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Enregistrer lâ€™upsell
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtres liste -->
    <div class="card mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end" method="get">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDeb) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">RÃ©servation</label>
                    <select name="reservation_id" class="form-select">
                        <option value="0">Toutes</option>
                        <?php foreach ($reservations as $r): ?>
                            <option value="<?= (int)$r['id'] ?>"
                                <?= $resId === (int)$r['id'] ? 'selected' : '' ?>>
                                <?= 'RES-' . (int)$r['id'] ?> â€“ <?= htmlspecialchars($r['client_nom']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3 d-flex gap-2 mt-3 mt-md-0">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('hotel/upsell_list.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste upsell -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($upsells)): ?>
                <p class="text-muted mb-0">Aucun service additionnel enregistrÃ©.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>RÃ©servation</th>
                            <th>Client</th>
                            <th>Chambre</th>
                            <th>PÃ©riode</th>
                            <th>Service additionnel</th>
                            <th class="text-end">Montant</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($upsells as $u): ?>
                            <tr>
                                <td>RES-<?= (int)$u['reservation_id'] ?></td>
                                <td><?= htmlspecialchars($u['client_nom']) ?></td>
                                <td><?= htmlspecialchars($u['chambre_code']) ?></td>
                                <td><?= htmlspecialchars($u['date_debut']) ?> â†’ <?= htmlspecialchars($u['date_fin']) ?></td>
                                <td><?= htmlspecialchars($u['service_additionnel']) ?></td>
                                <td class="text-end">
                                    <?= number_format((float)$u['montant'], 0, ',', ' ') ?> FCFA
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : hotel\visiteurs_list.php =====

<?php
// hotel/visiteurs_list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('HOTEL_GERER');

global $pdo;

// -----------------------------
// 1. Traitement ajout visiteur
// -----------------------------
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $dateVisite  = $_POST['date_visite'] ?? date('Y-m-d');
    $nom         = trim($_POST['nom_visiteur'] ?? '');
    $telephone   = trim($_POST['telephone'] ?? '');
    $email       = trim($_POST['email'] ?? '');
    $service     = trim($_POST['service_solicite'] ?? '');
    $orientation = trim($_POST['orientation'] ?? '');
    $motif       = trim($_POST['motif'] ?? ''); // besoin / dÃ©tails

    $errors = [];

    if ($nom === '') {
        $errors[] = "Le nom du visiteur est obligatoire.";
    }

    // Au moins un moyen de contact
    if ($telephone === '' && $email === '') {
        $errors[] = "Renseigne au moins un moyen de contact (tÃ©lÃ©phone ou email).";
    }

    if (empty($errors)) {
        $stmt = $pdo->prepare("
            INSERT INTO visiteurs_hotel
                (date_visite, nom_visiteur, telephone, email, motif,
                 service_solicite, orientation, concierge_id)
            VALUES
                (:date_visite, :nom, :telephone, :email, :motif,
                 :service, :orientation, :concierge_id)
        ");
        $stmt->execute([
            'date_visite'  => $dateVisite,
            'nom'          => $nom,
            'telephone'    => $telephone !== '' ? $telephone : null,
            'email'        => $email !== '' ? $email : null,
            'motif'        => $motif,
            'service'      => $service,
            'orientation'  => $orientation,
            'concierge_id' => utilisateurConnecte()['id'] ?? null,
        ]);

        $_SESSION['flash_success'] = "Visiteur enregistrÃ© avec succÃ¨s.";
        header('Location: ' . url_for('hotel/visiteurs_list.php'));
        exit;
    } else {
        $_SESSION['flash_error'] = implode(' ', $errors);
        header('Location: ' . url_for('hotel/visiteurs_list.php'));
        exit;
    }
}

// -----------------------------
// 2. Filtres liste visiteurs
// -----------------------------
$dateDeb = $_GET['date_debut'] ?? date('Y-m-d');
$dateFin = $_GET['date_fin'] ?? date('Y-m-d');

$where  = [];
$params = [];

if ($dateDeb !== '') {
    $where[] = "vh.date_visite >= :date_debut";
    $params['date_debut'] = $dateDeb;
}
if ($dateFin !== '') {
    $where[] = "vh.date_visite <= :date_fin";
    $params['date_fin'] = $dateFin;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// Liste visiteurs
$sql = "
    SELECT
        vh.*,
        u.nom_complet AS concierge_nom
    FROM visiteurs_hotel vh
    LEFT JOIN utilisateurs u ON u.id = vh.concierge_id
    $whereSql
    ORDER BY vh.date_visite DESC, vh.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$visiteurs = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Visiteurs hÃ´tel / conciergerie</h1>
        <a href="<?= url_for('hotel/reservations.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-building me-1"></i> Retour aux rÃ©servations
        </a>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Formulaire rapide d'ajout -->
    <div class="card mb-3">
        <div class="card-body">
            <h2 class="h6 mb-3">Enregistrer un visiteur</h2>
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                <div class="col-md-2">
                    <label class="form-label small">Date de visite</label>
                    <input type="date" name="date_visite" class="form-control"
                           value="<?= htmlspecialchars($dateDeb) ?>">
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Nom du visiteur</label>
                    <input type="text" name="nom_visiteur" class="form-control" required>
                </div>

                <div class="col-md-2">
                    <label class="form-label small">TÃ©lÃ©phone</label>
                    <input type="text" name="telephone" class="form-control"
                           placeholder="(+237) 6...">
                </div>

                <div class="col-md-2">
                    <label class="form-label small">Email</label>
                    <input type="email" name="email" class="form-control"
                           placeholder="exemple@mail.com">
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Service sollicitÃ©</label>
                    <input type="text" name="service_solicite" class="form-control"
                           placeholder="HÃ©bergement, info, visite...">
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Orientation</label>
                    <input type="text" name="orientation" class="form-control"
                           placeholder="Booking, rÃ©servation, autre...">
                </div>

                <div class="col-12">
                    <label class="form-label small">Besoin / motif</label>
                    <textarea name="motif" rows="2" class="form-control"
                              placeholder="Ce que le visiteur recherche prÃ©cisÃ©ment, dÃ©tails complÃ©mentaires..."></textarea>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Enregistrer le visiteur
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtres liste -->
    <div class="card mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end" method="get">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDeb) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-6 d-flex gap-2 mt-3 mt-md-0">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('hotel/visiteurs_list.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des visiteurs -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($visiteurs)): ?>
                <p class="text-muted mb-0">Aucun visiteur trouvÃ© pour la pÃ©riode sÃ©lectionnÃ©e.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Nom</th>
                            <th>TÃ©lÃ©phone</th>
                            <th>Email</th>
                            <th>Service sollicitÃ©</th>
                            <th>Besoin / motif</th>
                            <th>Orientation</th>
                            <th>Concierge</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($visiteurs as $v): ?>
                            <tr>
                                <td><?= htmlspecialchars($v['date_visite']) ?></td>
                                <td class="fw-semibold"><?= htmlspecialchars($v['nom_visiteur']) ?></td>
                                <td><?= htmlspecialchars($v['telephone'] ?? '') ?></td>
                                <td><?= htmlspecialchars($v['email'] ?? '') ?></td>
                                <td><?= htmlspecialchars($v['service_solicite'] ?? '') ?></td>
                                <td><?= nl2br(htmlspecialchars($v['motif'] ?? '')) ?></td>
                                <td><?= htmlspecialchars($v['orientation'] ?? '') ?></td>
                                <td><?= htmlspecialchars($v['concierge_nom'] ?? '') ?></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : lib\caisse.php =====

<?php
// lib/caisse.php
/**
 * Petite librairie de journal de caisse minimaliste.
 * La table `caisse_journal` est crÃ©Ã©e si elle n'existe pas.
 *
 * champs:
 *  - id INT PK
 *  - date_ecriture DATETIME
 *  - sens ENUM('ENTREE','SORTIE')
 *  - montant DECIMAL(15,2)
 *  - source_type VARCHAR(50)
 *  - source_id INT NULL
 *  - commentaire TEXT
 *  - utilisateur_id INT NULL
 */

function caisse_ensure_table(PDO $pdo): void
{
    $sql = "CREATE TABLE IF NOT EXISTS caisse_journal (
        id INT AUTO_INCREMENT PRIMARY KEY,
        date_ecriture DATETIME NOT NULL,
        sens ENUM('ENTREE','SORTIE') NOT NULL,
        montant DECIMAL(15,2) NOT NULL,
        source_type VARCHAR(50) DEFAULT NULL,
        source_id INT DEFAULT NULL,
        commentaire TEXT DEFAULT NULL,
        utilisateur_id INT DEFAULT NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";
    $pdo->exec($sql);
}

/**
 * Enregistre une Ã©criture dans la caisse.
 * sens: 'ENTREE' pour encaissement, 'SORTIE' pour dÃ©caissement.
 */
function caisse_enregistrer_ecriture(PDO $pdo, string $sens, float $montant, string $source_type = null, ?int $source_id = null, ?string $commentaire = null, ?int $utilisateur_id = null, ?string $date = null): int
{
    if (!in_array($sens, ['ENTREE', 'SORTIE'], true)) {
        throw new InvalidArgumentException('Sens invalide pour Ã©criture caisse');
    }

    caisse_ensure_table($pdo);

    $sql = "INSERT INTO caisse_journal (date_ecriture, sens, montant, source_type, source_id, commentaire, utilisateur_id)
            VALUES (:date_ecriture, :sens, :montant, :source_type, :source_id, :commentaire, :utilisateur_id)";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([
        ':date_ecriture' => $date ?? date('Y-m-d H:i:s'),
        ':sens' => $sens,
        ':montant' => $montant,
        ':source_type' => $source_type,
        ':source_id' => $source_id,
        ':commentaire' => $commentaire,
        ':utilisateur_id' => $utilisateur_id,
    ]);

    return (int)$pdo->lastInsertId();
}

/**
 * RÃ©cupÃ¨re les Ã©critures rÃ©centes (utile pour tests)
 */
function caisse_get_recent(PDO $pdo, int $limit = 50): array
{
    $stmt = $pdo->prepare('SELECT * FROM caisse_journal ORDER BY id DESC LIMIT :l');
    $stmt->bindValue(':l', $limit, PDO::PARAM_INT);
    $stmt->execute();
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}

?>



===== FICHIER : lib\stock.php =====

<?php
// lib/stock.php

/**
 * Retourne la quantitÃ© thÃ©orique en stock pour un produit donnÃ©
 * en additionnant tous les mouvements de la table stocks_mouvements.
 */
function stock_get_quantite_produit(PDO $pdo, int $produitId): int
{
    $sql = "
        SELECT
            COALESCE(
                SUM(
                    CASE
                        WHEN type_mouvement = 'ENTREE'    THEN quantite
                        WHEN type_mouvement = 'SORTIE'    THEN -quantite
                        WHEN type_mouvement = 'AJUSTEMENT' THEN quantite
                        ELSE 0
                    END
                ),
                0
            ) AS qte
        FROM stocks_mouvements
        WHERE produit_id = :produit_id
    ";

    $stmt = $pdo->prepare($sql);
    $stmt->execute([':produit_id' => $produitId]);
    $row = $stmt->fetch(PDO::FETCH_ASSOC);

    return (int)($row['qte'] ?? 0);
}

/**
 * Recalcule et stocke dans `produits.stock_actuel` la quantitÃ© thÃ©orique
 * pour le produit donnÃ© (d'aprÃ¨s `stocks_mouvements`).
 */
function stock_recalculer_stock_produit(PDO $pdo, int $produitId): void
{
    $qte = stock_get_quantite_produit($pdo, $produitId);
    $stmt = $pdo->prepare("UPDATE produits SET stock_actuel = :qte WHERE id = :id");
    $stmt->execute([':qte' => $qte, ':id' => $produitId]);
}

/**
 * Enregistre un mouvement de stock simple.
 *
 * $data = [
 *   'date_mouvement'  => 'YYYY-MM-DD' (optionnel, dÃ©faut = aujourdâ€™hui),
 *   'type_mouvement'  => 'ENTREE' | 'SORTIE' | 'CORRECTION',
 *   'produit_id'      => int (obligatoire),
 *   'quantite'        => float|int (obligatoire),
 *   'source_module'   => 'VENTE' | 'ACHAT' | 'AUTRE' | null,
 *   'source_id'       => int|null,
 *   'utilisateur_id'  => int|null,
 *   'commentaire'     => string|null,
 * ]
 */
function stock_enregistrer_mouvement(PDO $pdo, array $data): int
{
    $sql = "
        INSERT INTO stocks_mouvements (
            produit_id,
            date_mouvement,
            type_mouvement,
            quantite,
            source_type,
            source_id,
            commentaire,
            utilisateur_id
        ) VALUES (
            :produit_id,
            :date_mouvement,
            :type_mouvement,
            :quantite,
            :source_type,
            :source_id,
            :commentaire,
            :utilisateur_id
        )
    ";

    $stmt = $pdo->prepare($sql);

    // CompatibilitÃ© : mapper d'anciennes valeurs
    $type = $data['type_mouvement'] ?? 'AJUSTEMENT';
    if (strtoupper($type) === 'CORRECTION') {
        $type = 'AJUSTEMENT';
    }

    $stmt->execute([
        ':produit_id'     => $data['produit_id'],
        ':date_mouvement' => $data['date_mouvement'] ?? date('Y-m-d H:i:s'),
        ':type_mouvement' => $type,
        ':quantite'       => $data['quantite'],
        ':source_type'    => $data['source_type'] ?? ($data['source_module'] ?? null),
        ':source_id'      => $data['source_id'] ?? null,
        ':commentaire'    => $data['commentaire'] ?? null,
        ':utilisateur_id' => $data['utilisateur_id'] ?? 1,
    ]);

    $newId = (int)$pdo->lastInsertId();

    // Mettre Ã  jour le stock courant pour ce produit
    try {
        stock_recalculer_stock_produit($pdo, (int)$data['produit_id']);
    } catch (Exception $e) {
        // Ne pas interrompre le flux en production ; loger si besoin
    }

    return $newId;
}

/**
 * Supprime tous les mouvements liÃ©s Ã  une source donnÃ©e
 * (ex : une vente ou un achat), pour pouvoir les recalculer proprement.
 */
function stock_supprimer_mouvements_source(PDO $pdo, string $sourceModule, int $sourceId): void
{
    // RÃ©cupÃ©rer les produits impactÃ©s pour recalculer ensuite
    $stmt = $pdo->prepare("SELECT DISTINCT produit_id FROM stocks_mouvements WHERE source_type = :s AND source_id = :id");
    $stmt->execute([':s' => $sourceModule, ':id' => $sourceId]);
    $produits = $stmt->fetchAll(PDO::FETCH_COLUMN);

    $sql = "DELETE FROM stocks_mouvements WHERE source_type = :source_type AND source_id = :source_id";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([
        ':source_type' => $sourceModule,
        ':source_id'   => $sourceId,
    ]);

    if (!empty($produits)) {
        foreach ($produits as $pid) {
            stock_recalculer_stock_produit($pdo, (int)$pid);
        }
    }
}

/**
 * Re-calcul des mouvements de stock pour UNE vente.
 *
 * RÃ¨gle que je pose (simple et propre) :
 * - on ne sort le stock QUE si la vente est au statut 'LIVREE'
 * - 1 mouvement SORTIE par produit (quantitÃ© = somme des lignes).
 */
function stock_synchroniser_vente(PDO $pdo, int $venteId): void
{
    // 1) On rÃ©cupÃ¨re la vente
    $stmt = $pdo->prepare("
        SELECT id, numero, date_vente, statut
        FROM ventes
        WHERE id = :id
    ");
    $stmt->execute([':id' => $venteId]);
    $vente = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$vente) {
        return; // Vente inexistante -> rien Ã  faire
    }

    // 2) On efface les mouvements existants pour cette vente et recrÃ©e proprement
    try {
        $pdo->beginTransaction();
        stock_supprimer_mouvements_source($pdo, 'VENTE', $venteId);
    } catch (Exception $e) {
        if ($pdo->inTransaction()) $pdo->rollBack();
        return;
    }

    // 3) Si la vente nâ€™est pas livrÃ©e, on ne touche pas au stock
    if ($vente['statut'] !== 'LIVREE') {
        return;
    }

    // 4) On rÃ©cupÃ¨re les lignes de la vente (agrÃ©gÃ©es par produit)
    $stmt = $pdo->prepare("
        SELECT
            produit_id,
            SUM(quantite) AS qte
        FROM ventes_lignes
        WHERE vente_id = :vente_id
          AND produit_id IS NOT NULL
        GROUP BY produit_id
    ");
    $stmt->execute([':vente_id' => $venteId]);
    $lignes = $stmt->fetchAll(PDO::FETCH_ASSOC);

    if (!$lignes) {
        return; // aucune ligne -> pas de mouvement
    }

    $dateMvt = $vente['date_vente'] ?: date('Y-m-d');
    $comment = 'Sortie suite Ã  la vente ' . $vente['numero'];

    foreach ($lignes as $ligne) {
        $produitId = (int)$ligne['produit_id'];
        $qte       = (float)$ligne['qte'];

        if ($produitId <= 0 || $qte <= 0) {
            continue;
        }

        stock_enregistrer_mouvement($pdo, [
            'date_mouvement' => $dateMvt,
            'type_mouvement' => 'SORTIE',
            'produit_id'     => $produitId,
            'quantite'       => $qte,
            'source_type'    => 'VENTE',
            'source_id'      => $venteId,
            'commentaire'    => $comment,
        ]);
    }

    // commit de la transaction de synchronisation
    try {
        $pdo->commit();
    } catch (Exception $e) {
        if ($pdo->inTransaction()) $pdo->rollBack();
    }
}

/**
 * Re-calcul des mouvements de stock pour UN achat.
 *
 * RÃ¨gle simple :
 * - chaque ligne dâ€™achat gÃ©nÃ¨re une ENTREE de stock
 * - 1 mouvement ENTREE par produit (quantitÃ© = somme des lignes).
 */
function stock_synchroniser_achat(PDO $pdo, int $achatId): void
{
    // 1) On rÃ©cupÃ¨re lâ€™achat
    $stmt = $pdo->prepare("
        SELECT id, numero, date_achat, statut
        FROM achats
        WHERE id = :id
    ");
    $stmt->execute([':id' => $achatId]);
    $achat = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$achat) {
        return; // Achat inexistant
    }

    // 2) On efface les mouvements existants pour cet achat
    try {
        $pdo->beginTransaction();
        stock_supprimer_mouvements_source($pdo, 'ACHAT', $achatId);
    } catch (Exception $e) {
        if ($pdo->inTransaction()) $pdo->rollBack();
        return;
    }

    // (Optionnel : si tu veux, tu peux dÃ©cider que certains statuts
    //  ne doivent pas encore impacter le stock, ex :
    // if ($achat['statut'] === 'EN_COURS') return; )

    // 3) On rÃ©cupÃ¨re les lignes dâ€™achat agrÃ©gÃ©es par produit
    $stmt = $pdo->prepare("
        SELECT
            produit_id,
            SUM(quantite) AS qte
        FROM achats_lignes
        WHERE achat_id = :achat_id
          AND produit_id IS NOT NULL
        GROUP BY produit_id
    ");
    $stmt->execute([':achat_id' => $achatId]);
    $lignes = $stmt->fetchAll(PDO::FETCH_ASSOC);

    if (!$lignes) {
        return;
    }

    $dateMvt = $achat['date_achat'] ?: date('Y-m-d');
    $comment = 'EntrÃ©e suite Ã  lâ€™achat ' . $achat['numero'];

    foreach ($lignes as $ligne) {
        $produitId = (int)$ligne['produit_id'];
        $qte       = (float)$ligne['qte'];

        if ($produitId <= 0 || $qte <= 0) {
            continue;
        }

        stock_enregistrer_mouvement($pdo, [
            'date_mouvement' => $dateMvt,
            'type_mouvement' => 'ENTREE',
            'produit_id'     => $produitId,
            'quantite'       => $qte,
            'source_type'    => 'ACHAT',
            'source_id'      => $achatId,
            'commentaire'    => $comment,
        ]);
    }

    // commit
    try {
        $pdo->commit();
    } catch (Exception $e) {
        if ($pdo->inTransaction()) $pdo->rollBack();
    }
}



===== FICHIER : litiges\edit.php =====

<?php
// litiges/edit.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('VENTES_CREER');

global $pdo;

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$isEdit = $id > 0;

// Charger listes de rÃ©fÃ©rence
$stmt = $pdo->query("SELECT id, nom FROM clients ORDER BY nom");
$clients = $stmt->fetchAll();

$stmt = $pdo->query("SELECT id, code_produit, designation FROM produits ORDER BY code_produit");
$produits = $stmt->fetchAll();

$stmt = $pdo->query("SELECT id, nom_complet FROM utilisateurs ORDER BY nom_complet");
$utilisateurs = $stmt->fetchAll();

// Valeurs par dÃ©faut
$data = [
    'date_retour'        => date('Y-m-d'),
    'client_id'          => '',
    'produit_id'         => '',
    'vente_id'           => '',
    'motif'              => '',
    'responsable_suivi_id' => '',
    'statut_traitement'  => 'EN_COURS',
    'solution'           => '',
];

// Chargement en Ã©dition
if ($isEdit) {
    $stmt = $pdo->prepare("SELECT * FROM retours_litiges WHERE id = :id");
    $stmt->execute(['id' => $id]);
    $row = $stmt->fetch();

    if (!$row) {
        $_SESSION['flash_error'] = "Litige introuvable.";
        header('Location: ' . url_for('litiges/list.php'));
        exit;
    }

    $data = [
        'date_retour'        => $row['date_retour'],
        'client_id'          => $row['client_id'],
        'produit_id'         => $row['produit_id'],
        'vente_id'           => $row['vente_id'],
        'motif'              => $row['motif'],
        'responsable_suivi_id' => $row['responsable_suivi_id'],
        'statut_traitement'  => $row['statut_traitement'],
        'solution'           => $row['solution'],
    ];
}

$errors = [];

// Traitement POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        verifierCsrf($_POST['csrf_token'] ?? '');

        $data['date_retour']        = trim($_POST['date_retour'] ?? '');
        $data['client_id']          = (int)($_POST['client_id'] ?? 0);
        $data['produit_id']         = (int)($_POST['produit_id'] ?? 0);
        $data['vente_id']           = (int)($_POST['vente_id'] ?? 0) ?: null;
        $data['motif']              = trim($_POST['motif'] ?? '');
        $data['responsable_suivi_id'] = (int)($_POST['responsable_suivi_id'] ?? 0) ?: null;
        $data['statut_traitement']  = $_POST['statut_traitement'] ?? 'EN_COURS';
        $data['solution']           = trim($_POST['solution'] ?? '');

        // Validations simples
        if ($data['date_retour'] === '') {
            $errors[] = "La date de retour est obligatoire.";
        }
        if ($data['client_id'] <= 0) {
            $errors[] = "Le client est obligatoire.";
        }
        if ($data['produit_id'] <= 0) {
            $errors[] = "Le produit est obligatoire.";
        }
        if ($data['motif'] === '') {
            $errors[] = "Le motif du litige est obligatoire.";
        }
        if (!in_array($data['statut_traitement'], ['EN_COURS','RESOLU','ABANDONNE'], true)) {
            $errors[] = "Le statut de traitement est invalide.";
        }

        if (empty($errors)) {
            if ($isEdit) {
                $stmt = $pdo->prepare("
                    UPDATE retours_litiges
                    SET date_retour = :date_retour,
                        client_id   = :client_id,
                        produit_id  = :produit_id,
                        vente_id    = :vente_id,
                        motif       = :motif,
                        responsable_suivi_id = :responsable_suivi_id,
                        statut_traitement    = :statut_traitement,
                        solution    = :solution
                    WHERE id = :id
                ");
                $stmt->execute([
                    'date_retour'        => $data['date_retour'],
                    'client_id'          => $data['client_id'],
                    'produit_id'         => $data['produit_id'],
                    'vente_id'           => $data['vente_id'],
                    'motif'              => $data['motif'],
                    'responsable_suivi_id' => $data['responsable_suivi_id'],
                    'statut_traitement'  => $data['statut_traitement'],
                    'solution'           => $data['solution'] !== '' ? $data['solution'] : null,
                    'id'                 => $id,
                ]);

                $_SESSION['flash_success'] = "Litige mis Ã  jour avec succÃ¨s.";
            } else {
                $stmt = $pdo->prepare("
                    INSERT INTO retours_litiges
                    (date_retour, client_id, produit_id, vente_id, motif,
                     responsable_suivi_id, statut_traitement, solution)
                    VALUES
                    (:date_retour, :client_id, :produit_id, :vente_id, :motif,
                     :responsable_suivi_id, :statut_traitement, :solution)
                ");
                $stmt->execute([
                    'date_retour'        => $data['date_retour'],
                    'client_id'          => $data['client_id'],
                    'produit_id'         => $data['produit_id'],
                    'vente_id'           => $data['vente_id'],
                    'motif'              => $data['motif'],
                    'responsable_suivi_id' => $data['responsable_suivi_id'],
                    'statut_traitement'  => $data['statut_traitement'],
                    'solution'           => $data['solution'] !== '' ? $data['solution'] : null,
                ]);

                $_SESSION['flash_success'] = "Litige crÃ©Ã© avec succÃ¨s.";
            }

            header('Location: ' . url_for('litiges/list.php'));
            exit;
        }

    } catch (Throwable $e) {
        $errors[] = "Erreur lors de l'enregistrement du litige.";
    }
}

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $isEdit ? 'Suivi du litige' : 'Nouveau litige / retour' ?>
        </h1>
        <a href="<?= url_for('litiges/list.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
        </a>
    </div>

    <?php if (!empty($errors)): ?>
        <div class="alert alert-danger py-2">
            <ul class="mb-0">
                <?php foreach ($errors as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <div class="card">
        <div class="card-body">
            <form method="post">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small">Date de retour</label>
                        <input type="date" name="date_retour" class="form-control"
                               value="<?= htmlspecialchars($data['date_retour']) ?>" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small">Client</label>
                        <select name="client_id" class="form-select" required>
                            <option value="">-- SÃ©lectionner --</option>
                            <?php foreach ($clients as $cl): ?>
                                <option value="<?= (int)$cl['id'] ?>"
                                    <?= (int)$data['client_id'] === (int)$cl['id'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($cl['nom']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div class="col-md-5">
                        <label class="form-label small">Produit</label>
                        <select name="produit_id" class="form-select" required>
                            <option value="">-- SÃ©lectionner --</option>
                            <?php foreach ($produits as $pr): ?>
                                <option value="<?= (int)$pr['id'] ?>"
                                    <?= (int)$data['produit_id'] === (int)$pr['id'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($pr['code_produit']) ?> â€“ <?= htmlspecialchars($pr['designation']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label small">Vente liÃ©e (ID ou nÂ° interne)</label>
                        <input type="number" name="vente_id" class="form-control"
                               value="<?= htmlspecialchars((string)($data['vente_id'] ?? '')) ?>"
                               placeholder="ID vente (facultatif)">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small">Responsable du suivi</label>
                        <select name="responsable_suivi_id" class="form-select">
                            <option value="">-- Non dÃ©fini --</option>
                            <?php foreach ($utilisateurs as $u): ?>
                                <option value="<?= (int)$u['id'] ?>"
                                    <?= (int)($data['responsable_suivi_id'] ?? 0) === (int)$u['id'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($u['nom_complet']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div class="col-md-5">
                        <label class="form-label small">Statut du traitement</label>
                        <select name="statut_traitement" class="form-select" required>
                            <?php foreach (['EN_COURS','RESOLU','ABANDONNE'] as $s): ?>
                                <option value="<?= $s ?>" <?= $data['statut_traitement'] === $s ? 'selected' : '' ?>>
                                    <?= $s ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="form-label small">Motif du litige</label>
                        <textarea name="motif" class="form-control" rows="3" required
                                  placeholder="DÃ©crire le problÃ¨me, la non-conformitÃ©, etc."><?= htmlspecialchars($data['motif']) ?></textarea>
                    </div>

                    <div class="col-12">
                        <label class="form-label small">Solution / Actions menÃ©es</label>
                        <textarea name="solution" class="form-control" rows="3"
                                  placeholder="Ã‰changes avec le client, rÃ©paration, remboursement, remise, etc."><?= htmlspecialchars($data['solution'] ?? '') ?></textarea>
                    </div>

                    <div class="col-12 d-flex justify-content-end">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i>
                            <?= $isEdit ? 'Mettre Ã  jour le litige' : 'Enregistrer le litige' ?>
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : litiges\list.php =====

<?php
// litiges/list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('VENTES_LIRE');

global $pdo;

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';

$today      = date('Y-m-d');
$dateDebut  = $_GET['date_debut'] ?? $today;
$dateFin    = $_GET['date_fin'] ?? $today;
$statut     = $_GET['statut'] ?? '';
$clientId   = isset($_GET['client_id']) ? (int)$_GET['client_id'] : 0;
$produitId  = isset($_GET['produit_id']) ? (int)$_GET['produit_id'] : 0;

// Clients pour filtre
$stmt = $pdo->query("SELECT id, nom FROM clients ORDER BY nom");
$clients = $stmt->fetchAll();

// Produits pour filtre
$stmt = $pdo->query("SELECT id, code_produit, designation FROM produits ORDER BY code_produit");
$produits = $stmt->fetchAll();

// WHERE
$where  = [];
$params = [];

if ($dateDebut !== '') {
    $where[] = "rl.date_retour >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "rl.date_retour <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($statut !== '' && in_array($statut, ['EN_COURS','RESOLU','ABANDONNE'], true)) {
    $where[] = "rl.statut_traitement = :statut";
    $params['statut'] = $statut;
}
if ($clientId > 0) {
    $where[] = "rl.client_id = :client_id";
    $params['client_id'] = $clientId;
}
if ($produitId > 0) {
    $where[] = "rl.produit_id = :produit_id";
    $params['produit_id'] = $produitId;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

$sql = "
    SELECT
        rl.*,
        c.nom AS client_nom,
        p.code_produit,
        p.designation AS produit_nom,
        v.numero AS vente_numero,
        u.nom_complet AS responsable_nom
    FROM retours_litiges rl
    JOIN clients c ON c.id = rl.client_id
    JOIN produits p ON p.id = rl.produit_id
    LEFT JOIN ventes v ON v.id = rl.vente_id
    LEFT JOIN utilisateurs u ON u.id = rl.responsable_suivi_id
    $whereSql
    ORDER BY rl.date_retour DESC, rl.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$litiges = $stmt->fetchAll();

$peutEditer = in_array('VENTES_CREER', $_SESSION['permissions'] ?? [], true);

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Retours & litiges clients</h1>
        <?php if ($peutEditer): ?>
            <a href="<?= url_for('litiges/edit.php') ?>" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i> Nouveau litige
            </a>
        <?php endif; ?>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Statut</label>
                    <select name="statut" class="form-select">
                        <option value="">Tous</option>
                        <?php foreach (['EN_COURS','RESOLU','ABANDONNE'] as $s): ?>
                            <option value="<?= $s ?>" <?= $statut === $s ? 'selected' : '' ?>>
                                <?= $s ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Client</label>
                    <select name="client_id" class="form-select">
                        <option value="0">Tous</option>
                        <?php foreach ($clients as $cl): ?>
                            <option value="<?= (int)$cl['id'] ?>"
                                <?= $clientId === (int)$cl['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($cl['nom']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Produit</label>
                    <select name="produit_id" class="form-select">
                        <option value="0">Tous</option>
                        <?php foreach ($produits as $pr): ?>
                            <option value="<?= (int)$pr['id'] ?>"
                                <?= $produitId === (int)$pr['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($pr['code_produit']) ?> â€“ <?= htmlspecialchars($pr['designation']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-12 d-flex gap-2 mt-2">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('litiges/list.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($litiges)): ?>
                <p class="text-muted mb-0">Aucun litige trouvÃ© pour les filtres sÃ©lectionnÃ©s.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date retour</th>
                            <th>Client</th>
                            <th>Produit</th>
                            <th>Vente</th>
                            <th>Motif</th>
                            <th>Responsable</th>
                            <th class="text-center">Statut</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($litiges as $l): ?>
                            <?php
                            $badgeClass = 'bg-secondary-subtle text-secondary';
                            if ($l['statut_traitement'] === 'EN_COURS') $badgeClass = 'bg-warning-subtle text-warning';
                            elseif ($l['statut_traitement'] === 'RESOLU') $badgeClass = 'bg-success-subtle text-success';
                            elseif ($l['statut_traitement'] === 'ABANDONNE') $badgeClass = 'bg-dark-subtle text-dark';
                            ?>
                            <tr>
                                <td><?= htmlspecialchars($l['date_retour']) ?></td>
                                <td><?= htmlspecialchars($l['client_nom']) ?></td>
                                <td>
                                    <span class="fw-semibold"><?= htmlspecialchars($l['code_produit']) ?></span><br>
                                    <span class="text-muted small"><?= htmlspecialchars($l['produit_nom']) ?></span>
                                </td>
                                <td>
                                    <?php if (!empty($l['vente_id'])): ?>
                                        <span class="small">Vente nÂ° <?= htmlspecialchars($l['vente_numero'] ?? $l['vente_id']) ?></span>
                                    <?php else: ?>
                                        <span class="text-muted small">N/A</span>
                                    <?php endif; ?>
                                </td>
                                <td><?= nl2br(htmlspecialchars($l['motif'])) ?></td>
                                <td><?= htmlspecialchars($l['responsable_nom'] ?? '') ?></td>
                                <td class="text-center">
                                    <span class="badge <?= $badgeClass ?>">
                                        <?= htmlspecialchars($l['statut_traitement']) ?>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <?php if ($peutEditer): ?>
                                        <a href="<?= url_for('litiges/edit.php') . '?id=' . (int)$l['id'] ?>"
                                           class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-pencil-square me-1"></i> Suivre
                                        </a>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : livraisons\list.php =====

<?php
// livraisons/list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('VENTES_LIRE');

global $pdo;

$dateDeb  = $_GET['date_debut'] ?? '';
$dateFin  = $_GET['date_fin'] ?? '';
$clientId = isset($_GET['client_id']) ? (int)$_GET['client_id'] : 0;
$signe    = $_GET['signe'] ?? ''; // '', '0', '1'

// Clients
$stmt = $pdo->query("SELECT id, nom FROM clients ORDER BY nom");
$clients = $stmt->fetchAll();

$where  = [];
$params = [];

if ($dateDeb !== '') {
    $where[] = "b.date_bl >= :date_debut";
    $params['date_debut'] = $dateDeb;
}
if ($dateFin !== '') {
    $where[] = "b.date_bl <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($clientId > 0) {
    $where[] = "b.client_id = :client_id";
    $params['client_id'] = $clientId;
}
if ($signe !== '' && in_array($signe, ['0','1'], true)) {
    $where[] = "b.signe_client = :signe";
    $params['signe'] = (int)$signe;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

$sql = "
    SELECT
        b.*,
        c.nom AS client_nom,
        v.numero AS vente_numero
    FROM bons_livraison b
    JOIN clients c ON c.id = b.client_id
    LEFT JOIN ventes v ON v.id = b.vente_id
    $whereSql
    ORDER BY b.date_bl DESC, b.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$bons = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Bons de livraison</h1>
        <a href="<?= url_for('ventes/list.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Retour aux ventes
        </a>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label small">Date BL â‰¥</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDeb) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Date BL â‰¤</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Client</label>
                    <select name="client_id" class="form-select">
                        <option value="0">Tous</option>
                        <?php foreach ($clients as $cl): ?>
                            <option value="<?= (int)$cl['id'] ?>"
                                <?= $clientId === (int)$cl['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($cl['nom']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Signature client</label>
                    <select name="signe" class="form-select">
                        <option value="">Tous</option>
                        <option value="1" <?= $signe === '1' ? 'selected' : '' ?>>SignÃ©s</option>
                        <option value="0" <?= $signe === '0' ? 'selected' : '' ?>>Non signÃ©s</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary mt-4">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('livraisons/list.php') ?>" class="btn btn-outline-secondary mt-4">
                        RÃ©init.
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <?php if (empty($bons)): ?>
                <p class="text-muted mb-0">Aucun bon de livraison trouvÃ©.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>NÂ° BL</th>
                            <th>Date BL</th>
                            <th>Vente</th>
                            <th>Client</th>
                            <th>Transport</th>
                            <th>SignÃ© client</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($bons as $b): ?>
                            <tr>
                                <td><?= htmlspecialchars($b['numero']) ?></td>
                                <td><?= htmlspecialchars($b['date_bl']) ?></td>
                                <td><?= htmlspecialchars($b['vente_numero'] ?? '') ?></td>
                                <td><?= htmlspecialchars($b['client_nom']) ?></td>
                                <td><?= htmlspecialchars($b['transport_assure_par'] ?? '') ?></td>
                                <td>
                                    <?php if ((int)$b['signe_client'] === 1): ?>
                                        <span class="badge bg-success-subtle text-success">
                                            <i class="bi bi-check2-circle me-1"></i> SignÃ©
                                        </span>
                                    <?php else: ?>
                                        <span class="badge bg-warning-subtle text-warning">
                                            Non signÃ©
                                        </span>
                                    <?php endif; ?>
                                </td>
                                <td class="text-end">
                                    <?php if ((int)$b['signe_client'] === 0): ?>
                                        <form method="post" action="<?= url_for('livraisons/marquer_signe.php') ?>" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">
                                            <input type="hidden" name="bl_id" value="<?= (int)$b['id'] ?>">
                                            <button type="submit" class="btn btn-sm btn-outline-success">
                                                <i class="bi bi-pen me-1"></i> Marquer signÃ©
                                            </button>
                                        </form>
                                    <?php endif; ?>
                                    <?php if ($b['vente_id']): ?>
                                        <a href="<?= url_for('ventes/detail.php') . '?id=' . (int)$b['vente_id'] ?>"
                                           class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-eye me-1"></i> Voir vente
                                        </a>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : livraisons\marquer_signe.php =====

<?php
// livraisons/marquer_signe.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('VENTES_CREER'); // ou un droit plus spÃ©cifique si tu en crÃ©es un

global $pdo;

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: ' . url_for('livraisons/list.php'));
    exit;
}

try {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $blId = isset($_POST['bl_id']) ? (int)$_POST['bl_id'] : 0;
    if ($blId <= 0) {
        throw new RuntimeException("Bon de livraison invalide.");
    }

    $stmt = $pdo->prepare("SELECT * FROM bons_livraison WHERE id = :id");
    $stmt->execute(['id' => $blId]);
    $bl = $stmt->fetch();

    if (!$bl) {
        throw new RuntimeException("Bon de livraison introuvable.");
    }

    if ((int)$bl['signe_client'] === 1) {
        $_SESSION['flash_success'] = "Ce bon de livraison est dÃ©jÃ  marquÃ© comme signÃ©.";
    } else {
        $stmt = $pdo->prepare("
            UPDATE bons_livraison
            SET signe_client = 1
            WHERE id = :id
        ");
        $stmt->execute(['id' => $blId]);

        $_SESSION['flash_success'] = "Bon de livraison marquÃ© comme signÃ©.";
    }
} catch (Throwable $e) {
    $_SESSION['flash_error'] = $e->getMessage();
}

header('Location: ' . url_for('livraisons/list.php'));
exit;



===== FICHIER : partials\footer.php =====



===== FICHIER : partials\header.php =====

<?php
// partials/header.php
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}
$utilisateur = $_SESSION['utilisateur'] ?? null;

/**
 * Calcul dynamique de la base URL de l'application
 * Exemple :
 *  - DocumentRoot : C:/xampp/htdocs
 *  - App root FS : C:/xampp/htdocs/kms_app
 *  => $appBaseUrl = '/kms_app'
 *
 * Si l'app est Ã  la racine (htdocs directement) :
 *  - App root FS = DocumentRoot
 *  => $appBaseUrl = ''
 */
$docRoot   = rtrim(str_replace('\\', '/', $_SERVER['DOCUMENT_ROOT']), '/');
$appRootFs = str_replace('\\', '/', dirname(__DIR__)); // remonte d'un niveau depuis /partials

if (strpos($appRootFs, $docRoot) === 0) {
    $relative   = substr($appRootFs, strlen($docRoot)); // ex : '/kms_app' ou ''
    $appBaseUrl = rtrim($relative, '/');
} else {
    // Fallback : on considÃ¨re que l'app est Ã  la racine
    $appBaseUrl = '';
}

// URLs dynamiques
$homeUrl   = ($appBaseUrl !== '' ? $appBaseUrl : '') . '/index.php';
$logoutUrl = ($appBaseUrl !== '' ? $appBaseUrl : '') . '/logout.php';
?>
<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>KMS â€“ Back-office commercial</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    >

    <!-- IcÃ´nes (Bootstrap Icons) -->
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    >

    <!-- Styles personnalisÃ©s -->
    <link rel="stylesheet" href="/assets/css/custom.css">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="<?= htmlspecialchars($homeUrl) ?>">
            <img src="/kms_app/assets/img/logo-kms.png" alt="KMS" height="32" class="me-2">
            <span class="fw-semibold">Kenne Multi-Services</span>
        </a>

        <div class="d-flex align-items-center">
            <?php if ($utilisateur): ?>
                <span class="text-light small me-3">
                    <i class="bi bi-person-circle me-1"></i>
                    <?= htmlspecialchars($utilisateur['nom_complet'] ?? $utilisateur['login']) ?>
                </span>
                <a href="<?= htmlspecialchars($logoutUrl) ?>" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-box-arrow-right me-1"></i> DÃ©connexion
                </a>
            <?php endif; ?>
        </div>
    </div>
</nav>

<div class="d-flex">



===== FICHIER : partials\sidebar.php =====

<?php
// partials/sidebar.php
require_once __DIR__ . '/../security.php';
exigerConnexion();

$permissions = $_SESSION['permissions'] ?? [];

function peut(string $code): bool {
    global $permissions;
    return in_array($code, $permissions, true);
}
?>
<aside class="kms-sidebar bg-white border-end">
    <div class="list-group list-group-flush py-2">
        
        <!-- Dashboard -->
        <a href="<?= url_for('index.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
            <i class="bi bi-speedometer2 me-2"></i> Tableau de bord
        </a>

        <!-- Produits & stock -->
        <?php if (peut('PRODUITS_LIRE')): ?>
            <a href="<?= url_for('produits/list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-box-seam me-2"></i> Produits & stock
            </a>
        <?php endif; ?>

        <!-- Clients / Showroom / Terrain -->
        <?php if (peut('CLIENTS_LIRE')): ?>
            <a href="<?= url_for('clients/list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-people me-2"></i> Clients
            </a>
            <a href="<?= url_for('showroom/visiteurs_list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-shop-window me-2"></i> Showroom
            </a>
            <a href="<?= url_for('terrain/prospections_list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-geo-alt me-2"></i> Terrain
            </a>
        <?php endif; ?>

        <!-- Devis -->
        <?php if (peut('DEVIS_LIRE')): ?>
            <a href="<?= url_for('devis/list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-file-earmark-text me-2"></i> Devis
            </a>
        <?php endif; ?>

        <!-- Ventes & bons de livraison -->
        <?php if (peut('VENTES_LIRE')): ?>
            <a href="<?= url_for('ventes/list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-cart-check me-2"></i> Ventes
            </a>
            <a href="<?= url_for('livraisons/list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-truck me-2"></i> Bons de livraison
            </a>
        <?php endif; ?>

        <!-- Achats & approvisionnements -->
        <?php if (peut('ACHATS_GERER')): ?>
            <a href="<?= url_for('achats/list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-basket me-2"></i> Achats & approvisionnements
            </a>
        <?php endif; ?>

        <!-- Litiges & ruptures -->
        <?php if (peut('LITIGES_LIRE')): ?>
            <a href="<?= url_for('litiges/list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-exclamation-octagon me-2"></i> Litiges & retours
            </a>
        <?php endif; ?>

        <?php if (peut('RUPTURES_LIRE')): ?>
            <a href="<?= url_for('ruptures/list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-battery me-2"></i> Ruptures de stock
            </a>
        <?php endif; ?>

        <!-- Caisse -->
        <?php if (peut('CAISSE_LIRE')): ?>
            <a href="<?= url_for('caisse/journal.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-cash-coin me-2"></i> Caisse
            </a>
        <?php endif; ?>

        <!-- Promotions -->
        <?php if (peut('PROMOTIONS_GERER')): ?>
            <a href="<?= url_for('promotions/list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-megaphone me-2"></i> Promotions
            </a>
        <?php endif; ?>

        <!-- HÃ´tel -->
        <?php if (peut('HOTEL_GERER')): ?>
            <a href="<?= url_for('hotel/reservations.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-building me-2"></i> RÃ©servations hÃ´tel
            </a>
            <a href="<?= url_for('hotel/chambres_list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-door-closed me-2"></i> Chambres
            </a>
            <a href="<?= url_for('hotel/visiteurs_list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-person-walking me-2"></i> Visiteurs hÃ´tel
            </a>
            <a href="<?= url_for('hotel/upsell_list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-plus-circle-dotted me-2"></i> Upsell & services
            </a>
        <?php endif; ?>

        <!-- Formation -->
        <?php if (peut('FORMATION_GERER')): ?>
            <a href="<?= url_for('formation/inscriptions.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-mortarboard me-2"></i> Formation
            </a>
        <?php endif; ?>

        <!-- Satisfaction clients -->
        <?php if (peut('SATISFACTION_GERER')): ?>
            <a href="<?= url_for('satisfaction/list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-emoji-smile me-2"></i> Satisfaction clients
            </a>
        <?php endif; ?>

        <!-- Reporting -->
        <?php if (peut('REPORTING_LIRE')): ?>
            <a href="<?= url_for('reporting/index.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-graph-up-arrow me-2"></i> Reporting
            </a>
        <?php endif; ?>

        <!-- Utilisateurs -->
        <?php if (peut('UTILISATEURS_GERER')): ?>
            <a href="<?= url_for('utilisateurs/list.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="bi bi-people-gear me-2"></i> Utilisateurs
            </a>
        <?php endif; ?>

        <!-- DÃ©connexion -->
        <a href="<?= url_for('logout.php') ?>" class="list-group-item list-group-item-action d-flex align-items-center text-danger">
            <i class="bi bi-box-arrow-right me-2"></i> DÃ©connexion
        </a>

    </div>
</aside>

<main class="flex-grow-1 p-3 kms-main">



===== FICHIER : produits\edit.php =====

<?php
// produits/edit.php - Ã©dition / crÃ©ation produit (utilise lib/stock.php)

require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('PRODUITS_MODIFIER');

require_once __DIR__ . '/../lib/stock.php';

global $pdo;

// URL de redirection vers la liste (adapter si besoin)
$produitsListUrl = '/kms_app/produits/list.php';

$erreurs = [];

// RÃ©cupÃ©ration des listes pour le formulaire
$stmt = $pdo->query("SELECT id, nom FROM familles_produits ORDER BY nom");
$familles = $stmt->fetchAll(PDO::FETCH_ASSOC);

$stmt = $pdo->query("SELECT id, nom FROM fournisseurs ORDER BY nom");
$fournisseurs = $stmt->fetchAll(PDO::FETCH_ASSOC);

$stmt = $pdo->query("SELECT id, famille_id, nom FROM sous_categories_produits ORDER BY nom");
$sc = $stmt->fetchAll(PDO::FETCH_ASSOC);
$scParFamille = [];
foreach ($sc as $r) {
    $scParFamille[(int)$r['famille_id']][] = ['id' => (int)$r['id'], 'nom' => $r['nom']];
}

// DÃ©terminer si Ã©dition
$id = isset($_GET['id']) ? (int)$_GET['id'] : (int)($_POST['id'] ?? 0);
$modeEdition = $id > 0;

// Valeurs par dÃ©faut
$code_produit = '';
$designation = '';
$caracteristiques = '';
$description = '';
$famille_id = 0;
$sous_categorie_id = 0;
$fournisseur_id = 0;
$localisation = '';
$prix_achat = 0;
$prix_vente = 0;
$seuil_alerte = 0;
$actif = 1;
$image_path = null;
$stock_theorique = 0;
$stock_initial = 0;

if ($modeEdition) {
    $stmt = $pdo->prepare("SELECT * FROM produits WHERE id = :id");
    $stmt->execute([':id' => $id]);
    $prod = $stmt->fetch(PDO::FETCH_ASSOC);
    if ($prod) {
        $code_produit = $prod['code_produit'];
        $designation = $prod['designation'];
        $caracteristiques = $prod['caracteristiques'];
        $description = $prod['description'];
        $famille_id = (int)$prod['famille_id'];
        $sous_categorie_id = (int)$prod['sous_categorie_id'];
        $fournisseur_id = (int)$prod['fournisseur_id'];
        $localisation = $prod['localisation'];
        $prix_achat = $prod['prix_achat'];
        $prix_vente = $prod['prix_vente'];
        $seuil_alerte = $prod['seuil_alerte'];
        $actif = (int)$prod['actif'];
        $image_path = $prod['image_path'];
        $stock_theorique = stock_get_quantite_produit($pdo, $id);
    } else {
        $modeEdition = false; // produit introuvable
    }
}

// POST handling (create/update)
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // RÃ©cupÃ©rer champs
    $code_produit = trim($_POST['code_produit'] ?? '');
    $designation = trim($_POST['designation'] ?? '');
    $caracteristiques = trim($_POST['caracteristiques'] ?? '');
    $description = trim($_POST['description'] ?? '');
    $famille_id = (int)($_POST['famille_id'] ?? 0);
    $sous_categorie_id = (int)($_POST['sous_categorie_id'] ?? 0);
    $fournisseur_id = (int)($_POST['fournisseur_id'] ?? 0);
    $localisation = trim($_POST['localisation'] ?? '');
    $prix_achat = (float)($_POST['prix_achat'] ?? 0);
    $prix_vente = (float)($_POST['prix_vente'] ?? 0);
    $seuil_alerte = (int)($_POST['seuil_alerte'] ?? 0);
    $actif = isset($_POST['actif']) ? 1 : 0;
    $ajustement_stock = isset($_POST['ajustement_stock']) ? (float)$_POST['ajustement_stock'] : 0;
    $stock_initial = isset($_POST['stock_initial']) ? (float)$_POST['stock_initial'] : 0;

    // Validation minimale
    if ($code_produit === '') $erreurs[] = 'Le code produit est requis.';
    if ($designation === '') $erreurs[] = 'La dÃ©signation est requise.';
    if ($famille_id <= 0) $erreurs[] = 'La famille doit Ãªtre sÃ©lectionnÃ©e.';

    // Image upload (optionnel)
    $uploadPath = $image_path;
    if (!empty($_FILES['image']['tmp_name'])) {
        $file = $_FILES['image'];
        $ext = pathinfo($file['name'], PATHINFO_EXTENSION);
        $filename = preg_replace('/[^A-Za-z0-9_\-]/', '_', $code_produit) . '.' . $ext;
        $uploadDir = __DIR__ . '/../assets/img/produits';
        if (!is_dir($uploadDir)) mkdir($uploadDir, 0755, true);
        $dest = $uploadDir . '/' . $filename;
        if (!@move_uploaded_file($file['tmp_name'], $dest)) {
            $erreurs[] = 'Impossible d\'enregistrer l\'image sur le serveur.';
        } else {
            $uploadPath = '/kms_app/assets/img/produits/' . $filename;
        }
    }

    if (empty($erreurs)) {
        try {
            $pdo->beginTransaction();
            $utilisateur = utilisateurConnecte();
            $userId = (int)$utilisateur['id'];

            if ($modeEdition) {
                // Mise Ã  jour du produit
                $sql = "UPDATE produits SET
                    code_produit = :code_produit,
                    famille_id = :famille_id,
                    sous_categorie_id = :sous_categorie_id,
                    designation = :designation,
                    caracteristiques = :caracteristiques,
                    description = :description,
                    fournisseur_id = :fournisseur_id,
                    localisation = :localisation,
                    prix_achat = :prix_achat,
                    prix_vente = :prix_vente,
                    seuil_alerte = :seuil_alerte,
                    actif = :actif,
                    image_path = :image_path
                    WHERE id = :id";
                $stmt = $pdo->prepare($sql);
                $stmt->execute([
                    ':code_produit' => $code_produit,
                    ':famille_id' => $famille_id,
                    ':sous_categorie_id' => $sous_categorie_id ?: null,
                    ':designation' => $designation,
                    ':caracteristiques' => $caracteristiques ?: null,
                    ':description' => $description ?: null,
                    ':fournisseur_id' => $fournisseur_id ?: null,
                    ':localisation' => $localisation ?: null,
                    ':prix_achat' => $prix_achat,
                    ':prix_vente' => $prix_vente,
                    ':seuil_alerte' => $seuil_alerte,
                    ':actif' => $actif,
                    ':image_path' => $uploadPath,
                    ':id' => $id,
                ]);

                // Ajustement de stock (si demandÃ©)
                if ($ajustement_stock != 0) {
                    $typeMvt = $ajustement_stock > 0 ? 'ENTREE' : 'SORTIE';
                    stock_enregistrer_mouvement($pdo, [
                        'produit_id' => $id,
                        'date_mouvement' => date('Y-m-d H:i:s'),
                        'type_mouvement' => $typeMvt,
                        'quantite' => abs($ajustement_stock),
                        'source_type' => 'AJUSTEMENT',
                        'source_id' => null,
                        'commentaire' => 'Ajustement manuel depuis fiche produit',
                        'utilisateur_id' => $userId,
                    ]);
                }

                $pdo->commit();
                $_SESSION['flash_success'] = 'Le produit a Ã©tÃ© mis Ã  jour avec succÃ¨s.';

            } else {
                // CrÃ©ation
                $sql = "INSERT INTO produits (
                    code_produit, famille_id, sous_categorie_id, designation,
                    caracteristiques, description, fournisseur_id, localisation,
                    prix_achat, prix_vente, stock_actuel, seuil_alerte, image_path, actif, date_creation
                    ) VALUES (
                    :code_produit, :famille_id, :sous_categorie_id, :designation,
                    :caracteristiques, :description, :fournisseur_id, :localisation,
                    :prix_achat, :prix_vente, :stock_actuel, :seuil_alerte, :image_path, :actif, NOW()
                )";
                $stmt = $pdo->prepare($sql);
                $stmt->execute([
                    ':code_produit' => $code_produit,
                    ':famille_id' => $famille_id,
                    ':sous_categorie_id' => $sous_categorie_id ?: null,
                    ':designation' => $designation,
                    ':caracteristiques' => $caracteristiques ?: null,
                    ':description' => $description ?: null,
                    ':fournisseur_id' => $fournisseur_id ?: null,
                    ':localisation' => $localisation ?: null,
                    ':prix_achat' => $prix_achat,
                    ':prix_vente' => $prix_vente,
                    ':stock_actuel' => 0,
                    ':seuil_alerte' => $seuil_alerte,
                    ':image_path' => $uploadPath,
                    ':actif' => $actif,
                ]);

                $newId = (int)$pdo->lastInsertId();

                // Stock initial (via librairie)
                if ($stock_initial > 0) {
                    stock_enregistrer_mouvement($pdo, [
                        'produit_id' => $newId,
                        'date_mouvement' => date('Y-m-d H:i:s'),
                        'type_mouvement' => 'ENTREE',
                        'quantite' => $stock_initial,
                        'source_type' => 'INVENTAIRE',
                        'source_id' => null,
                        'commentaire' => 'Stock initial Ã  la crÃ©ation du produit',
                        'utilisateur_id' => $userId,
                    ]);
                }

                // Forcer recalcul
                stock_recalculer_stock_produit($pdo, $newId);

                $pdo->commit();
                $_SESSION['flash_success'] = 'Le produit a Ã©tÃ© crÃ©Ã© avec succÃ¨s.';
            }

            // Redirection vers la liste
            header('Location: ' . $produitsListUrl);
            exit;

        } catch (Throwable $e) {
            if ($pdo->inTransaction()) $pdo->rollBack();
            $erreurs[] = 'Erreur lors de l\'enregistrement du produit : ' . $e->getMessage();
        }
    }
}

$csrfToken = getCsrfToken();

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $modeEdition ? 'Modifier un produit' : 'Nouveau produit' ?>
        </h1>
        <a href="<?= $produitsListUrl ?>" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
        </a>
    </div>

    <?php if (!empty($erreurs)): ?>
        <div class="alert alert-danger">
            <h2 class="h6 mb-2"><i class="bi bi-exclamation-triangle me-1"></i> Erreurs</h2>
            <ul class="mb-0">
                <?php foreach ($erreurs as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <form method="post" enctype="multipart/form-data" class="card">
        <div class="card-body">
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">
            <input type="hidden" name="id" value="<?= (int)$id ?>">

            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small">Code produit *</label>
                    <input type="text" name="code_produit" class="form-control" required
                           value="<?= htmlspecialchars($code_produit) ?>">
                </div>

                <div class="col-md-5">
                    <label class="form-label small">DÃ©signation *</label>
                    <input type="text" name="designation" class="form-control" required
                           value="<?= htmlspecialchars($designation) ?>">
                </div>

                <div class="col-md-2 d-flex align-items-center">
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" name="actif" id="actif"
                               <?= $actif ? 'checked' : '' ?>>
                        <label class="form-check-label small" for="actif">
                            Produit actif
                        </label>
                    </div>
                </div>

                <div class="col-md-2">
                    <label class="form-label small">Seuil alerte</label>
                    <input type="number" name="seuil_alerte" class="form-control"
                           value="<?= (int)$seuil_alerte ?>">
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Famille *</label>
                    <select name="famille_id" id="famille_id" class="form-select" required>
                        <option value="">SÃ©lectionner...</option>
                        <?php foreach ($familles as $fam): ?>
                            <option value="<?= (int)$fam['id'] ?>"
                                <?= $famille_id === (int)$fam['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($fam['nom']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Sous-catÃ©gorie</label>
                    <select name="sous_categorie_id" id="sous_categorie_id" class="form-select">
                            <option value="">â€”</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Fournisseur</label>
                    <select name="fournisseur_id" class="form-select">
                        <option value="">â€”</option>
                        <?php foreach ($fournisseurs as $f): ?>
                            <option value="<?= (int)$f['id'] ?>"
                                <?= $fournisseur_id === (int)$f['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($f['nom']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Prix dâ€™achat (FCFA)</label>
                    <input type="number" step="0.01" name="prix_achat" class="form-control"
                           value="<?= htmlspecialchars($prix_achat) ?>">
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Prix de vente (FCFA)</label>
                    <input type="number" step="0.01" name="prix_vente" class="form-control"
                           value="<?= htmlspecialchars($prix_vente) ?>">
                </div>

                <?php if (!$modeEdition): ?>
                    <div class="col-md-3">
                        <label class="form-label small">Stock initial</label>
                        <input type="number" name="stock_initial" class="form-control"
                               value="0" min="0">
                        <div class="form-text small">
                            GÃ©nÃ¨re une entrÃ©e de stock (INVENTAIRE) Ã  la crÃ©ation du produit.
                        </div>
                    </div>
                <?php else: ?>
                    <div class="col-md-3">
                        <label class="form-label small">
                            Ajustement de stock (peut Ãªtre nÃ©gatif)
                        </label>
                        <input type="number" name="ajustement_stock" class="form-control"
                               value="0">
                        <div class="form-text small">
                            Stock actuel thÃ©orique :
                            <strong><?= (int)$stock_theorique ?></strong><br>
                            &gt; 0 = entrÃ©e, &lt; 0 = sortie (mouvement dâ€™ajustement).
                        </div>
                    </div>
                <?php endif; ?>

                <div class="col-md-3">
                    <label class="form-label small">Localisation (magasin, showroom...)</label>
                    <input type="text" name="localisation" class="form-control"
                           value="<?= htmlspecialchars($localisation) ?>">
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Image produit</label>
                    <input type="file" name="image" class="form-control" accept="image/*">
                    <?php if ($image_path): ?>
                        <div class="mt-2">
                            <div class="card border-light bg-light p-2" style="max-width: 120px;">
                                <?php 
                                    // Determiner le chemin correct
                                    $displayPath = $image_path;
                                    // Si le chemin ne commence pas par /kms_app, l'ajouter (migration)
                                    if (strpos($image_path, '/kms_app') === false && strpos($image_path, '/assets') === 0) {
                                        $displayPath = '/kms_app' . $image_path;
                                    }
                                ?>
                                <img src="<?= htmlspecialchars($displayPath) ?>" 
                                     alt="Image produit"
                                     style="max-height: 100px; object-fit: contain; width: 100%;"
                                     onerror="this.parentElement.innerHTML='<small class=\"text-muted\">Image non trouvee</small>';">
                            </div>
                            <small class="text-muted d-block mt-1">Fichier : <?= htmlspecialchars(basename($image_path)) ?></small>
                        </div>
                    <?php endif; ?>
                </div>

                <div class="col-md-12">
                    <label class="form-label small">CaractÃ©ristiques techniques</label>
                    <textarea name="caracteristiques" class="form-control" rows="2"><?= htmlspecialchars($caracteristiques) ?></textarea>
                </div>

                <div class="col-md-12">
                    <label class="form-label small">Description</label>
                    <textarea name="description" class="form-control" rows="3"><?= htmlspecialchars($description) ?></textarea>
                </div>
            </div>
        </div>

        <div class="card-footer d-flex justify-content-end gap-2">
            <a href="<?= $produitsListUrl ?>" class="btn btn-outline-secondary">
                Annuler
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>
                <?= $modeEdition ? 'Enregistrer les modifications' : 'CrÃ©er le produit' ?>
            </button>
        </div>
    </form>
</div>

<script>
    // Sous-catÃ©gories par famille (injectÃ© depuis PHP)
    const scParFamille = <?= json_encode($scParFamille, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES); ?>;
    const famSelect    = document.getElementById('famille_id');
    const scSelect     = document.getElementById('sous_categorie_id');
    const currentScId  = <?= $sous_categorie_id ? (int)$sous_categorie_id : 0 ?>;

    function majSousCategories(selectedId) {
        const fid = parseInt(famSelect.value || '0', 10);
        scSelect.innerHTML = '<option value="">â€”</option>';
        if (!fid || !scParFamille[fid]) return;

        scParFamille[fid].forEach(sc => {
            const opt = document.createElement('option');
            opt.value = sc.id;
            opt.textContent = sc.nom;
            if (selectedId && sc.id === selectedId) {
                opt.selected = true;
            }
            scSelect.appendChild(opt);
        });
    }

    if (famSelect && scSelect) {
        famSelect.addEventListener('change', () => {
            majSousCategories(0);
        });
        majSousCategories(currentScId);
    }
</script>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : produits\list.php =====

<?php
// produits/list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('PRODUITS_LIRE');

global $pdo;

// ---------------------------------------------------------
// Filtres de recherche
// ---------------------------------------------------------
$q      = trim($_GET['q'] ?? '');
$actif  = $_GET['actif'] ?? '1'; // 1 = seulement actifs, '' = tous

$where  = [];
$params = [];

// Recherche texte sur code_produit ou designation
if ($q !== '') {
    $where[]        = '(p.code_produit LIKE :q OR p.designation LIKE :q)';
    $params['q']    = '%' . $q . '%';
}

// Filtre "actifs seulement"
if ($actif === '1') {
    $where[] = 'p.actif = 1';
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// ---------------------------------------------------------
// RÃ©cupÃ©ration des produits
// ---------------------------------------------------------
$sql = "
    SELECT
        p.id,
        p.code_produit,
        p.designation,
        p.prix_vente,
        p.actif
    FROM produits p
    $whereSql
    ORDER BY p.designation
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$produits = $stmt->fetchAll();

// ---------------------------------------------------------
// RÃ©cupÃ©ration des stocks rÃ©els par produit
// ---------------------------------------------------------
// On agrÃ¨ge tous les mouvements de stock : SUM(quantite) par produit_id
$stocks = [];
// Calculer les stocks Ã  partir de la table canonique `stocks_mouvements`.
// Utiliser TRY/CATCH : si la table n'existe pas, on retombe sur `produits.stock_actuel`.
try {
    $stmtStock = $pdo->query(
        "SELECT produit_id, COALESCE(SUM(
            CASE
                WHEN type_mouvement = 'ENTREE' THEN quantite
                WHEN type_mouvement = 'SORTIE' THEN -quantite
                WHEN type_mouvement = 'AJUSTEMENT' THEN quantite
                ELSE 0
            END
        ),0) AS stock_qte
        FROM stocks_mouvements
        GROUP BY produit_id"
    );

    foreach ($stmtStock->fetchAll() as $row) {
        $stocks[(int)$row['produit_id']] = (float)$row['stock_qte'];
    }
} catch (Exception $e) {
    // fallback : utiliser produits.stock_actuel si la table des mouvements est absente
    foreach ($produits as $p) {
        $stocks[(int)$p['id']] = (int)$p['stock_actuel'];
    }
}

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Produits & stock</h1>
        <a href="<?= url_for('produits/edit.php') ?>" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> Nouveau produit
        </a>
    </div>

    <!-- Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small">Recherche</label>
                    <input type="text"
                           name="q"
                           class="form-control"
                           placeholder="Code produit, dÃ©signation..."
                           value="<?= htmlspecialchars($q) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Statut</label>
                    <select name="actif" class="form-select">
                        <option value="1" <?= $actif === '1' ? 'selected' : '' ?>>Produits actifs uniquement</option>
                        <option value="" <?= $actif === '' ? 'selected' : '' ?>>Tous les produits</option>
                    </select>
                </div>
                <div class="col-md-5 d-flex gap-2 mt-3 mt-md-0">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('produits/list.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                    <a href="<?= url_for('stock/etat.php') ?>" class="btn btn-outline-dark ms-auto">
                        <i class="bi bi-box-seam me-1"></i> Ã‰tat global du stock
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des produits -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($produits)): ?>
                <p class="text-muted mb-0">Aucun produit trouvÃ© pour les filtres sÃ©lectionnÃ©s.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th style="width: 12%;">Code</th>
                            <th>LibellÃ© / dÃ©signation</th>
                            <th style="width: 12%;" class="text-end">Prix vente</th>
                            <th style="width: 12%;" class="text-end">Stock actuel</th>
                            <th style="width: 8%;"  class="text-center">Statut</th>
                            <th style="width: 10%;" class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($produits as $p): ?>
                            <?php
                            $id           = (int)$p['id'];
                            $stockActuel  = $stocks[$id] ?? 0;
                            ?>
                            <tr>
                                <td class="fw-semibold">
                                    <?= htmlspecialchars($p['code_produit']) ?>
                                </td>
                                <td>
                                    <?= htmlspecialchars($p['designation']) ?>
                                </td>
                                <td class="text-end">
                                    <?= number_format((float)$p['prix_vente'], 0, ',', ' ') ?> FCFA
                                </td>
                                <td class="text-end">
                                    <span class="fw-semibold">
                                        <?= number_format($stockActuel, 3, ',', ' ') ?>
                                    </span>
                                </td>
                                <td class="text-center">
                                    <?php if ((int)$p['actif'] === 1): ?>
                                        <span class="badge bg-success-subtle text-success">Actif</span>
                                    <?php else: ?>
                                        <span class="badge bg-secondary-subtle text-secondary">Inactif</span>
                                    <?php endif; ?>
                                </td>
                                <td class="text-end">
                                    <a href="<?= url_for('produits/edit.php?id=' . $id) ?>" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : promotions\edit.php =====

<?php
// promotions/edit.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('PROMOTIONS_GERER');

global $pdo;

$id     = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$isEdit = $id > 0;

// Liste des produits pour la multi-sÃ©lection
$stmt = $pdo->query("
    SELECT id, code_produit, designation, prix_vente
    FROM produits
    WHERE actif = 1
    ORDER BY code_produit
");
$produits = $stmt->fetchAll();

// Valeurs par dÃ©faut
$data = [
    'nom'               => '',
    'description'       => '',
    'pourcentage_remise'=> '',
    'montant_remise'    => '',
    'date_debut'        => date('Y-m-d'),
    'date_fin'          => date('Y-m-d'),
    'actif'             => 1,
];

$produitsSelectionnes = [];

if ($isEdit) {
    // Promotion
    $stmt = $pdo->prepare("SELECT * FROM promotions WHERE id = :id");
    $stmt->execute(['id' => $id]);
    $row = $stmt->fetch();

    if (!$row) {
        $_SESSION['flash_error'] = "Promotion introuvable.";
        header('Location: ' . url_for('promotions/list.php'));
        exit;
    }

    $data = [
        'nom'                => $row['nom'],
        'description'        => $row['description'] ?? '',
        'pourcentage_remise' => $row['pourcentage_remise'] !== null ? (string)$row['pourcentage_remise'] : '',
        'montant_remise'     => $row['montant_remise'] !== null ? (string)$row['montant_remise'] : '',
        'date_debut'         => $row['date_debut'],
        'date_fin'           => $row['date_fin'],
        'actif'              => (int)$row['actif'],
    ];

    // Produits associÃ©s
    $stmt = $pdo->prepare("SELECT produit_id FROM promotion_produit WHERE promotion_id = :pid");
    $stmt->execute(['pid' => $id]);
    $produitsSelectionnes = array_map('intval', array_column($stmt->fetchAll(), 'produit_id'));
}

$errors = [];

// Traitement POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        verifierCsrf($_POST['csrf_token'] ?? '');

        $data['nom']          = trim($_POST['nom'] ?? '');
        $data['description']  = trim($_POST['description'] ?? '');
        $data['date_debut']   = trim($_POST['date_debut'] ?? '');
        $data['date_fin']     = trim($_POST['date_fin'] ?? '');
        $data['actif']        = isset($_POST['actif']) ? 1 : 0;

        // Remises
        $pourcentage          = str_replace(',', '.', trim($_POST['pourcentage_remise'] ?? ''));
        $montant              = str_replace(',', '.', trim($_POST['montant_remise'] ?? ''));

        $data['pourcentage_remise'] = $pourcentage;
        $data['montant_remise']     = $montant;

        $pourcentageVal = $pourcentage !== '' ? (float)$pourcentage : 0.0;
        $montantVal     = $montant !== '' ? (float)$montant : 0.0;

        // Produits sÃ©lectionnÃ©s
        $produitsSelectionnes = array_map('intval', $_POST['produits'] ?? []);

        // Validations
        if ($data['nom'] === '') {
            $errors[] = "Le nom de la promotion est obligatoire.";
        }
        if ($data['date_debut'] === '' || $data['date_fin'] === '') {
            $errors[] = "Les dates de dÃ©but et de fin sont obligatoires.";
        } elseif ($data['date_debut'] > $data['date_fin']) {
            $errors[] = "La date de dÃ©but ne peut pas Ãªtre postÃ©rieure Ã  la date de fin.";
        }

        // Au moins un type de remise
        if ($pourcentageVal <= 0 && $montantVal <= 0) {
            $errors[] = "Vous devez renseigner au moins un type de remise (pourcentage ou montant).";
        }
        // Ã‰viter deux remises simultanÃ©es > 0
        if ($pourcentageVal > 0 && $montantVal > 0) {
            $errors[] = "Merci de choisir soit une remise en pourcentage, soit une remise en montant, mais pas les deux.";
        }

        if (empty($produitsSelectionnes)) {
            $errors[] = "Vous devez associer au moins un produit Ã  la promotion.";
        }

        if (empty($errors)) {
            // Normalisation pour SQL (null si 0)
            $pourcentageSql = $pourcentageVal > 0 ? $pourcentageVal : null;
            $montantSql     = $montantVal > 0 ? $montantVal : null;

            if ($isEdit) {
                $stmt = $pdo->prepare("
                    UPDATE promotions
                    SET nom = :nom,
                        description = :description,
                        pourcentage_remise = :pourcentage_remise,
                        montant_remise = :montant_remise,
                        date_debut = :date_debut,
                        date_fin = :date_fin,
                        actif = :actif
                    WHERE id = :id
                ");
                $stmt->execute([
                    'nom'                => $data['nom'],
                    'description'        => $data['description'] !== '' ? $data['description'] : null,
                    'pourcentage_remise' => $pourcentageSql,
                    'montant_remise'     => $montantSql,
                    'date_debut'         => $data['date_debut'],
                    'date_fin'           => $data['date_fin'],
                    'actif'              => $data['actif'],
                    'id'                 => $id,
                ]);

                // MAJ associations produits
                $stmt = $pdo->prepare("DELETE FROM promotion_produit WHERE promotion_id = :pid");
                $stmt->execute(['pid' => $id]);

                $stmtInsert = $pdo->prepare("
                    INSERT INTO promotion_produit (promotion_id, produit_id)
                    VALUES (:pid, :prod)
                ");
                foreach ($produitsSelectionnes as $pidProduit) {
                    $stmtInsert->execute([
                        'pid'  => $id,
                        'prod' => $pidProduit,
                    ]);
                }

                $_SESSION['flash_success'] = "Promotion mise Ã  jour avec succÃ¨s.";

            } else {
                $stmt = $pdo->prepare("
                    INSERT INTO promotions
                    (nom, description, pourcentage_remise, montant_remise, date_debut, date_fin, actif)
                    VALUES
                    (:nom, :description, :pourcentage_remise, :montant_remise, :date_debut, :date_fin, :actif)
                ");
                $stmt->execute([
                    'nom'                => $data['nom'],
                    'description'        => $data['description'] !== '' ? $data['description'] : null,
                    'pourcentage_remise' => $pourcentageSql,
                    'montant_remise'     => $montantSql,
                    'date_debut'         => $data['date_debut'],
                    'date_fin'           => $data['date_fin'],
                    'actif'              => $data['actif'],
                ]);

                $newId = (int)$pdo->lastInsertId();

                $stmtInsert = $pdo->prepare("
                    INSERT INTO promotion_produit (promotion_id, produit_id)
                    VALUES (:pid, :prod)
                ");
                foreach ($produitsSelectionnes as $pidProduit) {
                    $stmtInsert->execute([
                        'pid'  => $newId,
                        'prod' => $pidProduit,
                    ]);
                }

                $_SESSION['flash_success'] = "Promotion crÃ©Ã©e avec succÃ¨s.";
            }

            header('Location: ' . url_for('promotions/list.php'));
            exit;
        }

    } catch (Throwable $e) {
        $errors[] = "Erreur lors de l'enregistrement de la promotion.";
    }
}

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $isEdit ? 'Modifier une promotion' : 'Nouvelle promotion' ?>
        </h1>
        <a href="<?= url_for('promotions/list.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
        </a>
    </div>

    <?php if (!empty($errors)): ?>
        <div class="alert alert-danger py-2">
            <ul class="mb-0">
                <?php foreach ($errors as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <div class="card">
        <div class="card-body">
            <form method="post">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label small">Nom de la promotion</label>
                        <input type="text" name="nom" class="form-control"
                               value="<?= htmlspecialchars($data['nom']) ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Date dÃ©but</label>
                        <input type="date" name="date_debut" class="form-control"
                               value="<?= htmlspecialchars($data['date_debut']) ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Date fin</label>
                        <input type="date" name="date_fin" class="form-control"
                               value="<?= htmlspecialchars($data['date_fin']) ?>" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label small">Description (facultatif)</label>
                        <textarea name="description" class="form-control" rows="3"
                                  placeholder="Contexte commercial, conditions, cible..."><?= htmlspecialchars($data['description']) ?></textarea>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label small">Remise en %</label>
                        <input type="number" step="0.01" name="pourcentage_remise" class="form-control"
                               value="<?= htmlspecialchars($data['pourcentage_remise']) ?>"
                               placeholder="Ex : 10 pour 10 %">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Remise en montant (FCFA)</label>
                        <input type="number" step="0.01" name="montant_remise" class="form-control"
                               value="<?= htmlspecialchars($data['montant_remise']) ?>"
                               placeholder="Ex : 5000">
                    </div>

                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" name="actif" id="prom_actif"
                                   value="1" <?= (int)$data['actif'] === 1 ? 'checked' : '' ?>>
                            <label class="form-check-label small" for="prom_actif">
                                Promotion active
                            </label>
                        </div>
                    </div>

                    <div class="col-md-9">
                        <label class="form-label small">Produits concernÃ©s</label>
                        <select name="produits[]" class="form-select" multiple size="8" required>
                            <?php foreach ($produits as $pr): ?>
                                <?php
                                $idProd = (int)$pr['id'];
                                $selected = in_array($idProd, $produitsSelectionnes, true) ? 'selected' : '';
                                ?>
                                <option value="<?= $idProd ?>" <?= $selected ?>>
                                    <?= htmlspecialchars($pr['code_produit']) ?> â€“ <?= htmlspecialchars($pr['designation']) ?>
                                    (<?= number_format((float)$pr['prix_vente'], 0, ',', ' ') ?> FCFA)
                                </option>
                            <?php endforeach; ?>
                        </select>
                        <small class="text-muted">
                            Maintenez CTRL (ou CMD sur Mac) pour sÃ©lectionner plusieurs produits.
                        </small>
                    </div>

                    <div class="col-12 d-flex justify-content-end">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i>
                            <?= $isEdit ? 'Mettre Ã  jour la promotion' : 'CrÃ©er la promotion' ?>
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : promotions\list.php =====

<?php
// promotions/list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('PROMOTIONS_GERER');

global $pdo;

$today      = date('Y-m-d');
$q          = trim($_GET['q'] ?? '');
$dateDebut  = $_GET['date_debut'] ?? '';
$dateFin    = $_GET['date_fin'] ?? '';
$actifFiltre = $_GET['actif'] ?? '';

// Construction WHERE
$where  = [];
$params = [];

if ($q !== '') {
    $where[] = "p.nom LIKE :q";
    $params['q'] = '%' . $q . '%';
}
if ($dateDebut !== '') {
    $where[] = "p.date_debut >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "p.date_fin <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($actifFiltre !== '' && in_array($actifFiltre, ['0','1'], true)) {
    $where[] = "p.actif = :actif";
    $params['actif'] = (int)$actifFiltre;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// RequÃªte promotions + nb de produits liÃ©s
$sql = "
    SELECT
        p.*,
        COUNT(pp.produit_id) AS nb_produits
    FROM promotions p
    LEFT JOIN promotion_produit pp ON pp.promotion_id = p.id
    $whereSql
    GROUP BY p.id
    ORDER BY p.date_debut DESC, p.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$promotions = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Promotions commerciales</h1>
        <a href="<?= url_for('promotions/edit.php') ?>" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> Nouvelle promotion
        </a>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small">Recherche</label>
                    <input type="text" name="q" class="form-control"
                           placeholder="Nom de la promotion..."
                           value="<?= htmlspecialchars($q) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Date dÃ©but â‰¥</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Date fin â‰¤</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Actif</label>
                    <select name="actif" class="form-select">
                        <option value="">Tous</option>
                        <option value="1" <?= $actifFiltre === '1' ? 'selected' : '' ?>>Actifs</option>
                        <option value="0" <?= $actifFiltre === '0' ? 'selected' : '' ?>>Inactifs</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary mt-4">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('promotions/list.php') ?>" class="btn btn-outline-secondary mt-4">
                        RÃ©init.
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste promotions -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($promotions)): ?>
                <p class="text-muted mb-0">Aucune promotion trouvÃ©e pour les filtres sÃ©lectionnÃ©s.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Nom</th>
                            <th>PÃ©riode</th>
                            <th>Type remise</th>
                            <th class="text-center">Produits associÃ©s</th>
                            <th class="text-center">Statut</th>
                            <th class="text-center">Actif</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($promotions as $p): ?>
                            <?php
                            $dateDeb = $p['date_debut'];
                            $dateFin = $p['date_fin'];
                            $enCours = false;
                            $statutLib = 'ProgrammÃ©e';
                            $badgeStatut = 'bg-secondary-subtle text-secondary';

                            if ($today < $dateDeb) {
                                $statutLib   = 'ProgrammÃ©e';
                                $badgeStatut = 'bg-info-subtle text-info';
                            } elseif ($today >= $dateDeb && $today <= $dateFin) {
                                $statutLib   = 'En cours';
                                $badgeStatut = 'bg-success-subtle text-success';
                                $enCours     = true;
                            } else {
                                $statutLib   = 'TerminÃ©e';
                                $badgeStatut = 'bg-dark-subtle text-dark';
                            }

                            $typeRemise = 'â€”';
                            if (!is_null($p['pourcentage_remise']) && (float)$p['pourcentage_remise'] > 0) {
                                $typeRemise = number_format((float)$p['pourcentage_remise'], 2, ',', ' ') . ' %';
                            } elseif (!is_null($p['montant_remise']) && (float)$p['montant_remise'] > 0) {
                                $typeRemise = number_format((float)$p['montant_remise'], 0, ',', ' ') . ' FCFA';
                            }
                            ?>
                            <tr>
                                <td>
                                    <span class="fw-semibold"><?= htmlspecialchars($p['nom']) ?></span><br>
                                    <?php if (!empty($p['description'])): ?>
                                        <span class="text-muted small"><?= nl2br(htmlspecialchars($p['description'])) ?></span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    Du <?= htmlspecialchars($dateDeb) ?><br>
                                    au <?= htmlspecialchars($dateFin) ?>
                                </td>
                                <td><?= $typeRemise ?></td>
                                <td class="text-center">
                                    <span class="badge bg-primary-subtle text-primary">
                                        <?= (int)$p['nb_produits'] ?> produit(s)
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge <?= $badgeStatut ?>">
                                        <?= htmlspecialchars($statutLib) ?>
                                    </span>
                                </td>
                                <td class="text-center">
                                    <?php if ((int)$p['actif'] === 1): ?>
                                        <span class="badge bg-success-subtle text-success">Actif</span>
                                    <?php else: ?>
                                        <span class="badge bg-secondary-subtle text-secondary">Inactif</span>
                                    <?php endif; ?>
                                </td>
                                <td class="text-end">
                                    <a href="<?= url_for('promotions/edit.php') . '?id=' . (int)$p['id'] ?>"
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil-square me-1"></i> Modifier
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : reporting\index.php =====

<?php
// reporting/index.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('REPORTING_LIRE');

global $pdo;

// --- Filtres pÃ©riode ---
$dateDebut = $_GET['date_debut'] ?? date('Y-m-01');
$dateFin   = $_GET['date_fin'] ?? date('Y-m-d');

// Normalisation basique (pas de validation lourde ici)
$whereVentes = [];
$whereDevis  = [];
$params      = [];

if ($dateDebut !== '') {
    $whereVentes[] = "v.date_vente >= :date_debut";
    $whereDevis[]  = "d.date_devis >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $whereVentes[] = "v.date_vente <= :date_fin";
    $whereDevis[]  = "d.date_devis <= :date_fin";
    $params['date_fin'] = $dateFin;
}

$whereVentesSql = '';
$whereDevisSql  = '';

if (!empty($whereVentes)) {
    $whereVentesSql = 'WHERE ' . implode(' AND ', $whereVentes);
}
if (!empty($whereDevis)) {
    $whereDevisSql = 'WHERE ' . implode(' AND ', $whereDevis);
}

// --- 1. KPIs VENTES (CA, nombre de ventes) ---
$sqlVentes = "
    SELECT
        COUNT(*) AS nb_ventes,
        COALESCE(SUM(CASE WHEN v.statut <> 'ANNULEE'
                     THEN v.montant_total_ttc ELSE 0 END), 0) AS ca_total_ttc,
        COALESCE(SUM(CASE WHEN v.statut <> 'ANNULEE'
                     THEN v.montant_total_ht ELSE 0 END), 0) AS ca_total_ht
    FROM ventes v
    $whereVentesSql
";
$stmt = $pdo->prepare($sqlVentes);
$stmt->execute($params);
$statsVentes = $stmt->fetch() ?: [
    'nb_ventes'      => 0,
    'ca_total_ttc'   => 0,
    'ca_total_ht'    => 0,
];

// --- 2. KPIs DEVIS (nombre, acceptÃ©s, taux de conversion) ---
$sqlDevis = "
    SELECT
        COUNT(*) AS total_devis,
        SUM(CASE WHEN d.statut = 'ACCEPTE' THEN 1 ELSE 0 END) AS devis_acceptes,
        SUM(CASE WHEN d.statut = 'REFUSE' THEN 1 ELSE 0 END) AS devis_refuses
    FROM devis d
    $whereDevisSql
";
$stmt = $pdo->prepare($sqlDevis);
$stmt->execute($params);
$statsDevis = $stmt->fetch() ?: [
    'total_devis'    => 0,
    'devis_acceptes' => 0,
    'devis_refuses'  => 0,
];

$tauxConversion = 0;
if ((int)$statsDevis['total_devis'] > 0) {
    $tauxConversion = round(
        ((int)$statsDevis['devis_acceptes'] / (int)$statsDevis['total_devis']) * 100
    );
}

// --- 3. CA par canal de vente ---
$sqlCanaux = "
    SELECT
        cv.id,
        cv.code,
        cv.libelle,
        COALESCE(SUM(CASE WHEN v.statut <> 'ANNULEE'
                     THEN v.montant_total_ttc ELSE 0 END), 0) AS ca_canal
    FROM canaux_vente cv
    LEFT JOIN ventes v ON v.canal_vente_id = cv.id
        " . ($whereVentesSql ? str_replace('WHERE', 'AND', $whereVentesSql) : '') . "
    GROUP BY cv.id, cv.code, cv.libelle
    ORDER BY ca_canal DESC, cv.code
";
$stmt = $pdo->prepare($sqlCanaux);
$stmt->execute($params);
$caParCanal = $stmt->fetchAll();

// --- 4. Top produits (CA sur la pÃ©riode) ---
$sqlTopProduits = "
    SELECT
        p.id,
        p.code_produit,
        p.designation,
        COALESCE(SUM(vl.montant_ligne_ht), 0) AS ca_produit_ht
    FROM produits p
    JOIN ventes_lignes vl ON vl.produit_id = p.id
    JOIN ventes v ON v.id = vl.vente_id
    $whereVentesSql
    AND v.statut <> 'ANNULEE'
    GROUP BY p.id, p.code_produit, p.designation
    HAVING ca_produit_ht > 0
    ORDER BY ca_produit_ht DESC
    LIMIT 5
";
$stmt = $pdo->prepare($sqlTopProduits);
$stmt->execute($params);
$topProduits = $stmt->fetchAll();

// --- 5. Ventilation statuts de ventes ---
$sqlStatutsVente = "
    SELECT
        v.statut,
        COUNT(*) AS nb
    FROM ventes v
    $whereVentesSql
    GROUP BY v.statut
";
$stmt = $pdo->prepare($sqlStatutsVente);
$stmt->execute($params);
$statutsVente = $stmt->fetchAll();

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Reporting & tableaux de bord</h1>
    </div>

    <!-- Filtres pÃ©riode -->
    <div class="card mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end" method="get">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-6 d-flex gap-2 mt-3 mt-md-0">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Actualiser
                    </button>
                    <a href="<?= url_for('reporting/index.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Ligne de KPIs principaux -->
    <div class="row g-3 mb-3">
        <!-- CA total TTC -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-3">
                    <div class="text-muted small">CA total TTC (ventes)</div>
                    <div class="h4 mb-0">
                        <?= number_format((float)$statsVentes['ca_total_ttc'], 0, ',', ' ') ?> FCFA
                    </div>
                    <div class="small text-muted mt-1">
                        Ventes non annulÃ©es
                    </div>
                </div>
            </div>
        </div>

        <!-- Nombre de ventes -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-3">
                    <div class="text-muted small">Nombre total de ventes</div>
                    <div class="h4 mb-0">
                        <?= (int)$statsVentes['nb_ventes'] ?>
                    </div>
                    <div class="small text-muted mt-1">
                        Tous statuts confondus
                    </div>
                </div>
            </div>
        </div>

        <!-- Taux de conversion devis -> acceptÃ©s -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-3">
                    <div class="text-muted small">Taux de conversion devis</div>
                    <div class="h4 mb-0">
                        <?php if ((int)$statsDevis['total_devis'] > 0): ?>
                            <?= $tauxConversion ?> %
                        <?php else: ?>
                            â€”
                        <?php endif; ?>
                    </div>
                    <div class="small text-muted mt-1">
                        Devis acceptÃ©s / devis totaux
                    </div>
                </div>
            </div>
        </div>

        <!-- Nombre de devis -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-3">
                    <div class="text-muted small">Nombre de devis</div>
                    <div class="h4 mb-0">
                        <?= (int)$statsDevis['total_devis'] ?>
                    </div>
                    <div class="small text-muted mt-1">
                        Dont acceptÃ©s : <strong><?= (int)$statsDevis['devis_acceptes'] ?></strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Deux colonnes : CA par canal / Top produits -->
    <div class="row g-3 mb-3">
        <!-- CA par canal -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-white">
                    <h2 class="h6 mb-0">CA par canal de vente</h2>
                </div>
                <div class="card-body">
                    <?php if (empty($caParCanal)): ?>
                        <p class="text-muted mb-0">Aucune vente sur la pÃ©riode sÃ©lectionnÃ©e.</p>
                    <?php else: ?>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                <tr>
                                    <th>Canal</th>
                                    <th class="text-end">CA TTC</th>
                                </tr>
                                </thead>
                                <tbody>
                                <?php foreach ($caParCanal as $c): ?>
                                    <tr>
                                        <td>
                                            <span class="fw-semibold"><?= htmlspecialchars($c['code']) ?></span><br>
                                            <span class="text-muted small"><?= htmlspecialchars($c['libelle']) ?></span>
                                        </td>
                                        <td class="text-end">
                                            <?= number_format((float)$c['ca_canal'], 0, ',', ' ') ?> FCFA
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>

        <!-- Top produits -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-white">
                    <h2 class="h6 mb-0">Top 5 produits par CA (HT)</h2>
                </div>
                <div class="card-body">
                    <?php if (empty($topProduits)): ?>
                        <p class="text-muted mb-0">Aucun produit vendu sur la pÃ©riode sÃ©lectionnÃ©e.</p>
                    <?php else: ?>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                <tr>
                                    <th>Produit</th>
                                    <th class="text-end">CA HT</th>
                                </tr>
                                </thead>
                                <tbody>
                                <?php foreach ($topProduits as $p): ?>
                                    <tr>
                                        <td>
                                            <span class="fw-semibold">
                                                <?= htmlspecialchars($p['code_produit']) ?>
                                            </span><br>
                                            <span class="text-muted small">
                                                <?= htmlspecialchars($p['designation']) ?>
                                            </span>
                                        </td>
                                        <td class="text-end">
                                            <?= number_format((float)$p['ca_produit_ht'], 0, ',', ' ') ?> FCFA
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>

    <!-- Ventilation des statuts de ventes -->
    <div class="card mb-4">
        <div class="card-header bg-white">
            <h2 class="h6 mb-0">RÃ©partition des ventes par statut</h2>
        </div>
        <div class="card-body">
            <?php if (empty($statutsVente)): ?>
                <p class="text-muted mb-0">Aucune vente enregistrÃ©e sur la pÃ©riode sÃ©lectionnÃ©e.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>Statut</th>
                            <th class="text-end">Nombre de ventes</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($statutsVente as $sv): ?>
                            <tr>
                                <td><?= htmlspecialchars($sv['statut']) ?></td>
                                <td class="text-end"><?= (int)$sv['nb'] ?></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : ruptures\list.php =====

<?php
// ruptures/list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('PRODUITS_LIRE');

global $pdo;

$peutCreer = in_array('PRODUITS_MODIFIER', $_SESSION['permissions'] ?? [], true);

// Traitement POST : signaler une rupture
$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

if ($_SERVER['REQUEST_METHOD'] === 'POST' && $peutCreer) {
    try {
        verifierCsrf($_POST['csrf_token'] ?? '');

        $dateRapport   = trim($_POST['date_rapport'] ?? date('Y-m-d'));
        $produitId     = (int)($_POST['produit_id'] ?? 0);
        $seuilAlerte   = (int)($_POST['seuil_alerte'] ?? 0);
        $stockActuel   = (int)($_POST['stock_actuel'] ?? 0);
        $impact        = trim($_POST['impact_commercial'] ?? '');
        $action        = trim($_POST['action_proposee'] ?? '');

        $utilisateur   = utilisateurConnecte();
        $magasinierId  = $utilisateur['id'] ?? null;

        $erreurs = [];
        if ($dateRapport === '') {
            $erreurs[] = "La date du rapport est obligatoire.";
        }
        if ($produitId <= 0) {
            $erreurs[] = "Le produit est obligatoire.";
        }

        if (!empty($erreurs)) {
            $_SESSION['flash_error'] = implode(' ', $erreurs);
            header('Location: ' . url_for('ruptures/list.php'));
            exit;
        }

        $stmt = $pdo->prepare("
            INSERT INTO ruptures_stock
            (date_rapport, produit_id, seuil_alerte, stock_actuel, impact_commercial, action_proposee, magasinier_id)
            VALUES
            (:date_rapport, :produit_id, :seuil_alerte, :stock_actuel, :impact_commercial, :action_proposee, :magasinier_id)
        ");
        $stmt->execute([
            'date_rapport'      => $dateRapport,
            'produit_id'        => $produitId,
            'seuil_alerte'      => $seuilAlerte,
            'stock_actuel'      => $stockActuel,
            'impact_commercial' => $impact !== '' ? $impact : null,
            'action_proposee'   => $action !== '' ? $action : null,
            'magasinier_id'     => $magasinierId,
        ]);

        $_SESSION['flash_success'] = "Rupture de stock signalÃ©e avec succÃ¨s.";
        header('Location: ' . url_for('ruptures/list.php'));
        exit;

    } catch (Throwable $e) {
        $_SESSION['flash_error'] = "Erreur lors du signalement de la rupture de stock.";
        header('Location: ' . url_for('ruptures/list.php'));
        exit;
    }
}

// Filtres liste
$today     = date('Y-m-d');
$dateDebut = $_GET['date_debut'] ?? $today;
$dateFin   = $_GET['date_fin'] ?? $today;
$produitId = isset($_GET['produit_id']) ? (int)$_GET['produit_id'] : 0;

// Produits pour filtres / formulaire
$stmt = $pdo->query("SELECT id, code_produit, designation, stock_actuel, seuil_alerte FROM produits ORDER BY code_produit");
$produits = $stmt->fetchAll();

$where  = [];
$params = [];

if ($dateDebut !== '') {
    $where[] = "r.date_rapport >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "r.date_rapport <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($produitId > 0) {
    $where[] = "r.produit_id = :produit_id";
    $params['produit_id'] = $produitId;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

$sql = "
    SELECT
        r.*,
        p.code_produit,
        p.designation AS produit_nom,
        u.nom_complet AS magasinier_nom
    FROM ruptures_stock r
    JOIN produits p ON p.id = r.produit_id
    LEFT JOIN utilisateurs u ON u.id = r.magasinier_id
    $whereSql
    ORDER BY r.date_rapport DESC, r.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$ruptures = $stmt->fetchAll();

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Ruptures de stock dÃ©clarÃ©es</h1>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-4">
                    <label class="form-label small">Produit</label>
                    <select name="produit_id" class="form-select">
                        <option value="0">Tous</option>
                        <?php foreach ($produits as $pr): ?>
                            <option value="<?= (int)$pr['id'] ?>"
                                <?= $produitId === (int)$pr['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($pr['code_produit']) ?> â€“ <?= htmlspecialchars($pr['designation']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary mt-4">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('ruptures/list.php') ?>" class="btn btn-outline-secondary mt-4">
                        RÃ©init.
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Formulaire de dÃ©claration -->
    <?php if ($peutCreer): ?>
        <div class="card mb-3">
            <div class="card-header">
                <strong>Signaler une nouvelle rupture / alerte stock</strong>
            </div>
            <div class="card-body">
                <form method="post">
                    <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label small">Date rapport</label>
                            <input type="date" name="date_rapport" class="form-control"
                                   value="<?= htmlspecialchars($today) ?>" required>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small">Produit</label>
                            <select name="produit_id" class="form-select" required>
                                <option value="">-- SÃ©lectionner --</option>
                                <?php foreach ($produits as $pr): ?>
                                    <option value="<?= (int)$pr['id'] ?>">
                                        <?= htmlspecialchars($pr['code_produit']) ?> â€“ <?= htmlspecialchars($pr['designation']) ?>
                                        (Stock: <?= (int)$pr['stock_actuel'] ?> / Seuil: <?= (int)$pr['seuil_alerte'] ?>)
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Seuil alerte</label>
                            <input type="number" name="seuil_alerte" class="form-control"
                                   placeholder="Ex : 5">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Stock actuel</label>
                            <input type="number" name="stock_actuel" class="form-control"
                                   placeholder="Ex : 0">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small">Impact commercial</label>
                            <textarea name="impact_commercial" class="form-control" rows="2"
                                      placeholder="Devis perdus, ventes reportÃ©es, insatisfaction client, etc."></textarea>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small">Action proposÃ©e</label>
                            <textarea name="action_proposee" class="form-control" rows="2"
                                      placeholder="RÃ©approvisionnement, commande fournisseur urgente, substitution produit, etc."></textarea>
                        </div>

                        <div class="col-12 d-flex justify-content-end">
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-exclamation-triangle me-1"></i> Enregistrer la rupture
                            </button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    <?php endif; ?>

    <!-- Liste des ruptures -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($ruptures)): ?>
                <p class="text-muted mb-0">Aucune rupture de stock dÃ©clarÃ©e pour les filtres sÃ©lectionnÃ©s.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date rapport</th>
                            <th>Produit</th>
                            <th>Seuil</th>
                            <th>Stock actuel</th>
                            <th>Magasinier</th>
                            <th>Impact commercial</th>
                            <th>Action proposÃ©e</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($ruptures as $r): ?>
                            <?php
                            $alerte = (int)$r['stock_actuel'] <= (int)$r['seuil_alerte'];
                            ?>
                            <tr>
                                <td><?= htmlspecialchars($r['date_rapport']) ?></td>
                                <td>
                                    <span class="fw-semibold"><?= htmlspecialchars($r['code_produit']) ?></span><br>
                                    <span class="text-muted small"><?= htmlspecialchars($r['produit_nom']) ?></span>
                                </td>
                                <td class="text-center"><?= (int)$r['seuil_alerte'] ?></td>
                                <td class="text-center">
                                    <span class="fw-semibold <?= $alerte ? 'text-danger' : '' ?>">
                                        <?= (int)$r['stock_actuel'] ?>
                                    </span>
                                    <?php if ($alerte): ?>
                                        <span class="badge bg-danger-subtle text-danger ms-1">
                                            Alerte
                                        </span>
                                    <?php endif; ?>
                                </td>
                                <td><?= htmlspecialchars($r['magasinier_nom'] ?? '') ?></td>
                                <td><?= nl2br(htmlspecialchars($r['impact_commercial'] ?? '')) ?></td>
                                <td><?= nl2br(htmlspecialchars($r['action_proposee'] ?? '')) ?></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : satisfaction\list.php =====

<?php
// satisfaction/list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('SATISFACTION_GERER');

global $pdo;

// --- Services possibles (utilisÃ© partout) ---
$servicesPossibles = ['SHOWROOM','HOTEL','FORMATION','TERRAIN','DIGITAL'];

// --- Traitement ajout d'une satisfaction ---
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $dateSatisfaction = $_POST['date_satisfaction'] ?? date('Y-m-d');
    $serviceUtilise    = $_POST['service_utilise'] ?? '';
    $note              = (int)($_POST['note'] ?? 0);
    $nomClient         = trim($_POST['nom_client'] ?? '');
    $clientId          = isset($_POST['client_id']) && $_POST['client_id'] !== ''
        ? (int)$_POST['client_id']
        : null;
    $commentaire       = trim($_POST['commentaire'] ?? '');

    $errors = [];

    // Validation service
    if (!in_array($serviceUtilise, $servicesPossibles, true)) {
        $errors[] = "Service utilisÃ© invalide.";
    }

    // Validation note
    if ($note < 1 || $note > 5) {
        $errors[] = "La note doit Ãªtre comprise entre 1 et 5.";
    }

    // Au moins nom ou client_id
    if ($nomClient === '' && $clientId === null) {
        $errors[] = "Veuillez renseigner au moins le nom du client ou sÃ©lectionner un client existant.";
    }

    if (empty($errors)) {
        // Si client_id renseignÃ© mais nom_client vide, on recopie depuis la table clients
        if ($clientId !== null && $nomClient === '') {
            $stmt = $pdo->prepare("SELECT nom FROM clients WHERE id = :id");
            $stmt->execute(['id' => $clientId]);
            $cli = $stmt->fetch();
            if ($cli) {
                $nomClient = $cli['nom'];
            }
        }

        $stmt = $pdo->prepare("
            INSERT INTO satisfaction_clients
                (date_satisfaction, client_id, nom_client, service_utilise, note, commentaire, utilisateur_id)
            VALUES
                (:date_satisfaction, :client_id, :nom_client, :service_utilise, :note, :commentaire, :utilisateur_id)
        ");

        $stmt->execute([
            'date_satisfaction' => $dateSatisfaction,
            'client_id'         => $clientId,
            'nom_client'        => $nomClient,
            'service_utilise'   => $serviceUtilise,
            'note'              => $note,
            'commentaire'       => $commentaire,
            'utilisateur_id'    => utilisateurConnecte()['id'] ?? null,
        ]);

        $_SESSION['flash_success'] = "EnquÃªte de satisfaction enregistrÃ©e avec succÃ¨s.";
        header('Location: ' . url_for('satisfaction/list.php'));
        exit;
    } else {
        $_SESSION['flash_error'] = implode(' ', $errors);
        header('Location: ' . url_for('satisfaction/list.php'));
        exit;
    }
}

// --- Filtres liste ---
$dateDebut = $_GET['date_debut'] ?? date('Y-m-01');
$dateFin   = $_GET['date_fin'] ?? date('Y-m-d');
$service   = $_GET['service'] ?? '';

$where  = [];
$params = [];

if ($dateDebut !== '') {
    $where[] = "s.date_satisfaction >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "s.date_satisfaction <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($service !== '' && in_array($service, $servicesPossibles, true)) {
    $where[] = "s.service_utilise = :service";
    $params['service'] = $service;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// --- RÃ©cupÃ©ration des enquÃªtes ---
$sql = "
    SELECT
        s.*,
        u.nom_complet AS utilisateur_nom
    FROM satisfaction_clients s
    LEFT JOIN utilisateurs u ON u.id = s.utilisateur_id
    $whereSql
    ORDER BY s.date_satisfaction DESC, s.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$enquetes = $stmt->fetchAll();

// --- Statistiques globales sur la satisfaction ---
$sqlStats = "
    SELECT
        COUNT(*) AS total_enquetes,
        AVG(s.note) AS moyenne_globale,
        SUM(CASE WHEN s.note >= 4 THEN 1 ELSE 0 END) AS nb_satisfaits,
        SUM(CASE WHEN s.service_utilise = 'SHOWROOM' THEN 1 ELSE 0 END) AS nb_showroom,
        SUM(CASE WHEN s.service_utilise = 'HOTEL' THEN 1 ELSE 0 END) AS nb_hotel,
        SUM(CASE WHEN s.service_utilise = 'FORMATION' THEN 1 ELSE 0 END) AS nb_formation,
        SUM(CASE WHEN s.service_utilise = 'TERRAIN' THEN 1 ELSE 0 END) AS nb_terrain,
        SUM(CASE WHEN s.service_utilise = 'DIGITAL' THEN 1 ELSE 0 END) AS nb_digital
    FROM satisfaction_clients s
    $whereSql
";

$stmtStats = $pdo->prepare($sqlStats);
$stmtStats->execute($params);
$stats = $stmtStats->fetch() ?: [
    'total_enquetes'   => 0,
    'moyenne_globale'  => null,
    'nb_satisfaits'    => 0,
    'nb_showroom'      => 0,
    'nb_hotel'         => 0,
    'nb_formation'     => 0,
    'nb_terrain'       => 0,
    'nb_digital'       => 0,
];

$pourcentageSatisfaits = 0;
if ((int)$stats['total_enquetes'] > 0) {
    $pourcentageSatisfaits = round(
        ((int)$stats['nb_satisfaits'] / (int)$stats['total_enquetes']) * 100
    );
}

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Satisfaction clients</h1>
    </div>

    <!-- Bloc de synthÃ¨se KPI Satisfaction -->
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-3">
                    <div class="text-muted small">Nombre dâ€™enquÃªtes</div>
                    <div class="h4 mb-0">
                        <?= (int)$stats['total_enquetes'] ?>
                    </div>
                    <div class="small text-muted mt-1">
                        Sur la pÃ©riode filtrÃ©e
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-3">
                    <div class="text-muted small">Note moyenne globale</div>
                    <div class="h4 mb-0">
                        <?php if ($stats['moyenne_globale'] !== null): ?>
                            <?= number_format((float)$stats['moyenne_globale'], 2, ',', ' ') ?>/5
                        <?php else: ?>
                            â€”
                        <?php endif; ?>
                    </div>
                    <div class="small text-muted mt-1">
                        Tous services confondus
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-3">
                    <div class="text-muted small">% clients satisfaits (4â€“5)</div>
                    <div class="h4 mb-0">
                        <?php if ((int)$stats['total_enquetes'] > 0): ?>
                            <?= $pourcentageSatisfaits ?> %
                        <?php else: ?>
                            â€”
                        <?php endif; ?>
                    </div>
                    <div class="small text-muted mt-1">
                        Objectif Ã  suivre par la direction
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-3">
                    <div class="text-muted small mb-1">RÃ©partition par service</div>
                    <div class="small">
                        <div>Showroom : <strong><?= (int)$stats['nb_showroom'] ?></strong></div>
                        <div>HÃ´tel : <strong><?= (int)$stats['nb_hotel'] ?></strong></div>
                        <div>Formation : <strong><?= (int)$stats['nb_formation'] ?></strong></div>
                        <div>Terrain : <strong><?= (int)$stats['nb_terrain'] ?></strong></div>
                        <div>Digital : <strong><?= (int)$stats['nb_digital'] ?></strong></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Formulaire de saisie d'une satisfaction -->
    <div class="card mb-3">
        <div class="card-body">
            <h2 class="h6 mb-3">Enregistrer une satisfaction client</h2>
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                <div class="col-md-3">
                    <label class="form-label small">Date</label>
                    <input type="date"
                           name="date_satisfaction"
                           class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Service utilisÃ©</label>
                    <select name="service_utilise" class="form-select" required>
                        <option value="">SÃ©lectionner...</option>
                        <?php foreach ($servicesPossibles as $svc): ?>
                            <option value="<?= $svc ?>"><?= $svc ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label small">Note (1 Ã  5)</label>
                    <select name="note" class="form-select" required>
                        <option value="">Note...</option>
                        <?php for ($i = 1; $i <= 5; $i++): ?>
                            <option value="<?= $i ?>"><?= $i ?></option>
                        <?php endfor; ?>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Nom du client (libre)</label>
                    <input type="text" name="nom_client" class="form-control"
                           placeholder="Nom du client (si pas dans la base)">
                    <div class="form-text">
                        Tu peux remplir ce champ mÃªme si le client n'existe pas encore dans la base.
                    </div>
                </div>

                <!-- Recherche AJAX client -->
                <div class="col-md-6 position-relative">
                    <label class="form-label small">Client (BD KMS - facultatif)</label>
                    <input type="hidden" name="client_id" id="client_id" value="">
                    <input type="text"
                           id="client_search"
                           class="form-control"
                           placeholder="Rechercher un client par nom, tÃ©lÃ©phone ou email...">
                    <div id="client_search_results"
                         class="list-group position-absolute w-100 shadow-sm"
                         style="z-index: 1050; max-height: 250px; overflow-y: auto; display:none;"></div>
                    <div class="form-text">
                        Tape quelques lettres puis sÃ©lectionne un client dans la liste.
                    </div>
                </div>

                <div class="col-12">
                    <label class="form-label small">Commentaire</label>
                    <textarea name="commentaire" rows="2" class="form-control"
                              placeholder="Remarques du client, points positifs, axes d'amÃ©lioration..."></textarea>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtres liste -->
    <div class="card mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end" method="get">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Service</label>
                    <select name="service" class="form-select">
                        <option value="">Tous</option>
                        <?php foreach ($servicesPossibles as $svc): ?>
                            <option value="<?= $svc ?>" <?= $service === $svc ? 'selected' : '' ?>>
                                <?= $svc ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3 d-flex gap-2 mt-3 mt-md-0">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('satisfaction/list.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des enquÃªtes -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($enquetes)): ?>
                <p class="text-muted mb-0">Aucune enquÃªte de satisfaction trouvÃ©e pour les filtres sÃ©lectionnÃ©s.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Client (texte)</th>
                            <th>Service</th>
                            <th class="text-center">Note</th>
                            <th>Commentaire</th>
                            <th>Saisi par</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($enquetes as $e): ?>
                            <tr>
                                <td><?= htmlspecialchars($e['date_satisfaction']) ?></td>
                                <td>
                                    <?= htmlspecialchars($e['nom_client']) ?>
                                    <?php if (!empty($e['client_id'])): ?>
                                        <span class="badge bg-primary-subtle text-primary ms-1">
                                            ID #<?= (int)$e['client_id'] ?>
                                        </span>
                                    <?php endif; ?>
                                </td>
                                <td><?= htmlspecialchars($e['service_utilise']) ?></td>
                                <td class="text-center">
                                    <span class="fw-semibold"><?= (int)$e['note'] ?>/5</span>
                                </td>
                                <td><?= nl2br(htmlspecialchars($e['commentaire'] ?? '')) ?></td>
                                <td><?= htmlspecialchars($e['utilisateur_nom'] ?? '') ?></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<!-- Script de recherche AJAX client -->
<script>
(function() {
    const input      = document.getElementById('client_search');
    const hiddenId   = document.getElementById('client_id');
    const resultsBox = document.getElementById('client_search_results');

    if (!input || !hiddenId || !resultsBox) {
        return;
    }

    let timer = null;

    function clearResults() {
        resultsBox.innerHTML = '';
        resultsBox.style.display = 'none';
    }

    function selectClient(button) {
        hiddenId.value = button.dataset.id;
        input.value    = button.dataset.label;
        clearResults();
    }

    input.addEventListener('input', function() {
        const q = this.value.trim();
        hiddenId.value = ''; // reset de l'ID quand on modifie le texte

        if (timer) {
            clearTimeout(timer);
        }

        if (q.length < 2) {
            clearResults();
            return;
        }

        timer = setTimeout(function() {
            fetch('<?= url_for('ajax/clients_search.php') ?>?q=' + encodeURIComponent(q), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    resultsBox.innerHTML = '';

                    if (!Array.isArray(data) || data.length === 0) {
                        clearResults();
                        return;
                    }

                    data.forEach(function(row) {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'list-group-item list-group-item-action py-1';
                        btn.textContent = row.label;
                        btn.dataset.id = row.id;
                        btn.dataset.label = row.label;
                        btn.addEventListener('click', function() {
                            selectClient(btn);
                        });
                        resultsBox.appendChild(btn);
                    });

                    resultsBox.style.display = 'block';
                })
                .catch(function() {
                    clearResults();
                });
        }, 300); // debounce
    });

    document.addEventListener('click', function(e) {
        if (!resultsBox.contains(e.target) && e.target !== input) {
            clearResults();
        }
    });
})();
</script>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : showroom\visiteurs_list.php =====

<?php
// showroom/visiteurs_list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('CLIENTS_CREER'); // showrooms = gestion prospects / clients

global $pdo;

$utilisateur = utilisateurConnecte();
$userId      = (int)$utilisateur['id'];

// URL du script courant (inclut le rÃ©pertoire du projet, ex : /kms_app/showroom/visiteurs_list.php)
$scriptPath = $_SERVER['SCRIPT_NAME'];

// Filtres date
$today      = date('Y-m-d');
$dateDebut  = $_GET['date_debut'] ?? $today;
$dateFin    = $_GET['date_fin'] ?? $today;

$erreurs = [];

// Traitement formulaire ajout rapide (AVANT tout output HTML)
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $csrf = $_POST['csrf_token'] ?? '';
    verifierCsrf($csrf);

    $date_visite     = $_POST['date_visite'] ?? $today;
    $client_nom      = trim($_POST['client_nom'] ?? '');
    $contact         = trim($_POST['contact'] ?? '');
    $produit_interet = trim($_POST['produit_interet'] ?? '');
    $orientation     = trim($_POST['orientation'] ?? '');

    if ($client_nom === '') {
        $erreurs[] = "Le nom du visiteur est obligatoire.";
    }
    if ($contact === '') {
        $erreurs[] = "Un moyen de contact (tÃ©lÃ©phone) est obligatoire.";
    }

    if (empty($erreurs)) {
        $stmtIns = $pdo->prepare("
            INSERT INTO visiteurs_showroom (
                date_visite, client_nom, contact, produit_interet, orientation,
                client_id, utilisateur_id
            ) VALUES (
                :date_visite, :client_nom, :contact, :produit_interet, :orientation,
                NULL, :utilisateur_id
            )
        ");
        $stmtIns->execute([
            'date_visite'    => $date_visite,
            'client_nom'     => $client_nom,
            'contact'        => $contact,
            'produit_interet'=> $produit_interet ?: null,
            'orientation'    => $orientation ?: null,
            'utilisateur_id' => $userId
        ]);

        $_SESSION['flash_success'] = "Le visiteur showroom a Ã©tÃ© enregistrÃ©.";

        // Redirection vers la mÃªme page en conservant les filtres
        $redirectUrl = $scriptPath
            . '?date_debut=' . urlencode($dateDebut)
            . '&date_fin=' . urlencode($dateFin);

        header('Location: ' . $redirectUrl);
        exit;
    }
}

// Construction du WHERE pour le listing
$where  = [];
$params = [];

if ($dateDebut !== '') {
    $where[] = "vs.date_visite >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "vs.date_visite <= :date_fin";
    $params['date_fin'] = $dateFin;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// Liste visiteurs
$sql = "
    SELECT 
        vs.*,
        u.nom_complet AS utilisateur_nom,
        c.nom AS client_nom_lie
    FROM visiteurs_showroom vs
    JOIN utilisateurs u ON u.id = vs.utilisateur_id
    LEFT JOIN clients c ON c.id = vs.client_id
    $whereSql
    ORDER BY vs.date_visite DESC, vs.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$visiteurs = $stmt->fetchAll();

$csrfToken    = getCsrfToken();
$flashSuccess = $_SESSION['flash_success'] ?? null;
unset($_SESSION['flash_success']);

// INCLUDES APRÃˆS la logique PHP / redirections
include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Visiteurs showroom</h1>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if (!empty($erreurs)): ?>
        <div class="alert alert-danger">
            <h2 class="h6 mb-2"><i class="bi bi-exclamation-triangle me-1"></i> Erreurs</h2>
            <ul class="mb-0">
                <?php foreach ($erreurs as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <!-- Formulaire rapide d'enregistrement -->
    <div class="card mb-3">
        <div class="card-header">
            <strong>Saisie rapide dâ€™un visiteur</strong>
        </div>
        <div class="card-body">
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">

                <div class="col-md-3">
                    <label class="form-label small">Date de visite</label>
                    <input type="date" name="date_visite" class="form-control"
                           value="<?= htmlspecialchars($today) ?>">
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Nom du visiteur *</label>
                    <input type="text" name="client_nom" class="form-control" required>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Contact (tÃ©lÃ©phone) *</label>
                    <input type="text" name="contact" class="form-control" required>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Orientation</label>
                    <select name="orientation" class="form-select">
                        <option value="">â€”</option>
                        <option value="Devis">Devis</option>
                        <option value="HÃ´tel">HÃ´tel</option>
                        <option value="Formation">Formation</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>

                <div class="col-md-9">
                    <label class="form-label small">Produit / besoin exprimÃ©</label>
                    <input type="text" name="produit_interet" class="form-control">
                </div>

                <div class="col-md-3 d-flex align-items-end justify-content-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-plus-circle me-1"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtres & listing -->
    <div class="card">
        <div class="card-header">
            <form class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-6 d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary mt-4">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= htmlspecialchars($scriptPath) ?>" class="btn btn-outline-secondary mt-4">
                        Aujourdâ€™hui
                    </a>
                </div>
            </form>
        </div>
        <div class="card-body">
            <?php if (empty($visiteurs)): ?>
                <p class="text-muted mb-0">Aucun visiteur pour la pÃ©riode sÃ©lectionnÃ©e.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Nom</th>
                            <th>Contact</th>
                            <th>Produit / besoin</th>
                            <th>Orientation</th>
                            <th>EnregistrÃ© par</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($visiteurs as $v): ?>
                            <tr>
                                <td><?= htmlspecialchars($v['date_visite']) ?></td>
                                <td><?= htmlspecialchars($v['client_nom']) ?></td>
                                <td><?= htmlspecialchars($v['contact']) ?></td>
                                <td><?= htmlspecialchars($v['produit_interet'] ?? '') ?></td>
                                <td><?= htmlspecialchars($v['orientation'] ?? '') ?></td>
                                <td><?= htmlspecialchars($v['utilisateur_nom']) ?></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : stock\etat.php =====

<?php
// stock/etat.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
// On considÃ¨re que consulter l'Ã©tat du stock nÃ©cessite au moins la permission PRODUITS_LIRE
exigerPermission('PRODUITS_LIRE');

global $pdo;

// --- Filtres ---
$q = trim($_GET['q'] ?? '');
$hideZero = isset($_GET['hide_zero']) && $_GET['hide_zero'] === '1';

$where = 'WHERE p.actif = 1';
$params = [];

if ($q !== '') {
    $where .= ' AND (p.code_produit LIKE :q OR p.designation LIKE :q)';
    $params['q'] = '%' . $q . '%';
}

// --- RÃ©cupÃ©ration des produits + stock calculÃ© Ã  partir des mouvements ---
// On utilise la table `stocks_mouvements` : ENTREE => +quantite, SORTIE => -quantite, AJUSTEMENT => +quantite
$sql = "
    SELECT
        p.id,
        p.code_produit,
        p.designation,
        p.prix_vente,
        COALESCE(SUM(
            CASE
                WHEN m.type_mouvement = 'ENTREE' THEN m.quantite
                WHEN m.type_mouvement = 'SORTIE' THEN -m.quantite
                WHEN m.type_mouvement = 'AJUSTEMENT' THEN m.quantite
                ELSE 0
            END
        ), 0) AS stock_qte
    FROM produits p
    LEFT JOIN stocks_mouvements m ON m.produit_id = p.id
    $where
    GROUP BY p.id, p.code_produit, p.designation, p.prix_vente
    ORDER BY p.designation
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$rows = $stmt->fetchAll();

// Calcul des totaux (en tenant compte Ã©ventuellement du filtre "cacher stock = 0")
$totalValeur = 0;
$totalArticles = 0;

$produitsAffiches = [];

foreach ($rows as $r) {
    $stock = (float)$r['stock_qte'];
    if ($hideZero && abs($stock) < 0.00001) {
        // On masque les produits Ã  stock nul si demandÃ©
        continue;
    }

    $prixVente = (float)$r['prix_vente'];
    $valeur = $stock * $prixVente;

    $r['stock_qte'] = $stock;
    $r['valeur_stock'] = $valeur;

    $produitsAffiches[] = $r;

    $totalArticles += $stock;
    $totalValeur += $valeur;
}

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Ã‰tat du stock produits</h1>
    </div>

    <!-- Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small">Recherche produit</label>
                    <input type="text"
                           name="q"
                           class="form-control"
                           placeholder="Code produit ou dÃ©signation..."
                           value="<?= htmlspecialchars($q) ?>">
                </div>
                <div class="col-md-4">
                    <div class="form-check mt-4">
                        <input class="form-check-input"
                               type="checkbox"
                               value="1"
                               id="hide_zero"
                               name="hide_zero"
                            <?= $hideZero ? 'checked' : '' ?>>
                        <label class="form-check-label small" for="hide_zero">
                            Masquer les produits avec stock = 0
                        </label>
                    </div>
                </div>
                <div class="col-md-4 d-flex gap-2 mt-3 mt-md-0">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('stock/etat.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- RÃ©sumÃ© global -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="card border-start border-4 border-primary">
                <div class="card-body py-2">
                    <div class="small text-muted">Nombre de produits affichÃ©s</div>
                    <div class="h5 mb-0"><?= count($produitsAffiches) ?></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-start border-4 border-success">
                <div class="card-body py-2">
                    <div class="small text-muted">Stock total (quantitÃ©)</div>
                    <div class="h5 mb-0"><?= number_format($totalArticles, 2, ',', ' ') ?></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-start border-4 border-warning">
                <div class="card-body py-2">
                    <div class="small text-muted">Valeur thÃ©orique du stock</div>
                    <div class="h5 mb-0"><?= number_format($totalValeur, 0, ',', ' ') ?> FCFA</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste dÃ©taillÃ©e -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($produitsAffiches)): ?>
                <p class="text-muted mb-0">
                    Aucun produit trouvÃ© pour les filtres sÃ©lectionnÃ©s.
                </p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th style="width: 12%;">Code</th>
                            <th>Produit</th>
                            <th class="text-end" style="width: 12%;">Prix vente</th>
                            <th class="text-end" style="width: 12%;">Stock actuel</th>
                            <th class="text-end" style="width: 16%;">Valeur stock</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($produitsAffiches as $p): ?>
                            <tr>
                                <td><?= htmlspecialchars($p['code_produit']) ?></td>
                                <td><?= htmlspecialchars($p['designation']) ?></td>
                                <td class="text-end">
                                    <?= number_format((float)$p['prix_vente'], 0, ',', ' ') ?> FCFA
                                </td>
                                <td class="text-end">
                                    <?= number_format((float)$p['stock_qte'], 2, ',', ' ') ?>
                                </td>
                                <td class="text-end">
                                    <?= number_format((float)$p['valeur_stock'], 0, ',', ' ') ?> FCFA
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                        <tfoot>
                        <tr class="fw-semibold">
                            <td colspan="3" class="text-end">Total</td>
                            <td class="text-end">
                                <?= number_format($totalArticles, 2, ',', ' ') ?>
                            </td>
                            <td class="text-end">
                                <?= number_format($totalValeur, 0, ',', ' ') ?> FCFA
                            </td>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : stock\mouvements.php =====

<?php
// stock/mouvements.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('PRODUITS_MODIFIER');

require_once __DIR__ . '/../lib/stock.php';

global $pdo;

// --- Constantes / listes ---
$typesMouvement  = ['ENTREE', 'SORTIE', 'CORRECTION'];
$modulesSource   = ['VENTE', 'ACHAT', 'AUTRE'];

// --- RÃ©cupÃ©ration des produits pour les listes dÃ©roulantes ---
$stmt = $pdo->query("
    SELECT id, code_produit, designation, stock_actuel
    FROM produits
    WHERE actif = 1
    ORDER BY designation
");
$produits = $stmt->fetchAll();
$produitsMap = [];
foreach ($produits as $p) {
    $produitsMap[(int)$p['id']] = $p;
}

// --- Traitement ajout d'un mouvement manuel ---
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $dateMouvement  = $_POST['date_mouvement'] ?? date('Y-m-d');
    $typeMouvement  = strtoupper(trim($_POST['type_mouvement'] ?? ''));
    $produitId      = isset($_POST['produit_id']) ? (int)$_POST['produit_id'] : 0;
    $quantiteRaw    = str_replace(',', '.', $_POST['quantite'] ?? '0');
    $quantite       = (int)round((float)$quantiteRaw);
    $sourceModule   = strtoupper(trim($_POST['source_module'] ?? 'AUTRE'));
    $sourceIdRaw    = trim($_POST['source_id'] ?? '');
    $sourceId       = ($sourceIdRaw === '') ? null : (int)$sourceIdRaw;
    $commentaire    = trim($_POST['commentaire'] ?? '');

    $errors = [];

    if ($dateMouvement === '') {
        $errors[] = "La date du mouvement est obligatoire.";
    }

    if (!in_array($typeMouvement, $typesMouvement, true)) {
        $errors[] = "Type de mouvement invalide.";
    }

    if ($produitId <= 0 || !isset($produitsMap[$produitId])) {
        $errors[] = "Veuillez sÃ©lectionner un produit valide.";
    }

    if ($quantite <= 0) {
        $errors[] = "La quantitÃ© doit Ãªtre strictement positive.";
    }

    if (!in_array($sourceModule, $modulesSource, true)) {
        $sourceModule = 'AUTRE';
    }

    // RÃ¨gles de traÃ§abilitÃ© :
    // - ENTREE / SORTIE :
    //      * si module = VENTE ou ACHAT => source_id obligatoire
    //      * si module = AUTRE => commentaire obligatoire
    // - CORRECTION : commentaire obligatoire (explication de la correction)
    if (in_array($typeMouvement, ['ENTREE', 'SORTIE'], true)) {
        if (in_array($sourceModule, ['VENTE', 'ACHAT'], true) && ($sourceId === null || $sourceId <= 0)) {
            $errors[] = "Merci d'indiquer la rÃ©fÃ©rence liÃ©e (ID " .
                strtolower($sourceModule) . ") pour ce mouvement.";
        }
        if ($sourceModule === 'AUTRE' && $commentaire === '') {
            $errors[] = "Merci de prÃ©ciser le motif dans le commentaire pour un mouvement AUTRE.";
        }
    } elseif ($typeMouvement === 'CORRECTION' && $commentaire === '') {
        $errors[] = "Pour un mouvement de correction, un commentaire explicatif est obligatoire.";
    }

    if (empty($errors)) {
        try {
            stock_enregistrer_mouvement(
                $pdo,
                $typeMouvement,
                $produitId,
                $quantite,
                $sourceModule,
                $sourceId,
                $commentaire,
                $dateMouvement
            );

            $_SESSION['flash_success'] = "Mouvement de stock enregistrÃ© avec succÃ¨s.";
        } catch (Throwable $e) {
            // Ici tu peux loguer $e->getMessage() dans un fichier si besoin
            $_SESSION['flash_error'] = "Erreur lors de l'enregistrement du mouvement de stock.";
        }

        header('Location: ' . url_for('stock/mouvements.php'));
        exit;
    } else {
        $_SESSION['flash_error'] = implode(' ', $errors);
        header('Location: ' . url_for('stock/mouvements.php'));
        exit;
    }
}

// --- Filtres de la liste ---
$dateDebut = $_GET['date_debut'] ?? date('Y-m-01');
$dateFin   = $_GET['date_fin'] ?? date('Y-m-d');
$typeFiltre   = strtoupper(trim($_GET['type_mouvement'] ?? ''));
$produitFiltre= isset($_GET['produit_id']) ? (int)$_GET['produit_id'] : 0;

$where  = [];
$params = [];

if ($dateDebut !== '') {
    $where[] = "m.date_mouvement >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "m.date_mouvement <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($typeFiltre !== '' && in_array($typeFiltre, $typesMouvement, true)) {
    $where[] = "m.type_mouvement = :type_mouvement";
    $params['type_mouvement'] = $typeFiltre;
}
if ($produitFiltre > 0) {
    $where[] = "m.produit_id = :produit_id";
    $params['produit_id'] = $produitFiltre;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

// --- RÃ©cupÃ©ration des mouvements ---
$sql = "
    SELECT
        m.*,
        p.code_produit,
        p.designation,
        p.stock_actuel
    FROM mouvements_stock m
    JOIN produits p ON p.id = m.produit_id
    $whereSql
    ORDER BY m.date_mouvement DESC, m.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$mouvements = $stmt->fetchAll();

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

$csrfToken = getCsrfToken();

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Mouvements de stock</h1>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Formulaire de saisie d'un mouvement -->
    <div class="card mb-3">
        <div class="card-body">
            <h2 class="h6 mb-3">Enregistrer un mouvement manuel</h2>
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">

                <div class="col-md-3">
                    <label class="form-label small">Date du mouvement</label>
                    <input type="date"
                           name="date_mouvement"
                           class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Type de mouvement</label>
                    <select name="type_mouvement" class="form-select" required>
                        <option value="">SÃ©lectionner...</option>
                        <?php foreach ($typesMouvement as $t): ?>
                            <option value="<?= $t ?>"><?= $t ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label small">Produit</label>
                    <select name="produit_id" class="form-select" required>
                        <option value="">SÃ©lectionner un produit...</option>
                        <?php foreach ($produits as $p): ?>
                            <option value="<?= (int)$p['id'] ?>">
                                <?= htmlspecialchars($p['code_produit']) ?> â€“ <?= htmlspecialchars($p['designation']) ?>
                                (Stock : <?= (int)$p['stock_actuel'] ?>)
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">QuantitÃ©</label>
                    <input type="number" name="quantite" class="form-control" min="1" step="1" required>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Module / motif principal</label>
                    <select name="source_module" class="form-select" required>
                        <?php foreach ($modulesSource as $m): ?>
                            <option value="<?= $m ?>"><?= $m ?></option>
                        <?php endforeach; ?>
                    </select>
                    <div class="form-text">
                        VENTE = liÃ©e Ã  une vente, ACHAT = liÃ©e Ã  un achat, AUTRE = usage interne, casse, etc.
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">RÃ©fÃ©rence liÃ©e (ID)</label>
                    <input type="number" name="source_id" class="form-control" min="0"
                           placeholder="ID vente / achat / autre">
                    <div class="form-text">
                        Obligatoire si module = VENTE ou ACHAT. Peut rester vide pour AUTRE.
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label small">Commentaire / motif dÃ©taillÃ©</label>
                    <textarea name="commentaire" rows="2" class="form-control"
                              placeholder="Motif de la sortie/entrÃ©e ou explication de la correction..."></textarea>
                    <div class="form-text">
                        Obligatoire pour CORRECTION et pour les mouvements AUTRE.
                    </div>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Enregistrer le mouvement
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Type</label>
                    <select name="type_mouvement" class="form-select">
                        <option value="">Tous</option>
                        <?php foreach ($typesMouvement as $t): ?>
                            <option value="<?= $t ?>" <?= $typeFiltre === $t ? 'selected' : '' ?>>
                                <?= $t ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Produit</label>
                    <select name="produit_id" class="form-select">
                        <option value="0">Tous</option>
                        <?php foreach ($produits as $p): ?>
                            <option value="<?= (int)$p['id'] ?>" <?= $produitFiltre === (int)$p['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($p['code_produit']) ?> â€“ <?= htmlspecialchars($p['designation']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3 mt-2">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('stock/mouvements.php') ?>" class="btn btn-outline-secondary ms-2">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des mouvements -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($mouvements)): ?>
                <p class="text-muted mb-0">
                    Aucun mouvement de stock trouvÃ© pour les filtres sÃ©lectionnÃ©s.
                </p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Produit</th>
                            <th class="text-center">Type</th>
                            <th class="text-end">QuantitÃ©</th>
                            <th>Module / rÃ©f.</th>
                            <th>Commentaire</th>
                            <th class="text-end">Stock aprÃ¨s (indicatif)</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($mouvements as $m): ?>
                            <?php
                            $sens = $m['type_mouvement'] === 'SORTIE' ? -1 : 1;
                            $q = (int)$m['quantite'];
                            $affichageQte = ($sens < 0 ? '-' : '+') . $q;
                            ?>
                            <tr>
                                <td><?= htmlspecialchars($m['date_mouvement']) ?></td>
                                <td>
                                    <span class="fw-semibold">
                                        <?= htmlspecialchars($m['code_produit']) ?>
                                    </span><br>
                                    <span class="text-muted small">
                                        <?= htmlspecialchars($m['designation']) ?>
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge
                                        <?= $m['type_mouvement'] === 'ENTREE' ? 'bg-success-subtle text-success' : '' ?>
                                        <?= $m['type_mouvement'] === 'SORTIE' ? 'bg-danger-subtle text-danger' : '' ?>
                                        <?= $m['type_mouvement'] === 'CORRECTION' ? 'bg-warning-subtle text-warning' : '' ?>
                                    ">
                                        <?= htmlspecialchars($m['type_mouvement']) ?>
                                    </span>
                                </td>
                                <td class="text-end"><?= htmlspecialchars($affichageQte) ?></td>
                                <td>
                                    <span class="fw-semibold"><?= htmlspecialchars($m['source_module']) ?></span>
                                    <?php if (!empty($m['source_id'])): ?>
                                        <br><span class="text-muted small">RÃ©f. ID #<?= (int)$m['source_id'] ?></span>
                                    <?php endif; ?>
                                </td>
                                <td><?= nl2br(htmlspecialchars($m['commentaire'] ?? '')) ?></td>
                                <td class="text-end">
                                    <?= (int)$m['stock_actuel'] ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : terrain\prospections_list.php =====

<?php
// terrain/prospections_list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('CLIENTS_CREER'); // les commerciaux terrain ont dÃ©jÃ  cette permission

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';

global $pdo;

$utilisateur = utilisateurConnecte();
$userId      = (int)$utilisateur['id'];

$today      = date('Y-m-d');
$dateDebut  = $_GET['date_debut'] ?? $today;
$dateFin    = $_GET['date_fin'] ?? $today;

$where  = [];
$params = [];

$where[] = "pt.commercial_id = :cid";
$params['cid'] = $userId;

if ($dateDebut !== '') {
    $where[] = "pt.date_prospection >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "pt.date_prospection <= :date_fin";
    $params['date_fin'] = $dateFin;
}

$whereSql = 'WHERE ' . implode(' AND ', $where);

$sql = "
    SELECT pt.*
    FROM prospections_terrain pt
    $whereSql
    ORDER BY pt.date_prospection DESC, pt.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$prospections = $stmt->fetchAll();

// Formulaire POST
$erreurs = [];
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $csrf = $_POST['csrf_token'] ?? '';
    verifierCsrf($csrf);

    $date_prospection = $_POST['date_prospection'] ?? $today;
    $prospect_nom     = trim($_POST['prospect_nom'] ?? '');
    $secteur          = trim($_POST['secteur'] ?? '');
    $besoin_identifie = trim($_POST['besoin_identifie'] ?? '');
    $action_menee     = trim($_POST['action_menee'] ?? '');
    $resultat         = trim($_POST['resultat'] ?? '');
    $prochaine_etape  = trim($_POST['prochaine_etape'] ?? '');

    if ($prospect_nom === '') {
        $erreurs[] = "Le nom du prospect est obligatoire.";
    }
    if ($secteur === '') {
        $erreurs[] = "Le secteur (zone, quartier...) est obligatoire.";
    }
    if ($besoin_identifie === '') {
        $erreurs[] = "Le besoin identifiÃ© est obligatoire.";
    }
    if ($action_menee === '') {
        $erreurs[] = "Lâ€™action menÃ©e est obligatoire.";
    }
    if ($resultat === '') {
        $erreurs[] = "Le rÃ©sultat de la visite est obligatoire.";
    }

    if (empty($erreurs)) {
        $stmtIns = $pdo->prepare("
            INSERT INTO prospections_terrain (
                date_prospection, prospect_nom, secteur,
                besoin_identifie, action_menee, resultat,
                prochaine_etape, client_id, commercial_id
            ) VALUES (
                :date_prospection, :prospect_nom, :secteur,
                :besoin_identifie, :action_menee, :resultat,
                :prochaine_etape, NULL, :commercial_id
            )
        ");
        $stmtIns->execute([
            'date_prospection' => $date_prospection,
            'prospect_nom'     => $prospect_nom,
            'secteur'          => $secteur,
            'besoin_identifie' => $besoin_identifie,
            'action_menee'     => $action_menee,
            'resultat'         => $resultat,
            'prochaine_etape'  => $prochaine_etape ?: null,
            'commercial_id'    => $userId
        ]);

        $_SESSION['flash_success'] = "Prospection terrain enregistrÃ©e.";
        header('Location: /terrain/prospections_list.php?date_debut=' . urlencode($dateDebut) . '&date_fin=' . urlencode($dateFin));
        exit;
    }
}

$csrfToken = getCsrfToken();
$flashSuccess = $_SESSION['flash_success'] ?? null;
unset($_SESSION['flash_success']);
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Prospections terrain</h1>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if (!empty($erreurs)): ?>
        <div class="alert alert-danger">
            <h2 class="h6 mb-2"><i class="bi bi-exclamation-triangle me-1"></i> Erreurs</h2>
            <ul class="mb-0">
                <?php foreach ($erreurs as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <!-- Saisie rapide -->
    <div class="card mb-3">
        <div class="card-header">
            <strong>Nouvelle prospection terrain</strong>
        </div>
        <div class="card-body">
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">

                <div class="col-md-3">
                    <label class="form-label small">Date prospection</label>
                    <input type="date" name="date_prospection" class="form-control"
                           value="<?= htmlspecialchars($today) ?>">
                </div>
                <div class="col-md-4">
                    <label class="form-label small">Nom du prospect *</label>
                    <input type="text" name="prospect_nom" class="form-control" required>
                </div>
                <div class="col-md-5">
                    <label class="form-label small">Secteur / zone *</label>
                    <input type="text" name="secteur" class="form-control" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label small">Besoin identifiÃ© *</label>
                    <textarea name="besoin_identifie" class="form-control" rows="2" required></textarea>
                </div>
                <div class="col-md-6">
                    <label class="form-label small">Action menÃ©e *</label>
                    <textarea name="action_menee" class="form-control" rows="2" required></textarea>
                </div>

                <div class="col-md-6">
                    <label class="form-label small">RÃ©sultat *</label>
                    <textarea name="resultat" class="form-control" rows="2" required></textarea>
                </div>
                <div class="col-md-6">
                    <label class="form-label small">Prochaine Ã©tape</label>
                    <textarea name="prochaine_etape" class="form-control" rows="2"></textarea>
                </div>

                <div class="col-md-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i> Enregistrer la prospection
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtres + liste -->
    <div class="card">
        <div class="card-header">
            <form class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-6 d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary mt-4">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="/terrain/prospections_list.php" class="btn btn-outline-secondary mt-4">
                        Aujourdâ€™hui
                    </a>
                </div>
            </form>
        </div>
        <div class="card-body">
            <?php if (empty($prospections)): ?>
                <p class="text-muted mb-0">Aucune prospection pour la pÃ©riode sÃ©lectionnÃ©e.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Prospect</th>
                            <th>Secteur</th>
                            <th>Besoin identifiÃ©</th>
                            <th>Action menÃ©e</th>
                            <th>RÃ©sultat</th>
                            <th>Prochaine Ã©tape</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($prospections as $p): ?>
                            <tr>
                                <td><?= htmlspecialchars($p['date_prospection']) ?></td>
                                <td><?= htmlspecialchars($p['prospect_nom']) ?></td>
                                <td><?= htmlspecialchars($p['secteur']) ?></td>
                                <td><?= nl2br(htmlspecialchars($p['besoin_identifie'])) ?></td>
                                <td><?= nl2br(htmlspecialchars($p['action_menee'])) ?></td>
                                <td><?= nl2br(htmlspecialchars($p['resultat'])) ?></td>
                                <td><?= nl2br(htmlspecialchars($p['prochaine_etape'] ?? '')) ?></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : terrain\rendezvous_list.php =====

<?php
// terrain/rendezvous_list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('CLIENTS_CREER');

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';

global $pdo;

$utilisateur = utilisateurConnecte();
$userId      = (int)$utilisateur['id'];

$today      = date('Y-m-d');
$dateDebut  = $_GET['date_debut'] ?? $today;
$dateFin    = $_GET['date_fin'] ?? $today;
$statutFiltre = $_GET['statut'] ?? '';

$where  = [];
$params = [];

$where[] = "rt.commercial_id = :cid";
$params['cid'] = $userId;

if ($dateDebut !== '') {
    $where[] = "rt.date_rdv >= :date_debut";
    $params['date_debut'] = $dateDebut;
}
if ($dateFin !== '') {
    $where[] = "rt.date_rdv <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($statutFiltre !== '' && in_array($statutFiltre, ['PLANIFIE','CONFIRME','ANNULE','HONORE'], true)) {
    $where[] = "rt.statut = :statut";
    $params['statut'] = $statutFiltre;
}

$whereSql = 'WHERE ' . implode(' AND ', $where);

$sql = "
    SELECT rt.*
    FROM rendezvous_terrain rt
    $whereSql
    ORDER BY rt.date_rdv ASC, rt.heure_rdv ASC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$rendezvous = $stmt->fetchAll();

// POST : crÃ©ation rapide de RDV
$erreurs = [];
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $csrf = $_POST['csrf_token'] ?? '';
    verifierCsrf($csrf);

    $date_rdv  = $_POST['date_rdv'] ?? $today;
    $heure_rdv = $_POST['heure_rdv'] ?? '09:00';
    $client_prospect_nom = trim($_POST['client_prospect_nom'] ?? '');
    $lieu     = trim($_POST['lieu'] ?? '');
    $objectif = trim($_POST['objectif'] ?? '');
    $statut   = $_POST['statut'] ?? 'PLANIFIE';

    if ($client_prospect_nom === '') {
        $erreurs[] = "Le nom du client / prospect est obligatoire.";
    }
    if ($lieu === '') {
        $erreurs[] = "Le lieu du rendez-vous est obligatoire.";
    }
    if ($objectif === '') {
        $erreurs[] = "Lâ€™objectif du rendez-vous est obligatoire.";
    }
    if (!in_array($statut, ['PLANIFIE','CONFIRME','ANNULE','HONORE'], true)) {
        $erreurs[] = "Statut de rendez-vous invalide.";
    }

    if (empty($erreurs)) {
        $stmtIns = $pdo->prepare("
            INSERT INTO rendezvous_terrain (
                date_rdv, heure_rdv, client_prospect_nom,
                lieu, objectif, statut,
                client_id, commercial_id
            ) VALUES (
                :date_rdv, :heure_rdv, :client_prospect_nom,
                :lieu, :objectif, :statut,
                NULL, :commercial_id
            )
        ");
        $stmtIns->execute([
            'date_rdv'           => $date_rdv,
            'heure_rdv'          => $heure_rdv,
            'client_prospect_nom'=> $client_prospect_nom,
            'lieu'               => $lieu,
            'objectif'           => $objectif,
            'statut'             => $statut,
            'commercial_id'      => $userId
        ]);

        $_SESSION['flash_success'] = "Rendez-vous terrain enregistrÃ©.";
        header('Location: /terrain/rendezvous_list.php?date_debut=' . urlencode($dateDebut) . '&date_fin=' . urlencode($dateFin) . '&statut=' . urlencode($statutFiltre));
        exit;
    }
}

$csrfToken = getCsrfToken();
$flashSuccess = $_SESSION['flash_success'] ?? null;
unset($_SESSION['flash_success']);
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Rendez-vous terrain</h1>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if (!empty($erreurs)): ?>
        <div class="alert alert-danger">
            <h2 class="h6 mb-2"><i class="bi bi-exclamation-triangle me-1"></i> Erreurs</h2>
            <ul class="mb-0">
                <?php foreach ($erreurs as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <!-- Saisie RDV -->
    <div class="card mb-3">
        <div class="card-header">
            <strong>Nouveau rendez-vous terrain</strong>
        </div>
        <div class="card-body">
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">

                <div class="col-md-3">
                    <label class="form-label small">Date *</label>
                    <input type="date" name="date_rdv" class="form-control"
                           value="<?= htmlspecialchars($today) ?>" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Heure *</label>
                    <input type="time" name="heure_rdv" class="form-control"
                           value="09:00" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label small">Nom client / prospect *</label>
                    <input type="text" name="client_prospect_nom" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Lieu *</label>
                    <input type="text" name="lieu" class="form-control" required>
                </div>

                <div class="col-md-8">
                    <label class="form-label small">Objectif du rendez-vous *</label>
                    <textarea name="objectif" class="form-control" rows="2" required></textarea>
                </div>
                <div class="col-md-4">
                    <label class="form-label small">Statut</label>
                    <select name="statut" class="form-select">
                        <?php foreach (['PLANIFIE','CONFIRME','ANNULE','HONORE'] as $s): ?>
                            <option value="<?= $s ?>"><?= $s ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-md-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i> Enregistrer le rendez-vous
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtres + liste -->
    <div class="card">
        <div class="card-header">
            <form class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDebut) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Statut</label>
                    <select name="statut" class="form-select">
                        <option value="">Tous</option>
                        <?php foreach (['PLANIFIE','CONFIRME','ANNULE','HONORE'] as $s): ?>
                            <option value="<?= $s ?>" <?= $statutFiltre === $s ? 'selected' : '' ?>>
                                <?= $s ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary mt-4">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="/terrain/rendezvous_list.php" class="btn btn-outline-secondary mt-4">
                        Aujourdâ€™hui
                    </a>
                </div>
            </form>
        </div>
        <div class="card-body">
            <?php if (empty($rendezvous)): ?>
                <p class="text-muted mb-0">Aucun rendez-vous pour la pÃ©riode sÃ©lectionnÃ©e.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Heure</th>
                            <th>Client / prospect</th>
                            <th>Lieu</th>
                            <th>Objectif</th>
                            <th>Statut</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($rendezvous as $r): ?>
                            <tr>
                                <td><?= htmlspecialchars($r['date_rdv']) ?></td>
                                <td><?= htmlspecialchars(substr($r['heure_rdv'], 0, 5)) ?></td>
                                <td><?= htmlspecialchars($r['client_prospect_nom']) ?></td>
                                <td><?= htmlspecialchars($r['lieu']) ?></td>
                                <td><?= nl2br(htmlspecialchars($r['objectif'])) ?></td>
                                <td>
                                    <?php
                                    $badgeClass = 'bg-secondary-subtle text-secondary';
                                    if ($r['statut'] === 'PLANIFIE') $badgeClass = 'bg-warning-subtle text-warning';
                                    elseif ($r['statut'] === 'CONFIRME') $badgeClass = 'bg-info-subtle text-info';
                                    elseif ($r['statut'] === 'HONORE') $badgeClass = 'bg-success-subtle text-success';
                                    elseif ($r['statut'] === 'ANNULE') $badgeClass = 'bg-danger-subtle text-danger';
                                    ?>
                                    <span class="badge <?= $badgeClass ?>">
                                        <?= htmlspecialchars($r['statut']) ?>
                                    </span>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : tests\check_movements_for_product.php =====

<?php
require_once __DIR__ . '/../db/db.php';
$prodId = isset($argv[1]) ? (int)$argv[1] : 0;
if ($prodId <= 0) { echo json_encode([]); exit(0); }
$stmt = $pdo->prepare('SELECT id, date_mouvement, type_mouvement, quantite, source_type, source_id, commentaire FROM stocks_mouvements WHERE produit_id = ? ORDER BY id DESC LIMIT 10');
$stmt->execute([$prodId]);
$rows = $stmt->fetchAll(PDO::FETCH_ASSOC);
echo json_encode($rows);



===== FICHIER : tests\check_product_by_code.php =====

<?php
require_once __DIR__ . '/../db/db.php';
$code = $argv[1] ?? '';
if ($code === '') { echo json_encode(null); exit(0); }
$stmt = $pdo->prepare('SELECT id, code_produit, stock_actuel FROM produits WHERE code_produit = ?');
$stmt->execute([$code]);
$r = $stmt->fetch(PDO::FETCH_ASSOC);
echo json_encode($r);



===== FICHIER : tests\compare_stock_product.php =====

<?php
require_once __DIR__ . '/../db/db.php';
require_once __DIR__ . '/../lib/stock.php';
$prodId = isset($argv[1]) ? (int)$argv[1] : 0;
if ($prodId <= 0) { echo json_encode(null); exit(0); }
$stmt = $pdo->prepare('SELECT stock_actuel FROM produits WHERE id = ?');
$stmt->execute([$prodId]);
$stockActuel = $stmt->fetchColumn();
$theorique = stock_get_quantite_produit($pdo, $prodId);
echo json_encode(['produit_id' => $prodId, 'stock_actuel' => (int)$stockActuel, 'theorique' => (int)$theorique]);



===== FICHIER : tests\count_movements_for_vente.php =====

<?php
require_once __DIR__ . '/../db/db.php';
$venteId = isset($argv[1]) ? (int)$argv[1] : 0;
if ($venteId <= 0) { echo 0; exit(0); }
$stmt = $pdo->prepare('SELECT COUNT(*) as c FROM stocks_mouvements WHERE source_type = ? AND source_id = ?');
$stmt->execute(['VENTE', $venteId]);
echo (int)$stmt->fetchColumn();



===== FICHIER : tests\find_vente_with_lines.php =====

<?php
require_once __DIR__ . '/../db/db.php';
$stmt = $pdo->query("SELECT v.id FROM ventes v JOIN ventes_lignes l ON l.vente_id = v.id GROUP BY v.id LIMIT 1");
$r = $stmt->fetch(PDO::FETCH_ASSOC);
echo $r ? (int)$r['id'] : 0;



===== FICHIER : tests\generer_bl_simulate.php =====

<?php
require_once __DIR__ . '/../db/db.php';
require_once __DIR__ . '/../lib/stock.php';

echo "DÃ©but simulation gÃ©nÃ©ration BL (transactionnel, non-destructif)\n";

// Trouver une vente avec lignes et des quantitÃ©s restantes Ã  livrer
$stmt = $pdo->query("SELECT id FROM ventes WHERE statut <> 'ANNULEE'");
$candidate = null;
while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
    $vid = (int)$row['id'];
    // RÃ©cup lignes de vente
    $s = $pdo->prepare("SELECT vl.*, p.stock_actuel FROM ventes_lignes vl JOIN produits p ON p.id = vl.produit_id WHERE vl.vente_id = :id");
    $s->execute(['id' => $vid]);
    $lignes = $s->fetchAll(PDO::FETCH_ASSOC);
    if (empty($lignes)) continue;

    // Calcul livraisons existantes
    $s2 = $pdo->prepare("SELECT bll.produit_id, SUM(bll.quantite) AS qte_livree FROM bons_livraison_lignes bll JOIN bons_livraison bl ON bl.id = bll.bon_livraison_id WHERE bl.vente_id = :id GROUP BY bll.produit_id");
    $s2->execute(['id' => $vid]);
    $liv = $s2->fetchAll(PDO::FETCH_KEY_PAIR);

    $toDeliver = [];
    foreach ($lignes as $lv) {
        $pid = (int)$lv['produit_id'];
        $qteCmd = (float)$lv['quantite'];
        $qteLiv = isset($liv[$pid]) ? (float)$liv[$pid] : 0.0;
        $rest = max(0, $qteCmd - $qteLiv);
        if ($rest > 0) $toDeliver[] = ['produit_id' => $pid, 'quantite' => $rest];
    }

    if (!empty($toDeliver)) {
        $candidate = ['vente_id' => $vid, 'lignes' => $toDeliver];
        break;
    }
}

if (!$candidate) {
    echo "Aucune vente trouvÃ©e avec lignes Ã  livrer. Test impossible.\n";
    exit(1);
}

$venteId = $candidate['vente_id'];
$lignesALivrer = $candidate['lignes'];

echo "Vente choisie: {$venteId}\n";

try {
    // Mesurer stocks avant
    $before = [];
    foreach ($lignesALivrer as $lg) {
        $pid = (int)$lg['produit_id'];
        $before[$pid] = stock_get_quantite_produit($pdo, $pid);
    }
    echo "Stocks avant:\n";
    foreach ($before as $pid => $q) echo " - produit {$pid}: {$q}\n";

    // DÃ©marrer transaction et crÃ©er BL + lignes + mouvements
    $pdo->beginTransaction();

    $numeroBL = 'BL-TEST-' . date('Ymd-His');
    // RÃ©cupÃ©rer utilisateur courant si la fonction est disponible, sinon fallback Ã  1
    if (function_exists('utilisateurConnecte')) {
        $util = utilisateurConnecte();
        $magasinierId = $util['id'] ?? 1;
    } else {
        $magasinierId = 1;
    }

    // Insertion BL
    $stmt = $pdo->prepare("INSERT INTO bons_livraison (numero, date_bl, vente_id, client_id, transport_assure_par, observations, signe_client, magasinier_id) VALUES (:numero, :date_bl, :vente_id, :client_id, :transport, :obs, 0, :magasinier_id)");

    // RÃ©cup client pour la vente
    $s3 = $pdo->prepare("SELECT client_id FROM ventes WHERE id = :id");
    $s3->execute(['id' => $venteId]);
    $clientId = $s3->fetchColumn();

    $stmt->execute([
        'numero' => $numeroBL,
        'date_bl' => date('Y-m-d'),
        'vente_id' => $venteId,
        'client_id' => $clientId,
        'transport' => null,
        'obs' => null,
        'magasinier_id' => $magasinierId,
    ]);
    $blId = (int)$pdo->lastInsertId();

    $stmtBL = $pdo->prepare("INSERT INTO bons_livraison_lignes (bon_livraison_id, produit_id, quantite) VALUES (:bl_id, :produit_id, :quantite)");

    echo "BL temporaire crÃ©Ã©: {$blId} (numero {$numeroBL})\n";

    foreach ($lignesALivrer as $lg) {
        $pid = (int)$lg['produit_id'];
        $qte = (float)$lg['quantite'];

        $stmtBL->execute(['bl_id' => $blId, 'produit_id' => $pid, 'quantite' => $qte]);

        // Enregistrer mouvement via API
        $mvtId = stock_enregistrer_mouvement($pdo, [
            'produit_id' => $pid,
            'date_mouvement' => date('Y-m-d H:i:s'),
            'type_mouvement' => 'SORTIE',
            'quantite' => $qte,
            'source_type' => 'VENTE',
            'source_id' => $venteId,
            'commentaire' => 'Test BL ' . $numeroBL,
            'utilisateur_id' => $magasinierId,
        ]);
        echo " Mouvement temporaire insÃ©rÃ©: ID={$mvtId} pour produit {$pid} qte {$qte}\n";
    }

    // Mesurer stocks aprÃ¨s insertion (dans la transaction)
    $after = [];
    foreach ($lignesALivrer as $lg) {
        $pid = (int)$lg['produit_id'];
        $after[$pid] = stock_get_quantite_produit($pdo, $pid);
    }
    echo "Stocks aprÃ¨s (transaction ouverte):\n";
    foreach ($after as $pid => $q) echo " - produit {$pid}: {$q}\n";

    // Rollback
    $pdo->rollBack();
    echo "Rollback effectuÃ©.\n";

    // VÃ©rifier qu'aucun BL ou mouvement n'est persistÃ©
    $cntBl = (int)$pdo->prepare("SELECT COUNT(*) FROM bons_livraison WHERE id = :id")->execute(['id' => $blId]);
    // The above returns bool; better to query properly
    $cntBl = (int)$pdo->query("SELECT COUNT(*) FROM bons_livraison WHERE id = " . (int)$blId)->fetchColumn();
    $cntMvt = (int)$pdo->query("SELECT COUNT(*) FROM stocks_mouvements WHERE source_type = 'VENTE' AND source_id = " . (int)$venteId . " AND commentaire LIKE 'Test BL %'")->fetchColumn();

    echo "BL persistants (aprÃ¨s rollback): {$cntBl}\n";
    echo "Mouvements persistants liÃ©s au test (aprÃ¨s rollback): {$cntMvt}\n";

    // VÃ©rifier stocks finaux
    $final = [];
    foreach ($lignesALivrer as $lg) {
        $pid = (int)$lg['produit_id'];
        $final[$pid] = stock_get_quantite_produit($pdo, $pid);
    }
    echo "Stocks finaux (aprÃ¨s rollback):\n";
    foreach ($final as $pid => $q) echo " - produit {$pid}: {$q}\n";

    $ok = true;
    foreach ($before as $pid => $q) {
        if ($final[$pid] != $q) { $ok = false; break; }
    }

    if ($ok && $cntBl === 0 && $cntMvt === 0) {
        echo "TEST GENERER_BL OK: aucun effet persistant, stocks restaurÃ©s.\n";
        exit(0);
    } else {
        echo "TEST GENERER_BL FAIL: effets persistants ou stocks modifiÃ©s.\n";
        exit(2);
    }

} catch (Throwable $e) {
    if ($pdo->inTransaction()) $pdo->rollBack();
    echo "Erreur pendant la simulation: " . $e->getMessage() . "\n";
    exit(3);
}



===== FICHIER : tests\http_tests_run.ps1 =====

# tests/http_tests_run.ps1
$baseUrl = 'http://localhost/kms_app'
$session = New-Object Microsoft.PowerShell.Commands.WebRequestSession

# Add provided PHPSESSID cookie
$phpSess = 'lq6v6f45ldaavbihfgmubhhi5j'
$cookie = New-Object System.Net.Cookie('PHPSESSID', $phpSess, '/', 'localhost')
$session.Cookies.Add($cookie)

function Get-CsrfToken($url) {
    $r = Invoke-WebRequest -Uri $url -WebSession $session -UseBasicParsing -ErrorAction Stop
    $m = [regex]::Match($r.Content, 'name="csrf_token"\s+value="([^"]+)"')
    if ($m.Success) { return $m.Groups[1].Value }
    return $null
}

Write-Host "Base URL: $baseUrl"

# 1) Create product
Write-Host "\n==> 1) CrÃ©ation du produit TEST-PRD-001"
$token = Get-CsrfToken "$baseUrl/produits/edit.php"
if (-not $token) { Write-Error "CSRF token introuvable pour crÃ©ation produit"; exit 1 }

$body = @{
    csrf_token = $token
    id = 0
    code_produit = 'TEST-PRD-001'
    designation = 'Produit test automatisÃ©'
    actif = 'on'
    famille_id = 1
    prix_achat = 1000
    prix_vente = 1500
    stock_initial = 5
    localisation = 'Magasin test'
    caracteristiques = 'auto test'
    description = 'CrÃ©ation via script automatique'
}

$r = Invoke-WebRequest -Uri "$baseUrl/produits/edit.php" -Method Post -Body $body -WebSession $session -MaximumRedirection 0 -ErrorAction SilentlyContinue
Write-Host "HTTP status (create):" $r.StatusCode

Write-Host "\nRequÃªte DB: recherche produit TEST-PRD-001"
$json = (php "tests/check_product_by_code.php" "TEST-PRD-001") 2>&1
Write-Host $json
try { $obj = $json | ConvertFrom-Json } catch { Write-Error "Produit non trouvÃ© ou JSON invalide:"; Write-Host $json; exit 1 }
$prodId = $obj.id
Write-Host "Produit ID trouvÃ©: $prodId, stock_actuel: $($obj.stock_actuel)"

# 3) Ajuster le produit (ajustement_stock = -2)
Write-Host "\n==> 2) Ajustement de stock: -2 sur produit ID $prodId"
$token2 = Get-CsrfToken "$baseUrl/produits/edit.php?id=$prodId"
if (-not $token2) { Write-Error "CSRF token introuvable pour Ã©dition produit"; exit 1 }

# To avoid overwriting unknown fields, we'll fetch the current form values and reuse them in body
$page = Invoke-WebRequest -Uri "$baseUrl/produits/edit.php?id=$prodId" -WebSession $session -UseBasicParsing -ErrorAction Stop
# crude extraction of some fields
$code = [regex]::Match($page.Content, 'name="code_produit"[^>]*value="([^"]*)"').Groups[1].Value
$designation = [regex]::Match($page.Content, 'name="designation"[^>]*value="([^"]*)"').Groups[1].Value
$prix_vente = [regex]::Match($page.Content, 'name="prix_vente"[^>]*value="([^"]*)"').Groups[1].Value
$famille = [regex]::Match($page.Content, 'name="famille_id"[^>]*>\s*<option value="([^"]+)" selected').Groups[1].Value
if (-not $famille) { $famille = 1 }

$body2 = @{
    csrf_token = $token2
    id = $prodId
    code_produit = $code
    designation = $designation
    famille_id = $famille
    prix_vente = $prix_vente
    ajustement_stock = -2
}

$r2 = Invoke-WebRequest -Uri "$baseUrl/produits/edit.php?id=$prodId" -Method Post -Body $body2 -WebSession $session -MaximumRedirection 0 -ErrorAction SilentlyContinue
Write-Host "HTTP status (ajustement):" $r2.StatusCode

# 4) VÃ©rifier en base les derniers mouvements pour ce produit
Write-Host "\nRequÃªte DB: mouvements rÃ©cents pour le produit"
Write-Host "\nMouvements rÃ©cents pour le produit (DB):"
$mvtJson = (php "tests/check_movements_for_product.php" "$prodId") 2>&1
Write-Host $mvtJson

Write-Host "\nComparaison stock_actuel vs stock thÃ©orique (lib/stock.php):"
$cmp = (php "tests/compare_stock_product.php" "$prodId") 2>&1
Write-Host $cmp

# 5) GÃ©nÃ©rer un BL pour une vente existante
Write-Host "\n==> 3) GÃ©nÃ©ration automatique d'un BL (tentative)"
# Find a vente with lines and not fully delivered (via PHP check)
# find a vente via helper script
$venteId = (php "tests/find_vente_with_lines.php") 2>&1
if ($venteId -eq '' -or $venteId -eq '0') { Write-Host 'Aucune vente trouvÃ©e pour BL'; exit 0 }
Write-Host "Vente choisie pour BL: $venteId"
$token3 = Get-CsrfToken "$baseUrl/ventes/edit.php?id=$venteId"
if (-not $token3) { $token3 = Get-CsrfToken "$baseUrl/ventes/detail.php?id=$venteId" }
if (-not $token3) { Write-Error "CSRF token introuvable pour BL"; exit 1 }

$body3 = @{ csrf_token = $token3; vente_id = $venteId }
$r3 = Invoke-WebRequest -Uri "$baseUrl/ventes/generer_bl.php" -Method Post -Body $body3 -WebSession $session -MaximumRedirection 0 -ErrorAction SilentlyContinue
Write-Host "HTTP status (generer_bl):" $r3.StatusCode

# VÃ©rifier mouvements liÃ©s Ã  la vente
Write-Host "Mouvements liÃ©s Ã  la vente (count):"
$cnt = (php "tests/count_movements_for_vente.php" "$venteId") 2>&1
Write-Host $cnt

Write-Host "\nScript HTTP terminÃ©."



===== FICHIER : tests\stock_test.php =====

<?php
require_once __DIR__ . '/../db/db.php';
require_once __DIR__ . '/../lib/stock.php';

echo "DÃ©but test stock (transactionnel, non-destructif)\n";

// RÃ©cupÃ©rer un produit actif
$stmt = $pdo->query("SELECT id, code_produit FROM produits WHERE actif = 1 LIMIT 1");
$prod = $stmt->fetch(PDO::FETCH_ASSOC);
if (!$prod) {
    echo "Aucun produit actif trouvÃ© â€” test impossible\n";
    exit(1);
}

$pid = (int)$prod['id'];
$code = $prod['code_produit'];

echo "Produit choisi: ID={$pid}, code={$code}\n";

try {
    $pdo->beginTransaction();

    $q_before = stock_get_quantite_produit($pdo, $pid);
    echo "QuantitÃ© avant: {$q_before}\n";

    $mvtId = stock_enregistrer_mouvement($pdo, [
        'produit_id' => $pid,
        'date_mouvement' => date('Y-m-d H:i:s'),
        'type_mouvement' => 'ENTREE',
        'quantite' => 1,
        'source_type' => 'TEST',
        'source_id' => null,
        'commentaire' => 'Test transactionnel',
        'utilisateur_id' => 1,
    ]);

    echo "Mouvement insÃ©rÃ© (ID temporaire): {$mvtId}\n";

    $q_after = stock_get_quantite_produit($pdo, $pid);
    echo "QuantitÃ© aprÃ¨s insertion (transaction ouverte): {$q_after}\n";

    // Annuler les modifications
    $pdo->rollBack();
    echo "Rollback effectuÃ©\n";

    // Recalculer depuis une connexion fraÃ®che pour vÃ©rifier l'Ã©tat rÃ©el
    $stmt2 = $pdo->query("SELECT COUNT(*) as c FROM stocks_mouvements WHERE source_type = 'TEST' AND produit_id = " . $pid);
    $cnt = $stmt2->fetch(PDO::FETCH_ASSOC)['c'];
    echo "Nombre de mouvements TEST persistants (aprÃ¨s rollback): {$cnt}\n";

    $q_final = stock_get_quantite_produit($pdo, $pid);
    echo "QuantitÃ© finale (aprÃ¨s rollback): {$q_final}\n";

    if ($q_before === $q_final) {
        echo "TEST OK: rollback a annulÃ© l'insertion et le recalcul.\n";
        exit(0);
    } else {
        echo "TEST FAIL: quantitÃ© diffÃ©rente aprÃ¨s rollback (before={$q_before} final={$q_final}).\n";
        exit(2);
    }

} catch (Throwable $e) {
    if ($pdo->inTransaction()) $pdo->rollBack();
    echo "Erreur pendant le test: " . $e->getMessage() . "\n";
    exit(3);
}



===== FICHIER : tests\stock_test_achat.php =====

<?php
require_once __DIR__ . '/../db/db.php';
require_once __DIR__ . '/../lib/stock.php';

echo "DÃ©but test synchroniseur achat (transactionnel, non-destructif)\n";

// Chercher un achat avec lignes
$stmt = $pdo->query("SELECT a.id FROM achats a JOIN achats_lignes l ON l.achat_id = a.id LIMIT 1");
$row = $stmt->fetch(PDO::FETCH_ASSOC);
if (!$row) {
    echo "Aucun achat avec lignes trouvÃ© â€” test impossible\n";
    exit(1);
}
$achat_id = (int)$row['id'];

echo "Achat choisi: ID={$achat_id}\n";

try {
    // Pas de transaction globale: on sauvegarde/restaure l'Ã©tat manuellement
    $stmtP = $pdo->prepare("SELECT DISTINCT produit_id FROM achats_lignes WHERE achat_id = ?");
    $stmtP->execute([$achat_id]);
    $pids = $stmtP->fetchAll(PDO::FETCH_COLUMN);

    $before = [];
    foreach ($pids as $pid) {
        $before[$pid] = stock_get_quantite_produit($pdo, (int)$pid);
    }

    echo "QuantitÃ©s avant:\n";
    foreach ($before as $pid => $q) echo " - produit {$pid}: {$q}\n";

    // Sauvegarde des mouvements prÃ©-existants pour cet achat
    $stmtOld = $pdo->prepare("SELECT * FROM stocks_mouvements WHERE source_type = 'ACHAT' AND source_id = ?");
    $stmtOld->execute([$achat_id]);
    $oldRows = $stmtOld->fetchAll(PDO::FETCH_ASSOC);

    // Appel du synchroniseur
    $res = stock_synchroniser_achat($pdo, $achat_id);
    echo "Synchroniseur retournÃ©: "; var_export($res); echo "\n";

    $stmtNow = $pdo->prepare("SELECT DISTINCT produit_id FROM stocks_mouvements WHERE source_type = 'ACHAT' AND source_id = ?");
    $stmtNow->execute([$achat_id]);
    $nowPids = $stmtNow->fetchAll(PDO::FETCH_COLUMN);
    echo "Produits affectÃ©s par synchroniseur: "; print_r($nowPids);

    // Suppression des mouvements ajoutÃ©s
    $del = $pdo->prepare("DELETE FROM stocks_mouvements WHERE source_type = 'ACHAT' AND source_id = ?");
    $del->execute([$achat_id]);
    echo "Mouvements pour l'achat supprimÃ©s (cleanup).\n";

    // Restaurer les anciennes lignes
    foreach ($oldRows as $r) {
        stock_enregistrer_mouvement($pdo, [
            'produit_id' => $r['produit_id'],
            'date_mouvement' => $r['date_mouvement'],
            'type_mouvement' => $r['type_mouvement'],
            'quantite' => $r['quantite'],
            'source_type' => $r['source_type'],
            'source_id' => $r['source_id'],
            'commentaire' => $r['commentaire'],
            'utilisateur_id' => $r['utilisateur_id'],
        ]);
    }

    // Recalculer et vÃ©rifier
    $final = [];
    foreach ($pids as $pid) {
        stock_recalculer_stock_produit($pdo, (int)$pid);
        $final[$pid] = stock_get_quantite_produit($pdo, (int)$pid);
    }

    echo "QuantitÃ©s finales (aprÃ¨s cleanup/restauration):\n";
    foreach ($final as $pid => $q) echo " - produit {$pid}: {$q}\n";

    $ok = true;
    foreach ($before as $pid => $q) {
        if ($final[$pid] != $q) { $ok = false; break; }
    }

    if ($ok) {
        echo "TEST ACHAT OK: synchronisation testÃ©e et Ã©tat restaurÃ©.\n";
        exit(0);
    } else {
        echo "TEST ACHAT FAIL: diffÃ©rences dÃ©tectÃ©es aprÃ¨s restauration.\n";
        exit(2);
    }

} catch (Throwable $e) {
    echo "Erreur: " . $e->getMessage() . "\n";
    exit(3);
}



===== FICHIER : tests\stock_test_ajustement.php =====

<?php
require_once __DIR__ . '/../db/db.php';
require_once __DIR__ . '/../lib/stock.php';

echo "DÃ©but test ajustement (transactionnel, non-destructif)\n";

// RÃ©cupÃ©rer un produit actif
$stmt = $pdo->query("SELECT id, code_produit FROM produits WHERE actif = 1 LIMIT 1");
$prod = $stmt->fetch(PDO::FETCH_ASSOC);
if (!$prod) {
    echo "Aucun produit actif trouvÃ© â€” test impossible\n";
    exit(1);
}
$pid = (int)$prod['id'];

try {
    $pdo->beginTransaction();

    $q_before = stock_get_quantite_produit($pdo, $pid);
    echo "QuantitÃ© avant: {$q_before}\n";

    $mvtId = stock_enregistrer_mouvement($pdo, [
        'produit_id' => $pid,
        'date_mouvement' => date('Y-m-d H:i:s'),
        'type_mouvement' => 'AJUSTEMENT',
        'quantite' => -2,
        'source_type' => 'TEST_AJUST',
        'source_id' => null,
        'commentaire' => 'Test ajustement transactionnel',
        'utilisateur_id' => 1,
    ]);

    echo "Mouvement AJUSTEMENT insÃ©rÃ© (ID temporaire): {$mvtId}\n";

    $q_after = stock_get_quantite_produit($pdo, $pid);
    echo "QuantitÃ© aprÃ¨s insertion (transaction ouverte): {$q_after}\n";

    $pdo->rollBack();
    echo "Rollback effectuÃ©\n";

    $stmt2 = $pdo->prepare("SELECT COUNT(*) as c FROM stocks_mouvements WHERE source_type = 'TEST_AJUST' AND produit_id = ?");
    $stmt2->execute([$pid]);
    $cnt = $stmt2->fetch(PDO::FETCH_ASSOC)['c'];
    echo "Mouvements TEST_AJUST persistants (aprÃ¨s rollback): {$cnt}\n";

    $q_final = stock_get_quantite_produit($pdo, $pid);
    echo "QuantitÃ© finale (aprÃ¨s rollback): {$q_final}\n";

    if ($q_before === $q_final) {
        echo "TEST AJUSTEMENT OK: rollback a annulÃ© l'insertion et le recalcul.\n";
        exit(0);
    } else {
        echo "TEST AJUSTEMENT FAIL: quantitÃ© diffÃ©rente aprÃ¨s rollback.\n";
        exit(2);
    }

} catch (Throwable $e) {
    if ($pdo->inTransaction()) $pdo->rollBack();
    echo "Erreur pendant le test: " . $e->getMessage() . "\n";
    exit(3);
}



===== FICHIER : tests\stock_test_vente.php =====

<?php
require_once __DIR__ . '/../db/db.php';
require_once __DIR__ . '/../lib/stock.php';

echo "DÃ©but test synchroniseur vente (transactionnel, non-destructif)\n";

// Chercher une vente avec lignes
$stmt = $pdo->query("SELECT v.id FROM ventes v JOIN ventes_lignes l ON l.vente_id = v.id LIMIT 1");
$row = $stmt->fetch(PDO::FETCH_ASSOC);
if (!$row) {
    echo "Aucune vente avec lignes trouvÃ©e â€” test impossible\n";
    exit(1);
}
$vente_id = (int)$row['id'];

echo "Vente choisie: ID={$vente_id}\n";

try {
    // On ne crÃ©e PAS de transaction globale car le synchroniseur gÃ¨re ses propres transactions.
    $stmtP = $pdo->prepare("SELECT DISTINCT produit_id FROM ventes_lignes WHERE vente_id = ?");
    $stmtP->execute([$vente_id]);
    $pids = $stmtP->fetchAll(PDO::FETCH_COLUMN);

    $before = [];
    foreach ($pids as $pid) {
        $before[$pid] = stock_get_quantite_produit($pdo, (int)$pid);
    }

    echo "QuantitÃ©s avant:\n";
    foreach ($before as $pid => $q) echo " - produit {$pid}: {$q}\n";

    // Sauvegarder mouvements existants pour cette vente (entier)
    $stmtOld = $pdo->prepare("SELECT * FROM stocks_mouvements WHERE source_type = 'VENTE' AND source_id = ?");
    $stmtOld->execute([$vente_id]);
    $oldRows = $stmtOld->fetchAll(PDO::FETCH_ASSOC);

    // Appel du synchroniseur (il gÃ¨re sa propre transaction)
    $res = stock_synchroniser_vente($pdo, $vente_id);
    echo "Synchroniseur retournÃ©: "; var_export($res); echo "\n";

    // VÃ©rifier le nombre de mouvements crÃ©Ã©s maintenant
    $stmtNow = $pdo->prepare("SELECT DISTINCT produit_id FROM stocks_mouvements WHERE source_type = 'VENTE' AND source_id = ?");
    $stmtNow->execute([$vente_id]);
    $nowPids = $stmtNow->fetchAll(PDO::FETCH_COLUMN);

    echo "Produits affectÃ©s par synchroniseur: "; print_r($nowPids);

    // Nettoyage: supprimer tous les mouvements pour cette vente
    $del = $pdo->prepare("DELETE FROM stocks_mouvements WHERE source_type = 'VENTE' AND source_id = ?");
    $del->execute([$vente_id]);
    echo "Mouvements pour la vente supprimÃ©s (cleanup).\n";

    // Restaurer les anciennes lignes si elles existaient
    foreach ($oldRows as $r) {
        // Utiliser stock_enregistrer_mouvement pour remise en place (recalcule Ã©galement)
        stock_enregistrer_mouvement($pdo, [
            'produit_id' => $r['produit_id'],
            'date_mouvement' => $r['date_mouvement'],
            'type_mouvement' => $r['type_mouvement'],
            'quantite' => $r['quantite'],
            'source_type' => $r['source_type'],
            'source_id' => $r['source_id'],
            'commentaire' => $r['commentaire'],
            'utilisateur_id' => $r['utilisateur_id'],
        ]);
    }

    // Recalcul des produits affectÃ©s
    $final = [];
    foreach ($pids as $pid) {
        stock_recalculer_stock_produit($pdo, (int)$pid);
        $final[$pid] = stock_get_quantite_produit($pdo, (int)$pid);
    }

    echo "QuantitÃ©s finales (aprÃ¨s cleanup/restauration):\n";
    foreach ($final as $pid => $q) echo " - produit {$pid}: {$q}\n";

    $ok = true;
    foreach ($before as $pid => $q) {
        if ($final[$pid] != $q) { $ok = false; break; }
    }

    if ($ok) {
        echo "TEST VENTE OK: synchronisation testÃ©e et Ã©tat restaurÃ©.\n";
        exit(0);
    } else {
        echo "TEST VENTE FAIL: diffÃ©rences dÃ©tectÃ©es aprÃ¨s restauration.\n";
        exit(2);
    }

} catch (Throwable $e) {
    echo "Erreur: " . $e->getMessage() . "\n";
    exit(3);
}



===== FICHIER : utilisateurs\edit.php =====

<?php
// utilisateurs/edit.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('UTILISATEURS_GERER');

global $pdo;

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$modeEdition = $id > 0;

// RÃ©cupÃ©rer la liste des rÃ´les
$stmt = $pdo->query("SELECT id, code, nom FROM roles ORDER BY code");
$roles = $stmt->fetchAll();

// Initialisation des champs
$login        = '';
$nom_complet  = '';
$email        = '';
$telephone    = '';
$actif        = 1;
$rolesActuels = []; // IDs de rÃ´le

$erreurs = [];

// Charger utilisateur en Ã©dition
if ($modeEdition && $_SERVER['REQUEST_METHOD'] === 'GET') {
    $stmt = $pdo->prepare("
        SELECT id, login, nom_complet, email, telephone, actif
        FROM utilisateurs
        WHERE id = :id
    ");
    $stmt->execute(['id' => $id]);
    $user = $stmt->fetch();

    if (!$user) {
        http_response_code(404);
        echo "Utilisateur introuvable.";
        exit;
    }

    $login       = $user['login'];
    $nom_complet = $user['nom_complet'];
    $email       = $user['email'];
    $telephone   = $user['telephone'];
    $actif       = (int)$user['actif'];

    // RÃ´les existants
    $stmt = $pdo->prepare("
        SELECT role_id
        FROM utilisateur_role
        WHERE utilisateur_id = :id
    ");
    $stmt->execute(['id' => $id]);
    $rolesActuels = array_map('intval', array_column($stmt->fetchAll(), 'role_id'));
}

// Traitement formulaire
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $csrf = $_POST['csrf_token'] ?? '';
    verifierCsrf($csrf);

    $id            = (int)($_POST['id'] ?? 0);
    $modeEdition   = $id > 0;
    $login         = trim($_POST['login'] ?? '');
    $nom_complet   = trim($_POST['nom_complet'] ?? '');
    $email         = trim($_POST['email'] ?? '');
    $telephone     = trim($_POST['telephone'] ?? '');
    $actif         = isset($_POST['actif']) ? 1 : 0;
    $rolesSelectionnes = isset($_POST['roles']) && is_array($_POST['roles'])
        ? array_map('intval', $_POST['roles'])
        : [];

    $motDePasse        = $_POST['mot_de_passe'] ?? '';
    $motDePasseConfirm = $_POST['mot_de_passe_confirm'] ?? '';

    // Validations de base
    if ($login === '') {
        $erreurs[] = "Le login est obligatoire.";
    }
    if ($nom_complet === '') {
        $erreurs[] = "Le nom complet est obligatoire.";
    }

    if (!$modeEdition && $motDePasse === '') {
        $erreurs[] = "Le mot de passe est obligatoire pour un nouvel utilisateur.";
    }

    if ($motDePasse !== '' && $motDePasse !== $motDePasseConfirm) {
        $erreurs[] = "Les mots de passe ne correspondent pas.";
    }

    // VÃ©rifier unicitÃ© du login
    $sqlLogin = "
        SELECT id FROM utilisateurs
        WHERE login = :login
        " . ($modeEdition ? "AND id <> :id" : "") . "
        LIMIT 1
    ";
    $paramsLogin = ['login' => $login];
    if ($modeEdition) {
        $paramsLogin['id'] = $id;
    }
    $stmt = $pdo->prepare($sqlLogin);
    $stmt->execute($paramsLogin);
    if ($stmt->fetch()) {
        $erreurs[] = "Ce login est dÃ©jÃ  utilisÃ© par un autre utilisateur.";
    }

    if (empty($erreurs)) {
        if ($modeEdition) {
            // UPDATE utilisateur
            $sql = "
                UPDATE utilisateurs
                SET login = :login,
                    nom_complet = :nom_complet,
                    email = :email,
                    telephone = :telephone,
                    actif = :actif
                WHERE id = :id
            ";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([
                'login'       => $login,
                'nom_complet' => $nom_complet,
                'email'       => $email ?: null,
                'telephone'   => $telephone ?: null,
                'actif'       => $actif,
                'id'          => $id
            ]);

            // Mise Ã  jour mot de passe si fourni
            if ($motDePasse !== '') {
                $hash = password_hash($motDePasse, PASSWORD_DEFAULT);
                $stmt = $pdo->prepare("
                    UPDATE utilisateurs
                    SET mot_de_passe_hash = :hash
                    WHERE id = :id
                ");
                $stmt->execute([
                    'hash' => $hash,
                    'id'   => $id
                ]);
            }

        } else {
            // INSERT nouvel utilisateur
            $hash = password_hash($motDePasse, PASSWORD_DEFAULT);
            $sql = "
                INSERT INTO utilisateurs (login, mot_de_passe_hash, nom_complet, email, telephone, actif, date_creation)
                VALUES (:login, :hash, :nom_complet, :email, :telephone, :actif, NOW())
            ";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([
                'login'       => $login,
                'hash'        => $hash,
                'nom_complet' => $nom_complet,
                'email'       => $email ?: null,
                'telephone'   => $telephone ?: null,
                'actif'       => $actif
            ]);
            $id = (int)$pdo->lastInsertId();
            $modeEdition = true;
        }

        // Mise Ã  jour des rÃ´les
        // On supprime dâ€™abord les rÃ´les existants
        $stmtDel = $pdo->prepare("DELETE FROM utilisateur_role WHERE utilisateur_id = :id");
        $stmtDel->execute(['id' => $id]);

        // Puis on insÃ¨re ceux sÃ©lectionnÃ©s
        if (!empty($rolesSelectionnes)) {
            $stmtIns = $pdo->prepare("
                INSERT INTO utilisateur_role (utilisateur_id, role_id)
                VALUES (:uid, :rid)
            ");

            foreach ($rolesSelectionnes as $rid) {
                $stmtIns->execute([
                    'uid' => $id,
                    'rid' => $rid
                ]);
            }
        }

        $_SESSION['flash_success'] = $modeEdition
            ? "Lâ€™utilisateur a Ã©tÃ© mis Ã  jour avec succÃ¨s."
            : "Lâ€™utilisateur a Ã©tÃ© crÃ©Ã© avec succÃ¨s.";

        header('Location: /utilisateurs/list.php');
        exit;
    } else {
        // En cas dâ€™erreur, on conserve les rÃ´les sÃ©lectionnÃ©s pour rÃ©afficher le formulaire
        $rolesActuels = $rolesSelectionnes;
    }
}

$csrfToken = getCsrfToken();

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $modeEdition ? 'Modifier un utilisateur' : 'Nouvel utilisateur' ?>
        </h1>
        <a href="/utilisateurs/list.php" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
        </a>
    </div>

    <?php if (!empty($erreurs)): ?>
        <div class="alert alert-danger">
            <h2 class="h6 mb-2"><i class="bi bi-exclamation-triangle me-1"></i> Erreurs</h2>
            <ul class="mb-0">
                <?php foreach ($erreurs as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <form method="post" class="card">
        <div class="card-body">
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken) ?>">
            <input type="hidden" name="id" value="<?= (int)$id ?>">

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small">Login *</label>
                    <input type="text" name="login" class="form-control" required
                           value="<?= htmlspecialchars($login) ?>">
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Nom complet *</label>
                    <input type="text" name="nom_complet" class="form-control" required
                           value="<?= htmlspecialchars($nom_complet) ?>">
                </div>

                <div class="col-md-4 d-flex align-items-center">
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" name="actif" id="actif"
                               <?= $actif ? 'checked' : '' ?>>
                        <label class="form-check-label small" for="actif">
                            Utilisateur actif
                        </label>
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Email</label>
                    <input type="email" name="email" class="form-control"
                           value="<?= htmlspecialchars($email) ?>">
                </div>

                <div class="col-md-4">
                    <label class="form-label small">TÃ©lÃ©phone</label>
                    <input type="text" name="telephone" class="form-control"
                           value="<?= htmlspecialchars($telephone) ?>">
                </div>

                <div class="col-md-4">
                    <label class="form-label small">
                        Mot de passe <?= $modeEdition ? '(laisser vide pour ne pas modifier)' : '*' ?>
                    </label>
                    <input type="password" name="mot_de_passe" class="form-control"
                           autocomplete="new-password">
                </div>

                <div class="col-md-4">
                    <label class="form-label small">Confirmation mot de passe</label>
                    <input type="password" name="mot_de_passe_confirm" class="form-control"
                           autocomplete="new-password">
                </div>

                <div class="col-md-8">
                    <label class="form-label small">RÃ´les</label>
                    <div class="row g-2">
                        <?php foreach ($roles as $role): ?>
                            <?php $checked = in_array((int)$role['id'], $rolesActuels, true); ?>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        name="roles[]"
                                        id="role_<?= (int)$role['id'] ?>"
                                        value="<?= (int)$role['id'] ?>"
                                        <?= $checked ? 'checked' : '' ?>
                                    >
                                    <label class="form-check-label small" for="role_<?= (int)$role['id'] ?>">
                                        <strong><?= htmlspecialchars($role['code']) ?></strong><br>
                                        <span class="text-muted">
                                            <?= htmlspecialchars($role['nom']) ?>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        <?php endforeach; ?>
                    </div>
                </div>

            </div>
        </div>

        <div class="card-footer d-flex justify-content-end gap-2">
            <a href="/utilisateurs/list.php" class="btn btn-outline-secondary">
                Annuler
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>
                <?= $modeEdition ? 'Enregistrer les modifications' : 'CrÃ©er lâ€™utilisateur' ?>
            </button>
        </div>
    </form>
</div>

<?php
include __DIR__ . '/../partials/footer.php';



===== FICHIER : utilisateurs\list.php =====

<?php
// utilisateurs/list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('UTILISATEURS_GERER');

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';

global $pdo;

// Flash message
$flashSuccess = $_SESSION['flash_success'] ?? null;
unset($_SESSION['flash_success']);

// RÃ©cupÃ©ration des utilisateurs + rÃ´les
$sql = "
    SELECT 
        u.id,
        u.login,
        u.nom_complet,
        u.email,
        u.telephone,
        u.actif,
        u.date_creation,
        GROUP_CONCAT(r.nom ORDER BY r.code SEPARATOR ', ') AS roles
    FROM utilisateurs u
    LEFT JOIN utilisateur_role ur ON ur.utilisateur_id = u.id
    LEFT JOIN roles r ON r.id = ur.role_id
    GROUP BY u.id
    ORDER BY u.date_creation DESC, u.login ASC
";
$stmt = $pdo->query($sql);
$utilisateurs = $stmt->fetchAll();
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Utilisateurs internes</h1>
        <a href="edit.php" class="btn btn-primary">
            <i class="bi bi-person-plus me-1"></i> Nouvel utilisateur
        </a>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <div class="card">
        <div class="card-body">
            <?php if (empty($utilisateurs)): ?>
                <p class="text-muted mb-0">Aucun utilisateur pour le moment.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Login</th>
                            <th>Nom complet</th>
                            <th>Email</th>
                            <th>TÃ©lÃ©phone</th>
                            <th>RÃ´les</th>
                            <th class="text-center">Actif</th>
                            <th>Date crÃ©ation</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($utilisateurs as $u): ?>
                            <tr>
                                <td><?= htmlspecialchars($u['login']) ?></td>
                                <td><?= htmlspecialchars($u['nom_complet']) ?></td>
                                <td><?= htmlspecialchars($u['email'] ?? '') ?></td>
                                <td><?= htmlspecialchars($u['telephone'] ?? '') ?></td>
                                <td><?= htmlspecialchars($u['roles'] ?? 'â€”') ?></td>
                                <td class="text-center">
                                    <?php if ((int)$u['actif'] === 1): ?>
                                        <span class="badge bg-success-subtle text-success">
                                            <i class="bi bi-check-circle me-1"></i> Actif
                                        </span>
                                    <?php else: ?>
                                        <span class="badge bg-secondary-subtle text-secondary">
                                            <i class="bi bi-slash-circle me-1"></i> Inactif
                                        </span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <?= htmlspecialchars($u['date_creation']) ?>
                                </td>
                                <td class="text-end">
                                    <a href="edit.php?id=<?= (int)$u['id'] ?>" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil-square me-1"></i> Modifier
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<?php
include __DIR__ . '/../partials/footer.php';



===== FICHIER : ventes\detail.php =====

<?php
// ventes/detail.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('VENTES_LIRE');

global $pdo;

// Base URL pour le module ventes (prend en compte le sous-dossier du projet)
$ventesBasePath       = rtrim(dirname($_SERVER['SCRIPT_NAME']), '/\\'); // ex: /kms_app/ventes
$ventesListUrl        = $ventesBasePath . '/list.php';
$ventesEditUrl        = $ventesBasePath . '/edit.php';
$ventesGenererBlUrl   = $ventesBasePath . '/generer_bl.php';

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
if ($id <= 0) {
    $_SESSION['flash_error'] = "Vente inconnue.";
    header('Location: ' . $ventesListUrl);
    exit;
}

// RÃ©cupÃ©ration de la vente
$stmt = $pdo->prepare("
    SELECT
        v.*,
        c.nom AS client_nom,
        cv.code AS canal_code,
        cv.libelle AS canal_libelle,
        u.nom_complet AS commercial_nom
    FROM ventes v
    JOIN clients c ON c.id = v.client_id
    JOIN canaux_vente cv ON cv.id = v.canal_vente_id
    JOIN utilisateurs u ON u.id = v.utilisateur_id
    WHERE v.id = :id
");
$stmt->execute(['id' => $id]);
$vente = $stmt->fetch();

if (!$vente) {
    $_SESSION['flash_error'] = "Vente introuvable.";
    header('Location: ' . $ventesListUrl);
    exit;
}

// Lignes de vente
$stmt = $pdo->prepare("
    SELECT vl.*, p.code_produit, p.designation
    FROM ventes_lignes vl
    JOIN produits p ON p.id = vl.produit_id
    WHERE vl.vente_id = :id
    ORDER BY vl.id
");
$stmt->execute(['id' => $id]);
$lignes = $stmt->fetchAll();

// BL dÃ©jÃ  gÃ©nÃ©rÃ©s pour cette vente
$stmt = $pdo->prepare("
    SELECT b.*
    FROM bons_livraison b
    WHERE b.vente_id = :id
    ORDER BY b.date_bl DESC, b.id DESC
");
$stmt->execute(['id' => $id]);
$bonsLivraison = $stmt->fetchAll();

$peutModifierVente = in_array('VENTES_CREER', $_SESSION['permissions'] ?? [], true);
$peutCreerBL       = $peutModifierVente;

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h4 mb-0">DÃ©tail de la vente <?= htmlspecialchars($vente['numero']) ?></h1>
            <div class="text-muted small">
                Client : <strong><?= htmlspecialchars($vente['client_nom']) ?></strong> â€¢
                Canal : <?= htmlspecialchars($vente['canal_code']) ?> â€“ <?= htmlspecialchars($vente['canal_libelle']) ?> â€¢
                Commercial : <?= htmlspecialchars($vente['commercial_nom']) ?>
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="<?= htmlspecialchars($ventesListUrl) ?>" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
            </a>
            <?php if ($peutModifierVente): ?>
                <a href="<?= htmlspecialchars($ventesEditUrl . '?id=' . (int)$vente['id']) ?>"
                   class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-pencil-square me-1"></i> Modifier
                </a>
            <?php endif; ?>
            <?php if ($peutCreerBL && in_array($vente['statut'], ['EN_ATTENTE_LIVRAISON','PARTIELLEMENT_LIVREE'], true)): ?>
                <form method="post" action="<?= htmlspecialchars($ventesGenererBlUrl) ?>">
                    <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">
                    <input type="hidden" name="vente_id" value="<?= (int)$vente['id'] ?>">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-truck me-1"></i> GÃ©nÃ©rer un bon de livraison
                    </button>
                </form>
            <?php endif; ?>
        </div>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Infos vente -->
    <div class="card mb-3">
        <div class="card-body row">
            <div class="col-md-3">
                <div class="text-muted small">Date de vente</div>
                <div class="fw-semibold"><?= htmlspecialchars($vente['date_vente']) ?></div>
            </div>
            <div class="col-md-3">
                <div class="text-muted small">Statut</div>
                <?php
                $badgeClass = 'bg-secondary-subtle text-secondary';
                if ($vente['statut'] === 'EN_ATTENTE_LIVRAISON') $badgeClass = 'bg-warning-subtle text-warning';
                elseif ($vente['statut'] === 'PARTIELLEMENT_LIVREE') $badgeClass = 'bg-info-subtle text-info';
                elseif ($vente['statut'] === 'LIVREE') $badgeClass = 'bg-success-subtle text-success';
                elseif ($vente['statut'] === 'ANNULEE') $badgeClass = 'bg-dark-subtle text-dark';
                ?>
                <span class="badge <?= $badgeClass ?>"><?= htmlspecialchars($vente['statut']) ?></span>
            </div>
            <div class="col-md-3 text-end">
                <div class="text-muted small">Montant HT</div>
                <div class="fw-semibold">
                    <?= number_format((float)$vente['montant_total_ht'], 0, ',', ' ') ?> FCFA
                </div>
            </div>
            <div class="col-md-3 text-end">
                <div class="text-muted small">Montant TTC</div>
                <div class="fw-semibold">
                    <?= number_format((float)$vente['montant_total_ttc'], 0, ',', ' ') ?> FCFA
                </div>
            </div>
            <?php if (!empty($vente['commentaires'])): ?>
                <div class="col-12 mt-2">
                    <div class="text-muted small">Commentaires</div>
                    <div><?= nl2br(htmlspecialchars($vente['commentaires'])) ?></div>
                </div>
            <?php endif; ?>
        </div>
    </div>

    <!-- Lignes de vente -->
    <div class="card mb-3">
        <div class="card-body">
            <h2 class="h6 mb-3">Lignes de vente</h2>
            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>Produit</th>
                        <th class="text-center">QtÃ©</th>
                        <th class="text-end">PU HT</th>
                        <th class="text-end">Remise</th>
                        <th class="text-end">Montant ligne HT</th>
                    </tr>
                    </thead>
                    <tbody>
                    <?php foreach ($lignes as $lg): ?>
                        <tr>
                            <td>
                                <span class="fw-semibold"><?= htmlspecialchars($lg['code_produit']) ?></span><br>
                                <span class="text-muted small"><?= htmlspecialchars($lg['designation']) ?></span>
                            </td>
                            <td class="text-center"><?= (int)$lg['quantite'] ?></td>
                            <td class="text-end">
                                <?= number_format((float)$lg['prix_unitaire'], 0, ',', ' ') ?> FCFA
                            </td>
                            <td class="text-end">
                                <?= number_format((float)$lg['remise'], 0, ',', ' ') ?> FCFA
                            </td>
                            <td class="text-end">
                                <?= number_format((float)$lg['montant_ligne_ht'], 0, ',', ' ') ?> FCFA
                            </td>
                        </tr>
                    <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bons de livraison associÃ©s -->
    <div class="card">
        <div class="card-body">
            <h2 class="h6 mb-3">Bons de livraison liÃ©s</h2>
            <?php if (empty($bonsLivraison)): ?>
                <p class="text-muted mb-0">Aucun bon de livraison gÃ©nÃ©rÃ© pour cette vente.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>NÂ° BL</th>
                            <th>Date</th>
                            <th>Transport</th>
                            <th>SignÃ© client</th>
                            <th>Magasinier</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($bonsLivraison as $bl): ?>
                            <tr>
                                <td><?= htmlspecialchars($bl['numero']) ?></td>
                                <td><?= htmlspecialchars($bl['date_bl']) ?></td>
                                <td><?= htmlspecialchars($bl['transport_assure_par'] ?? '') ?></td>
                                <td>
                                    <?php if ((int)$bl['signe_client'] === 1): ?>
                                        <span class="badge bg-success-subtle text-success">
                                            <i class="bi bi-check2-circle me-1"></i> SignÃ©
                                        </span>
                                    <?php else: ?>
                                        <span class="badge bg-warning-subtle text-warning">
                                            Non signÃ©
                                        </span>
                                    <?php endif; ?>
                                </td>
                                <td><?= (int)$bl['magasinier_id'] ?></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : ventes\edit.php =====

<?php
// ventes/edit.php
require_once __DIR__ . '/../security.php';
require_once __DIR__ . '/../lib/stock.php';
require_once __DIR__ . '/../lib/caisse.php';

exigerConnexion();
exigerPermission('VENTES_CREER');

global $pdo;

$TAUX_TVA = 0.1925; // Ajuste si besoin

$id     = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$isEdit = $id > 0;

// Clients
$stmt = $pdo->query("SELECT id, nom FROM clients ORDER BY nom");
$clients = $stmt->fetchAll();

// Canaux de vente
$stmt = $pdo->query("SELECT id, code, libelle FROM canaux_vente ORDER BY code");
$canaux = $stmt->fetchAll();

// Produits
$stmt = $pdo->query("
    SELECT id, code_produit, designation, prix_vente
    FROM produits
    WHERE actif = 1
    ORDER BY code_produit
");
$produits = $stmt->fetchAll();
$produitsById = [];
foreach ($produits as $p) {
    $produitsById[(int)$p['id']] = $p;
}

// Valeurs par dÃ©faut
$data = [
    'date_vente'        => date('Y-m-d'),
    'client_id'         => '',
    'canal_vente_id'    => '',
    'statut'            => 'EN_ATTENTE_LIVRAISON',
    'commentaires'      => '',
];

$lignes = []; // lignes de vente

if ($isEdit) {
    // Charger la vente
    $stmt = $pdo->prepare("SELECT * FROM ventes WHERE id = :id");
    $stmt->execute(['id' => $id]);
    $vente = $stmt->fetch();

    if (!$vente) {
        $_SESSION['flash_error'] = "Vente introuvable.";
        header('Location: ' . url_for('ventes/list.php'));
        exit;
    }

    $data = [
        'date_vente'      => $vente['date_vente'],
        'client_id'       => $vente['client_id'],
        'canal_vente_id'  => $vente['canal_vente_id'],
        'statut'          => $vente['statut'],
        'commentaires'    => $vente['commentaires'] ?? '',
    ];

    // Charger les lignes
    $stmt = $pdo->prepare("
        SELECT vl.*, p.code_produit, p.designation
        FROM ventes_lignes vl
        JOIN produits p ON p.id = vl.produit_id
        WHERE vl.vente_id = :id
        ORDER BY vl.id
    ");
    $stmt->execute(['id' => $id]);
    $lignes = $stmt->fetchAll();
} else {
    // Par dÃ©faut, on prÃ©pare 3 lignes vides pour initialiser le formulaire
    $lignes = [
        ['produit_id' => '', 'quantite' => '', 'prix_unitaire' => '', 'remise' => ''],
        ['produit_id' => '', 'quantite' => '', 'prix_unitaire' => '', 'remise' => ''],
        ['produit_id' => '', 'quantite' => '', 'prix_unitaire' => '', 'remise' => ''],
    ];
}

$errors = [];

// Traitement POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifierCsrf($_POST['csrf_token'] ?? '');

        $data['date_vente']     = trim($_POST['date_vente'] ?? '');
        $data['client_id']      = (int)($_POST['client_id'] ?? 0);
        $data['canal_vente_id'] = (int)($_POST['canal_vente_id'] ?? 0);
        $data['statut']         = $_POST['statut'] ?? 'EN_ATTENTE_LIVRAISON';
        $data['commentaires']   = trim($_POST['commentaires'] ?? '');

        $produitIds = $_POST['produit_id'] ?? [];
        $qtes       = $_POST['quantite'] ?? [];
        $prixUnit   = $_POST['prix_unitaire'] ?? [];
        $remises    = $_POST['remise'] ?? [];

        // Reconstruction des lignes
        $lignes = [];
        $totalHT = 0.0;

        foreach ($produitIds as $idx => $prodIdRaw) {
            $prodId = (int)$prodIdRaw;
            $q      = (float)str_replace(',', '.', $qtes[$idx] ?? '0');
            $pu     = (float)str_replace(',', '.', $prixUnit[$idx] ?? '0');
            $rem    = (float)str_replace(',', '.', $remises[$idx] ?? '0');

            if ($prodId <= 0 || $q <= 0 || $pu <= 0) {
                continue; // on ignore les lignes incomplÃ¨tes
            }

            $montantBrut = $pu * $q;
            $montantLigneHT = max(0, $montantBrut - $rem);

            $lignes[] = [
                'produit_id'    => $prodId,
                'quantite'      => $q,
                'prix_unitaire' => $pu,
                'remise'        => $rem,
                'montant_ligne_ht' => $montantLigneHT,
            ];

            $totalHT += $montantLigneHT;
        }

        // Validations
        if ($data['date_vente'] === '') {
            $errors[] = "La date de vente est obligatoire.";
        }
        if ($data['client_id'] <= 0) {
            $errors[] = "Le client est obligatoire.";
        }
        if ($data['canal_vente_id'] <= 0) {
            $errors[] = "Le canal de vente est obligatoire.";
        }
        if (!in_array($data['statut'], ['EN_ATTENTE_LIVRAISON','PARTIELLEMENT_LIVREE','LIVREE','ANNULEE'], true)) {
            $errors[] = "Statut de vente invalide.";
        }
        if (empty($lignes)) {
            $errors[] = "La vente doit contenir au moins une ligne produit valide.";
        }

        $totalTTC = $totalHT * (1 + $TAUX_TVA);

        if (empty($errors)) {
            try {
                $utilisateur = utilisateurConnecte();
                $utilisateurId = $utilisateur['id'] ?? null;

                if ($isEdit) {
                    // UPDATE vente
                    $stmt = $pdo->prepare("
                        UPDATE ventes
                        SET date_vente = :date_vente,
                            client_id = :client_id,
                            canal_vente_id = :canal_vente_id,
                            statut = :statut,
                            montant_total_ht = :mtht,
                            montant_total_ttc = :mttc,
                            commentaires = :commentaires
                        WHERE id = :id
                    ");
                    $stmt->execute([
                        'date_vente'     => $data['date_vente'],
                        'client_id'      => $data['client_id'],
                        'canal_vente_id' => $data['canal_vente_id'],
                        'statut'         => $data['statut'],
                        'mtht'           => $totalHT,
                        'mttc'           => $totalTTC,
                        'commentaires'   => $data['commentaires'] !== '' ? $data['commentaires'] : null,
                        'id'             => $id,
                    ]);

                    // Effacer les lignes existantes
                    $stmt = $pdo->prepare("DELETE FROM ventes_lignes WHERE vente_id = :id");
                    $stmt->execute(['id' => $id]);

                    // RÃ©insÃ©rer les lignes
                    $stmtL = $pdo->prepare("
                        INSERT INTO ventes_lignes
                        (vente_id, produit_id, quantite, prix_unitaire, remise, montant_ligne_ht)
                        VALUES
                        (:vente_id, :produit_id, :quantite, :prix_unitaire, :remise, :montant_ligne_ht)
                    ");
                    foreach ($lignes as $lg) {
                        $stmtL->execute([
                            'vente_id'        => $id,
                            'produit_id'      => $lg['produit_id'],
                            'quantite'        => $lg['quantite'],
                            'prix_unitaire'   => $lg['prix_unitaire'],
                            'remise'          => $lg['remise'],
                            'montant_ligne_ht'=> $lg['montant_ligne_ht'],
                        ]);
                    }

                    // ðŸ”— Synchronisation stock (sorties liÃ©es Ã  cette vente)
                    stock_synchroniser_vente($pdo, $id);

                    // Enregistrer Ã©criture en caisse (entrÃ©e de trÃ©sorerie pour vente)
                    try {
                        caisse_enregistrer_ecriture(
                            $pdo,
                            'ENTREE',
                            (float)$totalTTC,
                            'VENTE',
                            $id,
                            'Vente ' . ($data['numero'] ?? ''),
                            $utilisateurId ?? null
                        );
                    } catch (Throwable $e) {
                        // Ne pas empÃªcher l'enregistrement de la vente si l'Ã©criture caisse Ã©choue.
                    }

                    $_SESSION['flash_success'] = "Vente mise Ã  jour avec succÃ¨s.";

                } else {
                    // GÃ©nÃ©ration numÃ©ro de vente
                    $numero = 'V-' . date('Ymd-His');

                    // INSERT vente
                    $stmt = $pdo->prepare("
                        INSERT INTO ventes
                        (numero, date_vente, client_id, canal_vente_id, devis_id,
                         statut, montant_total_ht, montant_total_ttc, utilisateur_id, commentaires)
                        VALUES
                        (:numero, :date_vente, :client_id, :canal_vente_id, :devis_id,
                         :statut, :mtht, :mttc, :utilisateur_id, :commentaires)
                    ");
                    $stmt->execute([
                        'numero'         => $numero,
                        'date_vente'     => $data['date_vente'],
                        'client_id'      => $data['client_id'],
                        'canal_vente_id' => $data['canal_vente_id'],
                        'devis_id'       => null, // vente directe sans devis
                        'statut'         => $data['statut'],
                        'mtht'           => $totalHT,
                        'mttc'           => $totalTTC,
                        'utilisateur_id' => $utilisateurId,
                        'commentaires'   => $data['commentaires'] !== '' ? $data['commentaires'] : null,
                    ]);

                    $venteId = (int)$pdo->lastInsertId();

                    // INSERT lignes
                    $stmtL = $pdo->prepare("
                        INSERT INTO ventes_lignes
                        (vente_id, produit_id, quantite, prix_unitaire, remise, montant_ligne_ht)
                        VALUES
                        (:vente_id, :produit_id, :quantite, :prix_unitaire, :remise, :montant_ligne_ht)
                    ");
                    foreach ($lignes as $lg) {
                        $stmtL->execute([
                            'vente_id'        => $venteId,
                            'produit_id'      => $lg['produit_id'],
                            'quantite'        => $lg['quantite'],
                            'prix_unitaire'   => $lg['prix_unitaire'],
                            'remise'          => $lg['remise'],
                            'montant_ligne_ht'=> $lg['montant_ligne_ht'],
                        ]);
                    }

                    // ðŸ”— Synchronisation stock (sorties liÃ©es Ã  cette vente)
                    stock_synchroniser_vente($pdo, $venteId);

                    // Enregistrer Ã©criture en caisse (entrÃ©e de trÃ©sorerie pour vente)
                    try {
                        caisse_enregistrer_ecriture(
                            $pdo,
                            'ENTREE',
                            (float)$totalTTC,
                            'VENTE',
                            $venteId,
                            'Vente ' . ($numero ?? ''),
                            $utilisateurId ?? null
                        );
                    } catch (Throwable $e) {
                        // Ne pas empÃªcher l'enregistrement de la vente si l'Ã©criture caisse Ã©choue.
                    }

                    $_SESSION['flash_success'] = "Vente crÃ©Ã©e avec succÃ¨s.";
                }

                $pdo->commit();
                header('Location: ' . url_for('ventes/list.php'));
                exit;
            } catch (Throwable $e) {
                if ($pdo->inTransaction()) $pdo->rollBack();
                $errors[] = "Erreur lors de l'enregistrement de la vente : " . $e->getMessage();
            }
        }
}

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">
            <?= $isEdit ? 'Modifier une vente' : 'Nouvelle vente directe' ?>
        </h1>
        <a href="<?= url_for('ventes/list.php') ?>" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Retour Ã  la liste
        </a>
    </div>

    <?php if (!empty($errors)): ?>
        <div class="alert alert-danger py-2">
            <ul class="mb-0">
                <?php foreach ($errors as $err): ?>
                    <li><?= htmlspecialchars($err) ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
    <?php endif; ?>

    <div class="card mb-3">
        <div class="card-body">
            <form method="post">
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars(getCsrfToken()) ?>">

                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small">Date de vente</label>
                        <input type="date" name="date_vente" class="form-control"
                               value="<?= htmlspecialchars($data['date_vente']) ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">Client</label>
                        <select name="client_id" class="form-select" required>
                            <option value="">-- SÃ©lectionner --</option>
                            <?php foreach ($clients as $c): ?>
                                <option value="<?= (int)$c['id'] ?>"
                                    <?= (int)$data['client_id'] === (int)$c['id'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($c['nom']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Canal de vente</label>
                        <select name="canal_vente_id" class="form-select" required>
                            <option value="">-- SÃ©lectionner --</option>
                            <?php foreach ($canaux as $cv): ?>
                                <option value="<?= (int)$cv['id'] ?>"
                                    <?= (int)$data['canal_vente_id'] === (int)$cv['id'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($cv['code']) ?> â€“ <?= htmlspecialchars($cv['libelle']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Statut</label>
                        <select name="statut" class="form-select" required>
                            <?php foreach (['EN_ATTENTE_LIVRAISON','PARTIELLEMENT_LIVREE','LIVREE','ANNULEE'] as $s): ?>
                                <option value="<?= $s ?>" <?= $data['statut'] === $s ? 'selected' : '' ?>>
                                    <?= $s ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="form-label small">Commentaires (facultatif)</label>
                        <textarea name="commentaires" class="form-control" rows="2"
                                  placeholder="Infos complÃ©mentaires sur la vente, conditions spÃ©cifiques..."><?= htmlspecialchars($data['commentaires']) ?></textarea>
                    </div>
                </div>

                <hr class="my-4">

                <h5 class="h6 mb-3">Lignes de vente</h5>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th style="width:40%">Produit</th>
                            <th style="width:10%">QtÃ©</th>
                            <th style="width:20%">Prix unitaire</th>
                            <th style="width:15%">Remise (ligne)</th>
                            <th style="width:15%">Montant HT (indicatif)</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php
                        // On affiche au moins 3 lignes, ou les lignes existantes + 1
                        $nbLignesAffichees = max(count($lignes), 3);
                        for ($i = 0; $i < $nbLignesAffichees; $i++):
                            $lg = $lignes[$i] ?? [
                                'produit_id' => '',
                                'quantite'   => '',
                                'prix_unitaire' => '',
                                'remise'     => '',
                                'montant_ligne_ht' => '',
                            ];
                            $prodId = (int)($lg['produit_id'] ?? 0);
                            $montantIndicatif = $lg['montant_ligne_ht'] ?? '';
                        ?>
                            <tr>
                                <td>
                                    <select name="produit_id[]" class="form-select">
                                        <option value="">-- SÃ©lectionner --</option>
                                        <?php foreach ($produits as $p): ?>
                                            <option value="<?= (int)$p['id'] ?>"
                                                <?= $prodId === (int)$p['id'] ? 'selected' : '' ?>>
                                                <?= htmlspecialchars($p['code_produit']) ?> â€“ <?= htmlspecialchars($p['designation']) ?>
                                                (<?= number_format((float)$p['prix_vente'], 0, ',', ' ') ?> FCFA)
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </td>
                                <td>
                                    <input type="number" step="0.01" name="quantite[]" class="form-control"
                                           value="<?= htmlspecialchars((string)$lg['quantite']) ?>">
                                </td>
                                <td>
                                    <input type="number" step="0.01" name="prix_unitaire[]" class="form-control"
                                           value="<?= htmlspecialchars((string)$lg['prix_unitaire']) ?>">
                                </td>
                                <td>
                                    <input type="number" step="0.01" name="remise[]" class="form-control"
                                           value="<?= htmlspecialchars((string)$lg['remise']) ?>">
                                </td>
                                <td>
                                    <?php if ($montantIndicatif !== ''): ?>
                                        <?= number_format((float)$montantIndicatif, 0, ',', ' ') ?> FCFA
                                    <?php else: ?>
                                        <span class="text-muted small">CalculÃ© Ã  lâ€™enregistrement</span>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endfor; ?>
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i>
                        <?= $isEdit ? 'Mettre Ã  jour la vente' : 'Enregistrer la vente' ?>
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



===== FICHIER : ventes\generer_bl.php =====

<?php
// ventes/generer_bl.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('VENTES_CREER');

global $pdo;

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: ' . url_for('ventes/list.php'));
    exit;
}

try {
    verifierCsrf($_POST['csrf_token'] ?? '');

    $venteId = isset($_POST['vente_id']) ? (int)$_POST['vente_id'] : 0;
    if ($venteId <= 0) {
        throw new RuntimeException("Vente invalide.");
    }

    // RÃ©cup vente
    $stmt = $pdo->prepare("
        SELECT v.*, c.id AS client_id, c.nom AS client_nom
        FROM ventes v
        JOIN clients c ON c.id = v.client_id
        WHERE v.id = :id
    ");
    $stmt->execute(['id' => $venteId]);
    $vente = $stmt->fetch();

    if (!$vente) {
        throw new RuntimeException("Vente introuvable.");
    }
    if ($vente['statut'] === 'ANNULEE') {
        throw new RuntimeException("Impossible de gÃ©nÃ©rer un BL pour une vente annulÃ©e.");
    }

    // RÃ©cup lignes de vente
    $stmt = $pdo->prepare("
        SELECT vl.*, p.stock_actuel, p.designation
        FROM ventes_lignes vl
        JOIN produits p ON p.id = vl.produit_id
        WHERE vl.vente_id = :id
    ");
    $stmt->execute(['id' => $venteId]);
    $lignesVente = $stmt->fetchAll();

    if (empty($lignesVente)) {
        throw new RuntimeException("Aucune ligne de vente pour cette vente.");
    }

    // QuantitÃ©s dÃ©jÃ  livrÃ©es par produit
    $stmt = $pdo->prepare("
        SELECT bl.vente_id, bll.produit_id, SUM(bll.quantite) AS qte_livree
        FROM bons_livraison_lignes bll
        JOIN bons_livraison bl ON bl.id = bll.bon_livraison_id
        WHERE bl.vente_id = :vente_id
        GROUP BY bl.vente_id, bll.produit_id
    ");
    $stmt->execute(['vente_id' => $venteId]);
    $livraisonsExistantes = $stmt->fetchAll();

    $qteLivreeParProduit = [];
    foreach ($livraisonsExistantes as $row) {
        $qteLivreeParProduit[(int)$row['produit_id']] = (float)$row['qte_livree'];
    }

    // Calcul des quantitÃ©s restantes + vÃ©rifier s'il reste quelque chose Ã  livrer
    $lignesALivrer = [];
    foreach ($lignesVente as $lv) {
        $prodId = (int)$lv['produit_id'];
        $qteCommandee = (float)$lv['quantite'];
        $qteLivree = $qteLivreeParProduit[$prodId] ?? 0.0;
        $qteRestante = max(0, $qteCommandee - $qteLivree);

        if ($qteRestante > 0) {
            $lignesALivrer[] = [
                'produit_id' => $prodId,
                'quantite'   => $qteRestante,
            ];
        }
    }

    if (empty($lignesALivrer)) {
        throw new RuntimeException("Toute la vente est dÃ©jÃ  livrÃ©e. Aucun BL Ã  gÃ©nÃ©rer.");
    }

    // CrÃ©ation du BL + mouvements de stock en transaction
    $pdo->beginTransaction();

    $numeroBL = 'BL-' . date('Ymd-His');

    $utilisateur = utilisateurConnecte();
    $magasinierId = $utilisateur['id'] ?? null;

    // Insert BL
    $stmt = $pdo->prepare("
        INSERT INTO bons_livraison
        (numero, date_bl, vente_id, client_id, transport_assure_par, observations, signe_client, magasinier_id)
        VALUES
        (:numero, :date_bl, :vente_id, :client_id, :transport, :obs, 0, :magasinier_id)
    ");
    $stmt->execute([
        'numero'        => $numeroBL,
        'date_bl'       => date('Y-m-d'),
        'vente_id'      => $venteId,
        'client_id'     => $vente['client_id'],
        'transport'     => null,
        'obs'           => null,
        'magasinier_id' => $magasinierId,
    ]);
    $blId = (int)$pdo->lastInsertId();

    // Insert lignes BL + mouvements stock
    $stmtBL = $pdo->prepare("
        INSERT INTO bons_livraison_lignes (bon_livraison_id, produit_id, quantite)
        VALUES (:bl_id, :produit_id, :quantite)
    ");

    // On utilisera la librairie de stock pour enregistrer les mouvements
    // (stock_enregistrer_mouvement) afin que le recalcul et la logique
    // mÃ©tier soient centralisÃ©s dans `lib/stock.php`.

    foreach ($lignesALivrer as $lg) {
        $prodId = $lg['produit_id'];
        $qte    = $lg['quantite'];

        // Ligne BL
        $stmtBL->execute([
            'bl_id'      => $blId,
            'produit_id' => $prodId,
            'quantite'   => $qte,
        ]);

        // Enregistrer le mouvement via l'API centralisÃ©e
        stock_enregistrer_mouvement($pdo, [
            'produit_id'     => $prodId,
            'date_mouvement' => date('Y-m-d H:i:s'),
            'type_mouvement' => 'SORTIE',
            'quantite'       => $qte,
            'source_type'    => 'VENTE',
            'source_id'      => $venteId,
            'commentaire'    => 'Sortie via BL ' . $numeroBL,
            'utilisateur_id' => $magasinierId,
        ]);
    }

    // Recalcul du statut de la vente aprÃ¨s cette livraison
    $stmt = $pdo->prepare("
        SELECT vl.produit_id, vl.quantite,
               COALESCE(SUM(bll.quantite), 0) AS qte_livree
        FROM ventes_lignes vl
        LEFT JOIN bons_livraison b ON b.vente_id = vl.vente_id
        LEFT JOIN bons_livraison_lignes bll ON bll.bon_livraison_id = b.id
            AND bll.produit_id = vl.produit_id
        WHERE vl.vente_id = :vente_id
        GROUP BY vl.produit_id, vl.quantite
    ");
    $stmt->execute(['vente_id' => $venteId]);
    $rows = $stmt->fetchAll();

    $toutLivre = true;
    foreach ($rows as $r) {
        if ((float)$r['qte_livree'] < (float)$r['quantite']) {
            $toutLivre = false;
            break;
        }
    }

    $nouveauStatut = $toutLivre ? 'LIVREE' : 'PARTIELLEMENT_LIVREE';

    $stmt = $pdo->prepare("
        UPDATE ventes
        SET statut = :statut
        WHERE id = :id
    ");
    $stmt->execute([
        'statut' => $nouveauStatut,
        'id'     => $venteId,
    ]);

    $pdo->commit();

    $_SESSION['flash_success'] = "Bon de livraison $numeroBL gÃ©nÃ©rÃ© avec succÃ¨s.";
} catch (Throwable $e) {
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }
    $_SESSION['flash_error'] = $e->getMessage();
}

header('Location: ' . url_for('ventes/detail.php') . '?id=' . $venteId);
exit;



===== FICHIER : ventes\list.php =====

<?php
// ventes/list.php
require_once __DIR__ . '/../security.php';
exigerConnexion();
exigerPermission('VENTES_LIRE');

global $pdo;

$today    = date('Y-m-d');
$dateDeb  = $_GET['date_debut'] ?? $today;
$dateFin  = $_GET['date_fin'] ?? $today;
$statut   = $_GET['statut'] ?? '';
$clientId = isset($_GET['client_id']) ? (int)$_GET['client_id'] : 0;
$canalId  = isset($_GET['canal_id']) ? (int)$_GET['canal_id'] : 0;

// Clients pour filtre
$stmt = $pdo->query("SELECT id, nom FROM clients ORDER BY nom");
$clients = $stmt->fetchAll();

// Canaux de vente pour filtre
$stmt = $pdo->query("SELECT id, code, libelle FROM canaux_vente ORDER BY code");
$canaux = $stmt->fetchAll();

$where  = [];
$params = [];

if ($dateDeb !== '') {
    $where[] = "v.date_vente >= :date_debut";
    $params['date_debut'] = $dateDeb;
}
if ($dateFin !== '') {
    $where[] = "v.date_vente <= :date_fin";
    $params['date_fin'] = $dateFin;
}
if ($statut !== '' && in_array($statut, ['EN_ATTENTE_LIVRAISON','LIVREE','ANNULEE','PARTIELLEMENT_LIVREE'], true)) {
    $where[] = "v.statut = :statut";
    $params['statut'] = $statut;
}
if ($clientId > 0) {
    $where[] = "v.client_id = :client_id";
    $params['client_id'] = $clientId;
}
if ($canalId > 0) {
    $where[] = "v.canal_vente_id = :canal_id";
    $params['canal_id'] = $canalId;
}

$whereSql = '';
if (!empty($where)) {
    $whereSql = 'WHERE ' . implode(' AND ', $where);
}

$sql = "
    SELECT
        v.*,
        c.nom AS client_nom,
        cv.code AS canal_code,
        cv.libelle AS canal_libelle,
        u.nom_complet AS commercial_nom
    FROM ventes v
    JOIN clients c ON c.id = v.client_id
    JOIN canaux_vente cv ON cv.id = v.canal_vente_id
    JOIN utilisateurs u ON u.id = v.utilisateur_id
    $whereSql
    ORDER BY v.date_vente DESC, v.id DESC
";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$ventes = $stmt->fetchAll();

$peutCreerVente = in_array('VENTES_CREER', $_SESSION['permissions'] ?? [], true);

$flashSuccess = $_SESSION['flash_success'] ?? null;
$flashError   = $_SESSION['flash_error'] ?? null;
unset($_SESSION['flash_success'], $_SESSION['flash_error']);

include __DIR__ . '/../partials/header.php';
include __DIR__ . '/../partials/sidebar.php';
?>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Ventes</h1>
        <?php if ($peutCreerVente): ?>
            <a href="<?= url_for('ventes/edit.php') ?>" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i> Nouvelle vente
            </a>
        <?php endif; ?>
    </div>

    <?php if ($flashSuccess): ?>
        <div class="alert alert-success py-2">
            <i class="bi bi-check-circle me-1"></i>
            <?= htmlspecialchars($flashSuccess) ?>
        </div>
    <?php endif; ?>

    <?php if ($flashError): ?>
        <div class="alert alert-danger py-2">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <?= htmlspecialchars($flashError) ?>
        </div>
    <?php endif; ?>

    <!-- Filtres -->
    <div class="card mb-3">
        <div class="card-body">
            <form class="row g-2 align-items-end" method="get">
                <div class="col-md-2">
                    <label class="form-label small">Du</label>
                    <input type="date" name="date_debut" class="form-control"
                           value="<?= htmlspecialchars($dateDeb) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Au</label>
                    <input type="date" name="date_fin" class="form-control"
                           value="<?= htmlspecialchars($dateFin) ?>">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Statut</label>
                    <select name="statut" class="form-select">
                        <option value="">Tous</option>
                        <?php foreach (['EN_ATTENTE_LIVRAISON','PARTIELLEMENT_LIVREE','LIVREE','ANNULEE'] as $s): ?>
                            <option value="<?= $s ?>" <?= $statut === $s ? 'selected' : '' ?>>
                                <?= $s ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Client</label>
                    <select name="client_id" class="form-select">
                        <option value="0">Tous</option>
                        <?php foreach ($clients as $cl): ?>
                            <option value="<?= (int)$cl['id'] ?>"
                                <?= $clientId === (int)$cl['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($cl['nom']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Canal</label>
                    <select name="canal_id" class="form-select">
                        <option value="0">Tous</option>
                        <?php foreach ($canaux as $cv): ?>
                            <option value="<?= (int)$cv['id'] ?>"
                                <?= $canalId === (int)$cv['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($cv['code']) ?> â€“ <?= htmlspecialchars($cv['libelle']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="col-12 d-flex gap-2 mt-2">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                    <a href="<?= url_for('ventes/list.php') ?>" class="btn btn-outline-secondary">
                        RÃ©initialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des ventes -->
    <div class="card">
        <div class="card-body">
            <?php if (empty($ventes)): ?>
                <p class="text-muted mb-0">Aucune vente trouvÃ©e pour les filtres sÃ©lectionnÃ©s.</p>
            <?php else: ?>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>NÂ° vente</th>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Canal</th>
                            <th>Commercial</th>
                            <th class="text-end">Montant HT</th>
                            <th class="text-end">Montant TTC</th>
                            <th class="text-center">Statut</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($ventes as $v): ?>
                            <?php
                            $badgeClass = 'bg-secondary-subtle text-secondary';
                            if ($v['statut'] === 'EN_ATTENTE_LIVRAISON') $badgeClass = 'bg-warning-subtle text-warning';
                            elseif ($v['statut'] === 'PARTIELLEMENT_LIVREE') $badgeClass = 'bg-info-subtle text-info';
                            elseif ($v['statut'] === 'LIVREE') $badgeClass = 'bg-success-subtle text-success';
                            elseif ($v['statut'] === 'ANNULEE') $badgeClass = 'bg-dark-subtle text-dark';
                            ?>
                            <tr>
                                <td>
                                    <a href="<?= url_for('ventes/detail.php') . '?id=' . (int)$v['id'] ?>"
                                       class="link-primary text-decoration-none">
                                        <?= htmlspecialchars($v['numero']) ?>
                                    </a>
                                </td>
                                <td><?= htmlspecialchars($v['date_vente']) ?></td>
                                <td><?= htmlspecialchars($v['client_nom']) ?></td>
                                <td>
                                    <span class="badge bg-primary-subtle text-primary">
                                        <?= htmlspecialchars($v['canal_code']) ?>
                                    </span>
                                    <span class="text-muted small d-block">
                                        <?= htmlspecialchars($v['canal_libelle']) ?>
                                    </span>
                                </td>
                                <td><?= htmlspecialchars($v['commercial_nom']) ?></td>
                                <td class="text-end">
                                    <?= number_format((float)$v['montant_total_ht'], 0, ',', ' ') ?> FCFA
                                </td>
                                <td class="text-end">
                                    <?= number_format((float)$v['montant_total_ttc'], 0, ',', ' ') ?> FCFA
                                </td>
                                <td class="text-center">
                                    <span class="badge <?= $badgeClass ?>">
                                        <?= htmlspecialchars($v['statut']) ?>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <a href="<?= url_for('ventes/detail.php') . '?id=' . (int)$v['id'] ?>"
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-eye me-1"></i> DÃ©tails
                                    </a>
                                    <?php if ($peutCreerVente): ?>
                                        <a href="<?= url_for('ventes/edit.php') . '?id=' . (int)$v['id'] ?>"
                                           class="btn btn-sm btn-outline-secondary ms-1">
                                            <i class="bi bi-pencil-square me-1"></i> Modifier
                                        </a>
                                    <?php endif; ?>
                                    <!-- Bouton 'GÃ©nÃ©rer BL' gÃ©rÃ© depuis la page dÃ©tail -->
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>
    </div>

</div>

<?php include __DIR__ . '/../partials/footer.php'; ?>



